<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.0d86aa92c5843d055886.css" id="gatsby-global-css">/*!
 * ress.css • v2.0.4
 * MIT License
 * github.com/filipelinhares/ress
 */html{box-sizing:border-box;-webkit-text-size-adjust:100%;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4}*,:after,:before{background-repeat:no-repeat;box-sizing:inherit}:after,:before{text-decoration:inherit;vertical-align:inherit}*{padding:0;margin:0}hr{overflow:visible;height:0}details,main{display:block}summary{display:list-item}small{font-size:80%}[hidden]{display:none}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}a{background-color:transparent}a:active,a:hover{outline-width:0}code,kbd,pre,samp{font-family:monospace,monospace}pre{font-size:1em}b,strong{font-weight:bolder}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}input{border-radius:0}[disabled]{cursor:default}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}textarea{overflow:auto;resize:vertical}button,input,optgroup,select,textarea{font:inherit}optgroup{font-weight:700}button{overflow:visible}button,select{text-transform:none}[role=button],[type=button],[type=reset],[type=submit],button{cursor:pointer;color:inherit}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button:-moz-focusring{outline:1px dotted ButtonText}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}button,input,select,textarea{background-color:transparent;border-style:none}select{-moz-appearance:none;-webkit-appearance:none}select::-ms-expand{display:none}select::-ms-value{color:currentColor}legend{border:0;color:inherit;display:table;white-space:normal;max-width:100%}::-webkit-file-upload-button{-webkit-appearance:button;color:inherit;font:inherit}img{border-style:none}progress{vertical-align:baseline}svg:not([fill]){fill:currentColor}@media screen{[hidden~=screen]{display:inherit}[hidden~=screen]:not(:active):not(:focus):not(:target){position:absolute!important;clip:rect(0 0 0 0)!important}}[aria-busy=true]{cursor:progress}[aria-controls]{cursor:pointer}[aria-disabled]{cursor:default}</style><meta name="generator" content="Gatsby 2.30.1"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">連載 Rails2Phoenix 2 認証機能を実装する - On Blahfe</title><link data-react-helmet="true" rel="canonical" href="https://nabinno.github.io/posts/60"/><meta data-react-helmet="true" name="google-site-verification" content=""/><meta data-react-helmet="true" name="description" content="連載「Rails2Phoenix」になります、前回は「UmbrellaプロジェクトをHerokuにデプロイする 」でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。   &gt; PROBLEMPROBLEM 

- サービ"/><meta data-react-helmet="true" property="og:url" content="https://nabinno.github.io/posts/60"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="連載 Rails2Phoenix 2 認証機能を実装する - On Blahfe"/><meta data-react-helmet="true" property="og:description" content="連載「Rails2Phoenix」になります、前回は「UmbrellaプロジェクトをHerokuにデプロイする 」でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。   &gt; PROBLEMPROBLEM 

- サービ"/><meta data-react-helmet="true" property="og:image" content="https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="@nabinno"/><meta data-react-helmet="true" name="twitter:title" content="連載 Rails2Phoenix 2 認証機能を実装する - On Blahfe"/><meta data-react-helmet="true" name="twitter:description" content="連載「Rails2Phoenix」になります、前回は「UmbrellaプロジェクトをHerokuにデプロイする 」でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。   &gt; PROBLEMPROBLEM 

- サービ"/><meta data-react-helmet="true" name="twitter:image" content="https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"/><link rel="icon" href="/favicon-32x32.png?v=381a3661ec5793ff376970a2019b6518" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#fff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=381a3661ec5793ff376970a2019b6518"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-7a7e64c679eaacb6bc0d.js"/><link as="script" rel="preload" href="/framework-dbb498007a7447f28d8e.js"/><link as="script" rel="preload" href="/app-1609d7d465ccd6a5a330.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/commons-d1e204551af284801370.js"/><link as="script" rel="preload" href="/component---src-templates-posts-tsx-01adf45b9f8003118fcd.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-557e62df0f80429a7567.js"/><link as="fetch" rel="preload" href="/page-data/posts/60/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="ly78bw">.css-ly78bw{font-family:-apple-system-body,'Source Han Mono',BlinkMacSystemFont,'Helvetica Neue','Hiragino Sans','Hiragino Kaku Gothic ProN','Noto Sans Japanese','游ゴシック  Medium','Yu Gothic Medium','メイリオ',meiryo,sans-serif;}@media screen and (-webkit-min-device-pixel-ratio:2),screen and (min-resolution:2dppx){.css-ly78bw{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;}}</style><div class="css-ly78bw e1j2fp1f0"><div><style data-emotion-css="10061d2">.css-10061d2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}@media (min-width:980px){.css-10061d2{-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}}</style><div class="css-10061d2 e1rphn8v0"><style data-emotion-css="1ur9eye">.css-1ur9eye{max-width:620px;width:100%;margin:20px auto;}</style><div style="margin-top:32px" class="css-1ur9eye e1rphn8v1"><style data-emotion-css="1igky03">.css-1igky03{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-right:auto;margin-bottom:1.75rem;}</style><h1 class="css-1igky03"><style data-emotion-css="1a6yofc">.css-1a6yofc{color:rgba(26,32,44,0.88);-webkit-text-decoration:none;text-decoration:none;font-family:Montserrat,sans-serif;font-weight:900;font-size:1.4427rem;line-height:1.1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:16px;margin:-16px;}.css-1a6yofc:hover{background-color:rgba(255,255,255,0.1);}</style><a class="css-1a6yofc" href="/">On Blahfe</a></h1><style data-emotion-css="kvk3sk">.css-kvk3sk{padding:0 12px;}@media (min-width:600px){.css-kvk3sk{padding:0;}}</style><div class="css-kvk3sk epep3293"><style data-emotion-css="19sxenz">.css-19sxenz{display:block;margin-bottom:4px;font-weight:600;-webkit-letter-spacing:0.5px;-moz-letter-spacing:0.5px;-ms-letter-spacing:0.5px;letter-spacing:0.5px;opacity:0.6;font-size:15px;}</style><time class="css-19sxenz">2018.05.20</time><style data-emotion-css="1b1c2m5">.css-1b1c2m5{font-size:24px;line-height:1.4;font-weight:700;margin-bottom:4px;color:#1a202c;font-family:-apple-system,'Source Han Mono','BlinkMacSystemFont','Helvetica Neue','Hiragino Sans','游ゴシック Medium','YuGothic','Hiragino Kaku Gothic ProN','メイリオ','Meiryo,sans-serif';}@media (min-width:600px){.css-1b1c2m5{font-size:30px;}}</style><h1 class="css-1b1c2m5 epep3291">連載 Rails2Phoenix 2 認証機能を実装する</h1><style data-emotion-css="3bor06">.css-3bor06{display:inline-block;background-color:white;border:1px solid #eee;color:rgba(0,0,0,0.6);padding:6px 12px;margin-right:8px;font-weight:bold;font-size:12px;border-radius:4px;-webkit-text-decoration:none;text-decoration:none;background-image:linear-gradient( 45deg,#58463C 0px,#80695F 100% );color:white;margin-bottom:4px;text-transform:capitalize;-webkit-letter-spacing:0.2px;-moz-letter-spacing:0.2px;-ms-letter-spacing:0.2px;letter-spacing:0.2px;}.css-3bor06:hover{border-color:#ccc;color:rgba(0,0,0,0.8);}.css-3bor06:before{content:'#';}.css-3bor06:hover{border-color:inherit;color:white;}.css-3bor06:before{content:'';}</style><a class="css-3bor06 epep3292" href="/categories/blog/backend">blog/backend</a><style data-emotion-css="1qp0zyo">.css-1qp0zyo{display:inline-block;background-color:white;border:1px solid #eee;color:rgba(0,0,0,0.6);padding:6px 12px;margin-right:8px;font-weight:bold;font-size:12px;border-radius:4px;-webkit-text-decoration:none;text-decoration:none;}.css-1qp0zyo:hover{border-color:#ccc;color:rgba(0,0,0,0.8);}.css-1qp0zyo:before{content:'#';}</style><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/phoenix-framework">phoenix-framework</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/elixir">elixir</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/ruby-on-rails">ruby-on-rails</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/ruby">ruby</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/wercker">wercker</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/heroku">heroku</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/authentication">authentication</a><a style="margin-top:4px;margin-bottom:8px" class="css-1qp0zyo evhx4tm0" href="/tags/guardian">guardian</a><style data-emotion-css="1f03b13">.css-1f03b13{margin-top:24px;margin-bottom:4.375rem;line-height:1.8;font-size:15px;word-break:break-all;color:rgba(26,32,44,0.88);}.css-1f03b13 .hidden{display:none;}.css-1f03b13 pre{display:block;padding:10.5px;margin:0 0 11px;font-size:13px;line-height:1.6;word-break:break-all;word-wrap:break-word;color:#4a5568;background-color:#3e4149;border:1px solid #ccc;border-radius:4px;}.css-1f03b13 pre code{padding:0;font-size:inherit;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0;}.css-1f03b13 h1{font-size:200%;border-bottom:3px solid rgba(0,0,0,0.1);padding-bottom:10px;margin:30px 0;margin-bottom:10px;}.css-1f03b13 h1 .emoji{width:36px;height:36px;}.css-1f03b13 h1 a{color:#0a9b94;}.css-1f03b13 h1 a:hover{color:#1a202c;}.css-1f03b13 h2{font-size:160%;margin:30px 0 16px;font-weight:900;border-bottom:3px solid rgba(0,0,0,0.1);padding-bottom:4px;position:relative;}.css-1f03b13 h2:before{position:absolute;content:' ';width:100px;bottom:-3px;height:3px;background-color:#80695F;}.css-1f03b13 h2 .emoji{width:28px;height:28px;}.css-1f03b13 h2 a{color:#0a9b94;}.css-1f03b13 h2 a:hover{color:#1a202c;}.css-1f03b13 h3{margin:24px 0;margin-bottom:10px;font-size:130%;font-weight:900;}.css-1f03b13 h3 .emoji{width:22px;height:22px;}.css-1f03b13 h4{font-size:120%;font-weight:900;}.css-1f03b13 .markdown > ul,.css-1f03b13 .markdown > ol{margin:16px 0;}.css-1f03b13 ul,.css-1f03b13 ol{padding-left:40px;}.css-1f03b13 li{margin:4px 0;}.css-1f03b13 li > p{margin:0;}.css-1f03b13 dt{margin-top:14px;margin-bottom:4px;}.css-1f03b13 dd{padding:0 14px;margin-bottom:4px;}.css-1f03b13 p{margin:16px 0;}.css-1f03b13 p img{margin-bottom:0;}.css-1f03b13 blockquote{font-size:100%;color:rgba(60,74,96,0.7);border-left:5px solid rgba(0,0,0,0.1);margin-bottom:30px;padding:0 20px;}.css-1f03b13 blockquote p{margin:10px 0 !important;}.css-1f03b13 code{color:#3c4a60;white-space:pre-wrap;border-radius:4px;background-color:rgba(0,0,0,0.05);}.css-1f03b13 pre{border:none;}.css-1f03b13 pre code{background:#f6f6f6;}.css-1f03b13 a{color:#58463C;}.css-1f03b13 a:hover{color:#80695F;}.css-1f03b13 .code-block .highlight{border-radius:4px;}.css-1f03b13 .code-block__copy-button{position:absolute;top:0;right:0;display:none;background-color:white;border:1px solid rgba(0,0,0,0.1);padding:2px 7px;font-size:10px;font-family:'Source Han Mono','Lato',Emoji,Arial,'ヒラギノ角ゴPro W3','Hiragino Kaku Gothic Pro','メイリオ',Meiryo,'ＭＳ Ｐゴシック',sans-serif;}.css-1f03b13 .code-block__copy-button i{color:rgba(60,74,96,0.3);}.css-1f03b13 .code-block__copy-button:hover{background-color:#f6f6f6;border:1px solid rgba(0,0,0,0.2);}.css-1f03b13 .code-block__copy-label::after{content:'Copy';}.css-1f03b13 .code-block__copy-label.copied::after{content:'Copied';}.css-1f03b13 .code-block .highlight{position:relative;}.css-1f03b13 .code-block:hover .code-block__copy-button{display:block;}.css-1f03b13 table{border:1px solid rgba(0,0,0,0.1);width:100%;border-collapse:collapse;border-spacing:0;margin:20px 0;margin-bottom:30px;}.css-1f03b13 table tr:nth-child(odd) td{background-color:#f9f9f9;}.css-1f03b13 table tr th,.css-1f03b13 table tr td{padding:8px;line-height:1.6;vertical-align:top;border:1px solid rgba(0,0,0,0.1);}.css-1f03b13 strong{font-weight:700;}.css-1f03b13 img{max-width:100%;border:1px solid #eee;border-radius:4px;}.css-1f03b13 .anchor{-webkit-transition-duration:0;transition-duration:0;display:none;margin-left:-20px;width:20px;height:20px;font-size:20px;text-align:right;padding-top:8px;}.css-1f03b13 .anchor i:hover{color:#08837d;}.css-1f03b13 .anchor .fa-pencil{-webkit-transform:rotateY(180deg);-webkit-transform:rotateY(180deg);-ms-transform:rotateY(180deg);transform:rotateY(180deg);}.css-1f03b13 h1,.css-1f03b13 h2,.css-1f03b13 h3,.css-1f03b13 h4{-webkit-font-smoothing:antialiased;}.css-1f03b13 h1:hover .anchor,.css-1f03b13 h2:hover .anchor,.css-1f03b13 h3:hover .anchor{display:inline-block;}.css-1f03b13 h2 .anchor{padding-top:5px;font-size:18px;}.css-1f03b13 h2 .anchor i{top:4px;}.css-1f03b13 h3 .anchor{padding-top:3px;font-size:15px;}.css-1f03b13 h3 .anchor i{top:4px;}.css-1f03b13 .emoji{border:none;height:19px;width:19px;}.css-1f03b13 iframe{max-width:100%;}.css-1f03b13 hr{border-top-color:rgba(33,37,41,0.12);display:block;border-top-width:1px;border-top-style:solid;margin:32px 0;}.css-1f03b13 .code-filename{border-top-left-radius:4px;border-top-right-radius:4px;position:relative;top:auto;right:auto;bottom:auto;left:auto;top:4px;display:inline-block;padding:3px 10px;background-color:#3e4149;color:#fff;font-size:85%;line-height:1.5;margin-bottom:-10px;}.css-1f03b13 .code-filename i{color:rgba(60,74,96,0.3);}@media (max-width:900px){.css-1f03b13 video{width:100%;}}.css-1f03b13 .highlight code table td{padding:5px;}.css-1f03b13 .highlight code table pre{margin:0;}.css-1f03b13 .highlight code .c,.css-1f03b13 .highlight code .cd{color:#75715e;font-style:italic;}.css-1f03b13 .highlight code .cm{color:#75715e;font-style:italic;}.css-1f03b13 .highlight code .c1{color:#75715e;font-style:italic;}.css-1f03b13 .highlight code .cp{color:#75715e;font-weight:bold;}.css-1f03b13 .highlight code .cs{color:#75715e;font-weight:bold;font-style:italic;}.css-1f03b13 .highlight code .err{color:#960050;background-color:#1e0010;}.css-1f03b13 .highlight code .gi{color:#ffffff;background-color:#324932;}.css-1f03b13 .highlight code .gd{color:#ffffff;background-color:#493131;}.css-1f03b13 .highlight code .ge{color:#000000;font-style:italic;}.css-1f03b13 .highlight code .gr{color:#aa0000;}.css-1f03b13 .highlight code .gt{color:#aa0000;}.css-1f03b13 .highlight code .gh{color:#999999;}.css-1f03b13 .highlight code .go{color:#888888;}.css-1f03b13 .highlight code .gp{color:#555555;}.css-1f03b13 .highlight code .gs{font-weight:bold;}.css-1f03b13 .highlight code .gu{color:#aaaaaa;}.css-1f03b13 .highlight code .k,.css-1f03b13 .highlight code .kv{color:#66d9ef;font-weight:bold;}.css-1f03b13 .highlight code .kc{color:#66d9ef;font-weight:bold;}.css-1f03b13 .highlight code .kd{color:#66d9ef;font-weight:bold;}.css-1f03b13 .highlight code .kp{color:#66d9ef;font-weight:bold;}.css-1f03b13 .highlight code .kr{color:#66d9ef;font-weight:bold;}.css-1f03b13 .highlight code .kt{color:#66d9ef;font-weight:bold;}.css-1f03b13 .highlight code .kn{color:#f92672;font-weight:bold;}.css-1f03b13 .highlight code .ow{color:#f92672;font-weight:bold;}.css-1f03b13 .highlight code .o{color:#f92672;font-weight:bold;}.css-1f03b13 .highlight code .mf{color:#ae81ff;}.css-1f03b13 .highlight code .mh{color:#ae81ff;}.css-1f03b13 .highlight code .il{color:#ae81ff;}.css-1f03b13 .highlight code .mi{color:#ae81ff;}.css-1f03b13 .highlight code .mo{color:#ae81ff;}.css-1f03b13 .highlight code .m,.css-1f03b13 .highlight code .mb,.css-1f03b13 .highlight code .mx{color:#ae81ff;}.css-1f03b13 .highlight code .se{color:#ae81ff;}.css-1f03b13 .highlight code .sb{color:#e6db74;}.css-1f03b13 .highlight code .sc{color:#e6db74;}.css-1f03b13 .highlight code .sd{color:#e6db74;}.css-1f03b13 .highlight code .s2{color:#e6db74;}.css-1f03b13 .highlight code .sh{color:#e6db74;}.css-1f03b13 .highlight code .si{color:#e6db74;}.css-1f03b13 .highlight code .sx{color:#e6db74;}.css-1f03b13 .highlight code .sr{color:#e6db74;}.css-1f03b13 .highlight code .s1{color:#e6db74;}.css-1f03b13 .highlight code .ss{color:#e6db74;}.css-1f03b13 .highlight code .s{color:#e6db74;}.css-1f03b13 .highlight code .na{color:#a6e22e;}.css-1f03b13 .highlight code .nc{color:#a6e22e;font-weight:bold;}.css-1f03b13 .highlight code .nd{color:#a6e22e;font-weight:bold;}.css-1f03b13 .highlight code .ne{color:#a6e22e;font-weight:bold;}.css-1f03b13 .highlight code .nf{color:#a6e22e;font-weight:bold;}.css-1f03b13 .highlight code .no{color:#66d9ef;}.css-1f03b13 .highlight code .bp{color:#f8f8f2;}.css-1f03b13 .highlight code .nb{color:#f8f8f2;}.css-1f03b13 .highlight code .ni{color:#f8f8f2;}.css-1f03b13 .highlight code .nn{color:#f8f8f2;}.css-1f03b13 .highlight code .vc{color:#f8f8f2;}.css-1f03b13 .highlight code .vg{color:#f8f8f2;}.css-1f03b13 .highlight code .vi{color:#f8f8f2;}.css-1f03b13 .highlight code .nv{color:#f8f8f2;}.css-1f03b13 .highlight code .w{color:#f8f8f2;}.css-1f03b13 .highlight code .nl{color:#f8f8f2;font-weight:bold;}.css-1f03b13 .highlight code .nt{color:#f92672;}.css-1f03b13 .highlight code{color:#f8f8f2;background-color:#3e4149;}.css-1f03b13 h1,.css-1f03b13 h2,.css-1f03b13 h3,.css-1f03b13 h4,.css-1f03b13 h5,.css-1f03b13 h6{font-weight:700;}.css-1f03b13 .footnotes{margin-top:4.375rem;padding:20px 0;background-color:#efefef;}</style><div class="css-1f03b13 e1a9pvvr0"><a href="https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png" target="_blank" rel="noopener noreferrer"><img width="728" alt="thumbnail" src="https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"></a>
<p data-sourcepos="3:1-3:257">連載「Rails2Phoenix」になります、前回は<a href="https://blahfe.esa.io/posts/59">「UmbrellaプロジェクトをHerokuにデプロイする 」</a>でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。</p>
<h1 data-sourcepos="6:1-6:9" id="1-0-0" name="1-0-0">
<a class="anchor" id="PROBLEM" name="PROBLEM" href="#PROBLEM" data-position="1-0-0"><i class="fa fa-link"></i><span class="hidden" data-text="PROBLEM"> &gt; PROBLEM</span></a>PROBLEM</h1>
<ul data-sourcepos="7:1-11:0">
<li data-sourcepos="7:1-11:0">サービスについて
<ul data-sourcepos="8:5-11:0">
<li data-sourcepos="8:5-8:75">拡張にともない技術スタックがふえるのを抑えたい</li>
<li data-sourcepos="9:5-9:66">スケーラビリティのためのコストを抑えたい</li>
<li data-sourcepos="10:5-11:0">パフォーマンスをあげたい</li>
</ul>
</li>
</ul>
<h1 data-sourcepos="12:1-12:10" id="2-0-0" name="2-0-0">
<a class="anchor" id="SOLUTION" name="SOLUTION" href="#SOLUTION" data-position="2-0-0"><i class="fa fa-link"></i><span class="hidden" data-text="SOLUTION"> &gt; SOLUTION</span></a>SOLUTION</h1>
<p data-sourcepos="13:1-13:220">というわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRails/Deviseの認証機能をPhoenixで実装する流れを取り上げます。</p>
<p data-sourcepos="15:1-15:10"><strong>方針</strong></p>
<ul data-sourcepos="16:1-24:0">
<li data-sourcepos="16:1-22:64">Railsから徐々にPhoenixに移行できるように
<ul data-sourcepos="17:3-22:64">
<li data-sourcepos="17:3-17:44">いままでとおなじPaaS（Heroku）</li>
<li data-sourcepos="18:3-20:100">いままでとおなじレポジトリ
<ul data-sourcepos="19:7-20:100">
<li data-sourcepos="19:7-19:60">ブランチ戦略は <code>phoenix/base</code> をベースに</li>
<li data-sourcepos="20:7-20:100">気軽に参照できるようにRails関連ファイルは可能な限りのこしておく</li>
</ul>
</li>
<li data-sourcepos="21:3-22:64">いままでとおなじDB
<ul data-sourcepos="22:7-22:64">
<li data-sourcepos="22:7-22:64">移行完了までDBマイグレーションをしない</li>
</ul>
</li>
</ul>
</li>
<li data-sourcepos="23:1-24:0">Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで</li>
</ul>
<h2 data-sourcepos="25:1-25:26" id="2-1-0" name="2-1-0">
<a class="anchor" id="Guardianを実装する" name="Guardian%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B" href="#Guardian%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B" data-position="2-1-0"><i class="fa fa-link"></i><span class="hidden" data-text="Guardianを実装する"> &gt; Guardianを実装する</span></a>Guardianを実装する</h2>
<p data-sourcepos="26:1-26:382">まず、参考にしたのはBlackodeの<a href="https://github.com/blackode/guardian_auth" target="_blank" rel="noopener noreferrer">guardian_auth</a>です。ただ、Guardianのバージョンがふるいので<a href="https://github.com/ueberauth/guardian/blob/master/upgrade_guides/0.14.to.1.0.md" target="_blank" rel="noopener noreferrer">1.0へのマイグレーション記事</a>をもとにアレンジしてあります。認証に関係しそうな構成は下記の通り。</p>
<p data-sourcepos="28:1-28:12">ロジック</p>
<ul data-sourcepos="29:1-37:0">
<li data-sourcepos="29:1-29:15">MyApp.Account</li>
<li data-sourcepos="30:1-30:28">MyApp.Account.Registration</li>
<li data-sourcepos="31:1-31:20">MyApp.Account.User</li>
<li data-sourcepos="32:1-32:21">MyApp.Auth.Guardian</li>
<li data-sourcepos="33:1-33:25">MyApp.Auth.ErrorHandler</li>
<li data-sourcepos="34:1-34:21">MyApp.Auth.Pipeline</li>
<li data-sourcepos="35:1-35:26">MyApp.Auth.AfterPipeline</li>
<li data-sourcepos="36:1-37:0">MyApp.Auth.Session</li>
</ul>
<p data-sourcepos="38:1-38:18">コントローラ</p>
<ul data-sourcepos="39:1-41:0">
<li data-sourcepos="39:1-39:33">MyAppWeb.RegistrationController</li>
<li data-sourcepos="40:1-41:0">MyAppWeb.SessionController</li>
</ul>
<h3 data-sourcepos="42:1-42:55" id="2-1-1" name="2-1-1">
<a class="anchor" id="シリアライザとエラーハンドラの設定" name="%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%B6%E3%81%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A" href="#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%B6%E3%81%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A" data-position="2-1-1"><i class="fa fa-link"></i><span class="hidden" data-text="シリアライザとエラーハンドラの設定"> &gt; シリアライザとエラーハンドラの設定</span></a>シリアライザとエラーハンドラの設定</h3>
<p data-sourcepos="43:1-43:191">Guardian1.0から直接ではなくモジュールを介して参照するようになりました。下記のように各モジュールを用意してコンフィグに割り当てます。</p>
<div class="code-block" data-sourcepos="45:1-58:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/guardian.ex</span>

<span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Guardian</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Guardian</span><span class="p">,</span> <span class="ss">otp_app:</span> <span class="ss">:my_app</span>
  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Account</span>

  <span class="k">def</span> <span class="n">subject_for_token</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">_claims</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span>
  <span class="k">def</span> <span class="n">subject_for_token</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:reason_for_error</span><span class="p">}</span>

  <span class="k">def</span> <span class="n">resource_from_claims</span><span class="p">(</span><span class="n">claims</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">Account</span><span class="o">.</span><span class="n">get_user!</span><span class="p">(</span><span class="n">claims</span><span class="p">[</span><span class="s2">"sub"</span><span class="p">])}</span>
  <span class="k">def</span> <span class="n">resource_from_claims</span><span class="p">(</span><span class="n">_claims</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:reason_for_error</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="60:1-71:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/error_handler.ex</span>

<span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">ErrorHandler</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>

  <span class="k">def</span> <span class="n">auth_error</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">_reason</span><span class="p">},</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">body</span> <span class="o">=</span> <span class="no">Poison</span><span class="o">.</span><span class="n">encode!</span><span class="p">(%{</span><span class="ss">message:</span> <span class="n">to_string</span><span class="p">(</span><span class="n">type</span><span class="p">)})</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="73:1-87:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/config/config.exs</span>

<span class="n">config</span> <span class="ss">:my_app</span><span class="p">,</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">issuer:</span> <span class="s2">"MyApp"</span><span class="p">,</span>
  <span class="ss">ttl:</span> <span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="ss">:days</span><span class="p">},</span>
  <span class="ss">allowed_drift:</span> <span class="mi">2000</span><span class="p">,</span>
  <span class="c1"># optionals</span>
  <span class="ss">allowed_algos:</span> <span class="p">[</span><span class="s2">"HS512"</span><span class="p">],</span>
  <span class="ss">verify_module:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Guardian</span><span class="o">.</span><span class="no">JWT</span><span class="p">,</span>
  <span class="ss">verify_issuer:</span> <span class="no">true</span><span class="p">,</span>
  <span class="ss">secret_key:</span>
    <span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">"GUARDIAN_SECRET"</span><span class="p">)</span> <span class="o">||</span>
      <span class="s2">"secret_key"</span>
</code></pre></div>
</div>
<h3 data-sourcepos="89:1-89:25" id="2-1-2" name="2-1-2">
<a class="anchor" id="ルーターの設定" name="%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A" href="#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A" data-position="2-1-2"><i class="fa fa-link"></i><span class="hidden" data-text="ルーターの設定"> &gt; ルーターの設定</span></a>ルーターの設定</h3>
<p data-sourcepos="90:1-90:129">認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てます。</p>
<p data-sourcepos="92:1-92:614">ルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用しています。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになります。具体的にいうと、ルート <code>/</code> などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになります。</p>
<div class="code-block" data-sourcepos="94:1-104:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/pipeline.ex</span>

<span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Pipeline</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Pipeline</span><span class="p">,</span> <span class="ss">otp_app:</span> <span class="ss">:my_app</span>

  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifySession</span><span class="p">,</span> <span class="ss">claims:</span> <span class="p">%{</span><span class="s2">"typ"</span> <span class="o">=&gt;</span> <span class="s2">"access"</span><span class="p">})</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyHeader</span><span class="p">,</span> <span class="ss">claims:</span> <span class="p">%{</span><span class="s2">"typ"</span> <span class="o">=&gt;</span> <span class="s2">"access"</span><span class="p">})</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">LoadResource</span><span class="p">,</span> <span class="ss">allow_blank:</span> <span class="no">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="106:1-114:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/after_pipeline.ex</span>

<span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">AfterPipeline</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Pipeline</span><span class="p">,</span> <span class="ss">otp_app:</span> <span class="ss">:my_app</span>

  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">EnsureAuthenticated</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="116:1-156:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app_web/router.ex</span>

<span class="k">defmodule</span> <span class="no">MyAppWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">MyAppWeb</span><span class="p">,</span> <span class="ss">:router</span>

  <span class="n">pipeline</span> <span class="ss">:browser</span> <span class="k">do</span>
    <span class="n">plug</span><span class="p">(</span><span class="ss">:accepts</span><span class="p">,</span> <span class="p">[</span><span class="s2">"html"</span><span class="p">])</span>
    <span class="n">plug</span><span class="p">(</span><span class="ss">:fetch_session</span><span class="p">)</span>
    <span class="n">plug</span><span class="p">(</span><span class="ss">:fetch_flash</span><span class="p">)</span>
    <span class="n">plug</span><span class="p">(</span><span class="ss">:protect_from_forgery</span><span class="p">)</span>
    <span class="n">plug</span><span class="p">(</span><span class="ss">:put_secure_browser_headers</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">pipeline</span> <span class="ss">:browser_auth</span> <span class="k">do</span>
    <span class="n">plug</span><span class="p">(</span><span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Pipeline</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">pipeline</span> <span class="ss">:browser_auth_after</span> <span class="k">do</span>
    <span class="n">plug</span><span class="p">(</span><span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">AfterPipeline</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">MyAppWeb</span> <span class="k">do</span>
    <span class="n">pipe_through</span><span class="p">([</span><span class="ss">:browser</span><span class="p">,</span> <span class="ss">:browser_auth</span><span class="p">])</span>

    <span class="n">post</span><span class="p">(</span><span class="s2">"/registration"</span><span class="p">,</span> <span class="no">RegistrationController</span><span class="p">,</span> <span class="ss">:create</span><span class="p">)</span>
    <span class="n">get</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">,</span> <span class="no">SessionController</span><span class="p">,</span> <span class="ss">:new</span><span class="p">)</span>
    <span class="n">post</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">,</span> <span class="no">SessionController</span><span class="p">,</span> <span class="ss">:create</span><span class="p">)</span>
    <span class="n">get</span><span class="p">(</span><span class="s2">"/logout"</span><span class="p">,</span> <span class="no">SessionController</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">MyAppWeb</span> <span class="k">do</span>
    <span class="n">pipe_through</span><span class="p">([</span><span class="ss">:browser</span><span class="p">,</span> <span class="ss">:browser_auth</span><span class="p">,</span> <span class="ss">:browser_auth_after</span><span class="p">])</span>

    <span class="n">get</span><span class="p">(</span><span class="s2">"/edit"</span><span class="p">,</span> <span class="no">RegistrationController</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">)</span>
    <span class="n">put</span><span class="p">(</span><span class="s2">"/edit"</span><span class="p">,</span> <span class="no">RegistrationController</span><span class="p">,</span> <span class="ss">:update</span><span class="p">)</span>
    <span class="n">get</span><span class="p">(</span><span class="s2">"/users"</span><span class="p">,</span> <span class="no">UserController</span><span class="p">,</span> <span class="ss">:index</span><span class="p">)</span>
    <span class="n">resources</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">UserController</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">],</span> <span class="ss">param:</span> <span class="s2">"username"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="158:1-168:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/config/config.exs</span>

<span class="n">config</span> <span class="ss">:MyApp</span><span class="p">,</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Pipeline</span><span class="p">,</span>
  <span class="ss">module:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">error_handler:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">ErrorHandler</span>

<span class="n">config</span> <span class="ss">:MyApp</span><span class="p">,</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">AferPipeline</span><span class="p">,</span>
  <span class="ss">module:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">error_handler:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">ErrorHandler</span>
</code></pre></div>
</div>
<h3 data-sourcepos="170:1-170:10" id="2-1-3" name="2-1-3">
<a class="anchor" id="登録" name="%E7%99%BB%E9%8C%B2" href="#%E7%99%BB%E9%8C%B2" data-position="2-1-3"><i class="fa fa-link"></i><span class="hidden" data-text="登録"> &gt; 登録</span></a>登録</h3>
<p data-sourcepos="171:1-171:123">登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意します。</p>
<p data-sourcepos="173:1-173:207">このあたりはDevise/Railsとあまり変わりません。他のアクション「新規パスワード発行」「メールアドレス確認」等も同様の構成をとろうと思っています。</p>
<div class="code-block" data-sourcepos="175:1-194:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app_web/controller/registration_controller.ex</span>

<span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">changeset</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">registration_changeset</span><span class="p">(%</span><span class="no">User</span><span class="p">{},</span> <span class="n">user_params</span><span class="p">)</span>

  <span class="k">case</span> <span class="no">Registration</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="no">Repo</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:info</span><span class="p">,</span> <span class="s2">"Your account was created successfully"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="ss">to:</span> <span class="n">page_path</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:home</span><span class="p">))</span>

   <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">changeset</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"Unable to create account: Try again"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">MyAppWeb</span><span class="o">.</span><span class="no">PageView</span><span class="p">,</span> <span class="s2">"home.html"</span><span class="p">,</span> <span class="ss">changeset:</span> <span class="n">changeset</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="196:1-204:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/auth.ex</span>

<span class="k">def</span> <span class="n">login</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%</span><span class="no">User</span><span class="p">{}</span> <span class="o">=</span> <span class="n">user</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">conn</span>
  <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="206:1-213:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/account/registration.ex</span>

<span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="n">repo</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">changeset</span>
  <span class="o">|&gt;</span> <span class="n">repo</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div>
</div>
<h3 data-sourcepos="215:1-215:34" id="2-1-4" name="2-1-4">
<a class="anchor" id="ログイン・ログアウト" name="%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%BB%E3%83%AD%E3%82%B0%E3%82%A2%E3%82%A6%E3%83%88" href="#%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%BB%E3%83%AD%E3%82%B0%E3%82%A2%E3%82%A6%E3%83%88" data-position="2-1-4"><i class="fa fa-link"></i><span class="hidden" data-text="ログイン・ログアウト"> &gt; ログイン・ログアウト</span></a>ログイン・ログアウト</h3>
<p data-sourcepos="216:1-216:108">ログイン・ログアウトはセッション用のサービスとコントローラで実装します。</p>
<div class="code-block" data-sourcepos="218:1-244:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app_web/controller/session_controller.ex</span>

<span class="nv">@doc</span> <span class="s2">"Logged in [POST /login]"</span>
<span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span> <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">})</span> <span class="k">do</span>
  <span class="k">case</span> <span class="no">Session</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="no">Session</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:info</span><span class="p">,</span> <span class="s2">"Logged in successfully"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="ss">to:</span> <span class="n">page_path</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:home</span><span class="p">))</span>

    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_reason</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"Wrong username/password"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="s2">"new.html"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="nv">@doc</span> <span class="s2">"Logged out [DELETE /logout]"</span>
<span class="k">def</span> <span class="n">delete</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">conn</span>
  <span class="o">|&gt;</span> <span class="no">Session</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:info</span><span class="p">,</span> <span class="s2">"Logged out successfully."</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="ss">to:</span> <span class="s2">"/"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="246:1-285:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/session.ex</span>

<span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Session</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Query</span>
  <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>
  <span class="kn">import</span> <span class="no">Comeonin</span><span class="o">.</span><span class="no">Bcrypt</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">checkpw:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">dummy_checkpw:</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Repo</span>
  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Guardian</span>
  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Account</span><span class="o">.</span><span class="no">User</span>

  <span class="k">def</span> <span class="n">login</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%</span><span class="no">User</span><span class="p">{}</span> <span class="o">=</span> <span class="n">user</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">logout</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_out</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">given_password</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">query</span> <span class="o">=</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Query</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">u</span> <span class="ow">in</span> <span class="no">User</span><span class="p">,</span> <span class="ss">where:</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="o">^</span><span class="n">email</span><span class="p">)</span>

    <span class="no">Repo</span><span class="o">.</span><span class="n">one</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">check_password</span><span class="p">(</span><span class="n">given_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">current_user</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">[])</span>

  <span class="k">def</span> <span class="n">logged_in?</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">[])</span>

  <span class="k">defp</span> <span class="n">check_password</span><span class="p">(</span><span class="no">nil</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"Incorrect username or password"</span><span class="p">}</span>

  <span class="k">defp</span> <span class="n">check_password</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">given_password</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="no">Comeonin</span><span class="o">.</span><span class="no">Bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">given_password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">encrypted_password</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">true</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span>
      <span class="no">false</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"Incorrect email or password"</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p data-sourcepos="287:1-287:78">Devise/Railsのビューヘルパーはビューマクロで適用します。</p>
<div class="code-block" data-sourcepos="289:1-298:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app_web.ex</span>

<span class="k">def</span> <span class="n">view</span> <span class="k">do</span>
  <span class="kn">quote</span> <span class="k">do</span>
    <span class="c1"># ..</span>
    <span class="kn">import</span> <span class="no">Okuribi</span><span class="o">.</span><span class="no">Auth</span><span class="o">.</span><span class="no">Session</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">current_user:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">logged_in?:</span> <span class="mi">1</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p data-sourcepos="300:1-300:97">あるいは、<code>put_assigns</code>関数をはやしてコントローラマクロに適用します。</p>
<div class="code-block" data-sourcepos="302:1-318:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app/auth/session.ex</span>

<span class="k">def</span> <span class="n">put_assigns</span><span class="p">(%{</span><span class="ss">private:</span> <span class="p">%{</span><span class="ss">phoenix_action:</span> <span class="n">action</span><span class="p">}}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">current_resource</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

  <span class="n">settings</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">current_resource</span><span class="p">,</span>
      <span class="k">do</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="ss">:sign_in</span><span class="p">][</span><span class="n">action</span><span class="p">]</span> <span class="o">||</span> <span class="p">[],</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="ss">:sign_out</span><span class="p">][</span><span class="n">action</span><span class="p">]</span> <span class="o">||</span> <span class="p">[]</span>

  <span class="n">conn</span>
  <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">,</span> <span class="n">current_resource</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="ss">:page_title</span><span class="p">])</span>
  <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:page_description</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="ss">:page_description</span><span class="p">])</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="code-block" data-sourcepos="320:1-329:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app_web.ex</span>

<span class="k">def</span> <span class="n">controller</span> <span class="k">do</span>
  <span class="kn">quote</span> <span class="k">do</span>
    <span class="c1"># ..</span>
    <span class="kn">import</span> <span class="no">Okuribi</span><span class="o">.</span><span class="no">Auth</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">put_assigns:</span> <span class="mi">2</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p data-sourcepos="331:1-331:205"><code>assigns</code>ひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsの<code>ActionView::Helpers::CaptureHelper#provide</code>の代わりに使えます。</p>
<div class="code-block" data-sourcepos="333:1-351:3">
<div class="code-filename">
<i class="fa fa-file-code-o"></i>elixir</div>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1"># apps/my_app/lib/my_app_web/controller/*_controller.ex</span>

<span class="nv">@page</span> <span class="p">%{</span>
  <span class="ss">sign_in:</span> <span class="p">%{</span>
    <span class="ss">new:</span> <span class="p">%{</span>
      <span class="ss">page_title:</span> <span class="n">dgettext</span><span class="p">(</span><span class="s2">"views"</span><span class="p">,</span> <span class="s2">"pages.home.signed_in.page_title"</span><span class="p">),</span>
      <span class="ss">page_description:</span> <span class="s2">""</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="ss">sign_out:</span> <span class="p">%{</span>
    <span class="ss">new:</span> <span class="p">%{</span>
      <span class="ss">page_title:</span> <span class="n">dgettext</span><span class="p">(</span><span class="s2">"views"</span><span class="p">,</span> <span class="s2">"pages.home.signed_out.page_title"</span><span class="p">),</span>
      <span class="ss">page_description:</span> <span class="s2">""</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">plug</span><span class="p">(</span><span class="ss">:put_assigns</span><span class="p">,</span> <span class="nv">@page</span> <span class="ow">when</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="ss">:home</span><span class="p">])</span>
</code></pre></div>
</div>
<h2 data-sourcepos="353:1-353:12" id="2-2-0" name="2-2-0">
<a class="anchor" id="その他" name="%E3%81%9D%E3%81%AE%E4%BB%96" href="#%E3%81%9D%E3%81%AE%E4%BB%96" data-position="2-2-0"><i class="fa fa-link"></i><span class="hidden" data-text="その他"> &gt; その他</span></a>その他</h2>
<p data-sourcepos="354:1-354:120">RailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道に行っていきます。</p>
<ul data-sourcepos="356:1-374:0">
<li data-sourcepos="356:1-364:48">Rails
<ul data-sourcepos="357:5-364:48">
<li data-sourcepos="357:5-357:76"><code>ActionView::Helpers::FormHelper#form_for(record, options={}, &amp;block)</code></li>
<li data-sourcepos="358:5-358:83"><code>ActionView::Helpers::FormHelper#text_field(object_name, method, options={})</code></li>
<li data-sourcepos="359:5-359:83"><code>ActionView::Helpers::FormHelper#file_field(object_name, method, options={})</code></li>
<li data-sourcepos="360:5-360:85"><code>ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})</code></li>
<li data-sourcepos="361:5-361:87"><code>ActionView::Helpers::FormHelper#password_field(object_name, method, options={})</code></li>
<li data-sourcepos="362:5-362:96"><code>ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})</code></li>
<li data-sourcepos="363:5-363:70"><code>ActionView::Helpers::FormBuilder#submit(value=nil, options={})</code></li>
<li data-sourcepos="364:5-364:48"><code>ActionView::Helpers::TranslationHelper#t</code></li>
</ul>
</li>
<li data-sourcepos="365:1-374:0">Phoenix
<ul data-sourcepos="366:5-374:0">
<li data-sourcepos="366:5-366:73"><code>Phoenix.HTML.Form.form_for(form_data, action, options \\ [], fun)</code></li>
<li data-sourcepos="367:5-367:61"><code>Phoenix.HTML.Form.text_input(form, field, opts \\ [])</code></li>
<li data-sourcepos="368:5-368:61"><code>Phoenix.HTML.Form.file_input(form, field, opts \\ [])</code></li>
<li data-sourcepos="369:5-369:63"><code>Phoenix.HTML.Form.hidden_input(form, field, opts \\ [])</code></li>
<li data-sourcepos="370:5-370:65"><code>Phoenix.HTML.Form.password_input(form, field, opts \\ [])</code></li>
<li data-sourcepos="371:5-371:70"><code>Phoenix.HTML.Form.radio_button(form, field, value, opts \\ [])</code></li>
<li data-sourcepos="372:5-372:50"><code>Phoenix.HTML.Form.submit(opts, opts \\ [])</code></li>
<li data-sourcepos="373:5-374:0"><code>Gettext.dgettext(backend, domain, msgid, bindings \\ %{})</code></li>
</ul>
</li>
</ul>
<h1 data-sourcepos="375:1-375:8" id="3-0-0" name="3-0-0">
<a class="anchor" id="WRAPUP" name="WRAPUP" href="#WRAPUP" data-position="3-0-0"><i class="fa fa-link"></i><span class="hidden" data-text="WRAPUP"> &gt; WRAPUP</span></a>WRAPUP</h1>
<p data-sourcepos="376:1-376:177">前回もそうですが、コードのマイグレーションはまあ地味な作業ですよね。とまれ、認証機能を実装できたので良しとしましょう。</p>
</div><style data-emotion-css="k022ln">.css-k022ln > .heading{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:4.375rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-k022ln > .heading > .avatar{height:50px;width:50;margin-right:8px;border-radius:21px;}.css-k022ln > .heading > .description > a{color:#58463C;}.css-k022ln > .heading > .description > a:hover{color:#80695F;}</style><div class="css-k022ln ewgr1al0"><div class="heading"><img class="avatar" src="https://pbs.twimg.com/profile_images/1342772423859392512/fMR9l4Sv_400x400.jpg" alt="nabinno"/><div class="description">Emacsianでアート好き、ランニング好きな@nabinnoが書いています<br/><a href="https://utagaki.com/nabinno" target="_blank" rel="noopener noreferrer">Utagaki</a> / <a href="https://github.com/nabinno" target="_blank" rel="noopener noreferrer">GitHub</a> / <a href="https://twitter.com/nabinno" target="_blank" rel="noopener noreferrer">Twitter</a> / <a href="https://linkedin.com/in/nabinno" target="_blank" rel="noopener noreferrer">LinkedIn</a> / <a href="https://www.wantedly.com/companies/nextinnovation" target="_blank" rel="noopener noreferrer">ネクイノ</a></div></div></div></div><style data-emotion-css="1r17nfx">.css-1r17nfx{box-shadow:none;color:inherit;display:block;-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-1r17nfx" href="/posts/119"><style data-emotion-css="xbv8og">.css-xbv8og{height:100%;background-color:white;border-radius:8px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;border-bottom:1px solid #eee;padding:20px 12px;}@media (min-width:624px){.css-xbv8og{padding-left:0;padding-right:0;}}.css-xbv8og:hover .title{color:#80695F;}</style><div class="css-xbv8og"><style data-emotion-css="19idom">.css-19idom{margin-bottom:8px;}</style><div class="css-19idom eff00rj1"><style data-emotion-css="lhqszh">.css-lhqszh{line-height:1.4;background-color:white;font-weight:600;display:inline-block;font-size:12px;background-image:linear-gradient( 45deg,#58463C 0px,#80695F 100% );color:white;text-transform:capitalize;-webkit-letter-spacing:0.2px;-moz-letter-spacing:0.2px;-ms-letter-spacing:0.2px;letter-spacing:0.2px;border-style:solid;border-color:rgb(221,221,221);border-image:initial;margin:0px 8px 4px 0px;padding:4px 6px;border-radius:3px;border-width:0px;}</style><div class="css-lhqszh eff00rj0">blog/backend</div><style data-emotion-css="jsyva2">.css-jsyva2{margin-bottom:1px;font-size:18px;line-height:1.48;color:#1a202c;}</style><h3 class="title css-jsyva2 eff00rj2">踏み台をSSM Session ManagerとAWS SSOで実現する</h3><style data-emotion-css="1p4gbp4">.css-1p4gbp4{color:#1a202c;opacity:0.6;font-size:14px;line-height:1.6;word-break:break-all;overflow-y:hidden;max-height:67.2px;}</style><p class="css-1p4gbp4 eff00rj3">踏み台のユーザーが増えてきたため公開鍵管理や監視と運用負荷が上がってきました。オペミスが発生しやすい上 監査的な意味で無視できない状況になってきたので重い腰を上げることにしました。   &gt; PROBL</p></div><style data-emotion-css="8xl60i">.css-8xl60i{margin-top:auto;}</style><div class="css-8xl60i eff00rj4"><style data-emotion-css="2qp2g2">.css-2qp2g2{font-size:12px;font-weight:700;color:#666;}.css-2qp2g2:after{content:' ';width:1px;height:100%;background-color:#ddd;display:inline-block;}</style><time class="css-2qp2g2 eff00rj5">2021/11/21</time><style data-emotion-css="om1c75">.css-om1c75{font-size:12px;margin-left:4px;}.css-om1c75:before{content:'#';}</style><span class="css-om1c75 eff00rj6">SessionManager</span><span class="css-om1c75 eff00rj6">AWSSSO</span></div></div></a><a class="css-1r17nfx" href="/posts/68"><div class="css-xbv8og"><div class="css-19idom eff00rj1"><div class="css-lhqszh eff00rj0">blog/organization</div><h3 class="title css-jsyva2 eff00rj2">飲み会に参加するための機材</h3><p class="css-1p4gbp4 eff00rj3">以前チーム内でリモート懇親会を画策したのですが、食材の調達や経費精算など手間が多すぎて断念しました。ただ、その言い訳は実は本質的ではなく、実際に後ろ向きにさせていたのは「しゃべりながら食べるのがつらい</p></div><div class="css-8xl60i eff00rj4"><time class="css-2qp2g2 eff00rj5">2021/01/30</time><span class="css-om1c75 eff00rj6">drinkup</span><span class="css-om1c75 eff00rj6">team-building</span></div></div></a><a class="css-1r17nfx" href="/posts/93"><div class="css-xbv8og"><div class="css-19idom eff00rj1"><div class="css-lhqszh eff00rj0">blog/backend</div><h3 class="title css-jsyva2 eff00rj2">AWS CloudTrail用のコスパの良いSIEMを探す</h3><p class="css-1p4gbp4 eff00rj3">IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。   </p></div><div class="css-8xl60i eff00rj4"><time class="css-2qp2g2 eff00rj5">2021/08/15</time><span class="css-om1c75 eff00rj6">siem</span><span class="css-om1c75 eff00rj6">aws-cloudtrail</span><span class="css-om1c75 eff00rj6">azure-sentinel</span><span class="css-om1c75 eff00rj6">sumo-logic</span></div></div></a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-314558-24', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/60";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c2af0f9bcfb46c63126b.js"],"app":["/app-1609d7d465ccd6a5a330.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-7a73fce44527957a28a5.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-557e62df0f80429a7567.js"],"component---src-templates-posts-tsx":["/component---src-templates-posts-tsx-01adf45b9f8003118fcd.js"]};/*]]>*/</script><script src="/polyfill-c2af0f9bcfb46c63126b.js" nomodule=""></script><script src="/component---src-templates-post-tsx-557e62df0f80429a7567.js" async=""></script><script src="/component---src-templates-posts-tsx-01adf45b9f8003118fcd.js" async=""></script><script src="/commons-d1e204551af284801370.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-1609d7d465ccd6a5a330.js" async=""></script><script src="/framework-dbb498007a7447f28d8e.js" async=""></script><script src="/webpack-runtime-7a7e64c679eaacb6bc0d.js" async=""></script></body></html>