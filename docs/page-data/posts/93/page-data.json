{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/93","result":{"data":{"esaPost":{"number":93,"relative_category":"blog/backend","fields":{"title":"AWS CloudTrail用のコスパの良いSIEMを探す","excerpt":"IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。   > PROBLEMPROBLEM \n\n- AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい NewRelicのように人のコストをかけずに管理したい \n- 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい\n- 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい NewRelicのように人のコストをかけずに管理したい \n- NewRelicのように人のコストをかけずに管理したい  > SOLUTIONSOLUTION \n\nと言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。  > Azure SentinelAzure Sentinel  > 料金料金 \n\n- Azure Sentinel の価格 | Microsoft Azure\n- 価格 - Azure Monitor | Microsoft Azure  > SIEMからCloudTrailへの接続方法SIEMからCloudTrailへの接続方法 \n\n1. 下記設定でLog Analyticsワークスペースを作成 サブスクリプション 無料試用版 リソース グループ production 名前 prod-sentinel 地域 東日本 \n2. サブスクリプション 無料試用版\n3. リソース グループ production\n4. 名前 prod-sentinel\n5. 地域 東日本\n6. [ワークスペースprod-sentinel - データコネクタ] にて [アマゾンウェブサービス] コネクタページを開く\n7. [AWSアカウント - IAM - ロール] にて下記設定で [別のAWSアカウント] を作成 アカウントID {Microsoft account ID} オプション 外部IDが必要 をチェック 外部ID {外部ID (ワークスペースID)} パーミッションポリシーを適用 AWSCloudTrailReadOnlyAccess ロール名 AzureSentinel ※ Cf. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO \n8. アカウントID {Microsoft account ID}\n9. オプション 外部IDが必要 をチェック 外部ID {外部ID (ワークスペースID)} \n10. 外部IDが必要 をチェック\n11. 外部ID {外部ID (ワークスペースID)}\n12. パーミッションポリシーを適用 AWSCloudTrailReadOnlyAccess\n13. ロール名 AzureSentinel\n14. ※ Cf. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO \n15. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs\n16. アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs\n17. Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO  > SIEM機能 (AWS CloudTrail)SIEM機能 (AWS CloudTrail) \n\n- デフォルト監視対象 時間経過に伴うイベントアラート 悪意ある可能性があるイベント 最近のインシデント データソースの異常 \n- 時間経過に伴うイベントアラート\n- 悪意ある可能性があるイベント\n- 最近のインシデント\n- データソースの異常\n- ログクエリ Audit Network Security \n- Audit\n- Network\n- Security\n- 脅威管理 インシデント ブック ... 簡易な分析情報を提供 AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。 AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。 ハンティング ... 脅威判定となるログクエリを提供 Changes made to AWS IAM policy Tracking Privileged Account Rare Activity Exploit and Pentest Framework User Agent IAM Privilege Escalation by Instance Profile attachment Privileged role attached to Instance Suspicious credential token access of valid IAM Roles Unused or Unsupported Cloud Regions ノートブック ... Jupyter Notebookによる分析を提供 \n- インシデント\n- ブック ... 簡易な分析情報を提供 AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。 AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。 \n- AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。\n- AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。\n- ハンティング ... 脅威判定となるログクエリを提供 Changes made to AWS IAM policy Tracking Privileged Account Rare Activity Exploit and Pentest Framework User Agent IAM Privilege Escalation by Instance Profile attachment Privileged role attached to Instance Suspicious credential token access of valid IAM Roles Unused or Unsupported Cloud Regions \n- Changes made to AWS IAM policy\n- Tracking Privileged Account Rare Activity\n- Exploit and Pentest Framework User Agent\n- IAM Privilege Escalation by Instance Profile attachment\n- Privileged role attached to Instance\n- Suspicious credential token access of valid IAM Roles\n- Unused or Unsupported Cloud Regions\n- ノートブック ... Jupyter Notebookによる分析を提供\n- ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能 Trend Micro Apex One McAfee Network Security Platform \n- Trend Micro Apex One\n- McAfee Network Security Platform  > Sumo LogicSumo Logic  > 料金料金 \n\n- Sumo Logic 料金表  > SIEMからCloudTrailへの接続方法SIEMからCloudTrailへの接続方法 \n\n1. [AWSアカウントSecurity - S3] にてバケット cloudtrail-accumulativelogs-{account-id} を下記設定にて作成 パブリックアクセスをすべてブロック オフ バケットポリシー json{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSCloudTrailAclCheck20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\" }, { \"Sid\": \"AWSCloudTrailWrite20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } \n2. パブリックアクセスをすべてブロック オフ\n3. バケットポリシー json{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSCloudTrailAclCheck20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\" }, { \"Sid\": \"AWSCloudTrailWrite20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } \n4. [親AWSアカウント - KMS] にて下記設定でKSMを作成 キーのタイプ 対称 キーマテリアルオリジン KMS リージョンごと 単一リージョン エイリアス名 cloudtrail-kms キーポリシー json{ \"Version\": \"2012-10-17\", \"Id\": \"Key policy created by CloudTrail\", \"Statement\": [ { \"Sid\": \"Enable IAM User Permissions\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:*\", \"Resource\": \"*\" }, { \"Sid\": \"Allow CloudTrail to encrypt logs\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:GenerateDataKey*\", \"Resource\": \"*\", \"Condition\": { \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow CloudTrail to describe key\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:DescribeKey\", \"Resource\": \"*\" }, { \"Sid\": \"Allow principals in the account to decrypt log files\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow alias creation during setup\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:CreateAlias\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\", \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\" } } }, { \"Sid\": \"Enable cross account log decryption\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } } ] } \n5. キーのタイプ 対称\n6. キーマテリアルオリジン KMS\n7. リージョンごと 単一リージョン\n8. エイリアス名 cloudtrail-kms\n9. キーポリシー json{ \"Version\": \"2012-10-17\", \"Id\": \"Key policy created by CloudTrail\", \"Statement\": [ { \"Sid\": \"Enable IAM User Permissions\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:*\", \"Resource\": \"*\" }, { \"Sid\": \"Allow CloudTrail to encrypt logs\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:GenerateDataKey*\", \"Resource\": \"*\", \"Condition\": { \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow CloudTrail to describe key\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:DescribeKey\", \"Resource\": \"*\" }, { \"Sid\": \"Allow principals in the account to decrypt log files\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow alias creation during setup\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:CreateAlias\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\", \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\" } } }, { \"Sid\": \"Enable cross account log decryption\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } } ] } \n10. [親AWSアカウント - CloudTrail] にて下記設定で証跡を作成 全般的な詳細 証跡名 cloudtrail-logs 組織に証跡を適用 はい ストレージの場所 既存のS3バケットを使用する 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id} ログファイルのSSE-KMS暗号化 有効 カスタマー管理のAWS KMSキー 新規 AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id} ログファイルの検証 有効 管理イベント APIアクティビティ すべて \n11. 全般的な詳細 証跡名 cloudtrail-logs 組織に証跡を適用 はい ストレージの場所 既存のS3バケットを使用する 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id} ログファイルのSSE-KMS暗号化 有効 カスタマー管理のAWS KMSキー 新規 AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id} ログファイルの検証 有効 \n12. 証跡名 cloudtrail-logs\n13. 組織に証跡を適用 はい\n14. ストレージの場所 既存のS3バケットを使用する\n15. 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id}\n16. ログファイルのSSE-KMS暗号化 有効\n17. カスタマー管理のAWS KMSキー 新規\n18. AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id}\n19. ログファイルの検証 有効\n20. 管理イベント APIアクティビティ すべて \n21. APIアクティビティ すべて\n22. [Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail] にて下記設定でCloudTrailデータタイプを作成 Source Category aws/cloudtrail S3 Bucket S3 Bucket Name cloudtrail-accumulativelogs-{account-id} Path Expression AWSLogs/{organization-id}/* S3 Region Asia Pacific (Tokyo) How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n23. Source Category aws/cloudtrail\n24. S3 Bucket S3 Bucket Name cloudtrail-accumulativelogs-{account-id} Path Expression AWSLogs/{organization-id}/* S3 Region Asia Pacific (Tokyo) How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n25. S3 Bucket Name cloudtrail-accumulativelogs-{account-id}\n26. Path Expression AWSLogs/{organization-id}/*\n27. S3 Region Asia Pacific (Tokyo)\n28. How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n29. 指定されたCFnテンプレートでIAMロールを作成  > SIEM機能 (AWS CloudTrail)SIEM機能 (AWS CloudTrail) \n\nデフォルト監視対象 \n\n- Console Logins Geo Location of All Users Login Events By User Logins Over Time Logins from Multiple IP Logins from Outside the USA Outlier - Success Login Outlier - Failed Login Login Results - One Day Time Comparison Logins without MFA \n- Geo Location of All Users\n- Login Events By User\n- Logins Over Time\n- Logins from Multiple IP\n- Logins from Outside the USA\n- Outlier - Success Login\n- Outlier - Failed Login\n- Login Results - One Day Time Comparison\n- Logins without MFA\n- Network and Security Authorization Failures from All Countries Network and Security Events Over Time Authorization Failures Over Time Network ACL with All Allowed Ingress/Egress Recent Authorization Failures Recent Security Group and Network ACL Changes Created and Deleted Network and Security Events Short Lived Critical Operations \n- Authorization Failures from All Countries\n- Network and Security Events Over Time\n- Authorization Failures Over Time\n- Network ACL with All Allowed Ingress/Egress\n- Recent Authorization Failures\n- Recent Security Group and Network ACL Changes\n- Created and Deleted Network and Security Events\n- Short Lived Critical Operations\n- Operations Action Events Requested AWS Services Over Time Events by AWS Region Recent Elastic IP Address Operations Created Resources Over Time Deleted Resources Over Time \n- Action Events\n- Requested AWS Services Over Time\n- Events by AWS Region\n- Recent Elastic IP Address Operations\n- Created Resources Over Time\n- Deleted Resources Over Time\n- Overview Geo Location of All Users Created Resources Deleted Resources Over Time Top 10 Users Failed Logins Created and Deleted Network and Security Events \n- Geo Location of All Users\n- Created Resources\n- Deleted Resources Over Time\n- Top 10 Users\n- Failed Logins\n- Created and Deleted Network and Security Events\n- S3 Public Objects and Buckets New Public Objects New Public Object by Object-Bucket New Public Objects Table Public Buckets Public Buckets Table Modified Public Objects Modified Public Objects by Object-Buket Modified Public Objects Table \n- New Public Objects\n- New Public Object by Object-Bucket\n- New Public Objects Table\n- Public Buckets\n- Public Buckets Table\n- Modified Public Objects\n- Modified Public Objects by Object-Buket\n- Modified Public Objects Table\n- User Monitoring Geo Location of All Users Top 10 Users Launched and Terminated Instances by User Administrative Activities Over Time Top 10 Activities by Administrative User Recent Activity by Administrative Users \n- Geo Location of All Users\n- Top 10 Users\n- Launched and Terminated Instances by User\n- Administrative Activities Over Time\n- Top 10 Activities by Administrative User\n- Recent Activity by Administrative Users  > 総評総評  > 使用コスト使用コスト \n\n初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。    ログ取込量/日 Azure Sentinel月額 Sumo Logic月額     100MB 2,396 JPY 0 USD   500MB 11,978 JPY 0 USD   3GB 71,870 JPY 332 USD    \n\n※ Azure Sentinelの内訳は「 ((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB 」  > 導入コスト導入コスト \n\n一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。  > SIEM機能SIEM機能 \n\nAzure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。 \n\nまた、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。  > WRAPUPWRAPUP \n\nメインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png"},"wip":false,"body_md":"IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。\r\n\r\n<img width=\"681\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png\">\r\n\r\n# PROBLEM\r\n- AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない\r\n    - 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい\r\n    - 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい\r\n        - NewRelicのように人のコストをかけずに管理したい\r\n\r\n# SOLUTION\r\nと言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。\r\n\r\n## Azure Sentinel\r\n### 料金\r\n- [Azure Sentinel の価格 | Microsoft Azure](https://azure.microsoft.com/ja-jp/pricing/details/azure-sentinel/)\r\n- [価格 - Azure Monitor | Microsoft Azure](https://azure.microsoft.com/ja-jp/pricing/details/monitor/)\r\n\r\n### SIEMからCloudTrailへの接続方法\r\n1. 下記設定でLog Analyticsワークスペースを作成\r\n    - サブスクリプション `無料試用版`\r\n    - リソース グループ `production`\r\n    - 名前 `prod-sentinel`\r\n    - 地域 `東日本`\r\n1. `[ワークスペースprod-sentinel - データコネクタ]` にて `[アマゾンウェブサービス]` コネクタページを開く\r\n1. `[AWSアカウント - IAM - ロール]` にて下記設定で `[別のAWSアカウント]` を作成\r\n    - アカウントID `{Microsoft account ID}`\r\n    - オプション\r\n        - `外部IDが必要` をチェック\r\n        - 外部ID `{外部ID (ワークスペースID)}`\r\n    - パーミッションポリシーを適用 `AWSCloudTrailReadOnlyAccess`\r\n    - ロール名 `AzureSentinel`\r\n    - ※ Cf.\r\n        - [AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs](https://docs.microsoft.com/ja-jp/azure/sentinel/connect-aws)\r\n        - [アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs](https://docs.microsoft.com/ja-jp/azure/architecture/reference-architectures/aws/aws-azure-security-solutions)\r\n        - [Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO](https://dev.classmethod.jp/articles/security-jaws-21-report/)\r\n\r\n### SIEM機能 (AWS CloudTrail)\r\n- デフォルト監視対象\r\n    - 時間経過に伴うイベントアラート\r\n    - 悪意ある可能性があるイベント\r\n    - 最近のインシデント\r\n    - データソースの異常\r\n- ログクエリ\r\n    - Audit\r\n    - Network\r\n    - Security\r\n- 脅威管理\r\n    - インシデント\r\n    - ブック ... 簡易な分析情報を提供\r\n        - AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。\r\n        - AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。\r\n    - ハンティング ... 脅威判定となるログクエリを提供\r\n        - Changes made to AWS IAM policy\r\n        - Tracking Privileged Account Rare Activity\r\n        - Exploit and Pentest Framework User Agent\r\n        - IAM Privilege Escalation by Instance Profile attachment\r\n        - Privileged role attached to Instance\r\n        - Suspicious credential token access of valid IAM Roles\r\n        - Unused or Unsupported Cloud Regions\r\n    - ノートブック ... Jupyter Notebookによる分析を提供\r\n- ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能\r\n    - Trend Micro Apex One\r\n    - McAfee Network Security Platform\r\n\r\n## Sumo Logic\r\n### 料金\r\n- [Sumo Logic 料金表](https://www.sumologic.jp/pricing/jp/)\r\n\r\n### SIEMからCloudTrailへの接続方法\r\n1. `[AWSアカウントSecurity - S3]` にてバケット `cloudtrail-accumulativelogs-{account-id}` を下記設定にて作成\r\n    - パブリックアクセスをすべてブロック `オフ`\r\n    - <details><summary>バケットポリシー</summary>\r\n\r\n        ```json\r\n        {\r\n            \"Version\": \"2012-10-17\",\r\n            \"Statement\": [\r\n                {\r\n                    \"Sid\": \"AWSCloudTrailAclCheck20150319\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"s3:GetBucketAcl\",\r\n                    \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\"\r\n                },\r\n                {\r\n                    \"Sid\": \"AWSCloudTrailWrite20150319\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"s3:PutObject\",\r\n                    \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"s3:x-amz-acl\": \"bucket-owner-full-control\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n        ```\r\n        </details>\r\n1. `[親AWSアカウント - KMS]` にて下記設定でKSMを作成\r\n    - キーのタイプ `対称`\r\n    - キーマテリアルオリジン `KMS`\r\n    - リージョンごと `単一リージョン`\r\n    - エイリアス名 `cloudtrail-kms`\r\n    - <details><summary>キーポリシー</summary>\r\n\r\n        ```json\r\n        {\r\n            \"Version\": \"2012-10-17\",\r\n            \"Id\": \"Key policy created by CloudTrail\",\r\n            \"Statement\": [\r\n                {\r\n                    \"Sid\": \"Enable IAM User Permissions\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": \"kms:*\",\r\n                    \"Resource\": \"*\"\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow CloudTrail to encrypt logs\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"kms:GenerateDataKey*\",\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringLike\": {\r\n                            \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow CloudTrail to describe key\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"kms:DescribeKey\",\r\n                    \"Resource\": \"*\"\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow principals in the account to decrypt log files\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": [\r\n                        \"kms:Decrypt\",\r\n                        \"kms:ReEncryptFrom\"\r\n                    ],\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"kms:CallerAccount\": \"{account-id}\"\r\n                        },\r\n                        \"StringLike\": {\r\n                            \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow alias creation during setup\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": \"kms:CreateAlias\",\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"kms:CallerAccount\": \"{account-id}\",\r\n                            \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"Sid\": \"Enable cross account log decryption\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": [\r\n                        \"kms:Decrypt\",\r\n                        \"kms:ReEncryptFrom\"\r\n                    ],\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"kms:CallerAccount\": \"{account-id}\"\r\n                        },\r\n                        \"StringLike\": {\r\n                            \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n        ```\r\n        </details>\r\n1. `[親AWSアカウント - CloudTrail]` にて下記設定で証跡を作成\r\n    - 全般的な詳細\r\n        - 証跡名 `cloudtrail-logs`\r\n        - 組織に証跡を適用 `はい`\r\n        - ストレージの場所 `既存のS3バケットを使用する`\r\n        - 証跡ログバケット名 `cloudtrail-accumulativelogs-{account-id}`\r\n        - ログファイルのSSE-KMS暗号化 `有効`\r\n        - カスタマー管理のAWS KMSキー `新規`\r\n        - AWS KMSエイリアス `arn:aws:kms:{region}:{account-id}:key/{kms-id}`\r\n        - ログファイルの検証 `有効`\r\n    - 管理イベント\r\n        - APIアクティビティ `すべて`\r\n1. `[Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail]` にて下記設定でCloudTrailデータタイプを作成\r\n    - Source Category `aws/cloudtrail`\r\n    - S3 Bucket\r\n        - S3 Bucket Name `cloudtrail-accumulativelogs-{account-id}`\r\n        - Path Expression `AWSLogs/{organization-id}/*`\r\n        - S3 Region `Asia Pacific (Tokyo)`\r\n        - How do you want the user to access the S3 Bucket? `Role-based access`\r\n            - 指定されたCFnテンプレートでIAMロールを作成\r\n\r\n### SIEM機能 (AWS CloudTrail)\r\nデフォルト監視対象\r\n- Console Logins\r\n    - Geo Location of All Users\r\n    - Login Events By User\r\n    - Logins Over Time\r\n    - Logins from Multiple IP\r\n    - Logins from Outside the USA\r\n    - Outlier - Success Login\r\n    - Outlier - Failed Login\r\n    - Login Results - One Day Time Comparison\r\n    - Logins without MFA\r\n- Network and Security\r\n    - Authorization Failures from All Countries\r\n    - Network and Security Events Over Time\r\n    - Authorization Failures Over Time\r\n    - Network ACL with All Allowed Ingress/Egress\r\n    - Recent Authorization Failures\r\n    - Recent Security Group and Network ACL Changes\r\n    - Created and Deleted Network  and Security Events\r\n    - Short Lived Critical Operations\r\n- Operations\r\n    - Action Events\r\n    - Requested AWS Services Over Time\r\n    - Events by AWS Region\r\n    - Recent Elastic IP Address Operations\r\n    - Created Resources Over Time\r\n    - Deleted Resources Over Time\r\n- Overview\r\n    - Geo Location of All Users\r\n    - Created Resources\r\n    - Deleted Resources Over Time\r\n    - Top 10 Users\r\n    - Failed Logins\r\n    - Created and Deleted Network and Security Events\r\n- S3 Public Objects and Buckets\r\n    - New Public Objects\r\n    - New Public Object by Object-Bucket\r\n    - New Public Objects Table\r\n    - Public Buckets\r\n    - Public Buckets Table\r\n    - Modified Public Objects\r\n    - Modified Public Objects by Object-Buket\r\n    - Modified Public Objects Table\r\n- User Monitoring\r\n    - Geo Location of All Users\r\n    - Top 10 Users\r\n    - Launched and Terminated Instances by User\r\n    - Administrative Activities Over Time\r\n    - Top 10 Activities by Administrative User\r\n    - Recent Activity by Administrative Users\r\n\r\n# 総評\r\n## 使用コスト\r\n初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。\r\n\r\n| ログ取込量/日 | Azure Sentinel月額 | Sumo Logic月額 |\r\n| --- | --- | --- |\r\n| 100MB | 2,396 JPY | 0 USD |\r\n| 500MB | 11,978 JPY | 0 USD |\r\n| 3GB | 71,870 JPY | 332 USD |\r\n\r\n※ Azure Sentinelの内訳は「 `((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB` 」\r\n\r\n## 導入コスト\r\n一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。\r\n\r\n## SIEM機能\r\nAzure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。\r\n\r\nまた、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。\r\n\r\n# WRAPUP\r\nメインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。","body_html":"<p data-sourcepos=\"1:1-1:243\">IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。</p>\n<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"681\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png\"></a>\n<h1 data-sourcepos=\"5:1-5:9\" id=\"1-0-0\" name=\"1-0-0\"><a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"6:1-10:0\">\n<li data-sourcepos=\"6:1-10:0\">AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない\n<ul data-sourcepos=\"7:5-10:0\">\n<li data-sourcepos=\"7:5-7:99\">可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい</li>\n<li data-sourcepos=\"8:5-10:0\">可能ならCloudTrail以外のIaaSリソースを監視対象にしたい\n<ul data-sourcepos=\"9:9-10:0\">\n<li data-sourcepos=\"9:9-10:0\">NewRelicのように人のコストをかけずに管理したい</li>\n</ul></li>\n</ul></li>\n</ul>\n<h1 data-sourcepos=\"11:1-11:10\" id=\"2-0-0\" name=\"2-0-0\"><a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"12:1-12:102\">と言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。</p>\n<h2 data-sourcepos=\"14:1-14:17\" id=\"2-1-0\" name=\"2-1-0\"><a class=\"anchor\" id=\"Azure Sentinel\" name=\"Azure Sentinel\" href=\"#Azure Sentinel\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Azure Sentinel\"> &gt; Azure Sentinel</span></a>Azure Sentinel</h2>\n<h3 data-sourcepos=\"15:1-15:10\" id=\"2-1-1\" name=\"2-1-1\"><a class=\"anchor\" id=\"料金\" name=\"料金\" href=\"#料金\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"料金\"> &gt; 料金</span></a>料金</h3>\n<ul data-sourcepos=\"16:1-18:0\">\n<li data-sourcepos=\"16:1-16:113\"><a href=\"https://azure.microsoft.com/ja-jp/pricing/details/azure-sentinel/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Sentinel の価格 | Microsoft Azure</a></li>\n<li data-sourcepos=\"17:1-18:0\"><a href=\"https://azure.microsoft.com/ja-jp/pricing/details/monitor/\" target=\"_blank\" rel=\"noopener noreferrer\">価格 - Azure Monitor | Microsoft Azure</a></li>\n</ul>\n<h3 data-sourcepos=\"19:1-19:42\" id=\"2-1-2\" name=\"2-1-2\"><a class=\"anchor\" id=\"SIEMからCloudTrailへの接続方法\" name=\"SIEMからCloudTrailへの接続方法\" href=\"#SIEMからCloudTrailへの接続方法\" data-position=\"2-1-2\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEMからCloudTrailへの接続方法\"> &gt; SIEMからCloudTrailへの接続方法</span></a>SIEMからCloudTrailへの接続方法</h3>\n<ol data-sourcepos=\"20:1-37:0\">\n<li data-sourcepos=\"20:1-24:24\">下記設定でLog Analyticsワークスペースを作成\n<ul data-sourcepos=\"21:5-24:24\">\n<li data-sourcepos=\"21:5-21:51\">サブスクリプション <code>無料試用版</code></li>\n<li data-sourcepos=\"22:5-22:44\">リソース グループ <code>production</code></li>\n<li data-sourcepos=\"23:5-23:28\">名前 <code>prod-sentinel</code></li>\n<li data-sourcepos=\"24:5-24:24\">地域 <code>東日本</code></li>\n</ul>\n</li>\n<li data-sourcepos=\"25:1-25:141\"><code>[ワークスペースprod-sentinel - データコネクタ]</code> にて <code>[アマゾンウェブサービス]</code> コネクタページを開く</li>\n<li data-sourcepos=\"26:1-37:0\"><code>[AWSアカウント - IAM - ロール]</code> にて下記設定で <code>[別のAWSアカウント]</code> を作成\n<ul data-sourcepos=\"27:5-37:0\">\n<li data-sourcepos=\"27:5-27:48\">アカウントID <code>{Microsoft account ID}</code></li>\n<li data-sourcepos=\"28:5-30:57\">オプション\n<ul data-sourcepos=\"29:9-30:57\">\n<li data-sourcepos=\"29:9-29:45\"><code>外部IDが必要</code> をチェック</li>\n<li data-sourcepos=\"30:9-30:57\">外部ID <code>{外部ID (ワークスペースID)}</code></li>\n</ul></li>\n<li data-sourcepos=\"31:5-31:78\">パーミッションポリシーを適用 <code>AWSCloudTrailReadOnlyAccess</code></li>\n<li data-sourcepos=\"32:5-32:34\">ロール名 <code>AzureSentinel</code></li>\n<li data-sourcepos=\"33:5-37:0\">※ Cf.\n<ul data-sourcepos=\"34:9-37:0\">\n<li data-sourcepos=\"34:9-34:139\"><a href=\"https://docs.microsoft.com/ja-jp/azure/sentinel/connect-aws\" target=\"_blank\" rel=\"noopener noreferrer\">AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs</a></li>\n<li data-sourcepos=\"35:9-35:240\"><a href=\"https://docs.microsoft.com/ja-jp/azure/architecture/reference-architectures/aws/aws-azure-security-solutions\" target=\"_blank\" rel=\"noopener noreferrer\">アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs</a></li>\n<li data-sourcepos=\"36:9-37:0\"><a href=\"https://dev.classmethod.jp/articles/security-jaws-21-report/\" target=\"_blank\" rel=\"noopener noreferrer\">Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO</a></li>\n</ul></li>\n</ul>\n</li>\n</ol>\n<h3 data-sourcepos=\"38:1-38:31\" id=\"2-1-3\" name=\"2-1-3\"><a class=\"anchor\" id=\"SIEM機能 (AWS CloudTrail)\" name=\"SIEM機能 (AWS CloudTrail)\" href=\"#SIEM機能 (AWS CloudTrail)\" data-position=\"2-1-3\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEM機能 (AWS CloudTrail)\"> &gt; SIEM機能 (AWS CloudTrail)</span></a>SIEM機能 (AWS CloudTrail)</h3>\n<ul data-sourcepos=\"39:1-65:0\">\n<li data-sourcepos=\"39:1-43:33\">デフォルト監視対象\n<ul data-sourcepos=\"40:5-43:33\">\n<li data-sourcepos=\"40:5-40:51\">時間経過に伴うイベントアラート</li>\n<li data-sourcepos=\"41:5-41:48\">悪意ある可能性があるイベント</li>\n<li data-sourcepos=\"42:5-42:33\">最近のインシデント</li>\n<li data-sourcepos=\"43:5-43:33\">データソースの異常</li>\n</ul></li>\n<li data-sourcepos=\"44:1-47:14\">ログクエリ\n<ul data-sourcepos=\"45:5-47:14\">\n<li data-sourcepos=\"45:5-45:11\">Audit</li>\n<li data-sourcepos=\"46:5-46:13\">Network</li>\n<li data-sourcepos=\"47:5-47:14\">Security</li>\n</ul></li>\n<li data-sourcepos=\"48:1-61:69\">脅威管理\n<ul data-sourcepos=\"49:5-61:69\">\n<li data-sourcepos=\"49:5-49:24\">インシデント</li>\n<li data-sourcepos=\"50:5-52:364\">ブック ... 簡易な分析情報を提供\n<ul data-sourcepos=\"51:9-52:364\">\n<li data-sourcepos=\"51:9-51:263\">AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。</li>\n<li data-sourcepos=\"52:9-52:364\">AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。</li>\n</ul></li>\n<li data-sourcepos=\"53:5-60:45\">ハンティング ... 脅威判定となるログクエリを提供\n<ul data-sourcepos=\"54:9-60:45\">\n<li data-sourcepos=\"54:9-54:40\">Changes made to AWS IAM policy</li>\n<li data-sourcepos=\"55:9-55:51\">Tracking Privileged Account Rare Activity</li>\n<li data-sourcepos=\"56:9-56:50\">Exploit and Pentest Framework User Agent</li>\n<li data-sourcepos=\"57:9-57:65\">IAM Privilege Escalation by Instance Profile attachment</li>\n<li data-sourcepos=\"58:9-58:46\">Privileged role attached to Instance</li>\n<li data-sourcepos=\"59:9-59:63\">Suspicious credential token access of valid IAM Roles</li>\n<li data-sourcepos=\"60:9-60:45\">Unused or Unsupported Cloud Regions</li>\n</ul></li>\n<li data-sourcepos=\"61:5-61:69\">ノートブック ... Jupyter Notebookによる分析を提供</li>\n</ul></li>\n<li data-sourcepos=\"62:1-65:0\">ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能\n<ul data-sourcepos=\"63:5-65:0\">\n<li data-sourcepos=\"63:5-63:26\">Trend Micro Apex One</li>\n<li data-sourcepos=\"64:5-65:0\">McAfee Network Security Platform</li>\n</ul></li>\n</ul>\n<h2 data-sourcepos=\"66:1-66:13\" id=\"2-2-0\" name=\"2-2-0\"><a class=\"anchor\" id=\"Sumo Logic\" name=\"Sumo Logic\" href=\"#Sumo Logic\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Sumo Logic\"> &gt; Sumo Logic</span></a>Sumo Logic</h2>\n<h3 data-sourcepos=\"67:1-67:10\" id=\"2-2-1\" name=\"2-2-1\"><a class=\"anchor\" id=\"料金-1\" name=\"料金-1\" href=\"#料金-1\" data-position=\"2-2-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"料金\"> &gt; 料金</span></a>料金</h3>\n<ul data-sourcepos=\"68:1-69:0\">\n<li data-sourcepos=\"68:1-69:0\"><a href=\"https://www.sumologic.jp/pricing/jp/\" target=\"_blank\" rel=\"noopener noreferrer\">Sumo Logic 料金表</a></li>\n</ul>\n<h3 data-sourcepos=\"70:1-70:42\" id=\"2-2-2\" name=\"2-2-2\"><a class=\"anchor\" id=\"SIEMからCloudTrailへの接続方法-1\" name=\"SIEMからCloudTrailへの接続方法-1\" href=\"#SIEMからCloudTrailへの接続方法-1\" data-position=\"2-2-2\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEMからCloudTrailへの接続方法\"> &gt; SIEMからCloudTrailへの接続方法</span></a>SIEMからCloudTrailへの接続方法</h3>\n<ol data-sourcepos=\"71:1-229:0\">\n<li data-sourcepos=\"71:1-105:18\"><code>[AWSアカウントSecurity - S3]</code> にてバケット <code>cloudtrail-accumulativelogs-{account-id}</code> を下記設定にて作成\n<ul data-sourcepos=\"72:5-105:18\">\n<li data-sourcepos=\"72:5-72:66\"><p data-sourcepos=\"72:7-72:66\">パブリックアクセスをすべてブロック <code>オフ</code></p></li>\n<li data-sourcepos=\"73:5-105:18\"><details><summary>バケットポリシー</summary>\n<div class=\"code-block\" data-sourcepos=\"75:9-104:11\"><div class=\"code-filename\"><i class=\"fa fa-file-code-o\"></i>json</div><div class=\"highlight\"><pre class=\"highlight json\"><code><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nl\">\"Version\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2012-10-17\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"Statement\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AWSCloudTrailAclCheck20150319\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"s3:GetBucketAcl\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\"</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AWSCloudTrailWrite20150319\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"s3:PutObject\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"s3:x-amz-acl\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"bucket-owner-full-control\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">}</span><span class=\"w\">\n    </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre></div></div>\n  </details></li>\n</ul>\n</li>\n<li data-sourcepos=\"106:1-208:18\"><code>[親AWSアカウント - KMS]</code> にて下記設定でKSMを作成\n<ul data-sourcepos=\"107:5-208:18\">\n<li data-sourcepos=\"107:5-107:33\"><p data-sourcepos=\"107:7-107:33\">キーのタイプ <code>対称</code></p></li>\n<li data-sourcepos=\"108:5-108:45\"><p data-sourcepos=\"108:7-108:45\">キーマテリアルオリジン <code>KMS</code></p></li>\n<li data-sourcepos=\"109:5-109:51\"><p data-sourcepos=\"109:7-109:51\">リージョンごと <code>単一リージョン</code></p></li>\n<li data-sourcepos=\"110:5-110:41\"><p data-sourcepos=\"110:7-110:41\">エイリアス名 <code>cloudtrail-kms</code></p></li>\n<li data-sourcepos=\"111:5-208:18\"><details><summary>キーポリシー</summary>\n<div class=\"code-block\" data-sourcepos=\"113:9-207:11\"><div class=\"code-filename\"><i class=\"fa fa-file-code-o\"></i>json</div><div class=\"highlight\"><pre class=\"highlight json\"><code><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nl\">\"Version\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2012-10-17\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"Id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Key policy created by CloudTrail\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"Statement\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Enable IAM User Permissions\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow CloudTrail to encrypt logs\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:GenerateDataKey*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringLike\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:EncryptionContext:aws:cloudtrail:arn\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:cloudtrail:*:{account-id}:trail/*\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow CloudTrail to describe key\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:DescribeKey\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow principals in the account to decrypt log files\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:Decrypt\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:ReEncryptFrom\"</span><span class=\"w\">\n            </span><span class=\"p\">],</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:CallerAccount\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"{account-id}\"</span><span class=\"w\">\n                </span><span class=\"p\">},</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringLike\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:EncryptionContext:aws:cloudtrail:arn\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:cloudtrail:*:{account-id}:trail/*\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow alias creation during setup\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:CreateAlias\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:CallerAccount\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"{account-id}\"</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:ViaService\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"ec2.ap-northeast-1.amazonaws.com\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Enable cross account log decryption\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:Decrypt\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:ReEncryptFrom\"</span><span class=\"w\">\n            </span><span class=\"p\">],</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:CallerAccount\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"{account-id}\"</span><span class=\"w\">\n                </span><span class=\"p\">},</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringLike\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:EncryptionContext:aws:cloudtrail:arn\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:cloudtrail:*:{account-id}:trail/*\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">}</span><span class=\"w\">\n    </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre></div></div>\n  </details></li>\n</ul>\n</li>\n<li data-sourcepos=\"209:1-220:46\"><code>[親AWSアカウント - CloudTrail]</code> にて下記設定で証跡を作成\n<ul data-sourcepos=\"210:5-220:46\">\n<li data-sourcepos=\"210:5-218:46\">全般的な詳細\n<ul data-sourcepos=\"211:9-218:46\">\n<li data-sourcepos=\"211:9-211:37\">証跡名 <code>cloudtrail-logs</code></li>\n<li data-sourcepos=\"212:9-212:43\">組織に証跡を適用 <code>はい</code></li>\n<li data-sourcepos=\"213:9-213:75\">ストレージの場所 <code>既存のS3バケットを使用する</code></li>\n<li data-sourcepos=\"214:9-214:80\">証跡ログバケット名 <code>cloudtrail-accumulativelogs-{account-id}</code></li>\n<li data-sourcepos=\"215:9-215:56\">ログファイルのSSE-KMS暗号化 <code>有効</code></li>\n<li data-sourcepos=\"216:9-216:56\">カスタマー管理のAWS KMSキー <code>新規</code></li>\n<li data-sourcepos=\"217:9-217:81\">AWS KMSエイリアス <code>arn:aws:kms:{region}:{account-id}:key/{kms-id}</code></li>\n<li data-sourcepos=\"218:9-218:46\">ログファイルの検証 <code>有効</code></li>\n</ul></li>\n<li data-sourcepos=\"219:5-220:46\">管理イベント\n<ul data-sourcepos=\"220:9-220:46\">\n<li data-sourcepos=\"220:9-220:46\">APIアクティビティ <code>すべて</code></li>\n</ul></li>\n</ul>\n</li>\n<li data-sourcepos=\"221:1-229:0\"><code>[Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail]</code> にて下記設定でCloudTrailデータタイプを作成\n<ul data-sourcepos=\"222:5-229:0\">\n<li data-sourcepos=\"222:5-222:38\">Source Category <code>aws/cloudtrail</code></li>\n<li data-sourcepos=\"223:5-229:0\">S3 Bucket\n<ul data-sourcepos=\"224:9-229:0\">\n<li data-sourcepos=\"224:9-224:67\">S3 Bucket Name <code>cloudtrail-accumulativelogs-{account-id}</code></li>\n<li data-sourcepos=\"225:9-225:55\">Path Expression <code>AWSLogs/{organization-id}/*</code></li>\n<li data-sourcepos=\"226:9-226:42\">S3 Region <code>Asia Pacific (Tokyo)</code></li>\n<li data-sourcepos=\"227:9-229:0\">How do you want the user to access the S3 Bucket? <code>Role-based access</code><ul data-sourcepos=\"228:13-229:0\">\n<li data-sourcepos=\"228:13-229:0\">指定されたCFnテンプレートでIAMロールを作成</li>\n</ul></li>\n</ul></li>\n</ul>\n</li>\n</ol>\n<h3 data-sourcepos=\"230:1-230:31\" id=\"2-2-3\" name=\"2-2-3\"><a class=\"anchor\" id=\"SIEM機能 (AWS CloudTrail)-1\" name=\"SIEM機能 (AWS CloudTrail)-1\" href=\"#SIEM機能 (AWS CloudTrail)-1\" data-position=\"2-2-3\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEM機能 (AWS CloudTrail)\"> &gt; SIEM機能 (AWS CloudTrail)</span></a>SIEM機能 (AWS CloudTrail)</h3>\n<p data-sourcepos=\"231:1-231:27\">デフォルト監視対象</p>\n<ul data-sourcepos=\"232:1-281:0\">\n<li data-sourcepos=\"232:1-241:24\">Console Logins\n<ul data-sourcepos=\"233:5-241:24\">\n<li data-sourcepos=\"233:5-233:31\">Geo Location of All Users</li>\n<li data-sourcepos=\"234:5-234:26\">Login Events By User</li>\n<li data-sourcepos=\"235:5-235:22\">Logins Over Time</li>\n<li data-sourcepos=\"236:5-236:29\">Logins from Multiple IP</li>\n<li data-sourcepos=\"237:5-237:33\">Logins from Outside the USA</li>\n<li data-sourcepos=\"238:5-238:29\">Outlier - Success Login</li>\n<li data-sourcepos=\"239:5-239:28\">Outlier - Failed Login</li>\n<li data-sourcepos=\"240:5-240:45\">Login Results - One Day Time Comparison</li>\n<li data-sourcepos=\"241:5-241:24\">Logins without MFA</li>\n</ul></li>\n<li data-sourcepos=\"242:1-250:37\">Network and Security\n<ul data-sourcepos=\"243:5-250:37\">\n<li data-sourcepos=\"243:5-243:47\">Authorization Failures from All Countries</li>\n<li data-sourcepos=\"244:5-244:43\">Network and Security Events Over Time</li>\n<li data-sourcepos=\"245:5-245:38\">Authorization Failures Over Time</li>\n<li data-sourcepos=\"246:5-246:49\">Network ACL with All Allowed Ingress/Egress</li>\n<li data-sourcepos=\"247:5-247:35\">Recent Authorization Failures</li>\n<li data-sourcepos=\"248:5-248:51\">Recent Security Group and Network ACL Changes</li>\n<li data-sourcepos=\"249:5-249:54\">Created and Deleted Network  and Security Events</li>\n<li data-sourcepos=\"250:5-250:37\">Short Lived Critical Operations</li>\n</ul></li>\n<li data-sourcepos=\"251:1-257:33\">Operations\n<ul data-sourcepos=\"252:5-257:33\">\n<li data-sourcepos=\"252:5-252:19\">Action Events</li>\n<li data-sourcepos=\"253:5-253:38\">Requested AWS Services Over Time</li>\n<li data-sourcepos=\"254:5-254:26\">Events by AWS Region</li>\n<li data-sourcepos=\"255:5-255:42\">Recent Elastic IP Address Operations</li>\n<li data-sourcepos=\"256:5-256:33\">Created Resources Over Time</li>\n<li data-sourcepos=\"257:5-257:33\">Deleted Resources Over Time</li>\n</ul></li>\n<li data-sourcepos=\"258:1-264:53\">Overview\n<ul data-sourcepos=\"259:5-264:53\">\n<li data-sourcepos=\"259:5-259:31\">Geo Location of All Users</li>\n<li data-sourcepos=\"260:5-260:23\">Created Resources</li>\n<li data-sourcepos=\"261:5-261:33\">Deleted Resources Over Time</li>\n<li data-sourcepos=\"262:5-262:18\">Top 10 Users</li>\n<li data-sourcepos=\"263:5-263:19\">Failed Logins</li>\n<li data-sourcepos=\"264:5-264:53\">Created and Deleted Network and Security Events</li>\n</ul></li>\n<li data-sourcepos=\"265:1-273:35\">S3 Public Objects and Buckets\n<ul data-sourcepos=\"266:5-273:35\">\n<li data-sourcepos=\"266:5-266:24\">New Public Objects</li>\n<li data-sourcepos=\"267:5-267:40\">New Public Object by Object-Bucket</li>\n<li data-sourcepos=\"268:5-268:30\">New Public Objects Table</li>\n<li data-sourcepos=\"269:5-269:20\">Public Buckets</li>\n<li data-sourcepos=\"270:5-270:26\">Public Buckets Table</li>\n<li data-sourcepos=\"271:5-271:29\">Modified Public Objects</li>\n<li data-sourcepos=\"272:5-272:45\">Modified Public Objects by Object-Buket</li>\n<li data-sourcepos=\"273:5-273:35\">Modified Public Objects Table</li>\n</ul></li>\n<li data-sourcepos=\"274:1-281:0\">User Monitoring\n<ul data-sourcepos=\"275:5-281:0\">\n<li data-sourcepos=\"275:5-275:31\">Geo Location of All Users</li>\n<li data-sourcepos=\"276:5-276:18\">Top 10 Users</li>\n<li data-sourcepos=\"277:5-277:47\">Launched and Terminated Instances by User</li>\n<li data-sourcepos=\"278:5-278:41\">Administrative Activities Over Time</li>\n<li data-sourcepos=\"279:5-279:46\">Top 10 Activities by Administrative User</li>\n<li data-sourcepos=\"280:5-281:0\">Recent Activity by Administrative Users</li>\n</ul></li>\n</ul>\n<h1 data-sourcepos=\"282:1-282:8\" id=\"3-0-0\" name=\"3-0-0\"><a class=\"anchor\" id=\"総評\" name=\"総評\" href=\"#総評\" data-position=\"3-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"総評\"> &gt; 総評</span></a>総評</h1>\n<h2 data-sourcepos=\"283:1-283:18\" id=\"3-1-0\" name=\"3-1-0\"><a class=\"anchor\" id=\"使用コスト\" name=\"使用コスト\" href=\"#使用コスト\" data-position=\"3-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"使用コスト\"> &gt; 使用コスト</span></a>使用コスト</h2>\n<p data-sourcepos=\"284:1-284:102\">初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。</p>\n<table data-sourcepos=\"286:1-290:30\">\n<thead>\n<tr data-sourcepos=\"286:1-286:65\">\n<th data-sourcepos=\"286:2-286:22\">ログ取込量/日</th>\n<th data-sourcepos=\"286:24-286:45\">Azure Sentinel月額</th>\n<th data-sourcepos=\"286:47-286:64\">Sumo Logic月額</th>\n</tr>\n</thead>\n<tbody>\n<tr data-sourcepos=\"288:1-288:29\">\n<td data-sourcepos=\"288:2-288:8\">100MB</td>\n<td data-sourcepos=\"288:10-288:20\">2,396 JPY</td>\n<td data-sourcepos=\"288:22-288:28\">0 USD</td>\n</tr>\n<tr data-sourcepos=\"289:1-289:30\">\n<td data-sourcepos=\"289:2-289:8\">500MB</td>\n<td data-sourcepos=\"289:10-289:21\">11,978 JPY</td>\n<td data-sourcepos=\"289:23-289:29\">0 USD</td>\n</tr>\n<tr data-sourcepos=\"290:1-290:30\">\n<td data-sourcepos=\"290:2-290:6\">3GB</td>\n<td data-sourcepos=\"290:8-290:19\">71,870 JPY</td>\n<td data-sourcepos=\"290:21-290:29\">332 USD</td>\n</tr>\n</tbody>\n</table>\n<p data-sourcepos=\"292:1-292:153\">※ Azure Sentinelの内訳は「 <code>((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB</code> 」</p>\n<h2 data-sourcepos=\"294:1-294:18\" id=\"3-2-0\" name=\"3-2-0\"><a class=\"anchor\" id=\"導入コスト\" name=\"導入コスト\" href=\"#導入コスト\" data-position=\"3-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"導入コスト\"> &gt; 導入コスト</span></a>導入コスト</h2>\n<p data-sourcepos=\"295:1-295:249\">一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。</p>\n<h2 data-sourcepos=\"297:1-297:13\" id=\"3-3-0\" name=\"3-3-0\"><a class=\"anchor\" id=\"SIEM機能\" name=\"SIEM機能\" href=\"#SIEM機能\" data-position=\"3-3-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEM機能\"> &gt; SIEM機能</span></a>SIEM機能</h2>\n<p data-sourcepos=\"298:1-298:558\">Azure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。</p>\n<p data-sourcepos=\"300:1-300:267\">また、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。</p>\n<h1 data-sourcepos=\"302:1-302:8\" id=\"4-0-0\" name=\"4-0-0\"><a class=\"anchor\" id=\"WRAPUP\" name=\"WRAPUP\" href=\"#WRAPUP\" data-position=\"4-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"WRAPUP\"> &gt; WRAPUP</span></a>WRAPUP</h1>\n<p data-sourcepos=\"303:1-303:368\">メインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。</p>\n","tags":["siem","aws-cloudtrail","azure-sentinel","sumo-logic"],"updated_at":"2021-08-15T01:40:12+09:00","childPublishedDate":{"published_on":"2021-08-15T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_ef5f024307008aa399b91f87fa5f64e8.jpg"}},"relatedPosts":{"edges":[{"node":{"number":44,"relative_category":"blog/organization","fields":{"title":"整理したい私はITILをかぶる、PlantUMLへの愛","excerpt":"現在ネクイノでエンジニアリングマネージャー、バックエンドエンジニア、インフラエンジニアを担当しています。入社後8ヶ月、年の瀬ということで振り返り記事を書くことにしました。テーマを一つに絞らないと記事にならないので今回はPlantUMLに絞ります。断りとして、この記事で書いてあることはITILプラクティスを一部なぞっているに過ぎません。PlantUMLが全知全能のツールということを主張したいわけではないです、ただ愛しています。   > PROBLEMPROBLEM \n\n- 開発人数が増えるにあたり、チームとして機能していない 管理規程はあるものの 業務フローが明示化されておらず、誰が何を何の目的で業務を回しているか分からない 可視化されていないプロセスが問題になるケースが増えてきた \n- 管理規程はあるものの 業務フローが明示化されておらず、誰が何を何の目的で業務を回しているか分からない 可視化されていないプロセスが問題になるケースが増えてきた \n- 可視化されていないプロセスが問題になるケースが増えてきた  > SOLUTIONSOLUTION \n\nと言うわけで、入社早々PlantUMLで業務フローを可視化することを始めました。  > PlantUMLとはPlantUMLとは \n\nPlantUMLはオープンソースのUMLダイアグラム作成用のテキストベースの言語です。シークエンス図、ユースケース図、アクティビティ図、クラス図のようなダイアグラムをシンプルで直感的に書くことができます。 \n\n2009年リリースされており、私が使うようになったのは、Emacsのorg-babelで実装されてからなので2014年くらい1。2016-7年にesa.ioやVS Code等で実装されてから爆発的に普及したと記憶しています。「esa.ioはオンラインのorg-modeになるべくPlantUMLを実装すべき」と要望したのは良い思い出です。  > やったことやったこと \n\nさて、私はネクイノに入社早々既存システムの運用開発と情シス（業務運用）の部長職にアサインされました。既存システムの運用開発は新しく外部のパートナーが入ると言うことで、開発フローが大きく変わる節目にありました。  > 開発フローを整備する開発フローを整備する \n\n話を聞くに新しく入る外部パートナーはプロジェクトマネージャ、ブリッジエンジニア・コミュニケーター、モバイルエンジニア、バックエンドエンジニア、フロントエンジニア、品質チェック含め20名程の体制でした。また、既存システムの運用開発ではプロダクトマネジャー、プロダクトオーナーが各開発者とともに企画策定を行うことが慣習として存在していました。私はまず企画から実装、レビュー、リリースまでの流れを整理します。 Jira上の大まかな流れ \n\n 開発の流れ \n\n  > 要望フローを整備する要望フローを整備する \n\n次に、機能要望、バグ報告、改善要望がSlackチャンネルの至る所に散在している上、チケット化されないケースがありました。突貫ではありますが、GoogleフォームとJira連携を行いました2。 \n\nプロダクトマネジャーの体制が整備されてからは、機能要望のフォームは使われることはなくなりましたが、バグ報告、改善要望は要所要所で使われ、トリアージという形で定期的に活用されています。 \n\n  > デプロイフローを整備するデプロイフローを整備する \n\n開発が進んでいくと、今度は開発環境が足りなくなりました。当時はステージング環境と本番環境しかなく、かつ、ステージング環境がテスト環境兼デモ環境の役割を呈しており、ステージング環境おテストで不具合を起こすとデモに影響が出るという状態が続いておりました。また、外部パートナーが開発するに当たり繊細なステージング環境を使うのが難しいため進捗に影響が出始めておりました。 \n\n急を要する事態のためAWS CDKでステージング環境とは別に結合環境を用意し3、デプロイフローを整備しました。 \n\n  > 障害対応フローを整備する障害対応フローを整備する \n\nさて、運用開発が順調に進んでいくと、今度は障害が頻繁に起きていることに気づきました。いいえ、薄々気づいていたのですが多忙にかまけて蓋をしておりました。ここに関しては本腰を入れてAWSサポートプランをビジネスに変更し原因を突き止めました。協力いただいた各位には感謝です。 \n\nまた、今まで見過ごされていたGoogle Workspace等の業務運用のシステムも含め障害報告の体制を敷くとともに、監視体制も強化しました。 \n\n  > 業務フローを整理する業務フローを整理する \n\nまだまだあります。業務内容に関しては詳細は書けませんが、部内の業務から他部署の業務まで安全に生産性を高めるため整理を行いました。まだまだ行います。  > リモート飲みのフローを整備するリモート飲みのフローを整備する \n\nいよいよ疲れてきたのでお酒が飲みたくなりました。飲み会フローを作ってみましたが思いの外手間がかかることが分かりあまり活用できておりません。その代わり社内でオンラインシャッフルランチという制度ができました。 \n\n  > 分かったこと分かったこと \n\nはい、こうして振り返ると入社時に感じていた雑然さは業務フローが明確でない状態のことでした。開発者なら分かると思いますが、企画段階で思い描く構成図は実装する段になるとあまり意味をなさず、結局は頭の中はシークエンス図でいっぱいになります。それと同じで、登場人物、登場人物間のメッセージ、メッセージの大枠が関係者に共有されていないと、いくらリソースが投下されても不安定で生産性に伸び悩むのです。つまり、雑然とした環境を整理すると言うことはシークエンス図を書くことに他なりません。 \n\nしかしながら、当該環境一つ一つを俯瞰的に見るとITILプラクティスそのものであることにも気づきます。 \n\nITILとはITサービスマネジメントのベストプラクティスフレームワークのこと。何らかの高い技術を持っていても、投資対効果を考えていなければ赤字になりビジネスと成り立ちませんし、顧客のことを考えずに作ったものに価値はありませんし、サービスの評価を落とすことになります。このようなことを防ぐには顧客目線やビジネス的な観点が必要で、そのノウハウがまとまったものがITILです。  > 今回対応したプラクティス今回対応したプラクティス \n\n今回の振り返りでは具体的に次のプラクティスをなぞっておりました。    振り返り ITILプラクティス     開発フローを整備する 継続的サービス改善   要望フローを整備する 要求管理、問題管理   デプロイフローを整備する リリース管理及び展開管理   障害対応フローを整備する インシデント管理   業務フローを整理する CMMI   リモート飲みのフローを整備する 組織変更管理    \n\nCMMIと組織変更管理が分かりづらいの少し補足します。 \n\n- CMMIとは能力成熟度モデル統合のことで、業務フローを評価し5段階で成熟度レベルを出す手法です。現状はレベル1-2（初期段階）のものがほとんどなのでまずはPlantUMLを使い共通認識を作るところから始めました。\n- 組織変更管理とは経営学で言うところのチェンジマネジメントに当たります。ここでは各種フローを整備しメンバー全員に落とし込むことを目指します。『Fearless Change』では今回のリモート飲み以外にも多くのパターンランゲージが紹介されています。  > WRAPUPWRAPUP  > 次にすること次にすること \n\nネクストアクションですが、採用フローを考えています。 \n\n（読者の皆様はどんなシークエンス図を思い浮かべましたか?） \n\nというわけで、ネクイノはPlantUMLを愛している開発者を募集中です。  > PR__colon__ ネクイノとはPR: ネクイノとは \n\n「世界中の医療空間と体験を再定義する」をミッションに、人々と医療の間にICTのチカラで橋をかける遠隔医療ソリューションを手掛けている会社です。医療というと高齢の患者さんをイメージされるかもしれませんが、我らがターゲットとしているのは現役世代の方。病気を治療するというより、現役世代がQOLを高めるためのサポートを目的としています。 \n\nメインサービスは、女性に特化したピルのオンライン診療アプリ「スマルナ」。ピルを飲まれている人だけでなく、受診や服用に抵抗がある方にも気軽に利用していただけたらと思いサービス提供しています。診察室の手前に助産師と薬剤師を配置した相談室を設ける等、受診のハードルを下げる工夫をそこかしこに施しているのが特徴です。 \n\n様々なメディカルコミュニケーションを行っています - 専門家相談 - カスタマーサポート - ユーザーコミュニティ  \n\n妻からは「10年前にサービスがあったら良かったのに」とお墨付きをいただいており、興味をもった方は詳しくはこちらをご覧下さい。 https://smaluna.com/  \n\n1. [B! plantuml] nabinnoのブックマーク ↩ \n2. https://github.com/nabinno/google-forms-to-jira-slack ↩ \n3. CDKはaws-rails-provisionerを参考に ecs_patterns.ApplicationLoadBalancedFargateService を実装しました ↩"},"name":"[2020-12-30]整理したい私はITILをかぶる、PlantUMLへの愛","tags":["team-building"],"childPublishedDate":{"published_on":"2020-12-30T00:00:00.000Z","published_on_unix":1609286400}}},{"node":{"number":124,"relative_category":"blog/backend","fields":{"title":"Increment Pは住所のバリデーションチェックでどの程度使えるか","excerpt":"7月に調査した「imi-enrichment-addressは住所のバリデーションチェックでどの程度使えるか」の続きになります。コロナ禍であらゆる流通がオンラインに移行する中、正しい住所を使うことはいっそう求められています。ユーザーが配送用に住所を入力する時そのデータが正しいとどうやって判定するのでしょうか。今回は商用サービスIncrement Pが住所のバリデーションチェックでどの程度使えるか検証してみました。   > PROBLEMPROBLEM \n\n- 住所の不備が至るところで起きている 特に町名番地の抜けもれや不備が多くこの点をどうにか拾いたい 可能ならユーザーの入力時点でFEあるいはBE側でバリデーションチェックしたい imi-enrichment-addressで精度が思わしくなかったので今回は商用サービスで検証したい \n- 特に町名番地の抜けもれや不備が多くこの点をどうにか拾いたい\n- 可能ならユーザーの入力時点でFEあるいはBE側でバリデーションチェックしたい imi-enrichment-addressで精度が思わしくなかったので今回は商用サービスで検証したい \n- imi-enrichment-addressで精度が思わしくなかったので今回は商用サービスで検証したい  > SOLUTIONSOLUTION \n\nというわけで、住所のバリデーションチェックで商用版「Increment P」がどの程度使えるか検証します。  > Increment PとはIncrement Pとは \n\n住所をAPIを介すことで正規化することができます。APIの返値に解析レベル・解析ログを加えることでより柔軟な検証をおこなうことができるようになっています。 \n\n解析レベルとは、対象住所のマッチ度合いを都道府県・市区町村・町域・丁目・番地・号というレベルで分けたものです。APIの結果が解析レベル5「番地・番」以上になっていれば配送が確実に為されると言うように、配送の確実性を前提にして住所の入力者とやりとりを実現します。また、解析ログメッセージとは、住所の正規化を試みた際のログであり、バリデーションを調整する際に頻繁に確認するものです。詳細は「ドキュメント」をご覧下さい。    解析レベル レベルの数字 説明     都道府県 1 県レベルでマッチしました   市区町村 2 市区町村レベルでマッチしました   町域 (大字) 3 町域レベルでマッチしました   丁目 / 小字 4 丁目または小字レベルでマッチしました   番地（番） 5 番地（番）レベルでマッチしました   号情報が存在しない番地 7 番地（番）レベルでマッチしました（号情報が存在しない地域）   号 8 号レベルでマッチしました   不明 -1 不明    \n\n試しにIncrement Pを実行してみましょう。正確な住所を渡したときと不正確な住所を渡したときで解析レベルが5と3と異なった結果を返すことが見て取れます。 sh\n\n$ curl \"https://api-anorm.mapfan.com/v1/$(echo -n 長野県長野市大字長野旭町1108 | jq -sRr @uri).json\" \\ -H 'x-api-key: <api-key>' \\ -H 'Content-Type: application/json' | jq -r { \"type\": \"FeatureCollection\", \"query\": [ \"長野県長野市大字長野旭町1108\" ], \"features\": [ { \"type\": \"Feature\", \"geometry\": null, \"properties\": { \"query\": \"長野県長野市大字長野旭町1108\", \"place_name\": \"長野県長野市長野旭町 1108\", \"pref\": \"長野県\", \"pref_kana\": \"ナガノケン\", \"city\": \"長野市\", \"city_kana\": \"ナガノシ\", \"area\": \"長野\", \"area_kana\": \"ナガノ\", \"koaza_chome\": \"旭町\", \"koaza_chome_kana\": \"アサヒマチ\", \"banchi_go\": \"1108\", \"building\": \"\", \"building_number\": \"\", \"zipcode\": \"3800846\", \"geocoding_level\": 5, \"geocoding_level_desc\": \"番地（番）レベルでマッチしました(5)\", \"log\": \"RM002:[大字(字)]の文字を除去しました\", \"not_normalized\": \"\" } } ], \"attribution\": \"(c) INCREMENT P CORPORATION\" } $ curl \"https://api-anorm.mapfan.com/v1/$(echo -n 長野県長野市旭町1108 | jq -sRr @uri).json\" \\ -H 'x-api-key: <api-key>' \\ -H 'Content-Type: application/json' | jq -r { \"type\": \"FeatureCollection\", \"query\": [ \"長野県長野市旭町1108\" ], \"features\": [ { \"type\": \"Feature\", \"geometry\": null, \"properties\": { \"query\": \"長野県長野市旭町1108\", \"place_name\": \"長野県長野市旭町\", \"pref\": \"長野県\", \"pref_kana\": \"ナガノケン\", \"city\": \"長野市\", \"city_kana\": \"ナガノシ\", \"area\": \"旭町\", \"area_kana\": \"アサヒマチ\", \"koaza_chome\": \"\", \"koaza_chome_kana\": \"\", \"banchi_go\": \"\", \"building\": \"\", \"building_number\": \"\", \"zipcode\": \"3800846\", \"geocoding_level\": 3, \"geocoding_level_desc\": \"町域レベルでマッチしました(3)\", \"log\": \"NT001:正規化処理状況が建物名正規化処理の必要条件を満たさないので建物名正規化は行われません\", \"not_normalized\": \"1108\" } } ], \"attribution\": \"(c) INCREMENT P CORPORATION\" }  \n\nなお、上記結果を見て分かるとおり、Increment Pは大字省略には強そうですが町域自体の省略は苦手なようです。imi-enrichment-addressより柔軟ですが、基本は街区レベル位置参照情報を利用しているように推察されます。  > 検証用データ検証用データ \n\nさて、検証用データですが、imi-enrichment-addressの検証データと合わせて住所.jpを使います。今回はトライアルが1000件と制限があるので、imi-enrichment-addressで無効割合が54.42%と一番多かった青森県と住所の登録数が多い東京・愛知・北海道・大阪・福岡・神奈川、さらに通りが独特な京都、町字の組み合わせで住所が2つ以上存在する長野に対象を絞ります。各々100件ずつの検証になります。 sh\n\n$ { curl -sSL http://jusyo.jp/downloads/new/csv/csv_zenkoku.zip -o csv_zenkoku.zip; unzip -p csv_zenkoku.zip | nkf -w; rm csv_zenkoku.zip } >zenkoku.csv $ brew install noborus/tap/trdsql $ trdsql \" SELECT COUNT(*) FROM zenkoku.csv WHERE c21 <> '' \" 22431 $ trdsql -otbln \" SELECT c8, count(*) cn FROM zenkoku.csv WHERE c21 != '' GROUP BY c8 ORDER BY cn DESC\" | 都道府県 | count(*) | | --- | --- | | 東京都 | 4734 | | 愛知県 | 1541 | | 北海道 | 1251 | | 大阪府 | 884 | | 福岡県 | 845 | | 神奈川県 | 820 | [..] | 長野県 | 594 | [..] | 京都府 | 255 | [..] | 青森県 | 216 |   > Increment Pで検証用データを確認するIncrement Pで検証用データを確認する sh\n\n$ for p in 東京都 愛知県 北海道 大阪府 福岡県 神奈川県 青森県 京都府 長野県; do for a in $(trdsql \" SELECT c8||c10||c21 FROM zenkoku.csv WHERE c21 != '' AND c8 = '$p' ORDER BY RANDOM() LIMIT 100 \"); do curl -w'\\n' \"https://api-anorm.mapfan.com/v1/$(echo -n $a | jq -sRr @uri).json\" \\ -H 'x-api-key: <api-key>' \\ -H 'Content-Type: application/json' >>output.jsonl; done & done &   > 解析結果を確認する解析結果を確認する \n\nIncrement Pの解析結果を確認したところ、imi-enrichment-addressと比べると大方改善しました。特に青森県、北海道の改善率は高く字・条・線に対して有効に機能していることが伺えます。一方、京都や長野のように特殊な住所がある府県については改善が思うように行かないケースもあるようです。 sh\n\n$ cat output.jsonl \\ | jq -r '[ .features[].properties.pref, .features[].properties.query, .features[].properties.geocoding_level, .features[].properties.log ] | @csv' \\ | trdsql -otbln \" SELECT c1, COUNT(*) cn FROM - WHERE c3 >= 5 GROUP BY c1 ORDER BY cn DESC \"  \n\n解析レベル5「番地・番」以上の場合（※ 参考値はimi-enrichment-addressの有効割合）    都道府県 有効割合 参考値     東京都 100 99.11   大阪府 100 96.72   福岡県 95 91   神奈川県 95 98.28   愛知県 92 92.6   青森県 90 45.58   長野県 84 55.72   北海道 80 86.24   京都府 79 63.14    \n\n解析レベル4「丁目/小字」以上の場合（※ 参考値はimi-enrichment-addressの有効割合）    都道府県 有効割合 参考値     東京都 100 99.11   大阪府 100 96.72   北海道 98 86.24   愛知県 97 92.6   福岡県 96 91   神奈川県 95 98.28   青森県 93 45.58   長野県 84 55.72   京都府 79 63.14     > WRAPUPWRAPUP \n\n青森県の有効率が45.58%だったimi-enrichment-addressと比べると、Increment Pは調査した大凡の都道府県で改善し70%以上の有効割合を出していました。バリデーションチェックで使えるのかというと全ての都道府県で100%になっていないため心許ない状況ではあるものの、解析レベル4「丁目/小字」以下の住所については最終確認を促すフローを入れる等ひと手間加えれば実用に耐えうると考えます。"},"name":"[2021-11-23]Increment Pは住所のバリデーションチェックでどの程度使えるか","tags":["incrementp"],"childPublishedDate":{"published_on":"2021-11-23T00:00:00.000Z","published_on_unix":1637625600}}},{"node":{"number":119,"relative_category":"blog/backend","fields":{"title":"踏み台をSSM Session ManagerとAWS SSOで実現する","excerpt":"踏み台のユーザーが増えてきたため公開鍵管理や監視と運用負荷が上がってきました。オペミスが発生しやすい上 監査的な意味で無視できない状況になってきたので重い腰を上げることにしました。   > PROBLEMPROBLEM \n\n- EC2インスタンスの踏み台運用がつらい 公開鍵管理がつらい 提出・設定・確認ともに運用コストがかかる AWSアカウント数 x ユーザー数で指数関数的に運用コストが増していくことが想定される インフラ管理が分散していると、提出側・設定側ともに重複コストが発生する 監視運用がつらい 定期的に踏み台がブルートフォース攻撃を受けており、脅威が低いとは言えストレスがかかる 踏み台アクセスへの監査ログが不十分 \n- 公開鍵管理がつらい 提出・設定・確認ともに運用コストがかかる AWSアカウント数 x ユーザー数で指数関数的に運用コストが増していくことが想定される インフラ管理が分散していると、提出側・設定側ともに重複コストが発生する \n- 提出・設定・確認ともに運用コストがかかる\n- AWSアカウント数 x ユーザー数で指数関数的に運用コストが増していくことが想定される\n- インフラ管理が分散していると、提出側・設定側ともに重複コストが発生する\n- 監視運用がつらい 定期的に踏み台がブルートフォース攻撃を受けており、脅威が低いとは言えストレスがかかる 踏み台アクセスへの監査ログが不十分 \n- 定期的に踏み台がブルートフォース攻撃を受けており、脅威が低いとは言えストレスがかかる\n- 踏み台アクセスへの監査ログが不十分  > SOLUTIONSOLUTION \n\nというわけで、Session ManagerとSSOでアクセス管理の効率化を狙います。  > 踏み台サーバーの設定踏み台サーバーの設定 \n\nまず、データフローとしては下記の図の通りで、今回はプライベートサブネット上にEC2を置いて素のSession ManagerでDBへの接続することにします。当該インスタンスは AmazonSSMManagedInstanceCore ポリシー1を含んだロールを適用。なお、ECS ExecではSession Managerでポートフォワーディングを実現でき無かったことに加え、既存の踏み台資産を流用するため今回の実装対象から外しました。 \n\n  > SSOの設定SSOの設定 \n\n踏み台サーバーの設定が終わったら、次に当該インスタンスへ接続するためにSSOで渡すロールをアクセス権限セットに設定します。下記カスタムポリシーはEC2インスタンスにアクセスするための必要最低限のものになります。 カスタムポリシー json\n\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Action\": [ \"cloudwatch:PutMetricData\", \"ds:CreateComputer\", \"ds:DescribeDirectories\", \"ec2:DescribeInstanceStatus\", \"logs:*\", \"ssm:*\", \"ec2messages:*\" ], \"Resource\": \"*\" }, { \"Effect\": \"Allow\", \"Action\": [ \"ssm:StartSession\" ], \"Resource\": [ \"arn:aws:ssm:*:*:session/<EC2インスタンスID>\", \"arn:aws:ec2:*:*:instance/<EC2インスタンスID>\" ] }, { \"Effect\": \"Deny\", \"Action\": [ \"ssm:Describe*\", \"ssm:Get*\", \"ssm:List*\", \"logs:Describe*\", \"logs:Get*\", \"logs:List*\" ], \"Resource\": \"*\" }, { \"Effect\": \"Allow\", \"Action\": \"iam:CreateServiceLinkedRole\", \"Resource\": \"arn:aws:iam::*:role/aws-service-role/ssm.amazonaws.com/AWSServiceRoleForAmazonSSM*\", \"Condition\": { \"StringLike\": { \"iam:AWSServiceName\": \"ssm.amazonaws.com\" } } }, { \"Effect\": \"Allow\", \"Action\": \"iam:CreateServiceLinkedRole\", \"Resource\": \"arn:aws:iam::*:role/aws-service-role/ssm.amazonaws.com/AWSServiceRoleForAmazonSSM*\", \"Condition\": { \"StringLike\": { \"iam:AWSServiceName\": \"ssm.amazonaws.com\" } } }, { \"Effect\": \"Allow\", \"Action\": [ \"iam:DeleteServiceLinkedRole\", \"iam:GetServiceLinkedRoleDeletionStatus\" ], \"Resource\": \"arn:aws:iam::*:role/aws-service-role/ssm.amazonaws.com/AWSServiceRoleForAmazonSSM*\" }, { \"Effect\": \"Allow\", \"Action\": [ \"ssmmessages:CreateControlChannel\", \"ssmmessages:CreateDataChannel\", \"ssmmessages:OpenControlChannel\", \"ssmmessages:OpenDataChannel\" ], \"Resource\": \"*\" } ] }    > セッションを張るための事前準備セッションを張るための事前準備 \n\nセッションを張るためには下記3つの手順が必要になります。SSO経由のセッション設定が2通りありますが、クレデンシャル方式はセッションが切れる毎に変更する手間があるため、CLI方式をお薦めします。 \n\n1. AWS CLI v2をインストール\n2. 下記いずれかの方式でSSO経由のセッション設定を行う クレデンシャル方式 CLI（ aws sso login ）方式 \n3. クレデンシャル方式\n4. CLI（ aws sso login ）方式\n5. Session Manager プラグインをインストール  > DBクライアントの設定DBクライアントの設定 \n\n最後に、DBクライアントについて3つの手順を踏んで接続を試みます2。なお、ローカル環境でポートフォワーディングを都度行うのを省略したい方は、DataGripを利用すると良いでしょう。 \n\n1. ローカル環境にて ~/.ssh/config ファイルを編集 Session Managerにproxyと対象RDSのエンドポイントを記載 configHost <任意のhost名> HostName <※ 指定しなければlocalhostになる> User ec2-user ProxyCommand sh -c \"aws ssm start-session --target <接続する踏み台のインスタンスID> --document-name AWS-StartSSHSession --parameters 'portNumber=%p' --region ap-northeast-1 --profile <プロフィール>\" LocalForward <任意のポート> <RDSエンドポイント>:<RDSポート> IdentityFile ~/.ssh/<EC2に接続する秘密鍵> 設定したhost名でセッションマネージャー越しにssh接続できるかを確認 sh$ ssh <設定したhost名> \n2. Session Managerにproxyと対象RDSのエンドポイントを記載 configHost <任意のhost名> HostName <※ 指定しなければlocalhostになる> User ec2-user ProxyCommand sh -c \"aws ssm start-session --target <接続する踏み台のインスタンスID> --document-name AWS-StartSSHSession --parameters 'portNumber=%p' --region ap-northeast-1 --profile <プロフィール>\" LocalForward <任意のポート> <RDSエンドポイント>:<RDSポート> IdentityFile ~/.ssh/<EC2に接続する秘密鍵> \n3. 設定したhost名でセッションマネージャー越しにssh接続できるかを確認 sh$ ssh <設定したhost名> \n4. 手順1で設定したsshで接続することでポートフォワーディング\n5. DBクライアントで下記のように接続情報を設定し接続する Host: <手順1のconfigファイルにて任意指定したホスト名> Port: <手順4のconfigファイルにて任意指定したポート> 他項目: DB接続情報 \n6. Host: <手順1のconfigファイルにて任意指定したホスト名>\n7. Port: <手順4のconfigファイルにて任意指定したポート>\n8. 他項目: DB接続情報  > WRAPUPWRAPUP \n\nパブリックサブネット上の踏み台に慣れている方は馴染みのない方法に戸惑うかも知れませんが、踏み台資産を流用できるという意味で導入のコストもそれほどかかりませんし、ユーザーとしても利用の敷居は高くありませんでした。後々の管理コストを心配している方は一度検討してみてはいかがでしょうか。  \n\n1. AmazonEC2RoleforSSM は非推奨のため適用しないように注意します。 ↩ \n2. 今回はメンテナンスコストを避けるためSSH over SSMの関連ツール ssh-ssm.sh ssm-tool は使わない方針でいます。 ↩"},"name":"[2021-11-21]踏み台をSSM Session ManagerとAWS SSOで実現する","tags":["SessionManager","AWSSSO"],"childPublishedDate":{"published_on":"2021-11-21T00:00:00.000Z","published_on_unix":1637452800}}}]}},"pageContext":{"number":93}},"staticQueryHashes":[]}