{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/93","result":{"data":{"esaPost":{"number":93,"relative_category":"blog/backend","fields":{"title":"AWS CloudTrail用のコスパの良いSIEMを探す","excerpt":"IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。   > PROBLEMPROBLEM \n\n- AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい NewRelicのように人のコストをかけずに管理したい \n- 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい\n- 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい NewRelicのように人のコストをかけずに管理したい \n- NewRelicのように人のコストをかけずに管理したい  > SOLUTIONSOLUTION \n\nと言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。  > Azure SentinelAzure Sentinel  > 料金料金 \n\n- Azure Sentinel の価格 | Microsoft Azure\n- 価格 - Azure Monitor | Microsoft Azure  > SIEMからCloudTrailへの接続方法SIEMからCloudTrailへの接続方法 \n\n1. 下記設定でLog Analyticsワークスペースを作成 サブスクリプション 無料試用版 リソース グループ production 名前 prod-sentinel 地域 東日本 \n2. サブスクリプション 無料試用版\n3. リソース グループ production\n4. 名前 prod-sentinel\n5. 地域 東日本\n6. [ワークスペースprod-sentinel - データコネクタ] にて [アマゾンウェブサービス] コネクタページを開く\n7. [AWSアカウント - IAM - ロール] にて下記設定で [別のAWSアカウント] を作成 アカウントID {Microsoft account ID} オプション 外部IDが必要 をチェック 外部ID {外部ID (ワークスペースID)} パーミッションポリシーを適用 AWSCloudTrailReadOnlyAccess ロール名 AzureSentinel ※ Cf. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO \n8. アカウントID {Microsoft account ID}\n9. オプション 外部IDが必要 をチェック 外部ID {外部ID (ワークスペースID)} \n10. 外部IDが必要 をチェック\n11. 外部ID {外部ID (ワークスペースID)}\n12. パーミッションポリシーを適用 AWSCloudTrailReadOnlyAccess\n13. ロール名 AzureSentinel\n14. ※ Cf. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO \n15. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs\n16. アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs\n17. Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO  > SIEM機能 (AWS CloudTrail)SIEM機能 (AWS CloudTrail) \n\n- デフォルト監視対象 時間経過に伴うイベントアラート 悪意ある可能性があるイベント 最近のインシデント データソースの異常 \n- 時間経過に伴うイベントアラート\n- 悪意ある可能性があるイベント\n- 最近のインシデント\n- データソースの異常\n- ログクエリ Audit Network Security \n- Audit\n- Network\n- Security\n- 脅威管理 インシデント ブック ... 簡易な分析情報を提供 AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。 AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。 ハンティング ... 脅威判定となるログクエリを提供 Changes made to AWS IAM policy Tracking Privileged Account Rare Activity Exploit and Pentest Framework User Agent IAM Privilege Escalation by Instance Profile attachment Privileged role attached to Instance Suspicious credential token access of valid IAM Roles Unused or Unsupported Cloud Regions ノートブック ... Jupyter Notebookによる分析を提供 \n- インシデント\n- ブック ... 簡易な分析情報を提供 AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。 AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。 \n- AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。\n- AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。\n- ハンティング ... 脅威判定となるログクエリを提供 Changes made to AWS IAM policy Tracking Privileged Account Rare Activity Exploit and Pentest Framework User Agent IAM Privilege Escalation by Instance Profile attachment Privileged role attached to Instance Suspicious credential token access of valid IAM Roles Unused or Unsupported Cloud Regions \n- Changes made to AWS IAM policy\n- Tracking Privileged Account Rare Activity\n- Exploit and Pentest Framework User Agent\n- IAM Privilege Escalation by Instance Profile attachment\n- Privileged role attached to Instance\n- Suspicious credential token access of valid IAM Roles\n- Unused or Unsupported Cloud Regions\n- ノートブック ... Jupyter Notebookによる分析を提供\n- ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能 Trend Micro Apex One McAfee Network Security Platform \n- Trend Micro Apex One\n- McAfee Network Security Platform  > Sumo LogicSumo Logic  > 料金料金 \n\n- Sumo Logic 料金表  > SIEMからCloudTrailへの接続方法SIEMからCloudTrailへの接続方法 \n\n1. [AWSアカウントSecurity - S3] にてバケット cloudtrail-accumulativelogs-{account-id} を下記設定にて作成 パブリックアクセスをすべてブロック オフ バケットポリシー json{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSCloudTrailAclCheck20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\" }, { \"Sid\": \"AWSCloudTrailWrite20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } \n2. パブリックアクセスをすべてブロック オフ\n3. バケットポリシー json{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSCloudTrailAclCheck20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\" }, { \"Sid\": \"AWSCloudTrailWrite20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } \n4. [親AWSアカウント - KMS] にて下記設定でKSMを作成 キーのタイプ 対称 キーマテリアルオリジン KMS リージョンごと 単一リージョン エイリアス名 cloudtrail-kms キーポリシー json{ \"Version\": \"2012-10-17\", \"Id\": \"Key policy created by CloudTrail\", \"Statement\": [ { \"Sid\": \"Enable IAM User Permissions\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:*\", \"Resource\": \"*\" }, { \"Sid\": \"Allow CloudTrail to encrypt logs\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:GenerateDataKey*\", \"Resource\": \"*\", \"Condition\": { \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow CloudTrail to describe key\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:DescribeKey\", \"Resource\": \"*\" }, { \"Sid\": \"Allow principals in the account to decrypt log files\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow alias creation during setup\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:CreateAlias\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\", \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\" } } }, { \"Sid\": \"Enable cross account log decryption\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } } ] } \n5. キーのタイプ 対称\n6. キーマテリアルオリジン KMS\n7. リージョンごと 単一リージョン\n8. エイリアス名 cloudtrail-kms\n9. キーポリシー json{ \"Version\": \"2012-10-17\", \"Id\": \"Key policy created by CloudTrail\", \"Statement\": [ { \"Sid\": \"Enable IAM User Permissions\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:*\", \"Resource\": \"*\" }, { \"Sid\": \"Allow CloudTrail to encrypt logs\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:GenerateDataKey*\", \"Resource\": \"*\", \"Condition\": { \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow CloudTrail to describe key\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:DescribeKey\", \"Resource\": \"*\" }, { \"Sid\": \"Allow principals in the account to decrypt log files\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow alias creation during setup\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:CreateAlias\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\", \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\" } } }, { \"Sid\": \"Enable cross account log decryption\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } } ] } \n10. [親AWSアカウント - CloudTrail] にて下記設定で証跡を作成 全般的な詳細 証跡名 cloudtrail-logs 組織に証跡を適用 はい ストレージの場所 既存のS3バケットを使用する 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id} ログファイルのSSE-KMS暗号化 有効 カスタマー管理のAWS KMSキー 新規 AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id} ログファイルの検証 有効 管理イベント APIアクティビティ すべて \n11. 全般的な詳細 証跡名 cloudtrail-logs 組織に証跡を適用 はい ストレージの場所 既存のS3バケットを使用する 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id} ログファイルのSSE-KMS暗号化 有効 カスタマー管理のAWS KMSキー 新規 AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id} ログファイルの検証 有効 \n12. 証跡名 cloudtrail-logs\n13. 組織に証跡を適用 はい\n14. ストレージの場所 既存のS3バケットを使用する\n15. 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id}\n16. ログファイルのSSE-KMS暗号化 有効\n17. カスタマー管理のAWS KMSキー 新規\n18. AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id}\n19. ログファイルの検証 有効\n20. 管理イベント APIアクティビティ すべて \n21. APIアクティビティ すべて\n22. [Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail] にて下記設定でCloudTrailデータタイプを作成 Source Category aws/cloudtrail S3 Bucket S3 Bucket Name cloudtrail-accumulativelogs-{account-id} Path Expression AWSLogs/{organization-id}/* S3 Region Asia Pacific (Tokyo) How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n23. Source Category aws/cloudtrail\n24. S3 Bucket S3 Bucket Name cloudtrail-accumulativelogs-{account-id} Path Expression AWSLogs/{organization-id}/* S3 Region Asia Pacific (Tokyo) How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n25. S3 Bucket Name cloudtrail-accumulativelogs-{account-id}\n26. Path Expression AWSLogs/{organization-id}/*\n27. S3 Region Asia Pacific (Tokyo)\n28. How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n29. 指定されたCFnテンプレートでIAMロールを作成  > SIEM機能 (AWS CloudTrail)SIEM機能 (AWS CloudTrail) \n\nデフォルト監視対象 \n\n- Console Logins Geo Location of All Users Login Events By User Logins Over Time Logins from Multiple IP Logins from Outside the USA Outlier - Success Login Outlier - Failed Login Login Results - One Day Time Comparison Logins without MFA \n- Geo Location of All Users\n- Login Events By User\n- Logins Over Time\n- Logins from Multiple IP\n- Logins from Outside the USA\n- Outlier - Success Login\n- Outlier - Failed Login\n- Login Results - One Day Time Comparison\n- Logins without MFA\n- Network and Security Authorization Failures from All Countries Network and Security Events Over Time Authorization Failures Over Time Network ACL with All Allowed Ingress/Egress Recent Authorization Failures Recent Security Group and Network ACL Changes Created and Deleted Network and Security Events Short Lived Critical Operations \n- Authorization Failures from All Countries\n- Network and Security Events Over Time\n- Authorization Failures Over Time\n- Network ACL with All Allowed Ingress/Egress\n- Recent Authorization Failures\n- Recent Security Group and Network ACL Changes\n- Created and Deleted Network and Security Events\n- Short Lived Critical Operations\n- Operations Action Events Requested AWS Services Over Time Events by AWS Region Recent Elastic IP Address Operations Created Resources Over Time Deleted Resources Over Time \n- Action Events\n- Requested AWS Services Over Time\n- Events by AWS Region\n- Recent Elastic IP Address Operations\n- Created Resources Over Time\n- Deleted Resources Over Time\n- Overview Geo Location of All Users Created Resources Deleted Resources Over Time Top 10 Users Failed Logins Created and Deleted Network and Security Events \n- Geo Location of All Users\n- Created Resources\n- Deleted Resources Over Time\n- Top 10 Users\n- Failed Logins\n- Created and Deleted Network and Security Events\n- S3 Public Objects and Buckets New Public Objects New Public Object by Object-Bucket New Public Objects Table Public Buckets Public Buckets Table Modified Public Objects Modified Public Objects by Object-Buket Modified Public Objects Table \n- New Public Objects\n- New Public Object by Object-Bucket\n- New Public Objects Table\n- Public Buckets\n- Public Buckets Table\n- Modified Public Objects\n- Modified Public Objects by Object-Buket\n- Modified Public Objects Table\n- User Monitoring Geo Location of All Users Top 10 Users Launched and Terminated Instances by User Administrative Activities Over Time Top 10 Activities by Administrative User Recent Activity by Administrative Users \n- Geo Location of All Users\n- Top 10 Users\n- Launched and Terminated Instances by User\n- Administrative Activities Over Time\n- Top 10 Activities by Administrative User\n- Recent Activity by Administrative Users  > 総評総評  > 使用コスト使用コスト \n\n初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。    ログ取込量/日 Azure Sentinel月額 Sumo Logic月額     100MB 2,396 JPY 0 USD   500MB 11,978 JPY 0 USD   3GB 71,870 JPY 332 USD    \n\n※ Azure Sentinelの内訳は「 ((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB 」  > 導入コスト導入コスト \n\n一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。  > SIEM機能SIEM機能 \n\nAzure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。 \n\nまた、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。  > WRAPUPWRAPUP \n\nメインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png"},"wip":false,"body_md":"IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。\r\n\r\n<img width=\"681\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png\">\r\n\r\n# PROBLEM\r\n- AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない\r\n    - 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい\r\n    - 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい\r\n        - NewRelicのように人のコストをかけずに管理したい\r\n\r\n# SOLUTION\r\nと言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。\r\n\r\n## Azure Sentinel\r\n### 料金\r\n- [Azure Sentinel の価格 | Microsoft Azure](https://azure.microsoft.com/ja-jp/pricing/details/azure-sentinel/)\r\n- [価格 - Azure Monitor | Microsoft Azure](https://azure.microsoft.com/ja-jp/pricing/details/monitor/)\r\n\r\n### SIEMからCloudTrailへの接続方法\r\n1. 下記設定でLog Analyticsワークスペースを作成\r\n    - サブスクリプション `無料試用版`\r\n    - リソース グループ `production`\r\n    - 名前 `prod-sentinel`\r\n    - 地域 `東日本`\r\n1. `[ワークスペースprod-sentinel - データコネクタ]` にて `[アマゾンウェブサービス]` コネクタページを開く\r\n1. `[AWSアカウント - IAM - ロール]` にて下記設定で `[別のAWSアカウント]` を作成\r\n    - アカウントID `{Microsoft account ID}`\r\n    - オプション\r\n        - `外部IDが必要` をチェック\r\n        - 外部ID `{外部ID (ワークスペースID)}`\r\n    - パーミッションポリシーを適用 `AWSCloudTrailReadOnlyAccess`\r\n    - ロール名 `AzureSentinel`\r\n    - ※ Cf.\r\n        - [AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs](https://docs.microsoft.com/ja-jp/azure/sentinel/connect-aws)\r\n        - [アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs](https://docs.microsoft.com/ja-jp/azure/architecture/reference-architectures/aws/aws-azure-security-solutions)\r\n        - [Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO](https://dev.classmethod.jp/articles/security-jaws-21-report/)\r\n\r\n### SIEM機能 (AWS CloudTrail)\r\n- デフォルト監視対象\r\n    - 時間経過に伴うイベントアラート\r\n    - 悪意ある可能性があるイベント\r\n    - 最近のインシデント\r\n    - データソースの異常\r\n- ログクエリ\r\n    - Audit\r\n    - Network\r\n    - Security\r\n- 脅威管理\r\n    - インシデント\r\n    - ブック ... 簡易な分析情報を提供\r\n        - AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。\r\n        - AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。\r\n    - ハンティング ... 脅威判定となるログクエリを提供\r\n        - Changes made to AWS IAM policy\r\n        - Tracking Privileged Account Rare Activity\r\n        - Exploit and Pentest Framework User Agent\r\n        - IAM Privilege Escalation by Instance Profile attachment\r\n        - Privileged role attached to Instance\r\n        - Suspicious credential token access of valid IAM Roles\r\n        - Unused or Unsupported Cloud Regions\r\n    - ノートブック ... Jupyter Notebookによる分析を提供\r\n- ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能\r\n    - Trend Micro Apex One\r\n    - McAfee Network Security Platform\r\n\r\n## Sumo Logic\r\n### 料金\r\n- [Sumo Logic 料金表](https://www.sumologic.jp/pricing/jp/)\r\n\r\n### SIEMからCloudTrailへの接続方法\r\n1. `[AWSアカウントSecurity - S3]` にてバケット `cloudtrail-accumulativelogs-{account-id}` を下記設定にて作成\r\n    - パブリックアクセスをすべてブロック `オフ`\r\n    - <details><summary>バケットポリシー</summary>\r\n\r\n        ```json\r\n        {\r\n            \"Version\": \"2012-10-17\",\r\n            \"Statement\": [\r\n                {\r\n                    \"Sid\": \"AWSCloudTrailAclCheck20150319\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"s3:GetBucketAcl\",\r\n                    \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\"\r\n                },\r\n                {\r\n                    \"Sid\": \"AWSCloudTrailWrite20150319\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"s3:PutObject\",\r\n                    \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"s3:x-amz-acl\": \"bucket-owner-full-control\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n        ```\r\n        </details>\r\n1. `[親AWSアカウント - KMS]` にて下記設定でKSMを作成\r\n    - キーのタイプ `対称`\r\n    - キーマテリアルオリジン `KMS`\r\n    - リージョンごと `単一リージョン`\r\n    - エイリアス名 `cloudtrail-kms`\r\n    - <details><summary>キーポリシー</summary>\r\n\r\n        ```json\r\n        {\r\n            \"Version\": \"2012-10-17\",\r\n            \"Id\": \"Key policy created by CloudTrail\",\r\n            \"Statement\": [\r\n                {\r\n                    \"Sid\": \"Enable IAM User Permissions\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": \"kms:*\",\r\n                    \"Resource\": \"*\"\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow CloudTrail to encrypt logs\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"kms:GenerateDataKey*\",\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringLike\": {\r\n                            \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow CloudTrail to describe key\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"Service\": \"cloudtrail.amazonaws.com\"\r\n                    },\r\n                    \"Action\": \"kms:DescribeKey\",\r\n                    \"Resource\": \"*\"\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow principals in the account to decrypt log files\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": [\r\n                        \"kms:Decrypt\",\r\n                        \"kms:ReEncryptFrom\"\r\n                    ],\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"kms:CallerAccount\": \"{account-id}\"\r\n                        },\r\n                        \"StringLike\": {\r\n                            \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"Sid\": \"Allow alias creation during setup\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": \"kms:CreateAlias\",\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"kms:CallerAccount\": \"{account-id}\",\r\n                            \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"Sid\": \"Enable cross account log decryption\",\r\n                    \"Effect\": \"Allow\",\r\n                    \"Principal\": {\r\n                        \"AWS\": \"*\"\r\n                    },\r\n                    \"Action\": [\r\n                        \"kms:Decrypt\",\r\n                        \"kms:ReEncryptFrom\"\r\n                    ],\r\n                    \"Resource\": \"*\",\r\n                    \"Condition\": {\r\n                        \"StringEquals\": {\r\n                            \"kms:CallerAccount\": \"{account-id}\"\r\n                        },\r\n                        \"StringLike\": {\r\n                            \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n        ```\r\n        </details>\r\n1. `[親AWSアカウント - CloudTrail]` にて下記設定で証跡を作成\r\n    - 全般的な詳細\r\n        - 証跡名 `cloudtrail-logs`\r\n        - 組織に証跡を適用 `はい`\r\n        - ストレージの場所 `既存のS3バケットを使用する`\r\n        - 証跡ログバケット名 `cloudtrail-accumulativelogs-{account-id}`\r\n        - ログファイルのSSE-KMS暗号化 `有効`\r\n        - カスタマー管理のAWS KMSキー `新規`\r\n        - AWS KMSエイリアス `arn:aws:kms:{region}:{account-id}:key/{kms-id}`\r\n        - ログファイルの検証 `有効`\r\n    - 管理イベント\r\n        - APIアクティビティ `すべて`\r\n1. `[Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail]` にて下記設定でCloudTrailデータタイプを作成\r\n    - Source Category `aws/cloudtrail`\r\n    - S3 Bucket\r\n        - S3 Bucket Name `cloudtrail-accumulativelogs-{account-id}`\r\n        - Path Expression `AWSLogs/{organization-id}/*`\r\n        - S3 Region `Asia Pacific (Tokyo)`\r\n        - How do you want the user to access the S3 Bucket? `Role-based access`\r\n            - 指定されたCFnテンプレートでIAMロールを作成\r\n\r\n### SIEM機能 (AWS CloudTrail)\r\nデフォルト監視対象\r\n- Console Logins\r\n    - Geo Location of All Users\r\n    - Login Events By User\r\n    - Logins Over Time\r\n    - Logins from Multiple IP\r\n    - Logins from Outside the USA\r\n    - Outlier - Success Login\r\n    - Outlier - Failed Login\r\n    - Login Results - One Day Time Comparison\r\n    - Logins without MFA\r\n- Network and Security\r\n    - Authorization Failures from All Countries\r\n    - Network and Security Events Over Time\r\n    - Authorization Failures Over Time\r\n    - Network ACL with All Allowed Ingress/Egress\r\n    - Recent Authorization Failures\r\n    - Recent Security Group and Network ACL Changes\r\n    - Created and Deleted Network  and Security Events\r\n    - Short Lived Critical Operations\r\n- Operations\r\n    - Action Events\r\n    - Requested AWS Services Over Time\r\n    - Events by AWS Region\r\n    - Recent Elastic IP Address Operations\r\n    - Created Resources Over Time\r\n    - Deleted Resources Over Time\r\n- Overview\r\n    - Geo Location of All Users\r\n    - Created Resources\r\n    - Deleted Resources Over Time\r\n    - Top 10 Users\r\n    - Failed Logins\r\n    - Created and Deleted Network and Security Events\r\n- S3 Public Objects and Buckets\r\n    - New Public Objects\r\n    - New Public Object by Object-Bucket\r\n    - New Public Objects Table\r\n    - Public Buckets\r\n    - Public Buckets Table\r\n    - Modified Public Objects\r\n    - Modified Public Objects by Object-Buket\r\n    - Modified Public Objects Table\r\n- User Monitoring\r\n    - Geo Location of All Users\r\n    - Top 10 Users\r\n    - Launched and Terminated Instances by User\r\n    - Administrative Activities Over Time\r\n    - Top 10 Activities by Administrative User\r\n    - Recent Activity by Administrative Users\r\n\r\n# 総評\r\n## 使用コスト\r\n初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。\r\n\r\n| ログ取込量/日 | Azure Sentinel月額 | Sumo Logic月額 |\r\n| --- | --- | --- |\r\n| 100MB | 2,396 JPY | 0 USD |\r\n| 500MB | 11,978 JPY | 0 USD |\r\n| 3GB | 71,870 JPY | 332 USD |\r\n\r\n※ Azure Sentinelの内訳は「 `((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB` 」\r\n\r\n## 導入コスト\r\n一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。\r\n\r\n## SIEM機能\r\nAzure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。\r\n\r\nまた、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。\r\n\r\n# WRAPUP\r\nメインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。","body_html":"<p data-sourcepos=\"1:1-1:243\">IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。</p>\n<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"681\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/08/15/97367/649a1db9-aa36-4be6-846b-bb34d1e1eb31.png\"></a>\n<h1 data-sourcepos=\"5:1-5:9\" id=\"1-0-0\" name=\"1-0-0\"><a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"6:1-10:0\">\n<li data-sourcepos=\"6:1-10:0\">AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない\n<ul data-sourcepos=\"7:5-10:0\">\n<li data-sourcepos=\"7:5-7:99\">可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい</li>\n<li data-sourcepos=\"8:5-10:0\">可能ならCloudTrail以外のIaaSリソースを監視対象にしたい\n<ul data-sourcepos=\"9:9-10:0\">\n<li data-sourcepos=\"9:9-10:0\">NewRelicのように人のコストをかけずに管理したい</li>\n</ul></li>\n</ul></li>\n</ul>\n<h1 data-sourcepos=\"11:1-11:10\" id=\"2-0-0\" name=\"2-0-0\"><a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"12:1-12:102\">と言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。</p>\n<h2 data-sourcepos=\"14:1-14:17\" id=\"2-1-0\" name=\"2-1-0\"><a class=\"anchor\" id=\"Azure Sentinel\" name=\"Azure Sentinel\" href=\"#Azure Sentinel\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Azure Sentinel\"> &gt; Azure Sentinel</span></a>Azure Sentinel</h2>\n<h3 data-sourcepos=\"15:1-15:10\" id=\"2-1-1\" name=\"2-1-1\"><a class=\"anchor\" id=\"料金\" name=\"料金\" href=\"#料金\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"料金\"> &gt; 料金</span></a>料金</h3>\n<ul data-sourcepos=\"16:1-18:0\">\n<li data-sourcepos=\"16:1-16:113\"><a href=\"https://azure.microsoft.com/ja-jp/pricing/details/azure-sentinel/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Sentinel の価格 | Microsoft Azure</a></li>\n<li data-sourcepos=\"17:1-18:0\"><a href=\"https://azure.microsoft.com/ja-jp/pricing/details/monitor/\" target=\"_blank\" rel=\"noopener noreferrer\">価格 - Azure Monitor | Microsoft Azure</a></li>\n</ul>\n<h3 data-sourcepos=\"19:1-19:42\" id=\"2-1-2\" name=\"2-1-2\"><a class=\"anchor\" id=\"SIEMからCloudTrailへの接続方法\" name=\"SIEMからCloudTrailへの接続方法\" href=\"#SIEMからCloudTrailへの接続方法\" data-position=\"2-1-2\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEMからCloudTrailへの接続方法\"> &gt; SIEMからCloudTrailへの接続方法</span></a>SIEMからCloudTrailへの接続方法</h3>\n<ol data-sourcepos=\"20:1-37:0\">\n<li data-sourcepos=\"20:1-24:24\">下記設定でLog Analyticsワークスペースを作成\n<ul data-sourcepos=\"21:5-24:24\">\n<li data-sourcepos=\"21:5-21:51\">サブスクリプション <code>無料試用版</code></li>\n<li data-sourcepos=\"22:5-22:44\">リソース グループ <code>production</code></li>\n<li data-sourcepos=\"23:5-23:28\">名前 <code>prod-sentinel</code></li>\n<li data-sourcepos=\"24:5-24:24\">地域 <code>東日本</code></li>\n</ul>\n</li>\n<li data-sourcepos=\"25:1-25:141\"><code>[ワークスペースprod-sentinel - データコネクタ]</code> にて <code>[アマゾンウェブサービス]</code> コネクタページを開く</li>\n<li data-sourcepos=\"26:1-37:0\"><code>[AWSアカウント - IAM - ロール]</code> にて下記設定で <code>[別のAWSアカウント]</code> を作成\n<ul data-sourcepos=\"27:5-37:0\">\n<li data-sourcepos=\"27:5-27:48\">アカウントID <code>{Microsoft account ID}</code></li>\n<li data-sourcepos=\"28:5-30:57\">オプション\n<ul data-sourcepos=\"29:9-30:57\">\n<li data-sourcepos=\"29:9-29:45\"><code>外部IDが必要</code> をチェック</li>\n<li data-sourcepos=\"30:9-30:57\">外部ID <code>{外部ID (ワークスペースID)}</code></li>\n</ul></li>\n<li data-sourcepos=\"31:5-31:78\">パーミッションポリシーを適用 <code>AWSCloudTrailReadOnlyAccess</code></li>\n<li data-sourcepos=\"32:5-32:34\">ロール名 <code>AzureSentinel</code></li>\n<li data-sourcepos=\"33:5-37:0\">※ Cf.\n<ul data-sourcepos=\"34:9-37:0\">\n<li data-sourcepos=\"34:9-34:139\"><a href=\"https://docs.microsoft.com/ja-jp/azure/sentinel/connect-aws\" target=\"_blank\" rel=\"noopener noreferrer\">AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs</a></li>\n<li data-sourcepos=\"35:9-35:240\"><a href=\"https://docs.microsoft.com/ja-jp/azure/architecture/reference-architectures/aws/aws-azure-security-solutions\" target=\"_blank\" rel=\"noopener noreferrer\">アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs</a></li>\n<li data-sourcepos=\"36:9-37:0\"><a href=\"https://dev.classmethod.jp/articles/security-jaws-21-report/\" target=\"_blank\" rel=\"noopener noreferrer\">Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO</a></li>\n</ul></li>\n</ul>\n</li>\n</ol>\n<h3 data-sourcepos=\"38:1-38:31\" id=\"2-1-3\" name=\"2-1-3\"><a class=\"anchor\" id=\"SIEM機能 (AWS CloudTrail)\" name=\"SIEM機能 (AWS CloudTrail)\" href=\"#SIEM機能 (AWS CloudTrail)\" data-position=\"2-1-3\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEM機能 (AWS CloudTrail)\"> &gt; SIEM機能 (AWS CloudTrail)</span></a>SIEM機能 (AWS CloudTrail)</h3>\n<ul data-sourcepos=\"39:1-65:0\">\n<li data-sourcepos=\"39:1-43:33\">デフォルト監視対象\n<ul data-sourcepos=\"40:5-43:33\">\n<li data-sourcepos=\"40:5-40:51\">時間経過に伴うイベントアラート</li>\n<li data-sourcepos=\"41:5-41:48\">悪意ある可能性があるイベント</li>\n<li data-sourcepos=\"42:5-42:33\">最近のインシデント</li>\n<li data-sourcepos=\"43:5-43:33\">データソースの異常</li>\n</ul></li>\n<li data-sourcepos=\"44:1-47:14\">ログクエリ\n<ul data-sourcepos=\"45:5-47:14\">\n<li data-sourcepos=\"45:5-45:11\">Audit</li>\n<li data-sourcepos=\"46:5-46:13\">Network</li>\n<li data-sourcepos=\"47:5-47:14\">Security</li>\n</ul></li>\n<li data-sourcepos=\"48:1-61:69\">脅威管理\n<ul data-sourcepos=\"49:5-61:69\">\n<li data-sourcepos=\"49:5-49:24\">インシデント</li>\n<li data-sourcepos=\"50:5-52:364\">ブック ... 簡易な分析情報を提供\n<ul data-sourcepos=\"51:9-52:364\">\n<li data-sourcepos=\"51:9-51:263\">AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。</li>\n<li data-sourcepos=\"52:9-52:364\">AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。</li>\n</ul></li>\n<li data-sourcepos=\"53:5-60:45\">ハンティング ... 脅威判定となるログクエリを提供\n<ul data-sourcepos=\"54:9-60:45\">\n<li data-sourcepos=\"54:9-54:40\">Changes made to AWS IAM policy</li>\n<li data-sourcepos=\"55:9-55:51\">Tracking Privileged Account Rare Activity</li>\n<li data-sourcepos=\"56:9-56:50\">Exploit and Pentest Framework User Agent</li>\n<li data-sourcepos=\"57:9-57:65\">IAM Privilege Escalation by Instance Profile attachment</li>\n<li data-sourcepos=\"58:9-58:46\">Privileged role attached to Instance</li>\n<li data-sourcepos=\"59:9-59:63\">Suspicious credential token access of valid IAM Roles</li>\n<li data-sourcepos=\"60:9-60:45\">Unused or Unsupported Cloud Regions</li>\n</ul></li>\n<li data-sourcepos=\"61:5-61:69\">ノートブック ... Jupyter Notebookによる分析を提供</li>\n</ul></li>\n<li data-sourcepos=\"62:1-65:0\">ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能\n<ul data-sourcepos=\"63:5-65:0\">\n<li data-sourcepos=\"63:5-63:26\">Trend Micro Apex One</li>\n<li data-sourcepos=\"64:5-65:0\">McAfee Network Security Platform</li>\n</ul></li>\n</ul>\n<h2 data-sourcepos=\"66:1-66:13\" id=\"2-2-0\" name=\"2-2-0\"><a class=\"anchor\" id=\"Sumo Logic\" name=\"Sumo Logic\" href=\"#Sumo Logic\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Sumo Logic\"> &gt; Sumo Logic</span></a>Sumo Logic</h2>\n<h3 data-sourcepos=\"67:1-67:10\" id=\"2-2-1\" name=\"2-2-1\"><a class=\"anchor\" id=\"料金-1\" name=\"料金-1\" href=\"#料金-1\" data-position=\"2-2-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"料金\"> &gt; 料金</span></a>料金</h3>\n<ul data-sourcepos=\"68:1-69:0\">\n<li data-sourcepos=\"68:1-69:0\"><a href=\"https://www.sumologic.jp/pricing/jp/\" target=\"_blank\" rel=\"noopener noreferrer\">Sumo Logic 料金表</a></li>\n</ul>\n<h3 data-sourcepos=\"70:1-70:42\" id=\"2-2-2\" name=\"2-2-2\"><a class=\"anchor\" id=\"SIEMからCloudTrailへの接続方法-1\" name=\"SIEMからCloudTrailへの接続方法-1\" href=\"#SIEMからCloudTrailへの接続方法-1\" data-position=\"2-2-2\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEMからCloudTrailへの接続方法\"> &gt; SIEMからCloudTrailへの接続方法</span></a>SIEMからCloudTrailへの接続方法</h3>\n<ol data-sourcepos=\"71:1-229:0\">\n<li data-sourcepos=\"71:1-105:18\"><code>[AWSアカウントSecurity - S3]</code> にてバケット <code>cloudtrail-accumulativelogs-{account-id}</code> を下記設定にて作成\n<ul data-sourcepos=\"72:5-105:18\">\n<li data-sourcepos=\"72:5-72:66\"><p data-sourcepos=\"72:7-72:66\">パブリックアクセスをすべてブロック <code>オフ</code></p></li>\n<li data-sourcepos=\"73:5-105:18\"><details><summary>バケットポリシー</summary>\n<div class=\"code-block\" data-sourcepos=\"75:9-104:11\"><div class=\"code-filename\"><i class=\"fa fa-file-code-o\"></i>json</div><div class=\"highlight\"><pre class=\"highlight json\"><code><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nl\">\"Version\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2012-10-17\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"Statement\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AWSCloudTrailAclCheck20150319\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"s3:GetBucketAcl\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\"</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AWSCloudTrailWrite20150319\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"s3:PutObject\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"s3:x-amz-acl\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"bucket-owner-full-control\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">}</span><span class=\"w\">\n    </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre></div></div>\n  </details></li>\n</ul>\n</li>\n<li data-sourcepos=\"106:1-208:18\"><code>[親AWSアカウント - KMS]</code> にて下記設定でKSMを作成\n<ul data-sourcepos=\"107:5-208:18\">\n<li data-sourcepos=\"107:5-107:33\"><p data-sourcepos=\"107:7-107:33\">キーのタイプ <code>対称</code></p></li>\n<li data-sourcepos=\"108:5-108:45\"><p data-sourcepos=\"108:7-108:45\">キーマテリアルオリジン <code>KMS</code></p></li>\n<li data-sourcepos=\"109:5-109:51\"><p data-sourcepos=\"109:7-109:51\">リージョンごと <code>単一リージョン</code></p></li>\n<li data-sourcepos=\"110:5-110:41\"><p data-sourcepos=\"110:7-110:41\">エイリアス名 <code>cloudtrail-kms</code></p></li>\n<li data-sourcepos=\"111:5-208:18\"><details><summary>キーポリシー</summary>\n<div class=\"code-block\" data-sourcepos=\"113:9-207:11\"><div class=\"code-filename\"><i class=\"fa fa-file-code-o\"></i>json</div><div class=\"highlight\"><pre class=\"highlight json\"><code><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nl\">\"Version\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2012-10-17\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"Id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Key policy created by CloudTrail\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"Statement\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Enable IAM User Permissions\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow CloudTrail to encrypt logs\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:GenerateDataKey*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringLike\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:EncryptionContext:aws:cloudtrail:arn\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:cloudtrail:*:{account-id}:trail/*\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow CloudTrail to describe key\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"Service\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cloudtrail.amazonaws.com\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:DescribeKey\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow principals in the account to decrypt log files\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:Decrypt\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:ReEncryptFrom\"</span><span class=\"w\">\n            </span><span class=\"p\">],</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:CallerAccount\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"{account-id}\"</span><span class=\"w\">\n                </span><span class=\"p\">},</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringLike\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:EncryptionContext:aws:cloudtrail:arn\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:cloudtrail:*:{account-id}:trail/*\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow alias creation during setup\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"kms:CreateAlias\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:CallerAccount\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"{account-id}\"</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:ViaService\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"ec2.ap-northeast-1.amazonaws.com\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">},</span><span class=\"w\">\n        </span><span class=\"p\">{</span><span class=\"w\">\n            </span><span class=\"nl\">\"Sid\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Enable cross account log decryption\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Effect\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Principal\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"AWS\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\">\n            </span><span class=\"p\">},</span><span class=\"w\">\n            </span><span class=\"nl\">\"Action\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:Decrypt\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"s2\">\"kms:ReEncryptFrom\"</span><span class=\"w\">\n            </span><span class=\"p\">],</span><span class=\"w\">\n            </span><span class=\"nl\">\"Resource\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\">\n            </span><span class=\"nl\">\"Condition\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringEquals\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:CallerAccount\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"{account-id}\"</span><span class=\"w\">\n                </span><span class=\"p\">},</span><span class=\"w\">\n                </span><span class=\"nl\">\"StringLike\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n                    </span><span class=\"nl\">\"kms:EncryptionContext:aws:cloudtrail:arn\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"arn:aws:cloudtrail:*:{account-id}:trail/*\"</span><span class=\"w\">\n                </span><span class=\"p\">}</span><span class=\"w\">\n            </span><span class=\"p\">}</span><span class=\"w\">\n        </span><span class=\"p\">}</span><span class=\"w\">\n    </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre></div></div>\n  </details></li>\n</ul>\n</li>\n<li data-sourcepos=\"209:1-220:46\"><code>[親AWSアカウント - CloudTrail]</code> にて下記設定で証跡を作成\n<ul data-sourcepos=\"210:5-220:46\">\n<li data-sourcepos=\"210:5-218:46\">全般的な詳細\n<ul data-sourcepos=\"211:9-218:46\">\n<li data-sourcepos=\"211:9-211:37\">証跡名 <code>cloudtrail-logs</code></li>\n<li data-sourcepos=\"212:9-212:43\">組織に証跡を適用 <code>はい</code></li>\n<li data-sourcepos=\"213:9-213:75\">ストレージの場所 <code>既存のS3バケットを使用する</code></li>\n<li data-sourcepos=\"214:9-214:80\">証跡ログバケット名 <code>cloudtrail-accumulativelogs-{account-id}</code></li>\n<li data-sourcepos=\"215:9-215:56\">ログファイルのSSE-KMS暗号化 <code>有効</code></li>\n<li data-sourcepos=\"216:9-216:56\">カスタマー管理のAWS KMSキー <code>新規</code></li>\n<li data-sourcepos=\"217:9-217:81\">AWS KMSエイリアス <code>arn:aws:kms:{region}:{account-id}:key/{kms-id}</code></li>\n<li data-sourcepos=\"218:9-218:46\">ログファイルの検証 <code>有効</code></li>\n</ul></li>\n<li data-sourcepos=\"219:5-220:46\">管理イベント\n<ul data-sourcepos=\"220:9-220:46\">\n<li data-sourcepos=\"220:9-220:46\">APIアクティビティ <code>すべて</code></li>\n</ul></li>\n</ul>\n</li>\n<li data-sourcepos=\"221:1-229:0\"><code>[Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail]</code> にて下記設定でCloudTrailデータタイプを作成\n<ul data-sourcepos=\"222:5-229:0\">\n<li data-sourcepos=\"222:5-222:38\">Source Category <code>aws/cloudtrail</code></li>\n<li data-sourcepos=\"223:5-229:0\">S3 Bucket\n<ul data-sourcepos=\"224:9-229:0\">\n<li data-sourcepos=\"224:9-224:67\">S3 Bucket Name <code>cloudtrail-accumulativelogs-{account-id}</code></li>\n<li data-sourcepos=\"225:9-225:55\">Path Expression <code>AWSLogs/{organization-id}/*</code></li>\n<li data-sourcepos=\"226:9-226:42\">S3 Region <code>Asia Pacific (Tokyo)</code></li>\n<li data-sourcepos=\"227:9-229:0\">How do you want the user to access the S3 Bucket? <code>Role-based access</code><ul data-sourcepos=\"228:13-229:0\">\n<li data-sourcepos=\"228:13-229:0\">指定されたCFnテンプレートでIAMロールを作成</li>\n</ul></li>\n</ul></li>\n</ul>\n</li>\n</ol>\n<h3 data-sourcepos=\"230:1-230:31\" id=\"2-2-3\" name=\"2-2-3\"><a class=\"anchor\" id=\"SIEM機能 (AWS CloudTrail)-1\" name=\"SIEM機能 (AWS CloudTrail)-1\" href=\"#SIEM機能 (AWS CloudTrail)-1\" data-position=\"2-2-3\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEM機能 (AWS CloudTrail)\"> &gt; SIEM機能 (AWS CloudTrail)</span></a>SIEM機能 (AWS CloudTrail)</h3>\n<p data-sourcepos=\"231:1-231:27\">デフォルト監視対象</p>\n<ul data-sourcepos=\"232:1-281:0\">\n<li data-sourcepos=\"232:1-241:24\">Console Logins\n<ul data-sourcepos=\"233:5-241:24\">\n<li data-sourcepos=\"233:5-233:31\">Geo Location of All Users</li>\n<li data-sourcepos=\"234:5-234:26\">Login Events By User</li>\n<li data-sourcepos=\"235:5-235:22\">Logins Over Time</li>\n<li data-sourcepos=\"236:5-236:29\">Logins from Multiple IP</li>\n<li data-sourcepos=\"237:5-237:33\">Logins from Outside the USA</li>\n<li data-sourcepos=\"238:5-238:29\">Outlier - Success Login</li>\n<li data-sourcepos=\"239:5-239:28\">Outlier - Failed Login</li>\n<li data-sourcepos=\"240:5-240:45\">Login Results - One Day Time Comparison</li>\n<li data-sourcepos=\"241:5-241:24\">Logins without MFA</li>\n</ul></li>\n<li data-sourcepos=\"242:1-250:37\">Network and Security\n<ul data-sourcepos=\"243:5-250:37\">\n<li data-sourcepos=\"243:5-243:47\">Authorization Failures from All Countries</li>\n<li data-sourcepos=\"244:5-244:43\">Network and Security Events Over Time</li>\n<li data-sourcepos=\"245:5-245:38\">Authorization Failures Over Time</li>\n<li data-sourcepos=\"246:5-246:49\">Network ACL with All Allowed Ingress/Egress</li>\n<li data-sourcepos=\"247:5-247:35\">Recent Authorization Failures</li>\n<li data-sourcepos=\"248:5-248:51\">Recent Security Group and Network ACL Changes</li>\n<li data-sourcepos=\"249:5-249:54\">Created and Deleted Network  and Security Events</li>\n<li data-sourcepos=\"250:5-250:37\">Short Lived Critical Operations</li>\n</ul></li>\n<li data-sourcepos=\"251:1-257:33\">Operations\n<ul data-sourcepos=\"252:5-257:33\">\n<li data-sourcepos=\"252:5-252:19\">Action Events</li>\n<li data-sourcepos=\"253:5-253:38\">Requested AWS Services Over Time</li>\n<li data-sourcepos=\"254:5-254:26\">Events by AWS Region</li>\n<li data-sourcepos=\"255:5-255:42\">Recent Elastic IP Address Operations</li>\n<li data-sourcepos=\"256:5-256:33\">Created Resources Over Time</li>\n<li data-sourcepos=\"257:5-257:33\">Deleted Resources Over Time</li>\n</ul></li>\n<li data-sourcepos=\"258:1-264:53\">Overview\n<ul data-sourcepos=\"259:5-264:53\">\n<li data-sourcepos=\"259:5-259:31\">Geo Location of All Users</li>\n<li data-sourcepos=\"260:5-260:23\">Created Resources</li>\n<li data-sourcepos=\"261:5-261:33\">Deleted Resources Over Time</li>\n<li data-sourcepos=\"262:5-262:18\">Top 10 Users</li>\n<li data-sourcepos=\"263:5-263:19\">Failed Logins</li>\n<li data-sourcepos=\"264:5-264:53\">Created and Deleted Network and Security Events</li>\n</ul></li>\n<li data-sourcepos=\"265:1-273:35\">S3 Public Objects and Buckets\n<ul data-sourcepos=\"266:5-273:35\">\n<li data-sourcepos=\"266:5-266:24\">New Public Objects</li>\n<li data-sourcepos=\"267:5-267:40\">New Public Object by Object-Bucket</li>\n<li data-sourcepos=\"268:5-268:30\">New Public Objects Table</li>\n<li data-sourcepos=\"269:5-269:20\">Public Buckets</li>\n<li data-sourcepos=\"270:5-270:26\">Public Buckets Table</li>\n<li data-sourcepos=\"271:5-271:29\">Modified Public Objects</li>\n<li data-sourcepos=\"272:5-272:45\">Modified Public Objects by Object-Buket</li>\n<li data-sourcepos=\"273:5-273:35\">Modified Public Objects Table</li>\n</ul></li>\n<li data-sourcepos=\"274:1-281:0\">User Monitoring\n<ul data-sourcepos=\"275:5-281:0\">\n<li data-sourcepos=\"275:5-275:31\">Geo Location of All Users</li>\n<li data-sourcepos=\"276:5-276:18\">Top 10 Users</li>\n<li data-sourcepos=\"277:5-277:47\">Launched and Terminated Instances by User</li>\n<li data-sourcepos=\"278:5-278:41\">Administrative Activities Over Time</li>\n<li data-sourcepos=\"279:5-279:46\">Top 10 Activities by Administrative User</li>\n<li data-sourcepos=\"280:5-281:0\">Recent Activity by Administrative Users</li>\n</ul></li>\n</ul>\n<h1 data-sourcepos=\"282:1-282:8\" id=\"3-0-0\" name=\"3-0-0\"><a class=\"anchor\" id=\"総評\" name=\"総評\" href=\"#総評\" data-position=\"3-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"総評\"> &gt; 総評</span></a>総評</h1>\n<h2 data-sourcepos=\"283:1-283:18\" id=\"3-1-0\" name=\"3-1-0\"><a class=\"anchor\" id=\"使用コスト\" name=\"使用コスト\" href=\"#使用コスト\" data-position=\"3-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"使用コスト\"> &gt; 使用コスト</span></a>使用コスト</h2>\n<p data-sourcepos=\"284:1-284:102\">初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。</p>\n<table data-sourcepos=\"286:1-290:30\">\n<thead>\n<tr data-sourcepos=\"286:1-286:65\">\n<th data-sourcepos=\"286:2-286:22\">ログ取込量/日</th>\n<th data-sourcepos=\"286:24-286:45\">Azure Sentinel月額</th>\n<th data-sourcepos=\"286:47-286:64\">Sumo Logic月額</th>\n</tr>\n</thead>\n<tbody>\n<tr data-sourcepos=\"288:1-288:29\">\n<td data-sourcepos=\"288:2-288:8\">100MB</td>\n<td data-sourcepos=\"288:10-288:20\">2,396 JPY</td>\n<td data-sourcepos=\"288:22-288:28\">0 USD</td>\n</tr>\n<tr data-sourcepos=\"289:1-289:30\">\n<td data-sourcepos=\"289:2-289:8\">500MB</td>\n<td data-sourcepos=\"289:10-289:21\">11,978 JPY</td>\n<td data-sourcepos=\"289:23-289:29\">0 USD</td>\n</tr>\n<tr data-sourcepos=\"290:1-290:30\">\n<td data-sourcepos=\"290:2-290:6\">3GB</td>\n<td data-sourcepos=\"290:8-290:19\">71,870 JPY</td>\n<td data-sourcepos=\"290:21-290:29\">332 USD</td>\n</tr>\n</tbody>\n</table>\n<p data-sourcepos=\"292:1-292:153\">※ Azure Sentinelの内訳は「 <code>((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB</code> 」</p>\n<h2 data-sourcepos=\"294:1-294:18\" id=\"3-2-0\" name=\"3-2-0\"><a class=\"anchor\" id=\"導入コスト\" name=\"導入コスト\" href=\"#導入コスト\" data-position=\"3-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"導入コスト\"> &gt; 導入コスト</span></a>導入コスト</h2>\n<p data-sourcepos=\"295:1-295:249\">一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。</p>\n<h2 data-sourcepos=\"297:1-297:13\" id=\"3-3-0\" name=\"3-3-0\"><a class=\"anchor\" id=\"SIEM機能\" name=\"SIEM機能\" href=\"#SIEM機能\" data-position=\"3-3-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SIEM機能\"> &gt; SIEM機能</span></a>SIEM機能</h2>\n<p data-sourcepos=\"298:1-298:558\">Azure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。</p>\n<p data-sourcepos=\"300:1-300:267\">また、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。</p>\n<h1 data-sourcepos=\"302:1-302:8\" id=\"4-0-0\" name=\"4-0-0\"><a class=\"anchor\" id=\"WRAPUP\" name=\"WRAPUP\" href=\"#WRAPUP\" data-position=\"4-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"WRAPUP\"> &gt; WRAPUP</span></a>WRAPUP</h1>\n<p data-sourcepos=\"303:1-303:368\">メインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。</p>\n","tags":["siem","aws-cloudtrail","azure-sentinel","sumo-logic"],"updated_at":"2021-08-15T01:40:12+09:00","childPublishedDate":{"published_on":"2021-08-15T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_7b757a0db07cde6a337af7df901ab0c5.jpg"}},"relatedPosts":{"edges":[{"node":{"number":55,"relative_category":"blog/backend","fields":{"title":"PositiveSSLをHerokuに適用する","excerpt":"年に1回のSSL更新のイベントです。毎年同じことをすれば良いかというとそうでもなく、販社と卸の都合でSSLの購入方法が微妙に変わります。とは言え、毎年一から調べ直すのも手間なので備忘として記しておきます。  > PROBLEMPROBLEM \n\n- HerokuのSSLの期限がきた  > SOLUTIONSOLUTION \n\n- というわけで、いつも使っているSSL販売代理店SSLs.com（NameCheap社）でPositiveSSL（運用Comodo社）を購入しHerokuに適用します。  > HOWTOHOWTO \n\n1. 証明書を購入する SSL販売代理店であればどこでもいいのですが、昔から使っているので \n2. SSL販売代理店であればどこでもいいのですが、昔から使っているので\n3. 秘密鍵と署名リクエストをつくる 秘密鍵 openssl genrsa -des3 -out server.orig.key 2048 秘密鍵パスワードなしopenssl rsa -in server.orig.key -out server.key 署名リクエスト openssl req -new -key server.key -out server.csr ※ 最近このあたりの署名情報は、SSL販売代理店側で生成しているケースが増えてきました \n4. 秘密鍵 openssl genrsa -des3 -out server.orig.key 2048\n5. 秘密鍵パスワードなしopenssl rsa -in server.orig.key -out server.key\n6. 署名リクエスト openssl req -new -key server.key -out server.csr\n7. ※ 最近このあたりの署名情報は、SSL販売代理店側で生成しているケースが増えてきました\n8. 証明書発行を申請する SSL販売代理店より署名リクエストserver.csrと関連情報を送信します \n9. SSL販売代理店より署名リクエストserver.csrと関連情報を送信します\n10. ドメイン保持の証明をする PositiveSSLの運用会社Comodoに対しドメイン保持の証明します 証明方法はメールを受信する、あるいは、Webサイトにプレーンテキストを設置するかの2択になります \n11. PositiveSSLの運用会社Comodoに対しドメイン保持の証明します\n12. 証明方法はメールを受信する、あるいは、Webサイトにプレーンテキストを設置するかの2択になります\n13. Heroku用の証明書をつくる 証明タスクをこなししばらくすると、Comodo社より複数の証明書が送られてきます Heroku用に証明書をつくる cat www_example_com.crt COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt > server.crt \n14. 証明タスクをこなししばらくすると、Comodo社より複数の証明書が送られてきます\n15. Heroku用に証明書をつくる cat www_example_com.crt COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt > server.crt\n16. Herokuに証明書を適用する 新規で適用する場合は次のコマンドを実行します heroku addons:add ssl:endpoint heroku certs:add server.crt server.key 更新する場合は次のコマンドを実行します heroku certs:update server.crt server.key \n17. 新規で適用する場合は次のコマンドを実行します heroku addons:add ssl:endpoint heroku certs:add server.crt server.key \n18. heroku addons:add ssl:endpoint\n19. heroku certs:add server.crt server.key\n20. 更新する場合は次のコマンドを実行します heroku certs:update server.crt server.key \n21. heroku certs:update server.crt server.key  > WRAPUPWRAPUP \n\nこのあたりが自動化されれば良いと思いつつ、自動化されたらこのあたりを調べるモチベーションがなくなるので年に一回のリハビリイベントとして位置づけておきます、はい。  > 後日談後日談 \n\n現在はAutomated Certificate Management (ACM) 機能が用意されています。そちらを使う方が手間・実費ともにリーズナブルで、リハビリさえもいらなくなりました。以下適用方法。 \n\n1. ACMを有効化します。有効化するまでしばし時間がかかるので watch コマンドをつけて様子見します watch heroku certs:auto:enable \n2. watch heroku certs:auto:enable\n3. 手動で追加した証明書があるか確認します heroku certs \n4. heroku certs\n5. もし手動で追加した証明書がある場合は当該証明書を削除します heroku certs:remove --name foo-bar \n6. heroku certs:remove --name foo-bar"},"name":"[2017-04-23]PositiveSSLをHerokuに適用する","tags":[],"childPublishedDate":{"published_on":"2017-04-23T00:00:00.000Z","published_on_unix":1492905600}}},{"node":{"number":140,"relative_category":"blog/backend","fields":{"title":"提供していない決済方法を業務で取り扱う際に気をつけること","excerpt":"ECプロダクトを扱っている際にどうしても出てくる銀行振込。プロダクト立ち上げ時は、銀行振込が第一にあるターゲット層を除いて、コストの高い銀行振込は実装せずに裏メニューとして扱うのが通例だと思います。今回は、当該ケースの課題を取り上げて、その解決策を示します。単純な話なのですが、時間が経つにつれて業務が硬直化してスケーリングに影響してくるので事前に手を打っておくと良いと思います。   > PROBLEMPROBLEM \n\n- 銀行振込を通常決済方法でしか提供していないケースの場合 人力でトランザクションをはる必要があり、その処理の隙間で想定外の支払い、あるいは、二重決済が行われる可能性がある また、不整合処理を実施するCSあるいはそれに付随する担当に権限が集中しすぎ、統制上難しい運用になる \n- 人力でトランザクションをはる必要があり、その処理の隙間で想定外の支払い、あるいは、二重決済が行われる可能性がある\n- また、不整合処理を実施するCSあるいはそれに付随する担当に権限が集中しすぎ、統制上難しい運用になる  > 通常のケース通常のケース \n\n  > 不整合が起きるケース「銀行振込と通常決済が同時に実行」不整合が起きるケース「銀行振込と通常決済が同時に実行」 \n\n  > SOLUTIONSOLUTION \n\nと言うわけで、解決方法を整理してみました。答えは単純で銀行振込の決済ロックをシステム側に実装するというだけの話です。ただ、振込確認を人力で行っている場合は、銀行振込を決済方法として表側に出すのは難しいので問い合わせタイミングでロックできるよう問い合わせ窓口を工夫する必要があります。プロダクトのUXに関わってくる話なので簡単に実装するだけで済まないのが悩ましいところですが、粘り強く進めるしかないです。 \n\n  > WRAPUPWRAPUP \n\nECプロダクトがスケールしてくると決済方法が増え、業務処理が複雑になってきます。決済の適正性は統制上重要になってくるので決済の処理量に応じて、リスクアセスメントで拾い上げ適切な実装にしていきたいものですね。"},"name":"[2022-05-02]提供していない決済方法を業務で取り扱う際に気をつけること","tags":["payment-service"],"childPublishedDate":{"published_on":"2022-05-02T00:00:00.000Z","published_on_unix":1651449600}}},{"node":{"number":139,"relative_category":"blog/backend","fields":{"title":"ヘルステック界隈のエンジニアが気をつけるべき個人情報の扱い","excerpt":"ヘルステックでエンジニアをしている方であればデータの扱いには苦労していることと思います。CISOがつくったデータセグメンテーションがどういう意図で成り立っているのか、整理されていない現場だと読み解きに時間がかかります。現場に入って早々 何も知らないエンジニアとしては、緩めな方針よりは保守的に設計していく方が後々のトラブルが少なく安全です。   > PROBLEMPROBLEM \n\n- 要配慮個人情報について、厚労省医政局発「医療情報システムの安全管理に関するガイドライン」1を見ると「 医療・健康情報を[..]医師等以外の者が分析等を実施することは許されるものではない 」と書かれている ここでいう「 医療・健康情報 」は要配慮個人情報の中の具体的に何を指しているのか分かりづらい 「 医師等 」の「 等 」が何を指すのか分かりづらい 厚労省医政局の発令0912001号「診療情報の提供等に関する指針」2から推察するに、「 医療・健康情報 」は診療録、「 医師等 」は医療系有資格者を指している 医療系有資格者については、個人情報保護法の関連で出された医療・介護分野用「医療・介護関係事業者における個人情報の適切な取扱いのためのガイダンス」に掲載されている守秘義務対象 \n- ここでいう「 医療・健康情報 」は要配慮個人情報の中の具体的に何を指しているのか分かりづらい\n- 「 医師等 」の「 等 」が何を指すのか分かりづらい\n- 厚労省医政局の発令0912001号「診療情報の提供等に関する指針」2から推察するに、「 医療・健康情報 」は診療録、「 医師等 」は医療系有資格者を指している 医療系有資格者については、個人情報保護法の関連で出された医療・介護分野用「医療・介護関係事業者における個人情報の適切な取扱いのためのガイダンス」に掲載されている守秘義務対象 \n- 医療系有資格者については、個人情報保護法の関連で出された医療・介護分野用「医療・介護関係事業者における個人情報の適切な取扱いのためのガイダンス」に掲載されている守秘義務対象\n- また、データアクセス対象を緩めると、教育が不十分な人が故意に流出させ刑法上の秘密漏示罪3に問われる可能性がある 秘密漏示罪は身分犯ではあるが歯科医師のように解釈の余地もあり範囲が不透明 \n- 秘密漏示罪は身分犯ではあるが歯科医師のように解釈の余地もあり範囲が不透明  > SOLUTIONSOLUTION \n\nというわけで、ヘルステックに関わる個人情報の扱いを整理してみました。 \n\n課題は上記の通りで、時代の流れとともに医療情報の整備が進んでいる状況です。善管注意の責務を負ったエンジニアとしては医療系有資格者以外への診療録の情報提供は、例え、同僚であっても連結可能匿名（仮名加工）ではなく匿名加工で対応すべきでしょう。ゆくゆくは会社として次世代医療基盤法4を適用し、医療分野の研究開発に資するよう体制を構築することが望ましいと考えています。  > 加工なし加工なし \n\n学術研究等をのぞき第三者提供は本人同意が必要となるため、ユースケースは限定されます。各々の個人情報の種類によりアクセス出来る人が変わってきます。また、守秘義務が課せられる範囲が広く、行為によっては秘密漏示罪や不正アクセス禁止法5の罰則の対象になります。     診療録 診療録を除いた要配慮個人情報 要配慮個人情報を除いた個人情報     使用場所 社内 (医療関連有資格者) 社内 社内, 社外   利用目的の必要性 (公表有無) 必要 必要 必要   利用目的の必要性 (変更可否) 関連性を有する合理的な範囲 関連性を有する合理的な範囲 関連性を有する合理的な範囲   目的外利用 不可 不可 不可   第三者提供 (可否) 可 可 可   第三者提供 (本人同意) 必要 (オプトインのみ) 必要 (オプトインのみ) 必要 (オプトアウト)   個人の開示請求 応じる 応じる 応じる   漏洩時の報告 必須 必須 必須     > 仮名加工仮名加工 \n\n診療録に関する規定は次世代医療基盤法でまとめられているので、あえて規定が曖昧な仮名加工（連結可能匿名）をつかうのは望ましくありません。ユースケースとして要配慮個人情報を除いた個人情報の統計分析に限られるでしょう。     診療録を除いた要配慮個人情報 要配慮個人情報を除いた個人情報     使用場所 社内 社内   利用目的の必要性 (公表有無) 必要 必要   利用目的の必要性 (変更可否) 際限なく変更可能 際限なく変更可能   目的外利用 不可 不可   第三者提供 (可否) 不可 不可   個人の開示請求 応じない 応じない   漏洩時の報告 なし なし     > 匿名加工匿名加工 \n\n診療録は本人のオプトアウトありですが、基本本人同意なしで利用可能です。ただ、診療録は可変長文字列の上、特異な記述として最も気をつける対象になります。データマスキングの実装は手厚く行っていく必要があります。     診療録を含んだ要配慮個人情報 要配慮個人情報を除いた個人情報     使用場所 社内, 社外 社内, 社外   利用目的の必要性 (公表有無) 不要 不要   第三者提供 (可否) 可 可   第三者提供 (本人同意) 不要 (オプトアウトあり) 不要   個人の開示請求 応じない 応じない   漏洩時の報告 なし なし     > WRAPUPWRAPUP \n\nポイントをかいつまんでまとめてみました。エンジニア視点のため、考慮漏れの箇所があるかも知れませんが、フィードバックや各種レギュレーションの経過を元に更新していければと思います。  \n\n1. https://www.mhlw.go.jp/stf/shingi/0000516275.html ↩ \n2. https://www.mhlw.go.jp/web/t_doc?dataId=00tb3403&dataType=1&page%20No=1 ↩ \n3. https://elaws.e-gov.go.jp/document?lawid=140AC0000000045 ↩ \n4. https://elaws.e-gov.go.jp/document?lawid=429AC0000000028 ↩ \n5. https://elaws.e-gov.go.jp/document?lawid=411AC0000000128 ↩"},"name":"[2022-04-24]ヘルステック界隈のエンジニアが気をつけるべき個人情報の扱い","tags":["privacy","data-masking","data-engineering","health-informatics"],"childPublishedDate":{"published_on":"2022-04-24T00:00:00.000Z","published_on_unix":1650758400}}}]}},"pageContext":{"number":93}},"staticQueryHashes":[]}