{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/59","result":{"data":{"esaPost":{"number":59,"relative_category":"blog/backend","fields":{"title":"連載 Rails2Phoenix 1 UmbrellaプロジェクトをHerokuにデプロイする","excerpt":"使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。   > PROBLEMPROBLEM \n\n- サービスについて 拡張にともない技術スタックがふえるのを抑えたい スケーラビリティのためのコストを抑えたい パフォーマンスをあげたい \n- 拡張にともない技術スタックがふえるのを抑えたい\n- スケーラビリティのためのコストを抑えたい\n- パフォーマンスをあげたい   > SOLUTIONSOLUTION \n\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。 \n\n方針 \n\n- Railsから徐々にPhoenixに移行できるように いままでとおなじPaaS（Heroku） いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく いままでとおなじDB 移行完了までDBマイグレーションをしない \n- いままでとおなじPaaS（Heroku）\n- いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく \n- ブランチ戦略は phoenix/base をベースに\n- 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\n- いままでとおなじDB 移行完了までDBマイグレーションをしない \n- 移行完了までDBマイグレーションをしない\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで   > HerokuへのデプロイのながれHerokuへのデプロイのながれ \n\n基本的にドキュメント通り。   > Phoenixアプリケーションを作成Phoenixアプリケーションを作成 \n\nまず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル apps/, deps/, config/config.exs, mix.exs, mix.lock が追加されます。   sh \n\n> cd rails_project > mix new . --umbrella > (cd ./apps && mix phx.new phoenix_app)   \n\n次に、既存のRailsでつくられたスキーマをPhoenixに移植します。Ripperをつかうとはかどります。ちなみに手動でスキーマをつくりたい場合は、CLI mix phx.gen.schema --no-migration Blog.Post blog_posts title:string で作成します。   rb \n\n# lib/tasks/convert_to_phoenix.rake # こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの require 'ripper' require 'erb' require 'fileutils' namespace :db do namespace :schema do desc 'Convert schema from Rails to Phoenix' task convert_to_phoenix: :environment do ConvertSchemaForPhoenixService.call end end end class ConvertSchemaForPhoenixService class << self def call FileUtils.mkdir_p(File.join('tmp', 'models')) extract_activerecord_define_block( Ripper.sexp( Rails.root .join('db', 'schema.rb') .read ) ).select(&method(:create_table_block?)) .map(&method(:configuration)) .each do |conf| project_name = 'PhoenixApp' table_name = conf[:table_name] table_columns = conf[:table_columns].reject(&method(:reject_condition)) .map do |c| case c[:column_type] when 'text' then c[:column_type] = ':string' when 'datetime' then c[:column_type] = ':naive_datetime' when 'inet' then c[:column_type] = 'EctoNetwork.INET' else c[:column_type] = \":#{c[:column_type]}\" end c end File.write( File.join('tmp', 'models', \"#{conf[:table_name].singularize}.ex\"), template.result(binding) ) end end private def extract_activerecord_define_block(sexp) sexp.dig(1, 0, 2, 2) end def create_table_block?(activerecord_define_block_element_sexp) activerecord_define_block_element_sexp.dig(1, 1, 1) == 'create_table' rescue false end def extract_table_name(create_table_block_sexp) create_table_block_sexp.dig(1, 2, 1, 0, 1, 1, 1) end def extract_table_columns(create_table_block_sexp) create_table_block_sexp.dig(2, 2) end def extract_column_type(table_column_sexp) table_column_sexp.dig(3, 1) end def extract_column_name(table_column_sexp) # Return value of `t.index` is array like ['user_id']. if table_column_sexp.dig(4, 1, 0, 0) == :array return table_column_sexp.dig(4, 1, 0, 1).map { |e| e.dig(1, 1, 1) } end table_column_sexp.dig(4, 1, 0, 1, 1, 1) end def extract_column_option(table_column_sexp) # If is not `column_option`, then `table_column_sexp.dig(4, 1, 1, # 1)` method return nil. Set blank array ([]) for avoiding nil. table_column_sexp.dig(4, 1, 1, 1) || [] end def extract_option_key(column_option_sexp) # Remove colon for avoiding `null:`. column_option_sexp.dig(1, 1).gsub(/:\\z/, '') end def extract_option_value(column_option_sexp) if column_option_sexp.dig(2, 0) == :array return Array(column_option_sexp.dig(2, 1)).map { |e| e.dig(1, 1, 1) } end element = column_option_sexp.dig(2, 1) if element.class != Array return element end case element.dig(0) when :kw then element.dig(1) when :string_content then element.dig(1, 1) || '' end end def template ERB.new(<<'__EOD__', nil, '-') defmodule <%= project_name %>.<%= table_name.classify %> do use Ecto.Schema import Ecto.Changeset alias <%= project_name %>.<%= table_name.classify %> schema \"<%= table_name %>\" do<% table_columns.each do |c| %> field :<%= c[:column_name] -%>, <%= c[:column_type] -%> <% end %> timestamps inserted_at: :created_at end @doc false def changeset(%<%= table_name.classify %>{} = <%= table_name.singularize %>, attrs) do <%= table_name.singularize %> |> cast(attrs, [<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>]) # |> validate_required([<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>]) end end __EOD__ end def configuration(table) { table_name: extract_table_name(table), table_columns: extract_table_columns(table).map do |c| { column_name: extract_column_name(c), column_type: extract_column_type(c), column_option: Hash[extract_column_option(c).map { |o| [extract_option_key(o), extract_option_value(o)] }] } end } end def reject_condition(column) column[:column_name] =~ /\\A(created|updated)_at\\z/ || column[:column_type] == 'index' end end end     sh \n\n> rails db:schema:convert_to_phoenix   \n\n最後に、既存DBへはこんな感じで接続します。   config \n\n# rails_project/apps/phoenix_app/config/dev.exs config :phoenix_app, PhoenixApp.Repo, adapter: Ecto.Adapters.Postgres, url: System.get_env(\"DATABASE_URL\"), pool_size: 10, ssl: true     sh \n\n> (cd ./apps/phoenix_app/assets && npm install) > mix deps.get > mix phx.server     > デプロイのパイプラインを追加デプロイのパイプラインを追加 \n\nさて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。 \n\nBEFORE \n\n- build (all branch) deploy.prod (master branch) \n- deploy.prod (master branch) \n\nAFTER \n\n- build (all branch) deploy.prod (master branch) deploy.phoenix.prod (phoenix/base branch) \n- deploy.prod (master branch)\n- deploy.phoenix.prod (phoenix/base branch)   yaml \n\n# wercker.yml deploy-phoenix-prod-heroku: steps: - add-ssh-key: host: github.com keyname: GITHUB - add-to-known_hosts: hostname: github.com fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48 - heroku-deploy: key: $HEROKU_KEY user: $HEROKU_USER app-name: $HEROKU_APP_NAME install-toolbelt: true after-steps: - wantedly/pretty-slack-notify: webhook_url: ${SLACK_WEBHOOK_URL} channel: general     > Herokuアプリケーションを作成Herokuアプリケーションを作成 \n\n基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ rails_project/config/prod.exs をこう rails_project/apps/phoenix_app/config/prod.exs 変更します。 \n\n1. Herokuアプリにビルドパックを適用   sh \n\n> heroku create --buildpack https://github.com/HashNuke/heroku-buildpack-elixir.git > heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git   \n\n2. 起動設定を準備   config \n\n# rails_project/elixir_buildpack.config erlang_version=19.1 elixir_version=1.4.2 always_rebuild=false pre_compile=\"pwd\" post_compile=\"pwd\" runtime_path=/app config_vars_to_export=(DATABASE_URL) config_vars_to_export=(DATABASE_POOL_SIZE)     config \n\n# rails_project/phoenix_static_buildpack.config phoenix_relative_path=apps/phoenix_app     config \n\n# rails_project/Procfile web: MIX_ENV=prod mix phx.server   \n\n3. 環境変数を適用 \n\nデータベース関連。   config \n\n# rails_project/apps/phoenix_app/config/prod.exs config :phoenix_app, PhoenixApp.Repo, adapter: Ecto.Adapters.Postgres, url: System.get_env(\"DATABASE_URL\"), pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10), ssl: true     sh \n\nheroku config:set DATABASE_URL=foo heroku config:set DATABASE_POOL_SIZE=bar   \n\nクレデンシャル関連。   sh \n\n> heroku config:set HEROKU_API_KEY=$(heroku auth:token) > heroku config:set SECRET_KEY_BASE=$(mix phx.gen.secret)     > WRAPUPWRAPUP \n\n大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"},"wip":false,"body_md":"<img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\">\r\n\r\n使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。\r\n\r\n# PROBLEM\r\n- サービスについて\r\n    - 拡張にともない技術スタックがふえるのを抑えたい\r\n    - スケーラビリティのためのコストを抑えたい\r\n    - パフォーマンスをあげたい\r\n\r\n# SOLUTION\r\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。\r\n\r\n**方針**\r\n- Railsから徐々にPhoenixに移行できるように\r\n  - いままでとおなじPaaS（Heroku）\r\n  - いままでとおなじレポジトリ\r\n      - ブランチ戦略は `phoenix/base` をベースに\r\n      - 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\r\n  - いままでとおなじDB\r\n      - 移行完了までDBマイグレーションをしない\r\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで\r\n\r\n## Herokuへのデプロイのながれ\r\n基本的に[ドキュメント](https://hexdocs.pm/phoenix/heroku.html)通り。\r\n\r\n### Phoenixアプリケーションを作成\r\nまず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル `apps/`, `deps/`, `config/config.exs`, `mix.exs`, `mix.lock` が追加されます。\r\n```sh\r\n> cd rails_project\r\n> mix new . --umbrella\r\n> (cd ./apps && mix phx.new phoenix_app)\r\n```\r\n\r\n次に、既存のRailsでつくられたスキーマをPhoenixに移植します。[Ripperをつかうとはかどります](http://developersnote.jp/elixir/share-db-between-rails-and-phoenix.html)。ちなみに手動でスキーマをつくりたい場合は、CLI `mix phx.gen.schema --no-migration Blog.Post blog_posts title:string` で作成します。\r\n```rb\r\n# lib/tasks/convert_to_phoenix.rake\r\n# こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの\r\nrequire 'ripper'\r\nrequire 'erb'\r\nrequire 'fileutils'\r\n\r\nnamespace :db do\r\n  namespace :schema do\r\n    desc 'Convert schema from Rails to Phoenix'\r\n    task convert_to_phoenix: :environment do\r\n      ConvertSchemaForPhoenixService.call\r\n    end\r\n  end\r\nend\r\n\r\nclass ConvertSchemaForPhoenixService\r\n  class << self\r\n    def call\r\n      FileUtils.mkdir_p(File.join('tmp', 'models'))\r\n      extract_activerecord_define_block(\r\n        Ripper.sexp(\r\n          Rails.root\r\n               .join('db', 'schema.rb')\r\n               .read\r\n        )\r\n      ).select(&method(:create_table_block?))\r\n       .map(&method(:configuration))\r\n       .each do |conf|\r\n        project_name = 'PhoenixApp'\r\n        table_name = conf[:table_name]\r\n        table_columns = conf[:table_columns].reject(&method(:reject_condition))\r\n                                            .map do |c|\r\n          case c[:column_type]\r\n          when 'text' then c[:column_type] = ':string'\r\n          when 'datetime' then c[:column_type] = ':naive_datetime'\r\n          when 'inet' then c[:column_type] = 'EctoNetwork.INET'\r\n          else c[:column_type] = \":#{c[:column_type]}\"\r\n          end\r\n          c\r\n        end\r\n        File.write(\r\n          File.join('tmp', 'models', \"#{conf[:table_name].singularize}.ex\"),\r\n          template.result(binding)\r\n        )\r\n      end\r\n    end\r\n\r\n    private\r\n\r\n    def extract_activerecord_define_block(sexp)\r\n      sexp.dig(1, 0, 2, 2)\r\n    end\r\n\r\n    def create_table_block?(activerecord_define_block_element_sexp)\r\n      activerecord_define_block_element_sexp.dig(1, 1, 1) == 'create_table'\r\n    rescue\r\n      false\r\n    end\r\n\r\n    def extract_table_name(create_table_block_sexp)\r\n      create_table_block_sexp.dig(1, 2, 1, 0, 1, 1, 1)\r\n    end\r\n\r\n    def extract_table_columns(create_table_block_sexp)\r\n      create_table_block_sexp.dig(2, 2)\r\n    end\r\n\r\n    def extract_column_type(table_column_sexp)\r\n      table_column_sexp.dig(3, 1)\r\n    end\r\n\r\n    def extract_column_name(table_column_sexp)\r\n      # Return value of `t.index` is array like ['user_id'].\r\n      if table_column_sexp.dig(4, 1, 0, 0) == :array\r\n        return table_column_sexp.dig(4, 1, 0, 1).map { |e| e.dig(1, 1, 1) }\r\n      end\r\n      table_column_sexp.dig(4, 1, 0, 1, 1, 1)\r\n    end\r\n\r\n    def extract_column_option(table_column_sexp)\r\n      # If is not `column_option`, then `table_column_sexp.dig(4, 1, 1,\r\n      # 1)` method return nil. Set blank array ([]) for avoiding nil.\r\n      table_column_sexp.dig(4, 1, 1, 1) || []\r\n    end\r\n\r\n    def extract_option_key(column_option_sexp)\r\n      # Remove colon for avoiding `null:`.\r\n      column_option_sexp.dig(1, 1).gsub(/:\\z/, '')\r\n    end\r\n\r\n    def extract_option_value(column_option_sexp)\r\n      if column_option_sexp.dig(2, 0) == :array\r\n        return Array(column_option_sexp.dig(2, 1)).map { |e| e.dig(1, 1, 1) }\r\n      end\r\n      element = column_option_sexp.dig(2, 1)\r\n      if element.class != Array\r\n        return element\r\n      end\r\n      case element.dig(0)\r\n      when :kw then element.dig(1)\r\n      when :string_content then element.dig(1, 1) || ''\r\n      end\r\n    end\r\n\r\n    def template\r\n      ERB.new(<<'__EOD__', nil, '-')\r\ndefmodule <%= project_name %>.<%= table_name.classify %> do\r\n  use Ecto.Schema\r\n  import Ecto.Changeset\r\n  alias <%= project_name %>.<%= table_name.classify %>\r\n\r\n  schema \"<%= table_name %>\" do<% table_columns.each do |c| %>\r\n    field :<%= c[:column_name] -%>, <%= c[:column_type] -%>\r\n<% end %>\r\n    timestamps inserted_at: :created_at\r\n  end\r\n\r\n  @doc false\r\n  def changeset(%<%= table_name.classify %>{} = <%= table_name.singularize %>, attrs) do\r\n    <%= table_name.singularize %>\r\n    |> cast(attrs, [<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>])\r\n    # |> validate_required([<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>])\r\n  end\r\nend\r\n__EOD__\r\n    end\r\n\r\n    def configuration(table)\r\n      {\r\n        table_name: extract_table_name(table),\r\n        table_columns: extract_table_columns(table).map do |c|\r\n          {\r\n            column_name: extract_column_name(c),\r\n            column_type: extract_column_type(c),\r\n            column_option: Hash[extract_column_option(c).map { |o| [extract_option_key(o), extract_option_value(o)] }]\r\n          }\r\n        end\r\n      }\r\n    end\r\n\r\n    def reject_condition(column)\r\n      column[:column_name] =~ /\\A(created|updated)_at\\z/ || column[:column_type] == 'index'\r\n    end\r\n  end\r\nend\r\n```\r\n```sh\r\n> rails db:schema:convert_to_phoenix\r\n```\r\n\r\n最後に、既存DBへはこんな感じで接続します。\r\n```config\r\n# rails_project/apps/phoenix_app/config/dev.exs\r\nconfig :phoenix_app, PhoenixApp.Repo,\r\n  adapter: Ecto.Adapters.Postgres,\r\n  url: System.get_env(\"DATABASE_URL\"),\r\n  pool_size: 10,\r\n  ssl: true\r\n```\r\n```sh\r\n> (cd ./apps/phoenix_app/assets && npm install)\r\n> mix deps.get\r\n> mix phx.server\r\n```\r\n\r\n## デプロイのパイプラインを追加\r\nさて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。\r\n\r\n**BEFORE**\r\n- build (all branch)\r\n    - deploy.prod (master branch)\r\n\r\n**AFTER**\r\n- build (all branch)\r\n    - deploy.prod (master branch)\r\n    - deploy.phoenix.prod (phoenix/base branch)\r\n\r\n```yaml\r\n# wercker.yml\r\ndeploy-phoenix-prod-heroku:\r\n  steps:\r\n    - add-ssh-key:\r\n        host: github.com\r\n        keyname: GITHUB\r\n    - add-to-known_hosts:\r\n        hostname: github.com\r\n        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48\r\n    - heroku-deploy:\r\n        key: $HEROKU_KEY\r\n        user: $HEROKU_USER\r\n        app-name: $HEROKU_APP_NAME\r\n        install-toolbelt: true\r\n  after-steps:\r\n    - wantedly/pretty-slack-notify:\r\n        webhook_url: ${SLACK_WEBHOOK_URL}\r\n        channel: general\r\n```\r\n\r\n### Herokuアプリケーションを作成\r\n基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ `rails_project/config/prod.exs` をこう `rails_project/apps/phoenix_app/config/prod.exs` 変更します。\r\n\r\n**1. Herokuアプリにビルドパックを適用**\r\n```sh\r\n> heroku create --buildpack https://github.com/HashNuke/heroku-buildpack-elixir.git\r\n> heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git\r\n```\r\n\r\n**2. 起動設定を準備**\r\n```config\r\n# rails_project/elixir_buildpack.config\r\nerlang_version=19.1\r\nelixir_version=1.4.2\r\nalways_rebuild=false\r\npre_compile=\"pwd\"\r\npost_compile=\"pwd\"\r\nruntime_path=/app\r\nconfig_vars_to_export=(DATABASE_URL)\r\nconfig_vars_to_export=(DATABASE_POOL_SIZE)\r\n```\r\n```config\r\n# rails_project/phoenix_static_buildpack.config\r\nphoenix_relative_path=apps/phoenix_app\r\n```\r\n```config\r\n# rails_project/Procfile\r\nweb: MIX_ENV=prod mix phx.server\r\n```\r\n\r\n**3. 環境変数を適用**\r\n\r\nデータベース関連。\r\n```config\r\n# rails_project/apps/phoenix_app/config/prod.exs\r\nconfig :phoenix_app, PhoenixApp.Repo,\r\n  adapter: Ecto.Adapters.Postgres,\r\n  url: System.get_env(\"DATABASE_URL\"),\r\n  pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10),\r\n  ssl: true\r\n```\r\n```sh\r\nheroku config:set DATABASE_URL=foo\r\nheroku config:set DATABASE_POOL_SIZE=bar\r\n```\r\n\r\nクレデンシャル関連。\r\n```sh\r\n> heroku config:set HEROKU_API_KEY=$(heroku auth:token)\r\n> heroku config:set SECRET_KEY_BASE=$(mix phx.gen.secret)\r\n```\r\n\r\n# WRAPUP\r\n大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。","body_html":"<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\"></a>\n<p data-sourcepos=\"3:1-3:338\">使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。</p>\n<h1 data-sourcepos=\"5:1-5:9\" id=\"1-0-0\" name=\"1-0-0\">\n<a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"6:1-10:0\">\n<li data-sourcepos=\"6:1-10:0\">サービスについて\n<ul data-sourcepos=\"7:5-10:0\">\n<li data-sourcepos=\"7:5-7:75\">拡張にともない技術スタックがふえるのを抑えたい</li>\n<li data-sourcepos=\"8:5-8:66\">スケーラビリティのためのコストを抑えたい</li>\n<li data-sourcepos=\"9:5-10:0\">パフォーマンスをあげたい</li>\n</ul>\n</li>\n</ul>\n<h1 data-sourcepos=\"11:1-11:10\" id=\"2-0-0\" name=\"2-0-0\">\n<a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"12:1-12:255\">というわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。</p>\n<p data-sourcepos=\"14:1-14:10\"><strong>方針</strong></p>\n<ul data-sourcepos=\"15:1-23:0\">\n<li data-sourcepos=\"15:1-21:64\">Railsから徐々にPhoenixに移行できるように\n<ul data-sourcepos=\"16:3-21:64\">\n<li data-sourcepos=\"16:3-16:44\">いままでとおなじPaaS（Heroku）</li>\n<li data-sourcepos=\"17:3-19:100\">いままでとおなじレポジトリ\n<ul data-sourcepos=\"18:7-19:100\">\n<li data-sourcepos=\"18:7-18:60\">ブランチ戦略は <code>phoenix/base</code> をベースに</li>\n<li data-sourcepos=\"19:7-19:100\">気軽に参照できるようにRails関連ファイルは可能な限りのこしておく</li>\n</ul>\n</li>\n<li data-sourcepos=\"20:3-21:64\">いままでとおなじDB\n<ul data-sourcepos=\"21:7-21:64\">\n<li data-sourcepos=\"21:7-21:64\">移行完了までDBマイグレーションをしない</li>\n</ul>\n</li>\n</ul>\n</li>\n<li data-sourcepos=\"22:1-23:0\">Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで</li>\n</ul>\n<h2 data-sourcepos=\"24:1-24:39\" id=\"2-1-0\" name=\"2-1-0\">\n<a class=\"anchor\" id=\"Herokuへのデプロイのながれ\" name=\"Heroku%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%AA%E3%81%8C%E3%82%8C\" href=\"#Heroku%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%AA%E3%81%8C%E3%82%8C\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Herokuへのデプロイのながれ\"> &gt; Herokuへのデプロイのながれ</span></a>Herokuへのデプロイのながれ</h2>\n<p data-sourcepos=\"25:1-25:81\">基本的に<a href=\"https://hexdocs.pm/phoenix/heroku.html\" target=\"_blank\" rel=\"noopener noreferrer\">ドキュメント</a>通り。</p>\n<h3 data-sourcepos=\"27:1-27:44\" id=\"2-1-1\" name=\"2-1-1\">\n<a class=\"anchor\" id=\"Phoenixアプリケーションを作成\" name=\"Phoenix%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" href=\"#Phoenix%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Phoenixアプリケーションを作成\"> &gt; Phoenixアプリケーションを作成</span></a>Phoenixアプリケーションを作成</h3>\n<p data-sourcepos=\"28:1-28:181\">まず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル <code>apps/</code>, <code>deps/</code>, <code>config/config.exs</code>, <code>mix.exs</code>, <code>mix.lock</code> が追加されます。</p>\n<div class=\"code-block\" data-sourcepos=\"29:1-33:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> <span class=\"nb\">cd </span>rails_project\n<span class=\"o\">&gt;</span> mix new <span class=\"nb\">.</span> <span class=\"nt\">--umbrella</span>\n<span class=\"o\">&gt;</span> <span class=\"o\">(</span><span class=\"nb\">cd</span> ./apps <span class=\"o\">&amp;&amp;</span> mix phx.new phoenix_app<span class=\"o\">)</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"35:1-35:359\">次に、既存のRailsでつくられたスキーマをPhoenixに移植します。<a href=\"http://developersnote.jp/elixir/share-db-between-rails-and-phoenix.html\" target=\"_blank\" rel=\"noopener noreferrer\">Ripperをつかうとはかどります</a>。ちなみに手動でスキーマをつくりたい場合は、CLI <code>mix phx.gen.schema --no-migration Blog.Post blog_posts title:string</code> で作成します。</p>\n<div class=\"code-block\" data-sourcepos=\"36:1-182:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>rb</div>\n<div class=\"highlight\"><pre class=\"highlight ruby\"><code><span class=\"c1\"># lib/tasks/convert_to_phoenix.rake</span>\n<span class=\"c1\"># こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'ripper'</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'erb'</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'fileutils'</span>\n\n<span class=\"n\">namespace</span> <span class=\"ss\">:db</span> <span class=\"k\">do</span>\n  <span class=\"n\">namespace</span> <span class=\"ss\">:schema</span> <span class=\"k\">do</span>\n    <span class=\"n\">desc</span> <span class=\"s1\">'Convert schema from Rails to Phoenix'</span>\n    <span class=\"n\">task</span> <span class=\"ss\">convert_to_phoenix: :environment</span> <span class=\"k\">do</span>\n      <span class=\"no\">ConvertSchemaForPhoenixService</span><span class=\"p\">.</span><span class=\"nf\">call</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">ConvertSchemaForPhoenixService</span>\n  <span class=\"k\">class</span> <span class=\"o\">&lt;&lt;</span> <span class=\"nb\">self</span>\n    <span class=\"k\">def</span> <span class=\"nf\">call</span>\n      <span class=\"no\">FileUtils</span><span class=\"p\">.</span><span class=\"nf\">mkdir_p</span><span class=\"p\">(</span><span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'tmp'</span><span class=\"p\">,</span> <span class=\"s1\">'models'</span><span class=\"p\">))</span>\n      <span class=\"n\">extract_activerecord_define_block</span><span class=\"p\">(</span>\n        <span class=\"no\">Ripper</span><span class=\"p\">.</span><span class=\"nf\">sexp</span><span class=\"p\">(</span>\n          <span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">root</span>\n               <span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'db'</span><span class=\"p\">,</span> <span class=\"s1\">'schema.rb'</span><span class=\"p\">)</span>\n               <span class=\"p\">.</span><span class=\"nf\">read</span>\n        <span class=\"p\">)</span>\n      <span class=\"p\">).</span><span class=\"nf\">select</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:create_table_block?</span><span class=\"p\">))</span>\n       <span class=\"p\">.</span><span class=\"nf\">map</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:configuration</span><span class=\"p\">))</span>\n       <span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">conf</span><span class=\"o\">|</span>\n        <span class=\"n\">project_name</span> <span class=\"o\">=</span> <span class=\"s1\">'PhoenixApp'</span>\n        <span class=\"n\">table_name</span> <span class=\"o\">=</span> <span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_name</span><span class=\"p\">]</span>\n        <span class=\"n\">table_columns</span> <span class=\"o\">=</span> <span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_columns</span><span class=\"p\">].</span><span class=\"nf\">reject</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:reject_condition</span><span class=\"p\">))</span>\n                                            <span class=\"p\">.</span><span class=\"nf\">map</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span>\n          <span class=\"k\">case</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'text'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">':string'</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'datetime'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">':naive_datetime'</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'inet'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">'EctoNetwork.INET'</span>\n          <span class=\"k\">else</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\":</span><span class=\"si\">#{</span><span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n          <span class=\"k\">end</span>\n          <span class=\"n\">c</span>\n        <span class=\"k\">end</span>\n        <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">write</span><span class=\"p\">(</span>\n          <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'tmp'</span><span class=\"p\">,</span> <span class=\"s1\">'models'</span><span class=\"p\">,</span> <span class=\"s2\">\"</span><span class=\"si\">#{</span><span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_name</span><span class=\"p\">].</span><span class=\"nf\">singularize</span><span class=\"si\">}</span><span class=\"s2\">.ex\"</span><span class=\"p\">),</span>\n          <span class=\"n\">template</span><span class=\"p\">.</span><span class=\"nf\">result</span><span class=\"p\">(</span><span class=\"nb\">binding</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"kp\">private</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_activerecord_define_block</span><span class=\"p\">(</span><span class=\"n\">sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_table_block?</span><span class=\"p\">(</span><span class=\"n\">activerecord_define_block_element_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">activerecord_define_block_element_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'create_table'</span>\n    <span class=\"k\">rescue</span>\n      <span class=\"kp\">false</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_table_name</span><span class=\"p\">(</span><span class=\"n\">create_table_block_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">create_table_block_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_table_columns</span><span class=\"p\">(</span><span class=\"n\">create_table_block_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">create_table_block_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_type</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_name</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># Return value of `t.index` is array like ['user_id'].</span>\n      <span class=\"k\">if</span> <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"ss\">:array</span>\n        <span class=\"k\">return</span> <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span> <span class=\"n\">e</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_option</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># If is not `column_option`, then `table_column_sexp.dig(4, 1, 1,</span>\n      <span class=\"c1\"># 1)` method return nil. Set blank array ([]) for avoiding nil.</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_option_key</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># Remove colon for avoiding `null:`.</span>\n      <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"nf\">gsub</span><span class=\"p\">(</span><span class=\"sr\">/:\\z/</span><span class=\"p\">,</span> <span class=\"s1\">''</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_option_value</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">)</span>\n      <span class=\"k\">if</span> <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"ss\">:array</span>\n        <span class=\"k\">return</span> <span class=\"no\">Array</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span> <span class=\"n\">e</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n      <span class=\"n\">element</span> <span class=\"o\">=</span> <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n      <span class=\"k\">if</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">class</span> <span class=\"o\">!=</span> <span class=\"no\">Array</span>\n        <span class=\"k\">return</span> <span class=\"n\">element</span>\n      <span class=\"k\">end</span>\n      <span class=\"k\">case</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n      <span class=\"k\">when</span> <span class=\"ss\">:kw</span> <span class=\"k\">then</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n      <span class=\"k\">when</span> <span class=\"ss\">:string_content</span> <span class=\"k\">then</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"s1\">''</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">template</span>\n      <span class=\"no\">ERB</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"o\">&lt;&lt;</span><span class=\"no\">'__EOD__'</span><span class=\"p\">,</span> <span class=\"kp\">nil</span><span class=\"p\">,</span> <span class=\"s1\">'-'</span><span class=\"p\">)</span><span class=\"sh\">\ndefmodule &lt;%= project_name %&gt;.&lt;%= table_name.classify %&gt; do\n  use Ecto.Schema\n  import Ecto.Changeset\n  alias &lt;%= project_name %&gt;.&lt;%= table_name.classify %&gt;\n\n  schema \"&lt;%= table_name %&gt;\" do&lt;% table_columns.each do |c| %&gt;\n    field :&lt;%= c[:column_name] -%&gt;, &lt;%= c[:column_type] -%&gt;\n&lt;% end %&gt;\n    timestamps inserted_at: :created_at\n  end\n\n  @doc false\n  def changeset(%&lt;%= table_name.classify %&gt;{} = &lt;%= table_name.singularize %&gt;, attrs) do\n    &lt;%= table_name.singularize %&gt;\n    |&gt; cast(attrs, [&lt;%= table_columns.map { |c| \":\" &lt;&lt; c[:column_name] }.join(\", \") -%&gt;])\n    # |&gt; validate_required([&lt;%= table_columns.map { |c| \":\" &lt;&lt; c[:column_name] }.join(\", \") -%&gt;])\n  end\nend\n</span><span class=\"no\">__EOD__</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">configuration</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">)</span>\n      <span class=\"p\">{</span>\n        <span class=\"ss\">table_name: </span><span class=\"n\">extract_table_name</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">),</span>\n        <span class=\"ss\">table_columns: </span><span class=\"n\">extract_table_columns</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span>\n          <span class=\"p\">{</span>\n            <span class=\"ss\">column_name: </span><span class=\"n\">extract_column_name</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">),</span>\n            <span class=\"ss\">column_type: </span><span class=\"n\">extract_column_type</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">),</span>\n            <span class=\"ss\">column_option: </span><span class=\"no\">Hash</span><span class=\"p\">[</span><span class=\"n\">extract_column_option</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">o</span><span class=\"o\">|</span> <span class=\"p\">[</span><span class=\"n\">extract_option_key</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">),</span> <span class=\"n\">extract_option_value</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)]</span> <span class=\"p\">}]</span>\n          <span class=\"p\">}</span>\n        <span class=\"k\">end</span>\n      <span class=\"p\">}</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reject_condition</span><span class=\"p\">(</span><span class=\"n\">column</span><span class=\"p\">)</span>\n      <span class=\"n\">column</span><span class=\"p\">[</span><span class=\"ss\">:column_name</span><span class=\"p\">]</span> <span class=\"o\">=~</span> <span class=\"sr\">/\\A(created|updated)_at\\z/</span> <span class=\"o\">||</span> <span class=\"n\">column</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">'index'</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"183:1-185:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> rails db:schema:convert_to_phoenix\n</code></pre></div>\n</div>\n<p data-sourcepos=\"187:1-187:62\">最後に、既存DBへはこんな感じで接続します。</p>\n<div class=\"code-block\" data-sourcepos=\"188:1-195:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/apps/phoenix_app/config/dev.exs\nconfig :phoenix_app, PhoenixApp.Repo,\n  adapter: Ecto.Adapters.Postgres,\n  url: System.get_env(\"DATABASE_URL\"),\n  pool_size: 10,\n  ssl: true\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"196:1-200:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> <span class=\"o\">(</span><span class=\"nb\">cd</span> ./apps/phoenix_app/assets <span class=\"o\">&amp;&amp;</span> npm <span class=\"nb\">install</span><span class=\"o\">)</span>\n<span class=\"o\">&gt;</span> mix deps.get\n<span class=\"o\">&gt;</span> mix phx.server\n</code></pre></div>\n</div>\n<h2 data-sourcepos=\"202:1-202:45\" id=\"2-2-0\" name=\"2-2-0\">\n<a class=\"anchor\" id=\"デプロイのパイプラインを追加\" name=\"%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0\" href=\"#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"デプロイのパイプラインを追加\"> &gt; デプロイのパイプラインを追加</span></a>デプロイのパイプラインを追加</h2>\n<p data-sourcepos=\"203:1-203:217\">さて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。</p>\n<p data-sourcepos=\"205:1-205:10\"><strong>BEFORE</strong></p>\n<ul data-sourcepos=\"206:1-208:0\">\n<li data-sourcepos=\"206:1-208:0\">build (all branch)\n<ul data-sourcepos=\"207:5-208:0\">\n<li data-sourcepos=\"207:5-208:0\">deploy.prod (master branch)</li>\n</ul>\n</li>\n</ul>\n<p data-sourcepos=\"209:1-209:9\"><strong>AFTER</strong></p>\n<ul data-sourcepos=\"210:1-213:0\">\n<li data-sourcepos=\"210:1-213:0\">build (all branch)\n<ul data-sourcepos=\"211:5-213:0\">\n<li data-sourcepos=\"211:5-211:33\">deploy.prod (master branch)</li>\n<li data-sourcepos=\"212:5-213:0\">deploy.phoenix.prod (phoenix/base branch)</li>\n</ul>\n</li>\n</ul>\n<div class=\"code-block\" data-sourcepos=\"214:1-233:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>yaml</div>\n<div class=\"highlight\"><pre class=\"highlight yaml\"><code><span class=\"c1\"># wercker.yml</span>\n<span class=\"na\">deploy-phoenix-prod-heroku</span><span class=\"pi\">:</span>\n  <span class=\"na\">steps</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"na\">add-ssh-key</span><span class=\"pi\">:</span>\n        <span class=\"na\">host</span><span class=\"pi\">:</span> <span class=\"s\">github.com</span>\n        <span class=\"na\">keyname</span><span class=\"pi\">:</span> <span class=\"s\">GITHUB</span>\n    <span class=\"pi\">-</span> <span class=\"na\">add-to-known_hosts</span><span class=\"pi\">:</span>\n        <span class=\"na\">hostname</span><span class=\"pi\">:</span> <span class=\"s\">github.com</span>\n        <span class=\"na\">fingerprint</span><span class=\"pi\">:</span> <span class=\"s\">16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48</span>\n    <span class=\"pi\">-</span> <span class=\"na\">heroku-deploy</span><span class=\"pi\">:</span>\n        <span class=\"na\">key</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_KEY</span>\n        <span class=\"na\">user</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_USER</span>\n        <span class=\"na\">app-name</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_APP_NAME</span>\n        <span class=\"na\">install-toolbelt</span><span class=\"pi\">:</span> <span class=\"no\">true</span>\n  <span class=\"na\">after-steps</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">wantedly/pretty-slack-notify</span><span class=\"pi\">:</span>\n        <span class=\"na\">webhook_url</span><span class=\"pi\">:</span> <span class=\"s\">${SLACK_WEBHOOK_URL}</span>\n        <span class=\"na\">channel</span><span class=\"pi\">:</span> <span class=\"s\">general</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"235:1-235:43\" id=\"2-2-1\" name=\"2-2-1\">\n<a class=\"anchor\" id=\"Herokuアプリケーションを作成\" name=\"Heroku%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" href=\"#Heroku%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" data-position=\"2-2-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Herokuアプリケーションを作成\"> &gt; Herokuアプリケーションを作成</span></a>Herokuアプリケーションを作成</h3>\n<p data-sourcepos=\"236:1-236:306\">基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ <code>rails_project/config/prod.exs</code> をこう <code>rails_project/apps/phoenix_app/config/prod.exs</code> 変更します。</p>\n<p data-sourcepos=\"238:1-238:52\"><strong>1. Herokuアプリにビルドパックを適用</strong></p>\n<div class=\"code-block\" data-sourcepos=\"239:1-242:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> heroku create <span class=\"nt\">--buildpack</span> https://github.com/HashNuke/heroku-buildpack-elixir.git\n<span class=\"o\">&gt;</span> heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git\n</code></pre></div>\n</div>\n<p data-sourcepos=\"244:1-244:28\"><strong>2. 起動設定を準備</strong></p>\n<div class=\"code-block\" data-sourcepos=\"245:1-255:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/elixir_buildpack.config\nerlang_version=19.1\nelixir_version=1.4.2\nalways_rebuild=false\npre_compile=\"pwd\"\npost_compile=\"pwd\"\nruntime_path=/app\nconfig_vars_to_export=(DATABASE_URL)\nconfig_vars_to_export=(DATABASE_POOL_SIZE)\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"256:1-259:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/phoenix_static_buildpack.config\nphoenix_relative_path=apps/phoenix_app\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"260:1-263:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/Procfile\nweb: MIX_ENV=prod mix phx.server\n</code></pre></div>\n</div>\n<p data-sourcepos=\"265:1-265:28\"><strong>3. 環境変数を適用</strong></p>\n<p data-sourcepos=\"267:1-267:27\">データベース関連。</p>\n<div class=\"code-block\" data-sourcepos=\"268:1-275:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/apps/phoenix_app/config/prod.exs\nconfig :phoenix_app, PhoenixApp.Repo,\n  adapter: Ecto.Adapters.Postgres,\n  url: System.get_env(\"DATABASE_URL\"),\n  pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10),\n  ssl: true\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"276:1-279:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>heroku config:set <span class=\"nv\">DATABASE_URL</span><span class=\"o\">=</span>foo\nheroku config:set <span class=\"nv\">DATABASE_POOL_SIZE</span><span class=\"o\">=</span>bar\n</code></pre></div>\n</div>\n<p data-sourcepos=\"281:1-281:30\">クレデンシャル関連。</p>\n<div class=\"code-block\" data-sourcepos=\"282:1-285:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> heroku config:set <span class=\"nv\">HEROKU_API_KEY</span><span class=\"o\">=</span><span class=\"si\">$(</span>heroku auth:token<span class=\"si\">)</span>\n<span class=\"o\">&gt;</span> heroku config:set <span class=\"nv\">SECRET_KEY_BASE</span><span class=\"o\">=</span><span class=\"si\">$(</span>mix phx.gen.secret<span class=\"si\">)</span>\n</code></pre></div>\n</div>\n<h1 data-sourcepos=\"287:1-287:8\" id=\"3-0-0\" name=\"3-0-0\">\n<a class=\"anchor\" id=\"WRAPUP\" name=\"WRAPUP\" href=\"#WRAPUP\" data-position=\"3-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"WRAPUP\"> &gt; WRAPUP</span></a>WRAPUP</h1>\n<p data-sourcepos=\"288:1-288:579\">大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。</p>\n","tags":["phoenix-framework","elixir","ruby-on-rails","ruby","wercker","heroku"],"updated_at":"2021-01-16T23:20:50+09:00","childPublishedDate":{"published_on":"2018-01-08T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_7b757a0db07cde6a337af7df901ab0c5.jpg"}},"relatedPosts":{"edges":[{"node":{"number":50,"relative_category":"blog/health","fields":{"title":"30代からの胸郭変形（漏斗胸）手術","excerpt":"私の年齢が30代に差し掛かると、ある変化が体に訪れました。それは、肋軟骨の硬化です。この現象は、日常生活において心臓や肺を圧迫し、さらには階段を上るときには一層その影響を強く感じました。私は自己の身体が変わる原因として、以前から抱えていた胸郭の変形を疑い始めました。そこで、私はその治療、手術に踏み切る決断を下しました。  > PROBLEMPROBLEM \n\n問題は重度の胸郭変形（漏斗胸）で、これが内臓への負荷を増大させていました。ヘイラーインデックスという指標で見ると、私の数値は健常者の3倍にも上りました。30代を迎えると、肋軟骨の硬化が進行し、心臓や肺への圧迫感が増す一方でした。  > TLDRTLDR \n\n私が医師から聞いた漏斗胸患者の状況を思い起こすと、同じような問題に直面している人は、おそらく1万人くらいいるだろうと思いました。この記事は私自身の記憶を辿るためのものなので、医療的な内容については専門医に問い合わせてください。 \n\n漏斗胸患者の状況 \n\n- ナス法は2000年代に入ってから徐々に一般に知られるようなった\n- ナス法は10代のうちに受けるのが体力的・経済的にも適切\n- 日本人300-1000人に1人が漏斗胸患者の可能性がある\n- 漏斗胸患者の8-9割は男性である  > SOLUTIONSOLUTION \n\nそれは、長い間放置していた胸郭の問題についに立ち向かう日が訪れたのです。私はナス法と呼ばれる手術を受ける決断をしました。手術は無事終わり、現在は経過観察の段階にあります。体調も安定し始めたので、私はこれまでの対策を記録することにしました。30代でこの手術を受ける人の情報はほとんどなかったので、私の経験が誰かの役に立つことを願っています。 \n\n私の記憶が正しければ、ナス法は2000年代に入ってから徐々に認知度を上げ、現在では美容手術としても取り扱われています。それ以前の胸郭変形の手術は、胸部を開くことで骨を取り出し、その骨を逆にして再度取り付けるという、大規模で侵襲的なものでした。 \n\nこのナス法という手術は、歯の矯正と同じ原理に基づいています。つまり、矯正器具を患部周辺に取り付け、時間をかけて適切な形に整えていくというものです。ただし、この矯正器具は骨の内側に取り付けられるため、歯の矯正よりも時間と痛みが伴います。 \n\n具体的には、歯の矯正が4-6か月を要するのに対し、胸の矯正には2-3年の時間が必要とされています。また、痛みの度合いについても、歯の矯正では強力な麻薬や鎮痛剤が必要となる期間がおおよそ7日程度であるのに対し、胸の矯正ではそれが約40日にも及びます。 \n\n- 治療期間でみると、歯の矯正が4-6か月、胸の矯正が2-3年かかります。\n- 痛みの度合いでみると、強度の医療麻薬・鎮痛剤にお世話になる期間が歯の矯正では7日ほど、胸の矯正では40日ほど。また、鎮痛剤が不要になっても、施術部位の皮膚組成が治るまで、前者は2週間ほど噛むことが制限され、後者は90日ほど運動（胸郭をつかう運動のこと：例えば、満員電車への乗車、タクシー乗車、ジョギング、サイクリングなど）が制限されます。\n- 治療リスクは、歯の矯正が口内炎、歯髄炎である一方、胸の矯正が心臓の損傷、無気肺、肺水腫など。 \n\nさて、費用とタスク、そして手術後みえてきた課題（リハビリ）を以下に記します。  > 費用費用 \n\nまず、費用について話しましょう。この手術と入院費用は、健康保険の適用を受けることで、約10万円となりました。私が入院保険に加入していたため、この金額はあまり気にかける必要はありませんでした。 \n\nただし、手術後に日常生活を送ることができるようになるまでには4-6か月を要します。その間、収入が途絶えることを考えると、それに相当する金額を準備しておく必要があると感じました。  > タスク、退院までの工程タスク、退院までの工程 \n\n次に、退院までの工程について説明します。これは5つのステップで構成されています。全工程を終え、退院するまでには、少なくとも6か月は見ておくと良いでしょう。 \n\n1. ヘイラーインデックスを測る\n2. 入院保険にはいる\n3. 診察をうける、手術の打診\n4. 手術、入院\n5. 退院  > 1. ヘイラーインデックスを測る1. ヘイラーインデックスを測る \n\n初診の頃は知りませんでしたが、重度かどうかの判断はヘイラーインデックス（インデックス）を見ます。下記の式で簡単にインデックスを算出できます。本来であればCTで詳細をみて導き出すものですが、それほど複雑ではないのでまずは診察に行くかの判断材料として概算を出しておくと良いでしょう。 \n\nヘイラーインデックス = 肋骨の内側の距離 / 胸骨と背骨の距離  \n\nインデックスは通常は2.5ポイントぐらいでその値から離れるほど重症となります。重度の場合はさっと診察して、手術かどうかの判断を求められることがあるので準備に越したことはないです。  \n\n参考までにWikipediaに掲載されているヘイラーインデックス算出画像をみます。画像で出されたインデックスは3.59ポイント (25.1cm / 7.0cm)で、心臓が圧迫されている様子が見て取れます。 \n\nちなみに私は8.7～9.0ポイントで、第4胸骨（第6-7肋軟骨）と背骨の距離が通常の4分1ほど（3 cm）の状態、肺と心臓が押しつぶされていました。 \n\n個人の実感ですが、胸郭変形は整形上の問題もあるが、年齢をかさねるにつれて硬化する肋軟骨にあります。変形した骨が内臓への負荷をじょじょに増進し、気づいたら循環器系の機能低下、それにともなう免疫力低下につながる可能性があります。医師によると漏斗胸の患者には肺炎・心臓病が多く見られるが、その関係解明はこれからの課題だそうです。  > 2. 入院保険にはいる2. 入院保険にはいる \n\n既に入っている場合は必要ありません。胸郭変形の手術は健康保険が適用されるので、通常の民間保険でも同様に適用されます。私はインターネットで安い保険商品を見つけ、総額約20万円（月額2千円）で加入しました。 \n\nまた、術後の合併症などで想定外に入院・手術費がかさむ可能性があるので、手術が確定したら市区町村の高額医療費制度を利用すると良いでしょう。  > 3. 診察をうける、手術の打診3. 診察をうける、手術の打診 \n\nまだ、町のクリニックと形成外科との連携がとられるほどナス法手術が業界に浸透してないため、かかりつけの医師より紹介状をもらえる可能性は低いです（2017年時点）。従って、ネットで執刀数や論文提出数など勘案して信頼できる医師を選定します。ナス法が受けられる医療施設はこちらから探し出せます。外科には自分の体調不良とその原因を棚卸するため、診察してもらいに来たとでも言うと伝わるでしょう。 \n\n診察ではX線、CTをとって、ヘイラーインデックスの状態と患部の状態をくらべて施術判断がされます。初回ではCT、X線のみ。2回目にあらためて専任の医師より判断されます。医師の判断は一瞬で、施術リスクの重説と施術有無の打診がされ、スケジュール調整となります。  > 4. 入院、手術4. 入院、手術 \n\n手術を受けるようになっても入院までは普段と変わらない生活が送れます。それ以降は入院関連の慣習、業務フローを知らないと生活上でいろいろと不都合が生じるでしょう。 \n\n入院初日。入院手続きで連帯保証人が複数人必要と何人かの事務方に言われます。ただ、この情報は、患者が死亡した際の身柄引き取り先や医療費滞納が起きることを想定して病院が事前に知りたいだけで、法的にグレーな慣習です。マストではないので情報提供を断っても強く追及してこないです。 \n\n手術前日。貴重品を持てない、荷物を持てないという制約がかかります。警備体制が整ってていない病院は防犯が弱いのであえて金庫をおかない上、貴重品を預かりません。手術時患者は貴重品をもつことができないので、実質貴重品なしで入院することになります。しかし、手ぶらでは入院手続きできないので1人身で入院するには工夫が必要です。 \n\n術後。突然ICUで目が覚めます。そして、6本カテーテルが体に刺さっていて医療麻薬・鎮痛剤投与のルーチンが始まります。ICUから通常病棟への移管は受け入れ態勢によって変動します。術前に麻酔をうたれる辺りまでは記憶にあるが、それ以降のことはまったく覚えていないので混乱する時期です。 \n\n病棟移管後。ネット利用禁止。こちらはは昔からの慣習で建前上禁止になっているにすぎず、スマホの普及とともに黙認、あるいは容認するようになっています。ただ、手術前日の荷物をもてないという制約があることと、術後2週間は動くのがままならない状態なので1人身で入院すると外界と接続ができなくなります。  > 閑話休題 入院時の様子閑話休題 入院時の様子 \n\nここでちょうど入院時の様子がTwitterに残っていたので、抜粋します。入院直後、手術前、手術後、退院間近の心境の変化がみてとれます。 \n\n入院直後\n 手術がおもったよりも大変そうと気づきます。 \n\nnabinno, 02:26 PM October 01, 2016: かるい手術と思ったらICUに入ることになってる // from Twitter for Android [Tokyo, JP]  \n\n手術前\n 手術まで暇なのでPowerShellをいじりはじめます。 \n\nnabinno, 05:41 PM October 01, 2016: Hum > $($(curl http://www.yahoo.co.jp).Images | foreach {$_.src}) ` | sort ` | uniq ` | foreach { ` curl -Uri $_ -OutFile \"$(pwd)\\$(basename $_)\" ` } // from Twitter Web Client [Tokyo, JP]  \n\n手術後\n 麻酔の痛みがきれてナーバスになります。 \n\nnabinno, 04:06 PM October 08, 2016: ナースコールは enqueue/dequue もされてるがワーカーがかなりの頻度 でこける。夜になると汚いログがはかれるのは #医療OS の仕様だろうか ... // from Twitter for Android [Tokyo, JP]  \n\n気持ちを落ち着かせるためにEmacsをさわります。 \n\nnabinno, 09:01 PM October 11, 2016: 可能なかぎり Emacs で #Xamarin さわりたいので、CentOS 上に samba 立てた。 // from Twitter Web Client [Tokyo, JP]   \n\nBashOnWindowsで無茶をやり、少し落ち着きます。 \n\nnabinno, 09:18 PM October 11, 2016: #BashOnWindows の Emacs から #Xamarin さわったら 関連ファイルが消 されたり権限が変更されたりしたのだった ... // from twmode [Tokyo, JP]  \n\n術後ずっと寝たきりでしたが、なんとか動けるようになりました。 \n\nnabinno, 06:50 AM October 18, 2016: 胸郭手術時の 🛏 起床と就寝をマスターした // from Twitter Web Client [Tokyo, JP]   \n\n激痛のためノートPCがもてない体になっていました。 \n\nnabinno, 08:35 PM October 20, 2016: ノート PC は肉体的にまだ持てない ... // from twmode [Tokyo, JP]  \n\n退院間近\n アクティブトラッカーで客観的にみるよう心がけます。 \n\nnabinno, 05:22 PM October 21, 2016: #MicrosoftBand #HealthVault #MyFitnessPal で記録つけていて、ふと 医療機器がからだに入ってることにきづいた。他人事じゃないいんだけ ど、おもしろいなあ。 // from twmode [Tokyo, JP]   > 5. 退院5. 退院 \n\n退院は主治医が判断します、病棟の見回り医師ではないです。そして、たいてい腕のたつ主治医は多忙なので1週間に1度しか顔を出しません。なので、その時の様態次第で退院がどんどん後ろにずれていくので注意が必要です。 \n\n退院の条件 \n\n- 肺の状態、肺の膨らみ\n- 歩行の有無\n- 起床の有無\n- 退院したいという意志 \n\n入院中は上記の条件をクリアできるようこころがけることです、無為に過ごすと退院が遅れます。  > 手術後のリハビリ手術後のリハビリ  > 1か月後 ひたすら静養1か月後 ひたすら静養 \n\n退院直後の一ヶ月間は、ひたすら静養に専念しました。この期間は、風邪を引くと肺炎になる可能性が高まるため、極力体調管理に努めました。 \n\nまず、 内科医との関係 について考えました。退院前に外科から処方された鎮痛剤が強力だったため、それと他の薬の組み合わせに注意を払いました。特に、内科で処方される風邪薬自体にも鎮痛剤が含まれていたため、神経系に支障をきたす可能性がありました。私は内科医に、咳をしたときに胸に激痛が走るため、鎮痛剤を利用していることを伝え、抗生物質や鎮咳剤、去痰剤の薬を処方してもらうように頼みました。 \n\nまた、肺炎を疑いX線検査を行う場合、内科医にはバーが邪魔をして検査が難しい状況にあることを伝えました。そのため、内科医によっては、外科医が処方・処置した鎮痛剤とバーが自分の仕事を邪魔していると考える人もいました。 \n\n次に、 免疫力を高める ための工夫をしました。食事に関しては、「MyFitnessPal（Under Armour）」のような栄養を主としたアクティビティトラッカーを用いて、不足している栄養素を観察し、機能食品などで不足分を補いました。私は皮膚の組成に関係しそうな栄養素、特にタンパク質とビタミンCを意識的に摂るように心がけました。余裕が出てきたらスーパー食材、外食チェーンHPの栄養表をみて、実際に食事し体調を観察します。体調はWithing BodyとMS Bandでトラックすることで管理が楽でした。 \n\n運動については、医師からウォーキング程度に控えるよう指示されました。この期間は、胸郭や脇の傷周辺の皮膚組織に動きをつけない運動、例えばスクワットなどで筋力を回復させる程度にしました。また、無理のないストレッチで胸郭に埋め込まれたバー周辺の皮膚を徐々に伸ばし、新しい皮膚組織を作るよう心掛けました。室内での自重トレーニングよりもジムのトレーニングマシンで、リハビリという視点で負荷を調整しながら無理なくおこなうと良かったかも知れません。実際にトレーニングする前に医師からリハビリスタッフを紹介してもらうのも手だと思いました。 \n\n3つの運動 \n\n- 有酸素運動。ウォーキングで循環器系をきたえます。退院後でも起床など胸郭をうごかすのがむずかしい状態なので、まずウォーキングが普通にできるようにのぞみます。慣れてきたら距離をのばして5km、10kmとのばすと良いでしょう。足の負担を気にするようだったらAsics DynaFlyteのような、機能性を追求したランニングシューズの検討をすすめます。\n- 無酸素運動。無理のない筋トレで筋骨格をきたえる、皮膚を生成します。退院直後は腹筋、三角筋はバー周囲の皮膚が生成されていないので痛みとともに力を出すことがむずかしいです。従って、僧帽筋、大胸筋あたりから皮膚の生成を促すようにします。また、有酸素運動を無理なく行えるように下腿三頭筋（ふくろはぎ）や大腿四頭筋を積極的に動かします。余裕が出てきたら筋肉とトレーニングマシンの対応表を参考にすると良いでしょう。\n- ストレッチ。ヨガで皮膚の生成を促します。退院直後はヨガをする余裕はないが、軽いウォーキングや筋トレをはじめたあたりで、バウンドエンジェル、チャイルドポーズ、ハッピーベイビーポーズなど軽めなものを混ぜると良いでしょう。参考までにポーズ集があります。 \n\nまた、入院時に手術用コンプレッションウェアのタイツを着ることになりますが、退院後はスポーツ用コンプレッションウェアをシャツ、タイツともに着ると良いでしょう。手術時もそうですが、退院後も適度な負荷を皮膚に与えることで交感神経の活性化を促します。 \n\n私はできませんでしたが、免疫力向上は準備するのに時間がかかるので入院・手術前から取り組んでおくと良いでしょう。  > 3か月後どうなったか3か月後どうなったか \n\n退院から3ヶ月が経過した時点での私の状況を記載します。リハビリの経過を示すために、体組成の一部を以下に示します。    体組成 入院前 退院後1か月 退院後2か月 退院後3か月     胸囲 (cm) 68.5 80.8 82.7 82.9   体重 (kg) 51.0 46.6 49.6 50.8   筋肉 (kg) - 39.3 41.4 42.4   脂肪 (kg) - 4.9 5.8 5.9    \n\n退院後1ヶ月目は、胸囲が劇的に変わりましたが、体重は低下しました。これは、手術直後の痛みや無理のないストレッチにより、日常生活の中で行っていた運動量が大幅に減少し、筋肉が落ちてしまったためです。私はノートパソコンすら持つことができなかったので、筋力の低下は想像通りの結果でした。 \n\nしかし、退院後2ヶ月目には、リハビリの効果が少しずつ現れ始めました。体重が増え、筋肉量も少しずつ増えてきました。この頃から、日常生活の中での動きも自然と増え、心地よい疲労感を感じるようになりました。 \n\nそして、退院後3ヶ月目には、体重と筋肉量がさらに増えました。この頃になると、日常生活の中での動きはほぼ元の状態に戻り、運動も自然と増え、心地よい疲労感を感じることが多くなりました。胸囲も着実に広がり、見た目も大きな変化が出てきました。私自身、この結果を見て、手術の決断が正しかったと自信を持つことができました。  > WRAPUPWRAPUP \n\n予想通り、心臓と肺にかかっていた圧迫感は完全に消え去りました。毎日、少しずつ体調が改善していくのを感じ、自身の身体が元の状態に戻っていく様子を実感しました。特に、階段を上るときの苦労がなくなったことは、大きな喜びでした。 \n\n手術の決断は、仕事ができなくなる期間を含む全体のコストと、今後のリスクを考慮してのものでした。その結果、この手術を受けることを選んだ自分自身を、今では肯定的に評価できるようになりました。 \n\nただし、完全に一段落つくまでにはまだ時間がかかります。3年後にはバーを取り出す抜去手術が控えています。その手術が無事に終わり、経過観察も完全に終わるまで、私の戦いはまだ終わらないのです。"},"name":"[2017-02-06]30代からの胸郭変形（漏斗胸）手術","tags":["pectus-excavatum","bash-on-windows","emacs","powershell"],"childPublishedDate":{"published_on":"2017-02-06T00:00:00.000Z","published_on_unix":1486339200}}},{"node":{"number":66,"relative_category":"blog","fields":{"title":"On Blahfe","excerpt":"txt\n\n（小学校の作文より） ぼくは、二年の時、友達と自転車で、じゅくから帰ってくるとちゅう、トラックに足をふまれてしまいました。おほりの近くの道路でトラックが来たから、よけようとした時、ころんで足を道路にだしてしまったのです。 いたみは感じなかったのに、なぜか泣いてしまい、トラックのおじさんたちが「けがはなかったかい」と心配してくれました。それでも、ぼくが泣いてるもんだから、病院に行って、レントゲンで見てもらいました。全然いじょうはなかったそうです。 その時、ぼくはほっとして、これからは自分で安全を守ろうと、決心しました。ただ、三年になってしまうと、安全を守ろうなんていう決心は、とっくに忘れてしまいました。 三年の五月になって、お父さんと兄弟と友達で郡山ダムまでサイクリングに行きました。行くときは、よかったんだけど、帰りの時、坂で足をすべらして、自転車のスポークの中につま先をはめてしまいました。その勢いで、自転車が、一回転してしまいました。 たまたま車が通って、中の農家の人が「どうしたんだい」と、話しかけてくれました。ぼくは、足の方のいたさで、話すこともできませんでした。それから、農家の人が、心配して、家までつれていってくれました。 家に帰ると、安心して、泣いてしまいました。それから、病院に行ってレントゲンをとって見ると、お医者さんがだいじょうぶといっていました。とってもよかったです。 また、ぼくは、自分で安全を守ろうと、心に決めました。  \n\n※ 上記シーンは自身のテーマである「痛み」と向き合いながら、過去の出来事から学び取るエピソードとして描かれています。個人的な成長と共に、安全に対する意識も高めていく様子が見て取れます。  > サイト構成サイト構成 \n\nある方曰く、痛みとは人の根源だそうで。小学校の作文ではないですが、私がいつも気にしてるテーマです。 \n\n- 退屈\n- 寂しさ\n- 肉体の痛み\n- 健康喪失の恐れ\n- 金銭ストレス\n- 虚しさ \n\nこのブログは、PROBLEM-SOLUTIONの2つのセクションを通して、私自身の成長と向き合いながら、読者の皆さんにも共感を呼び起こすような内容を発信していきたいと考えています。PROBLEMは上記テーマのどれかが当てはまります。SOLUTIONでは、私が個人的に試してみた問題解決の手法やアプローチを紹介します。これらの方法は、私の職業や日常生活に近いものだけでなく、自分自身の成長や心の豊かさを追求するためのものも含まれています。人間の根源的な問題に直面する経験と、それに対する解決策を通して、共に成長していくことを願っています。"},"name":"[2017-01-31]On Blahfe","tags":["blahfe"],"childPublishedDate":{"published_on":"2017-01-31T00:00:00.000Z","published_on_unix":1485820800}}},{"node":{"number":44,"relative_category":"blog/organization","fields":{"title":"整理したい私はITILをかぶる、PlantUMLへの愛","excerpt":"現在、ネクイノでエンジニアリングマネージャー、バックエンドエンジニア、インフラエンジニアを担当している私は、年の瀬を迎えて振り返り記事を書くことに決めました。この記事では、PlantUMLに絞り、振り返ることで気づいた問題点とその解決策を詳細に描写します。PlantUMLは私にとって全知全能のツールではありませんが、愛しているツールであり、これまでの8ヶ月間の成長を共有したいと思います。   > PROBLEMPROBLEM \n\n振り返ることで私が気づいた主な問題点は、開発チーム全体がまだ機能していないことでした。管理規程はあるものの、業務フローが明示化されておらず、誰が何を何の目的で業務を回しているか分からない状態でした。この可視化されていないプロセスが問題になるケースが増えてきました。  > SOLUTIONSOLUTION \n\nこの問題に対して、私は入社早々PlantUML1を活用して業務フローの可視化を始めました。PlantUMLはオープンソースのUMLダイアグラム作成用のテキストベースの言語であり、シークエンス図、ユースケース図、アクティビティ図、クラス図などのダイアグラムをシンプルで直感的に書くことができます。 \n\n私がネクイノに入社してから使用し始めたのは、Emacsのorg-babelで実装された2014年頃であり、esa.ioやVS Codeなどで実装されてから爆発的に普及したと記憶しています。私がesa.ioでPlantUMLの実装を要望したのも良い思い出です。  > やったことやったこと \n\nさて、私はネクイノに入社してすぐに既存システムの運用開発と情シス（業務運用）の部長職にアサインされました。外部パートナーが入るということで、開発フローが大きく変わる節目にありました。  > 開発フローを整備する開発フローを整備する \n\n開発フローを整備するために、新しく入る外部パートナーがプロジェクトマネージャ、ブリッジエンジニア・コミュニケーター、モバイルエンジニア、バックエンドエンジニア、フロントエンジニア、品質チェックを含めて20名程の体制であることを把握しました。また、既存システムの運用開発ではプロダクトマネジャー、プロダクトオーナーが各開発者とともに企画策定を行うことが慣習として存在していました。そこで、私は企画から実装、レビュー、リリースまでの流れを整理しました。 \n\n 開発の流れ \n\nその結果、開発フローはJira上で大まかな流れとして、エピック(仕様策定)、エピック(見積)、エピック(実装)、エピック(レビュー)、エピック(リリース)という5つのステップに分かれました。このフローをPlantUMLを使って可視化しました。 \n\n  > 要望フローを整備する要望フローを整備する \n\nまた、要望フローについても同様に整備しました。機能要望、バグ報告、改善要望がSlackチャンネルに散在しており、チケット化されないケースがあったため、GoogleフォームとJira連携を行い、要望の集約とトリアージを行いました2。プロダクトマネジャーの体制が整備された後も、バグ報告や改善要望は要所要所で利用され、トリアージが定期的に活用されるようになりました。 \n\n  > デプロイフローを整備するデプロイフローを整備する \n\n開発が進んでいくと、今度は開発環境が足りなくなりました。当時はステージング環境と本番環境しかなく、かつ、ステージング環境がテスト環境兼デモ環境の役割を呈しており、ステージング環境おテストで不具合を起こすとデモに影響が出るという状態が続いておりました。また、外部パートナーが開発するに当たり繊細なステージング環境を使うのが難しいため進捗に影響が出始めておりました。 \n\n急を要する事態のためAWS CDKでステージング環境とは別に結合環境を用意し3、デプロイフローを整備しました。 \n\n  > 障害対応フローを整備する障害対応フローを整備する \n\nさて、運用開発が順調に進んでいくと、今度は障害が頻繁に起きていることに気づきました。いいえ、薄々気づいていたのですが多忙にかまけて蓋をしておりました。ここに関しては本腰を入れてAWSサポートプランをビジネスに変更し原因を突き止めました。協力いただいた各位には感謝です。 \n\nまた、今まで見過ごされていたGoogle Workspace等の業務運用のシステムも含め障害報告の体制を敷くとともに、監視体制も強化しました。 \n\n  > 業務フローを整理する業務フローを整理する \n\nまだまだあります。業務内容に関しては詳細は書けませんが、部内の業務から他部署の業務まで安全に生産性を高めるため整理を行いました。まだまだ行います。  > リモート飲みのフローを整備するリモート飲みのフローを整備する \n\nいよいよ疲れてきたのでお酒が飲みたくなりました。飲み会フローを作ってみましたが思いの外手間がかかることが分かりあまり活用できておりません。その代わり社内でオンラインシャッフルランチという制度ができました。 \n\n  > 分かったこと分かったこと \n\nはい、こうして振り返ると入社時に感じていた雑然さは業務フローが明確でない状態のことでした。開発者なら分かると思いますが、企画段階で思い描く構成図は実装する段になるとあまり意味をなさず、結局は頭の中はシークエンス図でいっぱいになります。それと同じで、登場人物、登場人物間のメッセージ、メッセージの大枠が関係者に共有されていないと、いくらリソースが投下されても不安定で生産性に伸び悩むのです。つまり、雑然とした環境を整理すると言うことはシークエンス図を書くことに他なりません。 \n\nしかしながら、当該環境一つ一つを俯瞰的に見るとITILプラクティスそのものであることにも気づきます。 \n\nITILとはITサービスマネジメントのベストプラクティスフレームワークのこと。何らかの高い技術を持っていても、投資対効果を考えていなければ赤字になりビジネスと成り立ちませんし、顧客のことを考えずに作ったものに価値はありませんし、サービスの評価を落とすことになります。このようなことを防ぐには顧客目線やビジネス的な観点が必要で、そのノウハウがまとまったものがITILです。  > 今回対応したプラクティス今回対応したプラクティス \n\n今回の振り返りでは具体的に次のプラクティスをなぞっておりました。    振り返り ITILプラクティス     開発フローを整備する 継続的サービス改善   要望フローを整備する 要求管理、問題管理   デプロイフローを整備する リリース管理及び展開管理   障害対応フローを整備する インシデント管理   業務フローを整理する CMMI   リモート飲みのフローを整備する 組織変更管理    \n\nCMMIと組織変更管理が分かりづらいの少し補足します。 \n\n- CMMIとは能力成熟度モデル統合のことで、業務フローを評価し5段階で成熟度レベルを出す手法です。現状はレベル1-2（初期段階）のものがほとんどなのでまずはPlantUMLを使い共通認識を作るところから始めました。\n- 組織変更管理とは経営学で言うところのチェンジマネジメントに当たります。ここでは各種フローを整備しメンバー全員に落とし込むことを目指します。『Fearless Change』では今回のリモート飲み以外にも多くのパターンランゲージが紹介されています。  > WRAPUPWRAPUP  > 次にすること次にすること \n\nネクストアクションですが、採用フローを考えています。 \n\n（読者の皆様はどんなシークエンス図を思い浮かべましたか?） \n\nというわけで、ネクイノはPlantUMLを愛している開発者を募集中です。  > PR__colon__ ネクイノとはPR: ネクイノとは \n\n「世界中の医療空間と体験を再定義する」をミッションに、人々と医療の間にICTのチカラで橋をかける遠隔医療ソリューションを手掛けている会社です。医療というと高齢の患者さんをイメージされるかもしれませんが、我らがターゲットとしているのは現役世代の方。病気を治療するというより、現役世代がQOLを高めるためのサポートを目的としています。 \n\nメインサービスは、女性に特化したピルのオンライン診療アプリ「スマルナ」。ピルを飲まれている人だけでなく、受診や服用に抵抗がある方にも気軽に利用していただけたらと思いサービス提供しています。診察室の手前に助産師と薬剤師を配置した相談室を設ける等、受診のハードルを下げる工夫をそこかしこに施しているのが特徴です。 \n\n様々なメディカルコミュニケーションを行っています - 専門家相談 - カスタマーサポート - ユーザーコミュニティ  \n\n妻からは「10年前にサービスがあったら良かったのに」とお墨付きをいただいており、興味をもった方は詳しくはこちらをご覧下さい。 https://smaluna.com/  \n\n1. [B! plantuml] nabinnoのブックマーク ↩ \n2. https://github.com/nabinno/google-forms-to-jira-slack ↩ \n3. CDKはaws-rails-provisionerを参考に ecs_patterns.ApplicationLoadBalancedFargateService を実装しました ↩"},"name":"[2020-12-30]整理したい私はITILをかぶる、PlantUMLへの愛","tags":["team-building"],"childPublishedDate":{"published_on":"2020-12-30T00:00:00.000Z","published_on_unix":1609286400}}}]}},"pageContext":{"number":59}},"staticQueryHashes":[]}