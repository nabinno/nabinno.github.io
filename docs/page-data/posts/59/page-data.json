{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/59","result":{"data":{"esaPost":{"number":59,"relative_category":"blog/backend","fields":{"title":"連載 Rails2Phoenix 1 UmbrellaプロジェクトをHerokuにデプロイする","excerpt":"使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。   > PROBLEMPROBLEM \n\n- サービスについて 拡張にともない技術スタックがふえるのを抑えたい スケーラビリティのためのコストを抑えたい パフォーマンスをあげたい \n- 拡張にともない技術スタックがふえるのを抑えたい\n- スケーラビリティのためのコストを抑えたい\n- パフォーマンスをあげたい   > SOLUTIONSOLUTION \n\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。 \n\n方針 \n\n- Railsから徐々にPhoenixに移行できるように いままでとおなじPaaS（Heroku） いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく いままでとおなじDB 移行完了までDBマイグレーションをしない \n- いままでとおなじPaaS（Heroku）\n- いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく \n- ブランチ戦略は phoenix/base をベースに\n- 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\n- いままでとおなじDB 移行完了までDBマイグレーションをしない \n- 移行完了までDBマイグレーションをしない\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで   > HerokuへのデプロイのながれHerokuへのデプロイのながれ \n\n基本的にドキュメント通り。   > Phoenixアプリケーションを作成Phoenixアプリケーションを作成 \n\nまず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル apps/, deps/, config/config.exs, mix.exs, mix.lock が追加されます。   sh \n\n> cd rails_project > mix new . --umbrella > (cd ./apps && mix phx.new phoenix_app)   \n\n次に、既存のRailsでつくられたスキーマをPhoenixに移植します。Ripperをつかうとはかどります。ちなみに手動でスキーマをつくりたい場合は、CLI mix phx.gen.schema --no-migration Blog.Post blog_posts title:string で作成します。   rb \n\n# lib/tasks/convert_to_phoenix.rake # こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの require 'ripper' require 'erb' require 'fileutils' namespace :db do namespace :schema do desc 'Convert schema from Rails to Phoenix' task convert_to_phoenix: :environment do ConvertSchemaForPhoenixService.call end end end class ConvertSchemaForPhoenixService class << self def call FileUtils.mkdir_p(File.join('tmp', 'models')) extract_activerecord_define_block( Ripper.sexp( Rails.root .join('db', 'schema.rb') .read ) ).select(&method(:create_table_block?)) .map(&method(:configuration)) .each do |conf| project_name = 'PhoenixApp' table_name = conf[:table_name] table_columns = conf[:table_columns].reject(&method(:reject_condition)) .map do |c| case c[:column_type] when 'text' then c[:column_type] = ':string' when 'datetime' then c[:column_type] = ':naive_datetime' when 'inet' then c[:column_type] = 'EctoNetwork.INET' else c[:column_type] = \":#{c[:column_type]}\" end c end File.write( File.join('tmp', 'models', \"#{conf[:table_name].singularize}.ex\"), template.result(binding) ) end end private def extract_activerecord_define_block(sexp) sexp.dig(1, 0, 2, 2) end def create_table_block?(activerecord_define_block_element_sexp) activerecord_define_block_element_sexp.dig(1, 1, 1) == 'create_table' rescue false end def extract_table_name(create_table_block_sexp) create_table_block_sexp.dig(1, 2, 1, 0, 1, 1, 1) end def extract_table_columns(create_table_block_sexp) create_table_block_sexp.dig(2, 2) end def extract_column_type(table_column_sexp) table_column_sexp.dig(3, 1) end def extract_column_name(table_column_sexp) # Return value of `t.index` is array like ['user_id']. if table_column_sexp.dig(4, 1, 0, 0) == :array return table_column_sexp.dig(4, 1, 0, 1).map { |e| e.dig(1, 1, 1) } end table_column_sexp.dig(4, 1, 0, 1, 1, 1) end def extract_column_option(table_column_sexp) # If is not `column_option`, then `table_column_sexp.dig(4, 1, 1, # 1)` method return nil. Set blank array ([]) for avoiding nil. table_column_sexp.dig(4, 1, 1, 1) || [] end def extract_option_key(column_option_sexp) # Remove colon for avoiding `null:`. column_option_sexp.dig(1, 1).gsub(/:\\z/, '') end def extract_option_value(column_option_sexp) if column_option_sexp.dig(2, 0) == :array return Array(column_option_sexp.dig(2, 1)).map { |e| e.dig(1, 1, 1) } end element = column_option_sexp.dig(2, 1) if element.class != Array return element end case element.dig(0) when :kw then element.dig(1) when :string_content then element.dig(1, 1) || '' end end def template ERB.new(<<'__EOD__', nil, '-') defmodule <%= project_name %>.<%= table_name.classify %> do use Ecto.Schema import Ecto.Changeset alias <%= project_name %>.<%= table_name.classify %> schema \"<%= table_name %>\" do<% table_columns.each do |c| %> field :<%= c[:column_name] -%>, <%= c[:column_type] -%> <% end %> timestamps inserted_at: :created_at end @doc false def changeset(%<%= table_name.classify %>{} = <%= table_name.singularize %>, attrs) do <%= table_name.singularize %> |> cast(attrs, [<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>]) # |> validate_required([<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>]) end end __EOD__ end def configuration(table) { table_name: extract_table_name(table), table_columns: extract_table_columns(table).map do |c| { column_name: extract_column_name(c), column_type: extract_column_type(c), column_option: Hash[extract_column_option(c).map { |o| [extract_option_key(o), extract_option_value(o)] }] } end } end def reject_condition(column) column[:column_name] =~ /\\A(created|updated)_at\\z/ || column[:column_type] == 'index' end end end     sh \n\n> rails db:schema:convert_to_phoenix   \n\n最後に、既存DBへはこんな感じで接続します。   config \n\n# rails_project/apps/phoenix_app/config/dev.exs config :phoenix_app, PhoenixApp.Repo, adapter: Ecto.Adapters.Postgres, url: System.get_env(\"DATABASE_URL\"), pool_size: 10, ssl: true     sh \n\n> (cd ./apps/phoenix_app/assets && npm install) > mix deps.get > mix phx.server     > デプロイのパイプラインを追加デプロイのパイプラインを追加 \n\nさて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。 \n\nBEFORE \n\n- build (all branch) deploy.prod (master branch) \n- deploy.prod (master branch) \n\nAFTER \n\n- build (all branch) deploy.prod (master branch) deploy.phoenix.prod (phoenix/base branch) \n- deploy.prod (master branch)\n- deploy.phoenix.prod (phoenix/base branch)   yaml \n\n# wercker.yml deploy-phoenix-prod-heroku: steps: - add-ssh-key: host: github.com keyname: GITHUB - add-to-known_hosts: hostname: github.com fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48 - heroku-deploy: key: $HEROKU_KEY user: $HEROKU_USER app-name: $HEROKU_APP_NAME install-toolbelt: true after-steps: - wantedly/pretty-slack-notify: webhook_url: ${SLACK_WEBHOOK_URL} channel: general     > Herokuアプリケーションを作成Herokuアプリケーションを作成 \n\n基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ rails_project/config/prod.exs をこう rails_project/apps/phoenix_app/config/prod.exs 変更します。 \n\n1. Herokuアプリにビルドパックを適用   sh \n\n> heroku create --buildpack https://github.com/HashNuke/heroku-buildpack-elixir.git > heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git   \n\n2. 起動設定を準備   config \n\n# rails_project/elixir_buildpack.config erlang_version=19.1 elixir_version=1.4.2 always_rebuild=false pre_compile=\"pwd\" post_compile=\"pwd\" runtime_path=/app config_vars_to_export=(DATABASE_URL) config_vars_to_export=(DATABASE_POOL_SIZE)     config \n\n# rails_project/phoenix_static_buildpack.config phoenix_relative_path=apps/phoenix_app     config \n\n# rails_project/Procfile web: MIX_ENV=prod mix phx.server   \n\n3. 環境変数を適用 \n\nデータベース関連。   config \n\n# rails_project/apps/phoenix_app/config/prod.exs config :phoenix_app, PhoenixApp.Repo, adapter: Ecto.Adapters.Postgres, url: System.get_env(\"DATABASE_URL\"), pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10), ssl: true     sh \n\nheroku config:set DATABASE_URL=foo heroku config:set DATABASE_POOL_SIZE=bar   \n\nクレデンシャル関連。   sh \n\n> heroku config:set HEROKU_API_KEY=$(heroku auth:token) > heroku config:set SECRET_KEY_BASE=$(mix phx.gen.secret)     > WRAPUPWRAPUP \n\n大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"},"wip":false,"body_md":"<img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\">\r\n\r\n使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。\r\n\r\n# PROBLEM\r\n- サービスについて\r\n    - 拡張にともない技術スタックがふえるのを抑えたい\r\n    - スケーラビリティのためのコストを抑えたい\r\n    - パフォーマンスをあげたい\r\n\r\n# SOLUTION\r\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。\r\n\r\n**方針**\r\n- Railsから徐々にPhoenixに移行できるように\r\n  - いままでとおなじPaaS（Heroku）\r\n  - いままでとおなじレポジトリ\r\n      - ブランチ戦略は `phoenix/base` をベースに\r\n      - 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\r\n  - いままでとおなじDB\r\n      - 移行完了までDBマイグレーションをしない\r\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで\r\n\r\n## Herokuへのデプロイのながれ\r\n基本的に[ドキュメント](https://hexdocs.pm/phoenix/heroku.html)通り。\r\n\r\n### Phoenixアプリケーションを作成\r\nまず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル `apps/`, `deps/`, `config/config.exs`, `mix.exs`, `mix.lock` が追加されます。\r\n```sh\r\n> cd rails_project\r\n> mix new . --umbrella\r\n> (cd ./apps && mix phx.new phoenix_app)\r\n```\r\n\r\n次に、既存のRailsでつくられたスキーマをPhoenixに移植します。[Ripperをつかうとはかどります](http://developersnote.jp/elixir/share-db-between-rails-and-phoenix.html)。ちなみに手動でスキーマをつくりたい場合は、CLI `mix phx.gen.schema --no-migration Blog.Post blog_posts title:string` で作成します。\r\n```rb\r\n# lib/tasks/convert_to_phoenix.rake\r\n# こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの\r\nrequire 'ripper'\r\nrequire 'erb'\r\nrequire 'fileutils'\r\n\r\nnamespace :db do\r\n  namespace :schema do\r\n    desc 'Convert schema from Rails to Phoenix'\r\n    task convert_to_phoenix: :environment do\r\n      ConvertSchemaForPhoenixService.call\r\n    end\r\n  end\r\nend\r\n\r\nclass ConvertSchemaForPhoenixService\r\n  class << self\r\n    def call\r\n      FileUtils.mkdir_p(File.join('tmp', 'models'))\r\n      extract_activerecord_define_block(\r\n        Ripper.sexp(\r\n          Rails.root\r\n               .join('db', 'schema.rb')\r\n               .read\r\n        )\r\n      ).select(&method(:create_table_block?))\r\n       .map(&method(:configuration))\r\n       .each do |conf|\r\n        project_name = 'PhoenixApp'\r\n        table_name = conf[:table_name]\r\n        table_columns = conf[:table_columns].reject(&method(:reject_condition))\r\n                                            .map do |c|\r\n          case c[:column_type]\r\n          when 'text' then c[:column_type] = ':string'\r\n          when 'datetime' then c[:column_type] = ':naive_datetime'\r\n          when 'inet' then c[:column_type] = 'EctoNetwork.INET'\r\n          else c[:column_type] = \":#{c[:column_type]}\"\r\n          end\r\n          c\r\n        end\r\n        File.write(\r\n          File.join('tmp', 'models', \"#{conf[:table_name].singularize}.ex\"),\r\n          template.result(binding)\r\n        )\r\n      end\r\n    end\r\n\r\n    private\r\n\r\n    def extract_activerecord_define_block(sexp)\r\n      sexp.dig(1, 0, 2, 2)\r\n    end\r\n\r\n    def create_table_block?(activerecord_define_block_element_sexp)\r\n      activerecord_define_block_element_sexp.dig(1, 1, 1) == 'create_table'\r\n    rescue\r\n      false\r\n    end\r\n\r\n    def extract_table_name(create_table_block_sexp)\r\n      create_table_block_sexp.dig(1, 2, 1, 0, 1, 1, 1)\r\n    end\r\n\r\n    def extract_table_columns(create_table_block_sexp)\r\n      create_table_block_sexp.dig(2, 2)\r\n    end\r\n\r\n    def extract_column_type(table_column_sexp)\r\n      table_column_sexp.dig(3, 1)\r\n    end\r\n\r\n    def extract_column_name(table_column_sexp)\r\n      # Return value of `t.index` is array like ['user_id'].\r\n      if table_column_sexp.dig(4, 1, 0, 0) == :array\r\n        return table_column_sexp.dig(4, 1, 0, 1).map { |e| e.dig(1, 1, 1) }\r\n      end\r\n      table_column_sexp.dig(4, 1, 0, 1, 1, 1)\r\n    end\r\n\r\n    def extract_column_option(table_column_sexp)\r\n      # If is not `column_option`, then `table_column_sexp.dig(4, 1, 1,\r\n      # 1)` method return nil. Set blank array ([]) for avoiding nil.\r\n      table_column_sexp.dig(4, 1, 1, 1) || []\r\n    end\r\n\r\n    def extract_option_key(column_option_sexp)\r\n      # Remove colon for avoiding `null:`.\r\n      column_option_sexp.dig(1, 1).gsub(/:\\z/, '')\r\n    end\r\n\r\n    def extract_option_value(column_option_sexp)\r\n      if column_option_sexp.dig(2, 0) == :array\r\n        return Array(column_option_sexp.dig(2, 1)).map { |e| e.dig(1, 1, 1) }\r\n      end\r\n      element = column_option_sexp.dig(2, 1)\r\n      if element.class != Array\r\n        return element\r\n      end\r\n      case element.dig(0)\r\n      when :kw then element.dig(1)\r\n      when :string_content then element.dig(1, 1) || ''\r\n      end\r\n    end\r\n\r\n    def template\r\n      ERB.new(<<'__EOD__', nil, '-')\r\ndefmodule <%= project_name %>.<%= table_name.classify %> do\r\n  use Ecto.Schema\r\n  import Ecto.Changeset\r\n  alias <%= project_name %>.<%= table_name.classify %>\r\n\r\n  schema \"<%= table_name %>\" do<% table_columns.each do |c| %>\r\n    field :<%= c[:column_name] -%>, <%= c[:column_type] -%>\r\n<% end %>\r\n    timestamps inserted_at: :created_at\r\n  end\r\n\r\n  @doc false\r\n  def changeset(%<%= table_name.classify %>{} = <%= table_name.singularize %>, attrs) do\r\n    <%= table_name.singularize %>\r\n    |> cast(attrs, [<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>])\r\n    # |> validate_required([<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>])\r\n  end\r\nend\r\n__EOD__\r\n    end\r\n\r\n    def configuration(table)\r\n      {\r\n        table_name: extract_table_name(table),\r\n        table_columns: extract_table_columns(table).map do |c|\r\n          {\r\n            column_name: extract_column_name(c),\r\n            column_type: extract_column_type(c),\r\n            column_option: Hash[extract_column_option(c).map { |o| [extract_option_key(o), extract_option_value(o)] }]\r\n          }\r\n        end\r\n      }\r\n    end\r\n\r\n    def reject_condition(column)\r\n      column[:column_name] =~ /\\A(created|updated)_at\\z/ || column[:column_type] == 'index'\r\n    end\r\n  end\r\nend\r\n```\r\n```sh\r\n> rails db:schema:convert_to_phoenix\r\n```\r\n\r\n最後に、既存DBへはこんな感じで接続します。\r\n```config\r\n# rails_project/apps/phoenix_app/config/dev.exs\r\nconfig :phoenix_app, PhoenixApp.Repo,\r\n  adapter: Ecto.Adapters.Postgres,\r\n  url: System.get_env(\"DATABASE_URL\"),\r\n  pool_size: 10,\r\n  ssl: true\r\n```\r\n```sh\r\n> (cd ./apps/phoenix_app/assets && npm install)\r\n> mix deps.get\r\n> mix phx.server\r\n```\r\n\r\n## デプロイのパイプラインを追加\r\nさて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。\r\n\r\n**BEFORE**\r\n- build (all branch)\r\n    - deploy.prod (master branch)\r\n\r\n**AFTER**\r\n- build (all branch)\r\n    - deploy.prod (master branch)\r\n    - deploy.phoenix.prod (phoenix/base branch)\r\n\r\n```yaml\r\n# wercker.yml\r\ndeploy-phoenix-prod-heroku:\r\n  steps:\r\n    - add-ssh-key:\r\n        host: github.com\r\n        keyname: GITHUB\r\n    - add-to-known_hosts:\r\n        hostname: github.com\r\n        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48\r\n    - heroku-deploy:\r\n        key: $HEROKU_KEY\r\n        user: $HEROKU_USER\r\n        app-name: $HEROKU_APP_NAME\r\n        install-toolbelt: true\r\n  after-steps:\r\n    - wantedly/pretty-slack-notify:\r\n        webhook_url: ${SLACK_WEBHOOK_URL}\r\n        channel: general\r\n```\r\n\r\n### Herokuアプリケーションを作成\r\n基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ `rails_project/config/prod.exs` をこう `rails_project/apps/phoenix_app/config/prod.exs` 変更します。\r\n\r\n**1. Herokuアプリにビルドパックを適用**\r\n```sh\r\n> heroku create --buildpack https://github.com/HashNuke/heroku-buildpack-elixir.git\r\n> heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git\r\n```\r\n\r\n**2. 起動設定を準備**\r\n```config\r\n# rails_project/elixir_buildpack.config\r\nerlang_version=19.1\r\nelixir_version=1.4.2\r\nalways_rebuild=false\r\npre_compile=\"pwd\"\r\npost_compile=\"pwd\"\r\nruntime_path=/app\r\nconfig_vars_to_export=(DATABASE_URL)\r\nconfig_vars_to_export=(DATABASE_POOL_SIZE)\r\n```\r\n```config\r\n# rails_project/phoenix_static_buildpack.config\r\nphoenix_relative_path=apps/phoenix_app\r\n```\r\n```config\r\n# rails_project/Procfile\r\nweb: MIX_ENV=prod mix phx.server\r\n```\r\n\r\n**3. 環境変数を適用**\r\n\r\nデータベース関連。\r\n```config\r\n# rails_project/apps/phoenix_app/config/prod.exs\r\nconfig :phoenix_app, PhoenixApp.Repo,\r\n  adapter: Ecto.Adapters.Postgres,\r\n  url: System.get_env(\"DATABASE_URL\"),\r\n  pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10),\r\n  ssl: true\r\n```\r\n```sh\r\nheroku config:set DATABASE_URL=foo\r\nheroku config:set DATABASE_POOL_SIZE=bar\r\n```\r\n\r\nクレデンシャル関連。\r\n```sh\r\n> heroku config:set HEROKU_API_KEY=$(heroku auth:token)\r\n> heroku config:set SECRET_KEY_BASE=$(mix phx.gen.secret)\r\n```\r\n\r\n# WRAPUP\r\n大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。","body_html":"<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\"></a>\n<p data-sourcepos=\"3:1-3:338\">使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。</p>\n<h1 data-sourcepos=\"5:1-5:9\" id=\"1-0-0\" name=\"1-0-0\">\n<a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"6:1-10:0\">\n<li data-sourcepos=\"6:1-10:0\">サービスについて\n<ul data-sourcepos=\"7:5-10:0\">\n<li data-sourcepos=\"7:5-7:75\">拡張にともない技術スタックがふえるのを抑えたい</li>\n<li data-sourcepos=\"8:5-8:66\">スケーラビリティのためのコストを抑えたい</li>\n<li data-sourcepos=\"9:5-10:0\">パフォーマンスをあげたい</li>\n</ul>\n</li>\n</ul>\n<h1 data-sourcepos=\"11:1-11:10\" id=\"2-0-0\" name=\"2-0-0\">\n<a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"12:1-12:255\">というわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。</p>\n<p data-sourcepos=\"14:1-14:10\"><strong>方針</strong></p>\n<ul data-sourcepos=\"15:1-23:0\">\n<li data-sourcepos=\"15:1-21:64\">Railsから徐々にPhoenixに移行できるように\n<ul data-sourcepos=\"16:3-21:64\">\n<li data-sourcepos=\"16:3-16:44\">いままでとおなじPaaS（Heroku）</li>\n<li data-sourcepos=\"17:3-19:100\">いままでとおなじレポジトリ\n<ul data-sourcepos=\"18:7-19:100\">\n<li data-sourcepos=\"18:7-18:60\">ブランチ戦略は <code>phoenix/base</code> をベースに</li>\n<li data-sourcepos=\"19:7-19:100\">気軽に参照できるようにRails関連ファイルは可能な限りのこしておく</li>\n</ul>\n</li>\n<li data-sourcepos=\"20:3-21:64\">いままでとおなじDB\n<ul data-sourcepos=\"21:7-21:64\">\n<li data-sourcepos=\"21:7-21:64\">移行完了までDBマイグレーションをしない</li>\n</ul>\n</li>\n</ul>\n</li>\n<li data-sourcepos=\"22:1-23:0\">Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで</li>\n</ul>\n<h2 data-sourcepos=\"24:1-24:39\" id=\"2-1-0\" name=\"2-1-0\">\n<a class=\"anchor\" id=\"Herokuへのデプロイのながれ\" name=\"Heroku%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%AA%E3%81%8C%E3%82%8C\" href=\"#Heroku%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%AA%E3%81%8C%E3%82%8C\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Herokuへのデプロイのながれ\"> &gt; Herokuへのデプロイのながれ</span></a>Herokuへのデプロイのながれ</h2>\n<p data-sourcepos=\"25:1-25:81\">基本的に<a href=\"https://hexdocs.pm/phoenix/heroku.html\" target=\"_blank\" rel=\"noopener noreferrer\">ドキュメント</a>通り。</p>\n<h3 data-sourcepos=\"27:1-27:44\" id=\"2-1-1\" name=\"2-1-1\">\n<a class=\"anchor\" id=\"Phoenixアプリケーションを作成\" name=\"Phoenix%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" href=\"#Phoenix%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Phoenixアプリケーションを作成\"> &gt; Phoenixアプリケーションを作成</span></a>Phoenixアプリケーションを作成</h3>\n<p data-sourcepos=\"28:1-28:181\">まず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル <code>apps/</code>, <code>deps/</code>, <code>config/config.exs</code>, <code>mix.exs</code>, <code>mix.lock</code> が追加されます。</p>\n<div class=\"code-block\" data-sourcepos=\"29:1-33:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> <span class=\"nb\">cd </span>rails_project\n<span class=\"o\">&gt;</span> mix new <span class=\"nb\">.</span> <span class=\"nt\">--umbrella</span>\n<span class=\"o\">&gt;</span> <span class=\"o\">(</span><span class=\"nb\">cd</span> ./apps <span class=\"o\">&amp;&amp;</span> mix phx.new phoenix_app<span class=\"o\">)</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"35:1-35:359\">次に、既存のRailsでつくられたスキーマをPhoenixに移植します。<a href=\"http://developersnote.jp/elixir/share-db-between-rails-and-phoenix.html\" target=\"_blank\" rel=\"noopener noreferrer\">Ripperをつかうとはかどります</a>。ちなみに手動でスキーマをつくりたい場合は、CLI <code>mix phx.gen.schema --no-migration Blog.Post blog_posts title:string</code> で作成します。</p>\n<div class=\"code-block\" data-sourcepos=\"36:1-182:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>rb</div>\n<div class=\"highlight\"><pre class=\"highlight ruby\"><code><span class=\"c1\"># lib/tasks/convert_to_phoenix.rake</span>\n<span class=\"c1\"># こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'ripper'</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'erb'</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'fileutils'</span>\n\n<span class=\"n\">namespace</span> <span class=\"ss\">:db</span> <span class=\"k\">do</span>\n  <span class=\"n\">namespace</span> <span class=\"ss\">:schema</span> <span class=\"k\">do</span>\n    <span class=\"n\">desc</span> <span class=\"s1\">'Convert schema from Rails to Phoenix'</span>\n    <span class=\"n\">task</span> <span class=\"ss\">convert_to_phoenix: :environment</span> <span class=\"k\">do</span>\n      <span class=\"no\">ConvertSchemaForPhoenixService</span><span class=\"p\">.</span><span class=\"nf\">call</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">ConvertSchemaForPhoenixService</span>\n  <span class=\"k\">class</span> <span class=\"o\">&lt;&lt;</span> <span class=\"nb\">self</span>\n    <span class=\"k\">def</span> <span class=\"nf\">call</span>\n      <span class=\"no\">FileUtils</span><span class=\"p\">.</span><span class=\"nf\">mkdir_p</span><span class=\"p\">(</span><span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'tmp'</span><span class=\"p\">,</span> <span class=\"s1\">'models'</span><span class=\"p\">))</span>\n      <span class=\"n\">extract_activerecord_define_block</span><span class=\"p\">(</span>\n        <span class=\"no\">Ripper</span><span class=\"p\">.</span><span class=\"nf\">sexp</span><span class=\"p\">(</span>\n          <span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">root</span>\n               <span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'db'</span><span class=\"p\">,</span> <span class=\"s1\">'schema.rb'</span><span class=\"p\">)</span>\n               <span class=\"p\">.</span><span class=\"nf\">read</span>\n        <span class=\"p\">)</span>\n      <span class=\"p\">).</span><span class=\"nf\">select</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:create_table_block?</span><span class=\"p\">))</span>\n       <span class=\"p\">.</span><span class=\"nf\">map</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:configuration</span><span class=\"p\">))</span>\n       <span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">conf</span><span class=\"o\">|</span>\n        <span class=\"n\">project_name</span> <span class=\"o\">=</span> <span class=\"s1\">'PhoenixApp'</span>\n        <span class=\"n\">table_name</span> <span class=\"o\">=</span> <span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_name</span><span class=\"p\">]</span>\n        <span class=\"n\">table_columns</span> <span class=\"o\">=</span> <span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_columns</span><span class=\"p\">].</span><span class=\"nf\">reject</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:reject_condition</span><span class=\"p\">))</span>\n                                            <span class=\"p\">.</span><span class=\"nf\">map</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span>\n          <span class=\"k\">case</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'text'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">':string'</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'datetime'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">':naive_datetime'</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'inet'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">'EctoNetwork.INET'</span>\n          <span class=\"k\">else</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\":</span><span class=\"si\">#{</span><span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n          <span class=\"k\">end</span>\n          <span class=\"n\">c</span>\n        <span class=\"k\">end</span>\n        <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">write</span><span class=\"p\">(</span>\n          <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'tmp'</span><span class=\"p\">,</span> <span class=\"s1\">'models'</span><span class=\"p\">,</span> <span class=\"s2\">\"</span><span class=\"si\">#{</span><span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_name</span><span class=\"p\">].</span><span class=\"nf\">singularize</span><span class=\"si\">}</span><span class=\"s2\">.ex\"</span><span class=\"p\">),</span>\n          <span class=\"n\">template</span><span class=\"p\">.</span><span class=\"nf\">result</span><span class=\"p\">(</span><span class=\"nb\">binding</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"kp\">private</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_activerecord_define_block</span><span class=\"p\">(</span><span class=\"n\">sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_table_block?</span><span class=\"p\">(</span><span class=\"n\">activerecord_define_block_element_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">activerecord_define_block_element_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'create_table'</span>\n    <span class=\"k\">rescue</span>\n      <span class=\"kp\">false</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_table_name</span><span class=\"p\">(</span><span class=\"n\">create_table_block_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">create_table_block_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_table_columns</span><span class=\"p\">(</span><span class=\"n\">create_table_block_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">create_table_block_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_type</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_name</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># Return value of `t.index` is array like ['user_id'].</span>\n      <span class=\"k\">if</span> <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"ss\">:array</span>\n        <span class=\"k\">return</span> <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span> <span class=\"n\">e</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_option</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># If is not `column_option`, then `table_column_sexp.dig(4, 1, 1,</span>\n      <span class=\"c1\"># 1)` method return nil. Set blank array ([]) for avoiding nil.</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_option_key</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># Remove colon for avoiding `null:`.</span>\n      <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"nf\">gsub</span><span class=\"p\">(</span><span class=\"sr\">/:\\z/</span><span class=\"p\">,</span> <span class=\"s1\">''</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_option_value</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">)</span>\n      <span class=\"k\">if</span> <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"ss\">:array</span>\n        <span class=\"k\">return</span> <span class=\"no\">Array</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span> <span class=\"n\">e</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n      <span class=\"n\">element</span> <span class=\"o\">=</span> <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n      <span class=\"k\">if</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">class</span> <span class=\"o\">!=</span> <span class=\"no\">Array</span>\n        <span class=\"k\">return</span> <span class=\"n\">element</span>\n      <span class=\"k\">end</span>\n      <span class=\"k\">case</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n      <span class=\"k\">when</span> <span class=\"ss\">:kw</span> <span class=\"k\">then</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n      <span class=\"k\">when</span> <span class=\"ss\">:string_content</span> <span class=\"k\">then</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"s1\">''</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">template</span>\n      <span class=\"no\">ERB</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"o\">&lt;&lt;</span><span class=\"no\">'__EOD__'</span><span class=\"p\">,</span> <span class=\"kp\">nil</span><span class=\"p\">,</span> <span class=\"s1\">'-'</span><span class=\"p\">)</span><span class=\"sh\">\ndefmodule &lt;%= project_name %&gt;.&lt;%= table_name.classify %&gt; do\n  use Ecto.Schema\n  import Ecto.Changeset\n  alias &lt;%= project_name %&gt;.&lt;%= table_name.classify %&gt;\n\n  schema \"&lt;%= table_name %&gt;\" do&lt;% table_columns.each do |c| %&gt;\n    field :&lt;%= c[:column_name] -%&gt;, &lt;%= c[:column_type] -%&gt;\n&lt;% end %&gt;\n    timestamps inserted_at: :created_at\n  end\n\n  @doc false\n  def changeset(%&lt;%= table_name.classify %&gt;{} = &lt;%= table_name.singularize %&gt;, attrs) do\n    &lt;%= table_name.singularize %&gt;\n    |&gt; cast(attrs, [&lt;%= table_columns.map { |c| \":\" &lt;&lt; c[:column_name] }.join(\", \") -%&gt;])\n    # |&gt; validate_required([&lt;%= table_columns.map { |c| \":\" &lt;&lt; c[:column_name] }.join(\", \") -%&gt;])\n  end\nend\n</span><span class=\"no\">__EOD__</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">configuration</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">)</span>\n      <span class=\"p\">{</span>\n        <span class=\"ss\">table_name: </span><span class=\"n\">extract_table_name</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">),</span>\n        <span class=\"ss\">table_columns: </span><span class=\"n\">extract_table_columns</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span>\n          <span class=\"p\">{</span>\n            <span class=\"ss\">column_name: </span><span class=\"n\">extract_column_name</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">),</span>\n            <span class=\"ss\">column_type: </span><span class=\"n\">extract_column_type</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">),</span>\n            <span class=\"ss\">column_option: </span><span class=\"no\">Hash</span><span class=\"p\">[</span><span class=\"n\">extract_column_option</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">o</span><span class=\"o\">|</span> <span class=\"p\">[</span><span class=\"n\">extract_option_key</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">),</span> <span class=\"n\">extract_option_value</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)]</span> <span class=\"p\">}]</span>\n          <span class=\"p\">}</span>\n        <span class=\"k\">end</span>\n      <span class=\"p\">}</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reject_condition</span><span class=\"p\">(</span><span class=\"n\">column</span><span class=\"p\">)</span>\n      <span class=\"n\">column</span><span class=\"p\">[</span><span class=\"ss\">:column_name</span><span class=\"p\">]</span> <span class=\"o\">=~</span> <span class=\"sr\">/\\A(created|updated)_at\\z/</span> <span class=\"o\">||</span> <span class=\"n\">column</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">'index'</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"183:1-185:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> rails db:schema:convert_to_phoenix\n</code></pre></div>\n</div>\n<p data-sourcepos=\"187:1-187:62\">最後に、既存DBへはこんな感じで接続します。</p>\n<div class=\"code-block\" data-sourcepos=\"188:1-195:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/apps/phoenix_app/config/dev.exs\nconfig :phoenix_app, PhoenixApp.Repo,\n  adapter: Ecto.Adapters.Postgres,\n  url: System.get_env(\"DATABASE_URL\"),\n  pool_size: 10,\n  ssl: true\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"196:1-200:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> <span class=\"o\">(</span><span class=\"nb\">cd</span> ./apps/phoenix_app/assets <span class=\"o\">&amp;&amp;</span> npm <span class=\"nb\">install</span><span class=\"o\">)</span>\n<span class=\"o\">&gt;</span> mix deps.get\n<span class=\"o\">&gt;</span> mix phx.server\n</code></pre></div>\n</div>\n<h2 data-sourcepos=\"202:1-202:45\" id=\"2-2-0\" name=\"2-2-0\">\n<a class=\"anchor\" id=\"デプロイのパイプラインを追加\" name=\"%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0\" href=\"#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"デプロイのパイプラインを追加\"> &gt; デプロイのパイプラインを追加</span></a>デプロイのパイプラインを追加</h2>\n<p data-sourcepos=\"203:1-203:217\">さて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。</p>\n<p data-sourcepos=\"205:1-205:10\"><strong>BEFORE</strong></p>\n<ul data-sourcepos=\"206:1-208:0\">\n<li data-sourcepos=\"206:1-208:0\">build (all branch)\n<ul data-sourcepos=\"207:5-208:0\">\n<li data-sourcepos=\"207:5-208:0\">deploy.prod (master branch)</li>\n</ul>\n</li>\n</ul>\n<p data-sourcepos=\"209:1-209:9\"><strong>AFTER</strong></p>\n<ul data-sourcepos=\"210:1-213:0\">\n<li data-sourcepos=\"210:1-213:0\">build (all branch)\n<ul data-sourcepos=\"211:5-213:0\">\n<li data-sourcepos=\"211:5-211:33\">deploy.prod (master branch)</li>\n<li data-sourcepos=\"212:5-213:0\">deploy.phoenix.prod (phoenix/base branch)</li>\n</ul>\n</li>\n</ul>\n<div class=\"code-block\" data-sourcepos=\"214:1-233:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>yaml</div>\n<div class=\"highlight\"><pre class=\"highlight yaml\"><code><span class=\"c1\"># wercker.yml</span>\n<span class=\"na\">deploy-phoenix-prod-heroku</span><span class=\"pi\">:</span>\n  <span class=\"na\">steps</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"na\">add-ssh-key</span><span class=\"pi\">:</span>\n        <span class=\"na\">host</span><span class=\"pi\">:</span> <span class=\"s\">github.com</span>\n        <span class=\"na\">keyname</span><span class=\"pi\">:</span> <span class=\"s\">GITHUB</span>\n    <span class=\"pi\">-</span> <span class=\"na\">add-to-known_hosts</span><span class=\"pi\">:</span>\n        <span class=\"na\">hostname</span><span class=\"pi\">:</span> <span class=\"s\">github.com</span>\n        <span class=\"na\">fingerprint</span><span class=\"pi\">:</span> <span class=\"s\">16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48</span>\n    <span class=\"pi\">-</span> <span class=\"na\">heroku-deploy</span><span class=\"pi\">:</span>\n        <span class=\"na\">key</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_KEY</span>\n        <span class=\"na\">user</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_USER</span>\n        <span class=\"na\">app-name</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_APP_NAME</span>\n        <span class=\"na\">install-toolbelt</span><span class=\"pi\">:</span> <span class=\"no\">true</span>\n  <span class=\"na\">after-steps</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">wantedly/pretty-slack-notify</span><span class=\"pi\">:</span>\n        <span class=\"na\">webhook_url</span><span class=\"pi\">:</span> <span class=\"s\">${SLACK_WEBHOOK_URL}</span>\n        <span class=\"na\">channel</span><span class=\"pi\">:</span> <span class=\"s\">general</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"235:1-235:43\" id=\"2-2-1\" name=\"2-2-1\">\n<a class=\"anchor\" id=\"Herokuアプリケーションを作成\" name=\"Heroku%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" href=\"#Heroku%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" data-position=\"2-2-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Herokuアプリケーションを作成\"> &gt; Herokuアプリケーションを作成</span></a>Herokuアプリケーションを作成</h3>\n<p data-sourcepos=\"236:1-236:306\">基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ <code>rails_project/config/prod.exs</code> をこう <code>rails_project/apps/phoenix_app/config/prod.exs</code> 変更します。</p>\n<p data-sourcepos=\"238:1-238:52\"><strong>1. Herokuアプリにビルドパックを適用</strong></p>\n<div class=\"code-block\" data-sourcepos=\"239:1-242:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> heroku create <span class=\"nt\">--buildpack</span> https://github.com/HashNuke/heroku-buildpack-elixir.git\n<span class=\"o\">&gt;</span> heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git\n</code></pre></div>\n</div>\n<p data-sourcepos=\"244:1-244:28\"><strong>2. 起動設定を準備</strong></p>\n<div class=\"code-block\" data-sourcepos=\"245:1-255:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/elixir_buildpack.config\nerlang_version=19.1\nelixir_version=1.4.2\nalways_rebuild=false\npre_compile=\"pwd\"\npost_compile=\"pwd\"\nruntime_path=/app\nconfig_vars_to_export=(DATABASE_URL)\nconfig_vars_to_export=(DATABASE_POOL_SIZE)\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"256:1-259:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/phoenix_static_buildpack.config\nphoenix_relative_path=apps/phoenix_app\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"260:1-263:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/Procfile\nweb: MIX_ENV=prod mix phx.server\n</code></pre></div>\n</div>\n<p data-sourcepos=\"265:1-265:28\"><strong>3. 環境変数を適用</strong></p>\n<p data-sourcepos=\"267:1-267:27\">データベース関連。</p>\n<div class=\"code-block\" data-sourcepos=\"268:1-275:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/apps/phoenix_app/config/prod.exs\nconfig :phoenix_app, PhoenixApp.Repo,\n  adapter: Ecto.Adapters.Postgres,\n  url: System.get_env(\"DATABASE_URL\"),\n  pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10),\n  ssl: true\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"276:1-279:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>heroku config:set <span class=\"nv\">DATABASE_URL</span><span class=\"o\">=</span>foo\nheroku config:set <span class=\"nv\">DATABASE_POOL_SIZE</span><span class=\"o\">=</span>bar\n</code></pre></div>\n</div>\n<p data-sourcepos=\"281:1-281:30\">クレデンシャル関連。</p>\n<div class=\"code-block\" data-sourcepos=\"282:1-285:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> heroku config:set <span class=\"nv\">HEROKU_API_KEY</span><span class=\"o\">=</span><span class=\"si\">$(</span>heroku auth:token<span class=\"si\">)</span>\n<span class=\"o\">&gt;</span> heroku config:set <span class=\"nv\">SECRET_KEY_BASE</span><span class=\"o\">=</span><span class=\"si\">$(</span>mix phx.gen.secret<span class=\"si\">)</span>\n</code></pre></div>\n</div>\n<h1 data-sourcepos=\"287:1-287:8\" id=\"3-0-0\" name=\"3-0-0\">\n<a class=\"anchor\" id=\"WRAPUP\" name=\"WRAPUP\" href=\"#WRAPUP\" data-position=\"3-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"WRAPUP\"> &gt; WRAPUP</span></a>WRAPUP</h1>\n<p data-sourcepos=\"288:1-288:579\">大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。</p>\n","tags":["phoenix-framework","elixir","ruby-on-rails","ruby","wercker","heroku"],"updated_at":"2021-01-16T23:20:50+09:00","childPublishedDate":{"published_on":"2018-01-08T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_ef5f024307008aa399b91f87fa5f64e8.jpg"}},"relatedPosts":{"edges":[{"node":{"number":89,"relative_category":"blog/backend","fields":{"title":"imi-enrichment-addressは住所のバリデーションチェックでどの程度使えるか","excerpt":"コロナ禍であらゆる流通がオンラインに移行する中、正しい住所を使うことはいっそう求められています。ユーザーが配送用に住所を入力する時そのデータが正しいとどうやって判定するのでしょうか。今回はOSSライブラリimi-enrichment-addressが住所のバリデーションチェックでどの程度使えるか検証してみました。\n   > PROBLEMPROBLEM \n\n- 住所の不備が至るところで起きている 特に町名番地の抜けもれや不備が多くこの点をどうにか拾いたい 可能ならユーザーの入力時点でFEあるいはBE側でバリデーションチェックしたい まずはOSSのライブラリをで検証したい \n- 特に町名番地の抜けもれや不備が多くこの点をどうにか拾いたい\n- 可能ならユーザーの入力時点でFEあるいはBE側でバリデーションチェックしたい まずはOSSのライブラリをで検証したい \n- まずはOSSのライブラリをで検証したい  > SOLUTIONSOLUTION \n\nというわけで、昨年（2020年）経産省IMI（情報共有基盤）から公開された住所変換コンポーネント「IMI-Tool-Project/imi-enrichment-address」がバリデーションチェックでどの程度使えるか検証します。  > imi-enrichment-addressとはimi-enrichment-addressとは \n\n経産省IMIツールプロジェクトで公開された住所変換コンポーネントです。CLIとサーバーが用意されていますが、今回はCLIを見ていきます。 \n\nヘルプを見ると住所を引数として渡すことで処理されることが分かります。 sh\n\n$ npm install -g https://info.gbiz.go.jp/tools/imi_tools/resource/imi-enrichment-address/imi-enrichment-address-2.0.0.tgz $ imi-enrichment-address --help imi-enrichment-address 住所文字列をもとに住所型・場所型の情報を補完します オプション -h, --help このヘルプを表示します -f, --file file 変換対象とする JSON ファイル -s, --string string 変換対象とする住所文字列 -i, --indent number 出力する JSON のインデント (default 2) 実行例 ヘルプの表示 $ imi-enrichment-address -h 文字列の処理 $ imi-enrichment-address -s 霞が関2 ファイルの処理 $ imi-enrichment-address input.json 標準入力の処理 $ cat input.json | imi-enrichment-address  \n\n実行すると正確な住所を渡したときと不正確な住所を渡したときで異なった結果を返すことが分かります。今回はこの正確・不正確の異なった結果を利用して検証していこうと思います。 sh\n\n$ imi-enrichment-address -s 長野県長野市大字長野旭町1108 { \"@context\": \"https://imi.go.jp/ns/core/context.jsonld\", \"@type\": \"場所型\", \"住所\": { \"@type\": \"住所型\", \"表記\": \"長野県長野市大字長野旭町1108\", \"都道府県\": \"長野県\", \"都道府県コード\": \"http://data.e-stat.go.jp/lod/sac/C20000\", \"市区町村\": \"長野市\", \"市区町村コード\": \"http://data.e-stat.go.jp/lod/sac/C20201\", \"町名\": \"大字長野\" }, \"地理座標\": { \"@type\": \"座標型\", \"緯度\": \"36.674892\", \"経度\": \"138.178449\" } } $ imi-enrichment-address -s 長野県長野市旭町1108 { \"@context\": \"https://imi.go.jp/ns/core/context.jsonld\", \"@type\": \"場所型\", \"住所\": { \"@type\": \"住所型\", \"表記\": \"長野県長野市旭町1108\", \"都道府県\": \"長野県\", \"都道府県コード\": \"http://data.e-stat.go.jp/lod/sac/C20000\", \"市区町村\": \"長野市\", \"市区町村コード\": \"http://data.e-stat.go.jp/lod/sac/C20201\" }, \"メタデータ\": { \"@type\": \"文書型\", \"説明\": \"該当する町名が見つかりません\" } }  \n\nなお、GitHubコードを見るとimi-enrichment-addressは街区レベル位置参照情報を利用して実装しています。このことを考えるとバリデーションチェックで積極的につかうのは難しく、ユースケースとしては下記2点に落ち着くと考えます。 \n\n- ユーザーに住所の再確認を促す\n- 入力後の住所不備について人が目検で確認する前段階で利用  > 検証用データ検証用データ \n\nさて、検証に進みましょう。imi-enrichment-addressで検証するデータは簡易に使える住所.jp、その中の事業所住所22402件を使います。他にも検証データはありますが、コストもそれほどかけられないのでコマンドだけで完結するものを選んでいます。 sh\n\n$ curl http://jusyo.jp/downloads/new/csv/csv_zenkoku.zip csv_zenkoku.zip $ unzip csv_zenkoku.zip $ go get github.com/mithrandie/csvq $ csvq -f CSV \"SELECT COUNT(*) FROM zenkoku WHERE 事業所住所 IS NOT NULL\" COUNT(*) 22402   > imi-enrichment-addressで検証用データを確認するimi-enrichment-addressで検証用データを確認する \n\n今回実行したCLIはNodeJSであることと数時間で処理できるという点で逐次で済ませました。 sh\n\n$ for i in $( csvq -f CSV \"SELECT 都道府県,市区町村,事業所住所 FROM zenkoku WHERE 事業所住所 IS NOT NULL\" \\ | sed 's/,//g' \\ | tail +2 \\ ); do imi-enrichment-address -s $i \\ | jq -r ' [ .[\"住所\"][\"表記\"], ( if .[\"地理座標\"] != null then true else false end ), .[\"メタデータ\"][\"説明\"] ] | @csv ' >>output.csv; done &   > バリデーションチェックの結果を確認するバリデーションチェックの結果を確認する \n\nimi-enrichment-addressの出力結果を確認したところ全国で9.25%が無効、下記の通り町名番地の表記揺れに弱いことが分かりました。特に町字（まちあざ）省略によるバリデーションエラーの比率が高く、青森、長野、沖縄等複数の県の住所が実用に耐えない結果となりました。 \n\n- 各地方の字・大字の省略\n- 京都の通り上る・下るの表記\n- 北海道の条、線の表記揺れ\n- 茨城、岐阜等の町名省略\n- 茨城、神奈川、岐阜、石川等の区画整理地    都道府県 無効割合（%） 備考     青森県 54.42 字省略により無効   長野県 44.28 字省略により無効   沖縄県 43.55 字省略により無効   大分県 38.96 字省略により無効   京都府 36.86 字省略、通りにより無効   佐賀県 33.33 字省略により無効   奈良県 29.94 字省略により無効   福島県 29.18 字省略により無効   宮崎県 27.71 字省略により無効   埼玉県 23.08 字省略により無効   山口県 22.65 字省略により無効   和歌山県 17.78 字省略により無効   群馬県 17.08 字省略、ノ町により無効   茨城県 15.51 字省略、町名省略、区画整理により無効   熊本県 14.89 字省略により無効   山形県 14.38 字省略により無効   北海道 13.76 字省略、条、線により無効   栃木県 13.6 字省略により無効   新潟県 13.19 字省略により無効   鳥取県 9.57 字省略により無効   全国 9.25    福岡県 9 字省略により無効   三重県 7.74 字省略により無効   愛知県 7.4 字省略により無効   鹿児島県 7.09 字省略により無効   山梨県 6.8 字省略により無効   宮城県 6.37 字省略により無効   岩手県 6.28 字省略により無効   岐阜県 5.67 字省略、町名省略、区画整理により無効   香川県 4.71 字省略により無効   石川県 4.7 字省略、区画整理により無効   愛媛県 4.39 字省略により無効   秋田県 4.17 字省略により無効   滋賀県 3.76 字省略により無効   広島県 3.74 字省略により無効   高知県 3.38 字省略により無効   大阪府 3.28 字省略により無効   兵庫県 2.71 字省略により無効   島根県 2.04 字省略により無効   岡山県 1.81 字省略により無効   神奈川県 1.72 字省略、区画整理により無効   徳島県 1.64 字省略により無効   富山県 1.14 字省略により無効   静岡県 1.06 字省略、町名省略、区画整理により無効   東京都 0.89 字省略により無効   福井県 0.71 字省略により無効   千葉県 0.64 字省略により無効   長崎県 0      > WRAPUPWRAPUP \n\nimi-enrichment-addressは町名番地の判定に素の街区レベル位置参照情報を使用しているため、町字（まちあざ）の省略に弱いことが分かりました。 \n\n- ユーザーに住所の再確認を促す\n- 入力後の住所不備について人が目検で確認する前段階で利用 \n\nまず、想定したユースケースの内1つ「ユーザーに住所の再確認を促す」については、配送で使う住所の場合「町字の省略は影響ない」ので機能として適切ではありません。ユーザーが東京に集中している場合は関係ないですが、「町字が存在するさいたま市、川崎市、名古屋市、広島市、北九州市、福岡市、熊本市等の政令指定都市」や長野市のように住所が町字の組み合わせで2つ以上存在する都市の場合、使い勝手の悪い機能となります。 \n\n次に「入力後の住所不備について人が目検で確認する前段階で利用」については多少は有効に機能するでしょう。ただし、町字が多い地域では上記同様に使い勝手が悪くなります。 \n\n今回の検証の結果、現状の仕様ではimi-enrichment-addressを使うケースは限定せざるを得ず、一旦使用を見送りとします。とは言え、街区レベル位置参照情報にある町名番地から町字を除けば活用範囲が広がる可能性も確認できました。幸いなことにライブラリはMITライセンスで公開されています。"},"name":"imi-enrichment-addressは住所のバリデーションチェックでどの程度使えるか","tags":[],"childPublishedDate":{"published_on":"2021-07-23T18:57:47.000Z","published_on_unix":1627066667}}},{"node":{"number":80,"relative_category":"blog/backend","fields":{"title":"AWS Organizationsを別のAWSアカウントに移行する","excerpt":"最近のAWSはCDKの発表に代表されるようにインフラ以外の開発者が触りやすい環境が整ってきています。ただ、こうした機能やリソースを存分に享受するにはIAM管理だけでは不足しており、AWSアカウントの管理方針を大枠で整理する必要が出てきました。今回は深く考えずに使っていたOrganizationsを整理する際にはまったポイントを記していきます。    > PROBLEMPROBLEM \n\n- 初期の頃につくったAWSアカウントにコンソリ請求の便利さからとりあえずOrganizations機能をつけてみた その後、当該アカウントに異なるワークロードのリソースを加えすぎてスケールしづらい構成になってきた 例えば 開発環境をAWSアカウント単位で分けられないためIAMや開発サイクルが複雑になり開発スピードに支障が出てきた セキュリティ上望ましくないシステム構成について改修のハードルが上がってきた \n- その後、当該アカウントに異なるワークロードのリソースを加えすぎてスケールしづらい構成になってきた 例えば 開発環境をAWSアカウント単位で分けられないためIAMや開発サイクルが複雑になり開発スピードに支障が出てきた セキュリティ上望ましくないシステム構成について改修のハードルが上がってきた \n- 例えば 開発環境をAWSアカウント単位で分けられないためIAMや開発サイクルが複雑になり開発スピードに支障が出てきた セキュリティ上望ましくないシステム構成について改修のハードルが上がってきた \n- 開発環境をAWSアカウント単位で分けられないためIAMや開発サイクルが複雑になり開発スピードに支障が出てきた\n- セキュリティ上望ましくないシステム構成について改修のハードルが上がってきた   > SOLUTIONSOLUTION \n\nというわけで、一旦Organizations機能を解除して新しく作成したAWS管理アカウントに移行していくことにしました。一つ一つの作業は単純なのですが意外と時間がかかることが分かったので備忘として残しておきます。 \n\nOrganizationsのOU構成はサムネイル画像のBEFORE/AFTERの通りです。 \n\nBEFORE：Organization Unitの構成は全然考えずとりあえず追加していました。 \n\n- Foo - AWS Organizationsのオーナーアカウントであり、異なるワークロードや環境が混在しているアカウント\n- Bar - お試し用アカウント1\n- Buzz - お試し用アカウント2 \n\nAFTER：こちらの記事「Best Practices for Organizational Units with AWS Organizations | AWS Management & Governance Blog」を参考に構成しました。 \n\n- Foundation Management - AWS Organizationsのオーナーアカウント Security Infrastructure \n- Management - AWS Organizationsのオーナーアカウント\n- Security\n- Infrastructure\n- Workload Prod Foo Stg FooStg Integ FooInteg \n- Prod Foo \n- Foo\n- Stg FooStg \n- FooStg\n- Integ FooInteg \n- FooInteg\n- Sandbox BarSandbox BuzzSandbox \n- BarSandbox\n- BuzzSandbox   > Organizationsを別アカウントに移行する方法Organizationsを別アカウントに移行する方法 \n\nやったことはこちらの記事「2 つの AWS Organizations 間でアカウントを移動する」の通りですが、いくつかはまるポイントが書かれていないのでそちらも合わせて記します。まず注意点として3つあります。 \n\n一つ目は、Organizationsの移行期間中は請求の種類が3種類になる可能性があります。具体的には「古いOrganizationsによるコンソリ請求」「スタンドアロンのAWSアカウントによる請求」「新しいOrganizationsによるコンソリ請求」です。会社組織としてAWSを利用している場合は経理側との連携が必要になってくるでしょう。 \n\n二つ目は、古いOrganizationsから追加作成されたメンバーアカウントには請求情報の追加と電話番号の認証を行う必要があります。前者の請求情報の追加はそれほど手間ではないのですが、後者の電話番号の認証はAWSサポートを介すため1アカウントごとに3日から1週間ほど時間がかかります。詳細の対応方法はこちらの記事「組織からのメンバーアカウントのリンク解除のエラーを解決する」を参照下さい。 \n\n三つ目は、新しいOrganizationsでは先に制限緩和を行っておきましょう。新しいOrganizationsを作成する際はおそらく古いOrganizationsの時よりもにメンバーアカウントが増えることと思います。特にベストプラクティスのOrganization Unitでアカウントを分けていくとあっという間にデフォルト制限の10を超える可能性が高いです。 \n\n次に移行手順ですが、上記の注意点をクリアしたらほぼ単純作業になります。 \n\n1. 古いOrganizationからメンバーアカウントを削除\n2. 新しいOrganizationからメンバーアカウントに招待を送信\n3. メンバーアカウントで新しいOrganizationへの招待を受け入れる\n4. （全てのメンバーアカウントを削除し終わった後に）古いOrganizationsを削除\n5. 古いOrganizationsの管理アカウントをメンバーアカウントとして新しい Organization に招待   > WRAPUPWRAPUP \n\n昨今のAWSの動きを見ると、インフラ以外の開発者にもAWSを気軽に使えるようになってきており、Organizations機能を使うこと前提にサービスが展開されているようです。なのでこうした恩恵をうけるためにもOrganizationsのベストプラクティスに則ったアカウント構成にする必要があります。 \n\n一応の注意点としては、Organizationsが便利だからといってOrganizationsからメンバーアカウントを追加することは止めた方がいいです。Organizations移行の注意点から分かる通り、Organizationsから追加されたメンバーアカウントには請求情報追加も電話番号認証も行われません。いざ別のOrganizationsに移行する際に想定外の手間と時間をかけないよう、常にスタンドアロンでAWSアカウントを作成するようにしましょう。 \n\nさて、Organizationsの勘所が見えてきたら次はAWS SSOという便利な機能が待っています。AWSを楽しみましょう。"},"name":"AWS Organizationsを別のAWSアカウントに移行する","tags":["aws-organizations"],"childPublishedDate":{"published_on":"2021-05-13T11:39:28.000Z","published_on_unix":1620905968}}},{"node":{"number":55,"relative_category":"blog/backend","fields":{"title":"PositiveSSLをHerokuに適用する","excerpt":"年に1回のSSL更新のイベントです。毎年同じことをすれば良いかというとそうでもなく、販社と卸の都合でSSLの購入方法が微妙に変わります。とは言え、毎年一から調べ直すのも手間なので備忘として記しておきます。   > PROBLEMPROBLEM \n\n- HerokuのSSLの期限がきた   > SOLUTIONSOLUTION \n\n- というわけで、いつも使っているSSL販売代理店SSLs.com（NameCheap社）でPositiveSSL（運用Comodo社）を購入しHerokuに適用します。   > HOWTOHOWTO \n\n1. 証明書を購入する SSL販売代理店であればどこでもいいのですが、昔から使っているので \n2. SSL販売代理店であればどこでもいいのですが、昔から使っているので\n3. 秘密鍵と署名リクエストをつくる 秘密鍵 openssl genrsa -des3 -out server.orig.key 2048 秘密鍵パスワードなしopenssl rsa -in server.orig.key -out server.key 署名リクエスト openssl req -new -key server.key -out server.csr ※ 最近このあたりの署名情報は、SSL販売代理店側で生成しているケースが増えてきました \n4. 秘密鍵 openssl genrsa -des3 -out server.orig.key 2048 \n5. 秘密鍵パスワードなしopenssl rsa -in server.orig.key -out server.key \n6. 署名リクエスト openssl req -new -key server.key -out server.csr \n7. ※ 最近このあたりの署名情報は、SSL販売代理店側で生成しているケースが増えてきました\n8. 証明書発行を申請する SSL販売代理店より署名リクエストserver.csrと関連情報を送信します \n9. SSL販売代理店より署名リクエストserver.csrと関連情報を送信します\n10. ドメイン保持の証明をする PositiveSSLの運用会社Comodoに対しドメイン保持の証明します 証明方法はメールを受信する、あるいは、Webサイトにプレーンテキストを設置するかの2択になります \n11. PositiveSSLの運用会社Comodoに対しドメイン保持の証明します\n12. 証明方法はメールを受信する、あるいは、Webサイトにプレーンテキストを設置するかの2択になります\n13. Heroku用の証明書をつくる 証明タスクをこなししばらくすると、Comodo社より複数の証明書が送られてきます Heroku用に証明書をつくる cat www_example_com.crt COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt > server.crt \n14. 証明タスクをこなししばらくすると、Comodo社より複数の証明書が送られてきます\n15. Heroku用に証明書をつくる cat www_example_com.crt COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt > server.crt \n16. Herokuに証明書を適用する 新規で適用する場合は次のコマンドを実行します heroku addons:add ssl:endpoint heroku certs:add server.crt server.key 更新する場合は次のコマンドを実行します heroku certs:update server.crt server.key \n17. 新規で適用する場合は次のコマンドを実行します heroku addons:add ssl:endpoint heroku certs:add server.crt server.key \n18. heroku addons:add ssl:endpoint\n19. heroku certs:add server.crt server.key\n20. 更新する場合は次のコマンドを実行します heroku certs:update server.crt server.key \n21. heroku certs:update server.crt server.key   > WRAPUPWRAPUP \n\nこのあたりが自動化されれば良いと思いつつ、自動化されたらこのあたりを調べるモチベーションがなくなるので年に一回のリハビリイベントとして位置づけておきます、はい。"},"name":"[2017-04-23]PositiveSSLをHerokuに適用する","tags":[],"childPublishedDate":{"published_on":"2017-04-23T00:00:00.000Z","published_on_unix":1492905600}}}]}},"pageContext":{"number":59}},"staticQueryHashes":[]}