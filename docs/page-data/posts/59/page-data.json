{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/59","result":{"data":{"esaPost":{"number":59,"relative_category":"blog/backend","fields":{"title":"連載 Rails2Phoenix 1 UmbrellaプロジェクトをHerokuにデプロイする","excerpt":"使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。   > PROBLEMPROBLEM \n\n- サービスについて 拡張にともない技術スタックがふえるのを抑えたい スケーラビリティのためのコストを抑えたい パフォーマンスをあげたい \n- 拡張にともない技術スタックがふえるのを抑えたい\n- スケーラビリティのためのコストを抑えたい\n- パフォーマンスをあげたい   > SOLUTIONSOLUTION \n\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。 \n\n方針 \n\n- Railsから徐々にPhoenixに移行できるように いままでとおなじPaaS（Heroku） いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく いままでとおなじDB 移行完了までDBマイグレーションをしない \n- いままでとおなじPaaS（Heroku）\n- いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく \n- ブランチ戦略は phoenix/base をベースに\n- 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\n- いままでとおなじDB 移行完了までDBマイグレーションをしない \n- 移行完了までDBマイグレーションをしない\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで   > HerokuへのデプロイのながれHerokuへのデプロイのながれ \n\n基本的にドキュメント通り。   > Phoenixアプリケーションを作成Phoenixアプリケーションを作成 \n\nまず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル apps/, deps/, config/config.exs, mix.exs, mix.lock が追加されます。   sh \n\n> cd rails_project > mix new . --umbrella > (cd ./apps && mix phx.new phoenix_app)   \n\n次に、既存のRailsでつくられたスキーマをPhoenixに移植します。Ripperをつかうとはかどります。ちなみに手動でスキーマをつくりたい場合は、CLI mix phx.gen.schema --no-migration Blog.Post blog_posts title:string で作成します。   rb \n\n# lib/tasks/convert_to_phoenix.rake # こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの require 'ripper' require 'erb' require 'fileutils' namespace :db do namespace :schema do desc 'Convert schema from Rails to Phoenix' task convert_to_phoenix: :environment do ConvertSchemaForPhoenixService.call end end end class ConvertSchemaForPhoenixService class << self def call FileUtils.mkdir_p(File.join('tmp', 'models')) extract_activerecord_define_block( Ripper.sexp( Rails.root .join('db', 'schema.rb') .read ) ).select(&method(:create_table_block?)) .map(&method(:configuration)) .each do |conf| project_name = 'PhoenixApp' table_name = conf[:table_name] table_columns = conf[:table_columns].reject(&method(:reject_condition)) .map do |c| case c[:column_type] when 'text' then c[:column_type] = ':string' when 'datetime' then c[:column_type] = ':naive_datetime' when 'inet' then c[:column_type] = 'EctoNetwork.INET' else c[:column_type] = \":#{c[:column_type]}\" end c end File.write( File.join('tmp', 'models', \"#{conf[:table_name].singularize}.ex\"), template.result(binding) ) end end private def extract_activerecord_define_block(sexp) sexp.dig(1, 0, 2, 2) end def create_table_block?(activerecord_define_block_element_sexp) activerecord_define_block_element_sexp.dig(1, 1, 1) == 'create_table' rescue false end def extract_table_name(create_table_block_sexp) create_table_block_sexp.dig(1, 2, 1, 0, 1, 1, 1) end def extract_table_columns(create_table_block_sexp) create_table_block_sexp.dig(2, 2) end def extract_column_type(table_column_sexp) table_column_sexp.dig(3, 1) end def extract_column_name(table_column_sexp) # Return value of `t.index` is array like ['user_id']. if table_column_sexp.dig(4, 1, 0, 0) == :array return table_column_sexp.dig(4, 1, 0, 1).map { |e| e.dig(1, 1, 1) } end table_column_sexp.dig(4, 1, 0, 1, 1, 1) end def extract_column_option(table_column_sexp) # If is not `column_option`, then `table_column_sexp.dig(4, 1, 1, # 1)` method return nil. Set blank array ([]) for avoiding nil. table_column_sexp.dig(4, 1, 1, 1) || [] end def extract_option_key(column_option_sexp) # Remove colon for avoiding `null:`. column_option_sexp.dig(1, 1).gsub(/:\\z/, '') end def extract_option_value(column_option_sexp) if column_option_sexp.dig(2, 0) == :array return Array(column_option_sexp.dig(2, 1)).map { |e| e.dig(1, 1, 1) } end element = column_option_sexp.dig(2, 1) if element.class != Array return element end case element.dig(0) when :kw then element.dig(1) when :string_content then element.dig(1, 1) || '' end end def template ERB.new(<<'__EOD__', nil, '-') defmodule <%= project_name %>.<%= table_name.classify %> do use Ecto.Schema import Ecto.Changeset alias <%= project_name %>.<%= table_name.classify %> schema \"<%= table_name %>\" do<% table_columns.each do |c| %> field :<%= c[:column_name] -%>, <%= c[:column_type] -%> <% end %> timestamps inserted_at: :created_at end @doc false def changeset(%<%= table_name.classify %>{} = <%= table_name.singularize %>, attrs) do <%= table_name.singularize %> |> cast(attrs, [<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>]) # |> validate_required([<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>]) end end __EOD__ end def configuration(table) { table_name: extract_table_name(table), table_columns: extract_table_columns(table).map do |c| { column_name: extract_column_name(c), column_type: extract_column_type(c), column_option: Hash[extract_column_option(c).map { |o| [extract_option_key(o), extract_option_value(o)] }] } end } end def reject_condition(column) column[:column_name] =~ /\\A(created|updated)_at\\z/ || column[:column_type] == 'index' end end end     sh \n\n> rails db:schema:convert_to_phoenix   \n\n最後に、既存DBへはこんな感じで接続します。   config \n\n# rails_project/apps/phoenix_app/config/dev.exs config :phoenix_app, PhoenixApp.Repo, adapter: Ecto.Adapters.Postgres, url: System.get_env(\"DATABASE_URL\"), pool_size: 10, ssl: true     sh \n\n> (cd ./apps/phoenix_app/assets && npm install) > mix deps.get > mix phx.server     > デプロイのパイプラインを追加デプロイのパイプラインを追加 \n\nさて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。 \n\nBEFORE \n\n- build (all branch) deploy.prod (master branch) \n- deploy.prod (master branch) \n\nAFTER \n\n- build (all branch) deploy.prod (master branch) deploy.phoenix.prod (phoenix/base branch) \n- deploy.prod (master branch)\n- deploy.phoenix.prod (phoenix/base branch)   yaml \n\n# wercker.yml deploy-phoenix-prod-heroku: steps: - add-ssh-key: host: github.com keyname: GITHUB - add-to-known_hosts: hostname: github.com fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48 - heroku-deploy: key: $HEROKU_KEY user: $HEROKU_USER app-name: $HEROKU_APP_NAME install-toolbelt: true after-steps: - wantedly/pretty-slack-notify: webhook_url: ${SLACK_WEBHOOK_URL} channel: general     > Herokuアプリケーションを作成Herokuアプリケーションを作成 \n\n基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ rails_project/config/prod.exs をこう rails_project/apps/phoenix_app/config/prod.exs 変更します。 \n\n1. Herokuアプリにビルドパックを適用   sh \n\n> heroku create --buildpack https://github.com/HashNuke/heroku-buildpack-elixir.git > heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git   \n\n2. 起動設定を準備   config \n\n# rails_project/elixir_buildpack.config erlang_version=19.1 elixir_version=1.4.2 always_rebuild=false pre_compile=\"pwd\" post_compile=\"pwd\" runtime_path=/app config_vars_to_export=(DATABASE_URL) config_vars_to_export=(DATABASE_POOL_SIZE)     config \n\n# rails_project/phoenix_static_buildpack.config phoenix_relative_path=apps/phoenix_app     config \n\n# rails_project/Procfile web: MIX_ENV=prod mix phx.server   \n\n3. 環境変数を適用 \n\nデータベース関連。   config \n\n# rails_project/apps/phoenix_app/config/prod.exs config :phoenix_app, PhoenixApp.Repo, adapter: Ecto.Adapters.Postgres, url: System.get_env(\"DATABASE_URL\"), pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10), ssl: true     sh \n\nheroku config:set DATABASE_URL=foo heroku config:set DATABASE_POOL_SIZE=bar   \n\nクレデンシャル関連。   sh \n\n> heroku config:set HEROKU_API_KEY=$(heroku auth:token) > heroku config:set SECRET_KEY_BASE=$(mix phx.gen.secret)     > WRAPUPWRAPUP \n\n大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"},"wip":false,"body_md":"<img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\">\r\n\r\n使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。\r\n\r\n# PROBLEM\r\n- サービスについて\r\n    - 拡張にともない技術スタックがふえるのを抑えたい\r\n    - スケーラビリティのためのコストを抑えたい\r\n    - パフォーマンスをあげたい\r\n\r\n# SOLUTION\r\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。\r\n\r\n**方針**\r\n- Railsから徐々にPhoenixに移行できるように\r\n  - いままでとおなじPaaS（Heroku）\r\n  - いままでとおなじレポジトリ\r\n      - ブランチ戦略は `phoenix/base` をベースに\r\n      - 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\r\n  - いままでとおなじDB\r\n      - 移行完了までDBマイグレーションをしない\r\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで\r\n\r\n## Herokuへのデプロイのながれ\r\n基本的に[ドキュメント](https://hexdocs.pm/phoenix/heroku.html)通り。\r\n\r\n### Phoenixアプリケーションを作成\r\nまず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル `apps/`, `deps/`, `config/config.exs`, `mix.exs`, `mix.lock` が追加されます。\r\n```sh\r\n> cd rails_project\r\n> mix new . --umbrella\r\n> (cd ./apps && mix phx.new phoenix_app)\r\n```\r\n\r\n次に、既存のRailsでつくられたスキーマをPhoenixに移植します。[Ripperをつかうとはかどります](http://developersnote.jp/elixir/share-db-between-rails-and-phoenix.html)。ちなみに手動でスキーマをつくりたい場合は、CLI `mix phx.gen.schema --no-migration Blog.Post blog_posts title:string` で作成します。\r\n```rb\r\n# lib/tasks/convert_to_phoenix.rake\r\n# こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの\r\nrequire 'ripper'\r\nrequire 'erb'\r\nrequire 'fileutils'\r\n\r\nnamespace :db do\r\n  namespace :schema do\r\n    desc 'Convert schema from Rails to Phoenix'\r\n    task convert_to_phoenix: :environment do\r\n      ConvertSchemaForPhoenixService.call\r\n    end\r\n  end\r\nend\r\n\r\nclass ConvertSchemaForPhoenixService\r\n  class << self\r\n    def call\r\n      FileUtils.mkdir_p(File.join('tmp', 'models'))\r\n      extract_activerecord_define_block(\r\n        Ripper.sexp(\r\n          Rails.root\r\n               .join('db', 'schema.rb')\r\n               .read\r\n        )\r\n      ).select(&method(:create_table_block?))\r\n       .map(&method(:configuration))\r\n       .each do |conf|\r\n        project_name = 'PhoenixApp'\r\n        table_name = conf[:table_name]\r\n        table_columns = conf[:table_columns].reject(&method(:reject_condition))\r\n                                            .map do |c|\r\n          case c[:column_type]\r\n          when 'text' then c[:column_type] = ':string'\r\n          when 'datetime' then c[:column_type] = ':naive_datetime'\r\n          when 'inet' then c[:column_type] = 'EctoNetwork.INET'\r\n          else c[:column_type] = \":#{c[:column_type]}\"\r\n          end\r\n          c\r\n        end\r\n        File.write(\r\n          File.join('tmp', 'models', \"#{conf[:table_name].singularize}.ex\"),\r\n          template.result(binding)\r\n        )\r\n      end\r\n    end\r\n\r\n    private\r\n\r\n    def extract_activerecord_define_block(sexp)\r\n      sexp.dig(1, 0, 2, 2)\r\n    end\r\n\r\n    def create_table_block?(activerecord_define_block_element_sexp)\r\n      activerecord_define_block_element_sexp.dig(1, 1, 1) == 'create_table'\r\n    rescue\r\n      false\r\n    end\r\n\r\n    def extract_table_name(create_table_block_sexp)\r\n      create_table_block_sexp.dig(1, 2, 1, 0, 1, 1, 1)\r\n    end\r\n\r\n    def extract_table_columns(create_table_block_sexp)\r\n      create_table_block_sexp.dig(2, 2)\r\n    end\r\n\r\n    def extract_column_type(table_column_sexp)\r\n      table_column_sexp.dig(3, 1)\r\n    end\r\n\r\n    def extract_column_name(table_column_sexp)\r\n      # Return value of `t.index` is array like ['user_id'].\r\n      if table_column_sexp.dig(4, 1, 0, 0) == :array\r\n        return table_column_sexp.dig(4, 1, 0, 1).map { |e| e.dig(1, 1, 1) }\r\n      end\r\n      table_column_sexp.dig(4, 1, 0, 1, 1, 1)\r\n    end\r\n\r\n    def extract_column_option(table_column_sexp)\r\n      # If is not `column_option`, then `table_column_sexp.dig(4, 1, 1,\r\n      # 1)` method return nil. Set blank array ([]) for avoiding nil.\r\n      table_column_sexp.dig(4, 1, 1, 1) || []\r\n    end\r\n\r\n    def extract_option_key(column_option_sexp)\r\n      # Remove colon for avoiding `null:`.\r\n      column_option_sexp.dig(1, 1).gsub(/:\\z/, '')\r\n    end\r\n\r\n    def extract_option_value(column_option_sexp)\r\n      if column_option_sexp.dig(2, 0) == :array\r\n        return Array(column_option_sexp.dig(2, 1)).map { |e| e.dig(1, 1, 1) }\r\n      end\r\n      element = column_option_sexp.dig(2, 1)\r\n      if element.class != Array\r\n        return element\r\n      end\r\n      case element.dig(0)\r\n      when :kw then element.dig(1)\r\n      when :string_content then element.dig(1, 1) || ''\r\n      end\r\n    end\r\n\r\n    def template\r\n      ERB.new(<<'__EOD__', nil, '-')\r\ndefmodule <%= project_name %>.<%= table_name.classify %> do\r\n  use Ecto.Schema\r\n  import Ecto.Changeset\r\n  alias <%= project_name %>.<%= table_name.classify %>\r\n\r\n  schema \"<%= table_name %>\" do<% table_columns.each do |c| %>\r\n    field :<%= c[:column_name] -%>, <%= c[:column_type] -%>\r\n<% end %>\r\n    timestamps inserted_at: :created_at\r\n  end\r\n\r\n  @doc false\r\n  def changeset(%<%= table_name.classify %>{} = <%= table_name.singularize %>, attrs) do\r\n    <%= table_name.singularize %>\r\n    |> cast(attrs, [<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>])\r\n    # |> validate_required([<%= table_columns.map { |c| \":\" << c[:column_name] }.join(\", \") -%>])\r\n  end\r\nend\r\n__EOD__\r\n    end\r\n\r\n    def configuration(table)\r\n      {\r\n        table_name: extract_table_name(table),\r\n        table_columns: extract_table_columns(table).map do |c|\r\n          {\r\n            column_name: extract_column_name(c),\r\n            column_type: extract_column_type(c),\r\n            column_option: Hash[extract_column_option(c).map { |o| [extract_option_key(o), extract_option_value(o)] }]\r\n          }\r\n        end\r\n      }\r\n    end\r\n\r\n    def reject_condition(column)\r\n      column[:column_name] =~ /\\A(created|updated)_at\\z/ || column[:column_type] == 'index'\r\n    end\r\n  end\r\nend\r\n```\r\n```sh\r\n> rails db:schema:convert_to_phoenix\r\n```\r\n\r\n最後に、既存DBへはこんな感じで接続します。\r\n```config\r\n# rails_project/apps/phoenix_app/config/dev.exs\r\nconfig :phoenix_app, PhoenixApp.Repo,\r\n  adapter: Ecto.Adapters.Postgres,\r\n  url: System.get_env(\"DATABASE_URL\"),\r\n  pool_size: 10,\r\n  ssl: true\r\n```\r\n```sh\r\n> (cd ./apps/phoenix_app/assets && npm install)\r\n> mix deps.get\r\n> mix phx.server\r\n```\r\n\r\n## デプロイのパイプラインを追加\r\nさて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。\r\n\r\n**BEFORE**\r\n- build (all branch)\r\n    - deploy.prod (master branch)\r\n\r\n**AFTER**\r\n- build (all branch)\r\n    - deploy.prod (master branch)\r\n    - deploy.phoenix.prod (phoenix/base branch)\r\n\r\n```yaml\r\n# wercker.yml\r\ndeploy-phoenix-prod-heroku:\r\n  steps:\r\n    - add-ssh-key:\r\n        host: github.com\r\n        keyname: GITHUB\r\n    - add-to-known_hosts:\r\n        hostname: github.com\r\n        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48\r\n    - heroku-deploy:\r\n        key: $HEROKU_KEY\r\n        user: $HEROKU_USER\r\n        app-name: $HEROKU_APP_NAME\r\n        install-toolbelt: true\r\n  after-steps:\r\n    - wantedly/pretty-slack-notify:\r\n        webhook_url: ${SLACK_WEBHOOK_URL}\r\n        channel: general\r\n```\r\n\r\n### Herokuアプリケーションを作成\r\n基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ `rails_project/config/prod.exs` をこう `rails_project/apps/phoenix_app/config/prod.exs` 変更します。\r\n\r\n**1. Herokuアプリにビルドパックを適用**\r\n```sh\r\n> heroku create --buildpack https://github.com/HashNuke/heroku-buildpack-elixir.git\r\n> heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git\r\n```\r\n\r\n**2. 起動設定を準備**\r\n```config\r\n# rails_project/elixir_buildpack.config\r\nerlang_version=19.1\r\nelixir_version=1.4.2\r\nalways_rebuild=false\r\npre_compile=\"pwd\"\r\npost_compile=\"pwd\"\r\nruntime_path=/app\r\nconfig_vars_to_export=(DATABASE_URL)\r\nconfig_vars_to_export=(DATABASE_POOL_SIZE)\r\n```\r\n```config\r\n# rails_project/phoenix_static_buildpack.config\r\nphoenix_relative_path=apps/phoenix_app\r\n```\r\n```config\r\n# rails_project/Procfile\r\nweb: MIX_ENV=prod mix phx.server\r\n```\r\n\r\n**3. 環境変数を適用**\r\n\r\nデータベース関連。\r\n```config\r\n# rails_project/apps/phoenix_app/config/prod.exs\r\nconfig :phoenix_app, PhoenixApp.Repo,\r\n  adapter: Ecto.Adapters.Postgres,\r\n  url: System.get_env(\"DATABASE_URL\"),\r\n  pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10),\r\n  ssl: true\r\n```\r\n```sh\r\nheroku config:set DATABASE_URL=foo\r\nheroku config:set DATABASE_POOL_SIZE=bar\r\n```\r\n\r\nクレデンシャル関連。\r\n```sh\r\n> heroku config:set HEROKU_API_KEY=$(heroku auth:token)\r\n> heroku config:set SECRET_KEY_BASE=$(mix phx.gen.secret)\r\n```\r\n\r\n# WRAPUP\r\n大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。","body_html":"<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\"></a>\n<p data-sourcepos=\"3:1-3:338\">使い慣れたRailsのプロジェクトを拡張したいのですが、その都度技術スタックを増やす必要があり、この点をどうにかクリアしたいと考えています。連載「Rails2Phoenix」になります、今回はフレームワークをElixir製のPhoenix Frameworkへと変更を試みました。</p>\n<h1 data-sourcepos=\"5:1-5:9\" id=\"1-0-0\" name=\"1-0-0\">\n<a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"6:1-10:0\">\n<li data-sourcepos=\"6:1-10:0\">サービスについて\n<ul data-sourcepos=\"7:5-10:0\">\n<li data-sourcepos=\"7:5-7:75\">拡張にともない技術スタックがふえるのを抑えたい</li>\n<li data-sourcepos=\"8:5-8:66\">スケーラビリティのためのコストを抑えたい</li>\n<li data-sourcepos=\"9:5-10:0\">パフォーマンスをあげたい</li>\n</ul>\n</li>\n</ul>\n<h1 data-sourcepos=\"11:1-11:10\" id=\"2-0-0\" name=\"2-0-0\">\n<a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"12:1-12:255\">というわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRailsから移行中のPhoenix UmbrellaプロジェクトをHerokuにデプロイする流れをとりあげます。</p>\n<p data-sourcepos=\"14:1-14:10\"><strong>方針</strong></p>\n<ul data-sourcepos=\"15:1-23:0\">\n<li data-sourcepos=\"15:1-21:64\">Railsから徐々にPhoenixに移行できるように\n<ul data-sourcepos=\"16:3-21:64\">\n<li data-sourcepos=\"16:3-16:44\">いままでとおなじPaaS（Heroku）</li>\n<li data-sourcepos=\"17:3-19:100\">いままでとおなじレポジトリ\n<ul data-sourcepos=\"18:7-19:100\">\n<li data-sourcepos=\"18:7-18:60\">ブランチ戦略は <code>phoenix/base</code> をベースに</li>\n<li data-sourcepos=\"19:7-19:100\">気軽に参照できるようにRails関連ファイルは可能な限りのこしておく</li>\n</ul>\n</li>\n<li data-sourcepos=\"20:3-21:64\">いままでとおなじDB\n<ul data-sourcepos=\"21:7-21:64\">\n<li data-sourcepos=\"21:7-21:64\">移行完了までDBマイグレーションをしない</li>\n</ul>\n</li>\n</ul>\n</li>\n<li data-sourcepos=\"22:1-23:0\">Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで</li>\n</ul>\n<h2 data-sourcepos=\"24:1-24:39\" id=\"2-1-0\" name=\"2-1-0\">\n<a class=\"anchor\" id=\"Herokuへのデプロイのながれ\" name=\"Heroku%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%AA%E3%81%8C%E3%82%8C\" href=\"#Heroku%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%AA%E3%81%8C%E3%82%8C\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Herokuへのデプロイのながれ\"> &gt; Herokuへのデプロイのながれ</span></a>Herokuへのデプロイのながれ</h2>\n<p data-sourcepos=\"25:1-25:81\">基本的に<a href=\"https://hexdocs.pm/phoenix/heroku.html\" target=\"_blank\" rel=\"noopener noreferrer\">ドキュメント</a>通り。</p>\n<h3 data-sourcepos=\"27:1-27:44\" id=\"2-1-1\" name=\"2-1-1\">\n<a class=\"anchor\" id=\"Phoenixアプリケーションを作成\" name=\"Phoenix%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" href=\"#Phoenix%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Phoenixアプリケーションを作成\"> &gt; Phoenixアプリケーションを作成</span></a>Phoenixアプリケーションを作成</h3>\n<p data-sourcepos=\"28:1-28:181\">まず、こんな感じでPhoenixの骨組みをつくります。Phoenix関連のファイル <code>apps/</code>, <code>deps/</code>, <code>config/config.exs</code>, <code>mix.exs</code>, <code>mix.lock</code> が追加されます。</p>\n<div class=\"code-block\" data-sourcepos=\"29:1-33:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> <span class=\"nb\">cd </span>rails_project\n<span class=\"o\">&gt;</span> mix new <span class=\"nb\">.</span> <span class=\"nt\">--umbrella</span>\n<span class=\"o\">&gt;</span> <span class=\"o\">(</span><span class=\"nb\">cd</span> ./apps <span class=\"o\">&amp;&amp;</span> mix phx.new phoenix_app<span class=\"o\">)</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"35:1-35:359\">次に、既存のRailsでつくられたスキーマをPhoenixに移植します。<a href=\"http://developersnote.jp/elixir/share-db-between-rails-and-phoenix.html\" target=\"_blank\" rel=\"noopener noreferrer\">Ripperをつかうとはかどります</a>。ちなみに手動でスキーマをつくりたい場合は、CLI <code>mix phx.gen.schema --no-migration Blog.Post blog_posts title:string</code> で作成します。</p>\n<div class=\"code-block\" data-sourcepos=\"36:1-182:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>rb</div>\n<div class=\"highlight\"><pre class=\"highlight ruby\"><code><span class=\"c1\"># lib/tasks/convert_to_phoenix.rake</span>\n<span class=\"c1\"># こちらはスキーマ移植タスクをPhoenix1.3用に改めたもの</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'ripper'</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'erb'</span>\n<span class=\"nb\">require</span> <span class=\"s1\">'fileutils'</span>\n\n<span class=\"n\">namespace</span> <span class=\"ss\">:db</span> <span class=\"k\">do</span>\n  <span class=\"n\">namespace</span> <span class=\"ss\">:schema</span> <span class=\"k\">do</span>\n    <span class=\"n\">desc</span> <span class=\"s1\">'Convert schema from Rails to Phoenix'</span>\n    <span class=\"n\">task</span> <span class=\"ss\">convert_to_phoenix: :environment</span> <span class=\"k\">do</span>\n      <span class=\"no\">ConvertSchemaForPhoenixService</span><span class=\"p\">.</span><span class=\"nf\">call</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">ConvertSchemaForPhoenixService</span>\n  <span class=\"k\">class</span> <span class=\"o\">&lt;&lt;</span> <span class=\"nb\">self</span>\n    <span class=\"k\">def</span> <span class=\"nf\">call</span>\n      <span class=\"no\">FileUtils</span><span class=\"p\">.</span><span class=\"nf\">mkdir_p</span><span class=\"p\">(</span><span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'tmp'</span><span class=\"p\">,</span> <span class=\"s1\">'models'</span><span class=\"p\">))</span>\n      <span class=\"n\">extract_activerecord_define_block</span><span class=\"p\">(</span>\n        <span class=\"no\">Ripper</span><span class=\"p\">.</span><span class=\"nf\">sexp</span><span class=\"p\">(</span>\n          <span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">root</span>\n               <span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'db'</span><span class=\"p\">,</span> <span class=\"s1\">'schema.rb'</span><span class=\"p\">)</span>\n               <span class=\"p\">.</span><span class=\"nf\">read</span>\n        <span class=\"p\">)</span>\n      <span class=\"p\">).</span><span class=\"nf\">select</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:create_table_block?</span><span class=\"p\">))</span>\n       <span class=\"p\">.</span><span class=\"nf\">map</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:configuration</span><span class=\"p\">))</span>\n       <span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">conf</span><span class=\"o\">|</span>\n        <span class=\"n\">project_name</span> <span class=\"o\">=</span> <span class=\"s1\">'PhoenixApp'</span>\n        <span class=\"n\">table_name</span> <span class=\"o\">=</span> <span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_name</span><span class=\"p\">]</span>\n        <span class=\"n\">table_columns</span> <span class=\"o\">=</span> <span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_columns</span><span class=\"p\">].</span><span class=\"nf\">reject</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"nb\">method</span><span class=\"p\">(</span><span class=\"ss\">:reject_condition</span><span class=\"p\">))</span>\n                                            <span class=\"p\">.</span><span class=\"nf\">map</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span>\n          <span class=\"k\">case</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'text'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">':string'</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'datetime'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">':naive_datetime'</span>\n          <span class=\"k\">when</span> <span class=\"s1\">'inet'</span> <span class=\"k\">then</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">'EctoNetwork.INET'</span>\n          <span class=\"k\">else</span> <span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\":</span><span class=\"si\">#{</span><span class=\"n\">c</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n          <span class=\"k\">end</span>\n          <span class=\"n\">c</span>\n        <span class=\"k\">end</span>\n        <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">write</span><span class=\"p\">(</span>\n          <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s1\">'tmp'</span><span class=\"p\">,</span> <span class=\"s1\">'models'</span><span class=\"p\">,</span> <span class=\"s2\">\"</span><span class=\"si\">#{</span><span class=\"n\">conf</span><span class=\"p\">[</span><span class=\"ss\">:table_name</span><span class=\"p\">].</span><span class=\"nf\">singularize</span><span class=\"si\">}</span><span class=\"s2\">.ex\"</span><span class=\"p\">),</span>\n          <span class=\"n\">template</span><span class=\"p\">.</span><span class=\"nf\">result</span><span class=\"p\">(</span><span class=\"nb\">binding</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"kp\">private</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_activerecord_define_block</span><span class=\"p\">(</span><span class=\"n\">sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_table_block?</span><span class=\"p\">(</span><span class=\"n\">activerecord_define_block_element_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">activerecord_define_block_element_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'create_table'</span>\n    <span class=\"k\">rescue</span>\n      <span class=\"kp\">false</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_table_name</span><span class=\"p\">(</span><span class=\"n\">create_table_block_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">create_table_block_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_table_columns</span><span class=\"p\">(</span><span class=\"n\">create_table_block_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">create_table_block_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_type</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_name</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># Return value of `t.index` is array like ['user_id'].</span>\n      <span class=\"k\">if</span> <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"ss\">:array</span>\n        <span class=\"k\">return</span> <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span> <span class=\"n\">e</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_column_option</span><span class=\"p\">(</span><span class=\"n\">table_column_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># If is not `column_option`, then `table_column_sexp.dig(4, 1, 1,</span>\n      <span class=\"c1\"># 1)` method return nil. Set blank array ([]) for avoiding nil.</span>\n      <span class=\"n\">table_column_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_option_key</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">)</span>\n      <span class=\"c1\"># Remove colon for avoiding `null:`.</span>\n      <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"nf\">gsub</span><span class=\"p\">(</span><span class=\"sr\">/:\\z/</span><span class=\"p\">,</span> <span class=\"s1\">''</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extract_option_value</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">)</span>\n      <span class=\"k\">if</span> <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"ss\">:array</span>\n        <span class=\"k\">return</span> <span class=\"no\">Array</span><span class=\"p\">(</span><span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span> <span class=\"n\">e</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n      <span class=\"n\">element</span> <span class=\"o\">=</span> <span class=\"n\">column_option_sexp</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n      <span class=\"k\">if</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">class</span> <span class=\"o\">!=</span> <span class=\"no\">Array</span>\n        <span class=\"k\">return</span> <span class=\"n\">element</span>\n      <span class=\"k\">end</span>\n      <span class=\"k\">case</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n      <span class=\"k\">when</span> <span class=\"ss\">:kw</span> <span class=\"k\">then</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n      <span class=\"k\">when</span> <span class=\"ss\">:string_content</span> <span class=\"k\">then</span> <span class=\"n\">element</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"s1\">''</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">template</span>\n      <span class=\"no\">ERB</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"o\">&lt;&lt;</span><span class=\"no\">'__EOD__'</span><span class=\"p\">,</span> <span class=\"kp\">nil</span><span class=\"p\">,</span> <span class=\"s1\">'-'</span><span class=\"p\">)</span><span class=\"sh\">\ndefmodule &lt;%= project_name %&gt;.&lt;%= table_name.classify %&gt; do\n  use Ecto.Schema\n  import Ecto.Changeset\n  alias &lt;%= project_name %&gt;.&lt;%= table_name.classify %&gt;\n\n  schema \"&lt;%= table_name %&gt;\" do&lt;% table_columns.each do |c| %&gt;\n    field :&lt;%= c[:column_name] -%&gt;, &lt;%= c[:column_type] -%&gt;\n&lt;% end %&gt;\n    timestamps inserted_at: :created_at\n  end\n\n  @doc false\n  def changeset(%&lt;%= table_name.classify %&gt;{} = &lt;%= table_name.singularize %&gt;, attrs) do\n    &lt;%= table_name.singularize %&gt;\n    |&gt; cast(attrs, [&lt;%= table_columns.map { |c| \":\" &lt;&lt; c[:column_name] }.join(\", \") -%&gt;])\n    # |&gt; validate_required([&lt;%= table_columns.map { |c| \":\" &lt;&lt; c[:column_name] }.join(\", \") -%&gt;])\n  end\nend\n</span><span class=\"no\">__EOD__</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">configuration</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">)</span>\n      <span class=\"p\">{</span>\n        <span class=\"ss\">table_name: </span><span class=\"n\">extract_table_name</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">),</span>\n        <span class=\"ss\">table_columns: </span><span class=\"n\">extract_table_columns</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span>\n          <span class=\"p\">{</span>\n            <span class=\"ss\">column_name: </span><span class=\"n\">extract_column_name</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">),</span>\n            <span class=\"ss\">column_type: </span><span class=\"n\">extract_column_type</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">),</span>\n            <span class=\"ss\">column_option: </span><span class=\"no\">Hash</span><span class=\"p\">[</span><span class=\"n\">extract_column_option</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">).</span><span class=\"nf\">map</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">o</span><span class=\"o\">|</span> <span class=\"p\">[</span><span class=\"n\">extract_option_key</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">),</span> <span class=\"n\">extract_option_value</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)]</span> <span class=\"p\">}]</span>\n          <span class=\"p\">}</span>\n        <span class=\"k\">end</span>\n      <span class=\"p\">}</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reject_condition</span><span class=\"p\">(</span><span class=\"n\">column</span><span class=\"p\">)</span>\n      <span class=\"n\">column</span><span class=\"p\">[</span><span class=\"ss\">:column_name</span><span class=\"p\">]</span> <span class=\"o\">=~</span> <span class=\"sr\">/\\A(created|updated)_at\\z/</span> <span class=\"o\">||</span> <span class=\"n\">column</span><span class=\"p\">[</span><span class=\"ss\">:column_type</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">'index'</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"183:1-185:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> rails db:schema:convert_to_phoenix\n</code></pre></div>\n</div>\n<p data-sourcepos=\"187:1-187:62\">最後に、既存DBへはこんな感じで接続します。</p>\n<div class=\"code-block\" data-sourcepos=\"188:1-195:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/apps/phoenix_app/config/dev.exs\nconfig :phoenix_app, PhoenixApp.Repo,\n  adapter: Ecto.Adapters.Postgres,\n  url: System.get_env(\"DATABASE_URL\"),\n  pool_size: 10,\n  ssl: true\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"196:1-200:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> <span class=\"o\">(</span><span class=\"nb\">cd</span> ./apps/phoenix_app/assets <span class=\"o\">&amp;&amp;</span> npm <span class=\"nb\">install</span><span class=\"o\">)</span>\n<span class=\"o\">&gt;</span> mix deps.get\n<span class=\"o\">&gt;</span> mix phx.server\n</code></pre></div>\n</div>\n<h2 data-sourcepos=\"202:1-202:45\" id=\"2-2-0\" name=\"2-2-0\">\n<a class=\"anchor\" id=\"デプロイのパイプラインを追加\" name=\"%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0\" href=\"#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"デプロイのパイプラインを追加\"> &gt; デプロイのパイプラインを追加</span></a>デプロイのパイプラインを追加</h2>\n<p data-sourcepos=\"203:1-203:217\">さて、既存のCI（Wercker）も更新しましょう。今回はPhoenix関連ブランチが更新された場合にのみ、関連パイプラインを走らせるように下記のように変更しました。</p>\n<p data-sourcepos=\"205:1-205:10\"><strong>BEFORE</strong></p>\n<ul data-sourcepos=\"206:1-208:0\">\n<li data-sourcepos=\"206:1-208:0\">build (all branch)\n<ul data-sourcepos=\"207:5-208:0\">\n<li data-sourcepos=\"207:5-208:0\">deploy.prod (master branch)</li>\n</ul>\n</li>\n</ul>\n<p data-sourcepos=\"209:1-209:9\"><strong>AFTER</strong></p>\n<ul data-sourcepos=\"210:1-213:0\">\n<li data-sourcepos=\"210:1-213:0\">build (all branch)\n<ul data-sourcepos=\"211:5-213:0\">\n<li data-sourcepos=\"211:5-211:33\">deploy.prod (master branch)</li>\n<li data-sourcepos=\"212:5-213:0\">deploy.phoenix.prod (phoenix/base branch)</li>\n</ul>\n</li>\n</ul>\n<div class=\"code-block\" data-sourcepos=\"214:1-233:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>yaml</div>\n<div class=\"highlight\"><pre class=\"highlight yaml\"><code><span class=\"c1\"># wercker.yml</span>\n<span class=\"na\">deploy-phoenix-prod-heroku</span><span class=\"pi\">:</span>\n  <span class=\"na\">steps</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"na\">add-ssh-key</span><span class=\"pi\">:</span>\n        <span class=\"na\">host</span><span class=\"pi\">:</span> <span class=\"s\">github.com</span>\n        <span class=\"na\">keyname</span><span class=\"pi\">:</span> <span class=\"s\">GITHUB</span>\n    <span class=\"pi\">-</span> <span class=\"na\">add-to-known_hosts</span><span class=\"pi\">:</span>\n        <span class=\"na\">hostname</span><span class=\"pi\">:</span> <span class=\"s\">github.com</span>\n        <span class=\"na\">fingerprint</span><span class=\"pi\">:</span> <span class=\"s\">16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48</span>\n    <span class=\"pi\">-</span> <span class=\"na\">heroku-deploy</span><span class=\"pi\">:</span>\n        <span class=\"na\">key</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_KEY</span>\n        <span class=\"na\">user</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_USER</span>\n        <span class=\"na\">app-name</span><span class=\"pi\">:</span> <span class=\"s\">$HEROKU_APP_NAME</span>\n        <span class=\"na\">install-toolbelt</span><span class=\"pi\">:</span> <span class=\"no\">true</span>\n  <span class=\"na\">after-steps</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">wantedly/pretty-slack-notify</span><span class=\"pi\">:</span>\n        <span class=\"na\">webhook_url</span><span class=\"pi\">:</span> <span class=\"s\">${SLACK_WEBHOOK_URL}</span>\n        <span class=\"na\">channel</span><span class=\"pi\">:</span> <span class=\"s\">general</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"235:1-235:43\" id=\"2-2-1\" name=\"2-2-1\">\n<a class=\"anchor\" id=\"Herokuアプリケーションを作成\" name=\"Heroku%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" href=\"#Heroku%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90\" data-position=\"2-2-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Herokuアプリケーションを作成\"> &gt; Herokuアプリケーションを作成</span></a>Herokuアプリケーションを作成</h3>\n<p data-sourcepos=\"236:1-236:306\">基本ドキュメントの説明通りです。Phoenix Umbrellaプロジェクトの注意点としては、ディレクトリの差異くらいでそれ以外は同じです。つまり、これ <code>rails_project/config/prod.exs</code> をこう <code>rails_project/apps/phoenix_app/config/prod.exs</code> 変更します。</p>\n<p data-sourcepos=\"238:1-238:52\"><strong>1. Herokuアプリにビルドパックを適用</strong></p>\n<div class=\"code-block\" data-sourcepos=\"239:1-242:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> heroku create <span class=\"nt\">--buildpack</span> https://github.com/HashNuke/heroku-buildpack-elixir.git\n<span class=\"o\">&gt;</span> heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git\n</code></pre></div>\n</div>\n<p data-sourcepos=\"244:1-244:28\"><strong>2. 起動設定を準備</strong></p>\n<div class=\"code-block\" data-sourcepos=\"245:1-255:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/elixir_buildpack.config\nerlang_version=19.1\nelixir_version=1.4.2\nalways_rebuild=false\npre_compile=\"pwd\"\npost_compile=\"pwd\"\nruntime_path=/app\nconfig_vars_to_export=(DATABASE_URL)\nconfig_vars_to_export=(DATABASE_POOL_SIZE)\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"256:1-259:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/phoenix_static_buildpack.config\nphoenix_relative_path=apps/phoenix_app\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"260:1-263:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/Procfile\nweb: MIX_ENV=prod mix phx.server\n</code></pre></div>\n</div>\n<p data-sourcepos=\"265:1-265:28\"><strong>3. 環境変数を適用</strong></p>\n<p data-sourcepos=\"267:1-267:27\">データベース関連。</p>\n<div class=\"code-block\" data-sourcepos=\"268:1-275:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>config</div>\n<div class=\"highlight\"><pre class=\"highlight plaintext\"><code># rails_project/apps/phoenix_app/config/prod.exs\nconfig :phoenix_app, PhoenixApp.Repo,\n  adapter: Ecto.Adapters.Postgres,\n  url: System.get_env(\"DATABASE_URL\"),\n  pool_size: String.to_integer(System.get_env(\"DATABASE_POOL_SIZE\") || 10),\n  ssl: true\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"276:1-279:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>heroku config:set <span class=\"nv\">DATABASE_URL</span><span class=\"o\">=</span>foo\nheroku config:set <span class=\"nv\">DATABASE_POOL_SIZE</span><span class=\"o\">=</span>bar\n</code></pre></div>\n</div>\n<p data-sourcepos=\"281:1-281:30\">クレデンシャル関連。</p>\n<div class=\"code-block\" data-sourcepos=\"282:1-285:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>sh</div>\n<div class=\"highlight\"><pre class=\"highlight shell\"><code><span class=\"o\">&gt;</span> heroku config:set <span class=\"nv\">HEROKU_API_KEY</span><span class=\"o\">=</span><span class=\"si\">$(</span>heroku auth:token<span class=\"si\">)</span>\n<span class=\"o\">&gt;</span> heroku config:set <span class=\"nv\">SECRET_KEY_BASE</span><span class=\"o\">=</span><span class=\"si\">$(</span>mix phx.gen.secret<span class=\"si\">)</span>\n</code></pre></div>\n</div>\n<h1 data-sourcepos=\"287:1-287:8\" id=\"3-0-0\" name=\"3-0-0\">\n<a class=\"anchor\" id=\"WRAPUP\" name=\"WRAPUP\" href=\"#WRAPUP\" data-position=\"3-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"WRAPUP\"> &gt; WRAPUP</span></a>WRAPUP</h1>\n<p data-sourcepos=\"288:1-288:579\">大枠は想定通りすんなり進めることが出来ましたが、課題もいくつか出てきました。まずは認証機能。こちらは次回のテーマで取り上げようと思いますが、Railsの認証ライブラリほど充実していないので自前でいくつか用意する必要がありそうです。次にビジネスロジック。これは元のRailsの実装が悪かったので致し方ないのですが、移植するのに時間がかかりそうです。先にRails側を整理してから進めた方が良いかもしれません。</p>\n","tags":["phoenix-framework","elixir","ruby-on-rails","ruby","wercker","heroku"],"updated_at":"2021-01-16T23:20:50+09:00","childPublishedDate":{"published_on":"2018-01-08T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_ef5f024307008aa399b91f87fa5f64e8.jpg"}},"relatedPosts":{"edges":[{"node":{"number":68,"relative_category":"blog/organization","fields":{"title":"飲み会に参加するための機材","excerpt":"以前チーム内でリモート懇親会を画策したのですが、食材の調達や経費精算など手間が多すぎて断念しました。ただ、その言い訳は実は本質的ではなく、実際に後ろ向きにさせていたのは「しゃべりながら食べるのがつらい」ということにありました。今回はそれを解決した機材を紹介します。  > PROBLEMPROBLEM \n\n- リモート飲みがつらい 何がつらいって、ヘッドホンをしながら飯を食べるのがつらい 有線ヘッドホンだとPCの前に張り付きになりつらい 無線ヘッドホンだと音声が悪すぎて相手のメッセージが聞き取りづらい というか、有線だろうが無線だろうが直接PCにつなげると少量のノイズが乗る場合がありつらい 音声が悪すぎて相手にメッセージが伝わらない 「えっ、今なんて言ったの?」という会話を何度も繰り返す様がいたたまれない 自分の顔を相手に見せつけるのが気持ち的にいたたまれない アバターはPCリソースを消費する上、アバターに気を使うのは飲み会の意義から少しずれている 最初は楽しいがすぐ飽きる \n- 何がつらいって、ヘッドホンをしながら飯を食べるのがつらい 有線ヘッドホンだとPCの前に張り付きになりつらい 無線ヘッドホンだと音声が悪すぎて相手のメッセージが聞き取りづらい というか、有線だろうが無線だろうが直接PCにつなげると少量のノイズが乗る場合がありつらい \n- 有線ヘッドホンだとPCの前に張り付きになりつらい\n- 無線ヘッドホンだと音声が悪すぎて相手のメッセージが聞き取りづらい\n- というか、有線だろうが無線だろうが直接PCにつなげると少量のノイズが乗る場合がありつらい\n- 音声が悪すぎて相手にメッセージが伝わらない\n- 「えっ、今なんて言ったの?」という会話を何度も繰り返す様がいたたまれない\n- 自分の顔を相手に見せつけるのが気持ち的にいたたまれない アバターはPCリソースを消費する上、アバターに気を使うのは飲み会の意義から少しずれている 最初は楽しいがすぐ飽きる \n- アバターはPCリソースを消費する上、アバターに気を使うのは飲み会の意義から少しずれている 最初は楽しいがすぐ飽きる \n- 最初は楽しいがすぐ飽きる  > SOLUTIONSOLUTION \n\nというわけで、自分がこの1年試行錯誤した末に辿り着いた飲み会参加の機材スタックを共有します。  > オーディオインターフェイスオーディオインターフェイス \n\nオーディオインターフェイスはマイクやギターの音をパソコンに取り込むアナログ・デジタル変換と、取り込んだ音を再生するデジタル・アナログ変換の機能を提供します。 \n\nボイスメモ程度なら必要ないですが、フルリモートで頻繁に会議をしている機会が多いと音質とレイテンシーに多分な影響を与えます。オーディオインターフェイスがない場合、入力時にノイズが乗ったり、出力時に音質が劣化します。また、レイテンシーがひどくなったり音がゆがんだり、下手をするとPCに負荷がかかりフリーズします... \n\n会議を頻繁にする人はとりあえず手に入れたい機材。Steinberg UR22Cが人気です。 \n\n- Steinberg UR22C  > マイクマイク \n\n演説やスピーチ用にダイナミックマイクが使われていますが、オンラインミーティングで使う場合は聞き取りづらいので、何はともあれコンデンサーマイクを使うべきです。 \n\nコンデンサーマイクと言っても、いろいろあります。特にマイクの振動板（ダイアフラム）が大型か小型かで音質の印象が変わるので注意が必要です。私は下記の表のように利用シーンごとに使い分けています。    - 説明 利用シーン     スモールダイアフラム 現実主義。色のない、ニュートラルな音色を提供 ファシリテート   ラージダイアフラム 浪漫主義。音源をより大きく、愛らしいものに変換 発表、音楽活動    \n\nなお、HHKB等の打鍵音が大きいキーボードを利用している方や仕事スペースと家庭スペースとの距離が近い方は、いずれにしてもスモールダイアフラムがお薦めです。スモールダイアフラムはマイクから口元を少しでもずらすと音が入力されずらくなくなるため、期待した音質を提供することが出来ます。 \n\n製品としてはShure Beta87Aが人気です。また、購入する際はマイクスタンドとマイクスポンジもセットで検討すると良いです。マイクの位置を固定し風よけを設置した方が安定した音質に繋がります。 \n\n- Shure Beta87A  > ヘッドホンヘッドホン \n\n食事を取りながら相手の話を聞くには通常のヘッドホンだと食べ物を咀嚼するのに苦労します。口を開けたり閉めたりする際、顎とともにヘッドホンが上下に動くため相手の声が聞き取りづらくなります。 \n\n耳の穴に接しない骨伝導ヘッドホンは、食べ物を咀嚼する際の顎の動きに左右されることがないです。テレワークのヘッドホン多用が外耳炎を引き起こしているという話もあるので、そういう意味で骨伝導ヘッドホンは健康を保つ上でも重要な機材となります。 \n\nまた、使用していて分かったのですが、普段の食事の中でも使うことが出来るので、隙間時間に気軽にメディアに接しやすくなります。例えば、家族と一緒の部屋にいる中、食事を取りながらAWSのWebinarを聞くことができます。 \n\n製品としては業界を牽引しているAfterShokzのAeropexが人気です。今回はオーディオインターフェイスを利用しているので、音質をさらに高めるためにトランスリミッターと組み合わせましょう。 \n\n- AfterShokz Aeropex\n- トランスリミッター TaoTronics aptX-LL  > ビデオビデオ \n\nソーシャルメディアでよく登場するビデオ画像は、表情アップの図（ず）が前面に押し出された絵が一般的ですが、地（じ）の表現が薄く解釈余地がないものが多いです。表情が豊かな方は良いのですが、全員がそういうわけではないので地（じ）の生活の部分に焦点を当てた方が実態に合っています。 \n\n例えば、対面での会話の中では身につけている服装や持ち物等のアトリビュートに焦点が当たりますよね。「その身につけているアクセサリーは何?」「机の上に置いてあるその本、面白そうだね」という会話を思い出してください。 \n\nそういう意味で広角レンズを搭載したアクションカムは望ましい選択です。今時のアクションカムは高解像で鮮やかに表現してくれますし、外にいなくても部屋の中で十分面白い絵になります。 \n\nアクションカムは何でも良いのですが、私は普段「撮れラン」で使っているSony HDR-AS3000をミーティングの際に使っています。 \n\n- Sony HDR-AS3000  > WRAPUPWRAPUP \n\n今回紹介した機材に出会うまで紆余曲折ありましたが、揃えてみて満足しています。 \n\n飲み会でなくても良いですが、機材を揃えた方でいろいろ試してみたい方は一緒に雑談してみませんか。60分雑談会というのを開催しているので、いつでもお気軽にお声がけください。"},"name":"[2021-01-30]飲み会に参加するための機材","tags":["drinkup","team-building"],"childPublishedDate":{"published_on":"2021-01-30T00:00:00.000Z","published_on_unix":1611964800}}},{"node":{"number":93,"relative_category":"blog/backend","fields":{"title":"AWS CloudTrail用のコスパの良いSIEMを探す","excerpt":"IT統制において証跡管理の充実という観点から、また、ゼロトラストの強化という観点からSIEMの導入が必要になってきました。今回はAWS CloudTrail用のSIEMについてざっと調べました。   > PROBLEMPROBLEM \n\n- AWS CloudTrailのログをセキュリティアカウントに集約しているが、深く監視しきれていない 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい NewRelicのように人のコストをかけずに管理したい \n- 可能ならアカウントが不審な操作をした場合にアラートを飛ばしたい\n- 可能ならCloudTrail以外のIaaSリソースを監視対象にしたい NewRelicのように人のコストをかけずに管理したい \n- NewRelicのように人のコストをかけずに管理したい  > SOLUTIONSOLUTION \n\nと言うわけで、コスパが良いと噂のSumo LogicとAzure Sentinelを比較評価します。  > Azure SentinelAzure Sentinel  > 料金料金 \n\n- Azure Sentinel の価格 | Microsoft Azure\n- 価格 - Azure Monitor | Microsoft Azure  > SIEMからCloudTrailへの接続方法SIEMからCloudTrailへの接続方法 \n\n1. 下記設定でLog Analyticsワークスペースを作成 サブスクリプション 無料試用版 リソース グループ production 名前 prod-sentinel 地域 東日本 \n2. サブスクリプション 無料試用版\n3. リソース グループ production\n4. 名前 prod-sentinel\n5. 地域 東日本\n6. [ワークスペースprod-sentinel - データコネクタ] にて [アマゾンウェブサービス] コネクタページを開く\n7. [AWSアカウント - IAM - ロール] にて下記設定で [別のAWSアカウント] を作成 アカウントID {Microsoft account ID} オプション 外部IDが必要 をチェック 外部ID {外部ID (ワークスペースID)} パーミッションポリシーを適用 AWSCloudTrailReadOnlyAccess ロール名 AzureSentinel ※ Cf. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO \n8. アカウントID {Microsoft account ID}\n9. オプション 外部IDが必要 をチェック 外部ID {外部ID (ワークスペースID)} \n10. 外部IDが必要 をチェック\n11. 外部ID {外部ID (ワークスペースID)}\n12. パーミッションポリシーを適用 AWSCloudTrailReadOnlyAccess\n13. ロール名 AzureSentinel\n14. ※ Cf. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO \n15. AWS CloudTrail を Azure Sentinel に接続する | Microsoft Docs\n16. アマゾン ウェブ サービス (AWS) のための MCAS と Azure Sentinel - Azure Solution Ideas | Microsoft Docs\n17. Security-JAWS 第21回レポート #secjaws #secjaws21 #jawsug | DevelopersIO  > SIEM機能 (AWS CloudTrail)SIEM機能 (AWS CloudTrail) \n\n- デフォルト監視対象 時間経過に伴うイベントアラート 悪意ある可能性があるイベント 最近のインシデント データソースの異常 \n- 時間経過に伴うイベントアラート\n- 悪意ある可能性があるイベント\n- 最近のインシデント\n- データソースの異常\n- ログクエリ Audit Network Security \n- Audit\n- Network\n- Security\n- 脅威管理 インシデント ブック ... 簡易な分析情報を提供 AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。 AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。 ハンティング ... 脅威判定となるログクエリを提供 Changes made to AWS IAM policy Tracking Privileged Account Rare Activity Exploit and Pentest Framework User Agent IAM Privilege Escalation by Instance Profile attachment Privileged role attached to Instance Suspicious credential token access of valid IAM Roles Unused or Unsupported Cloud Regions ノートブック ... Jupyter Notebookによる分析を提供 \n- インシデント\n- ブック ... 簡易な分析情報を提供 AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。 AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。 \n- AWSネットワークアクティビティ ... SG、ネットワークACL、IGW、ELB、VPC、サブネット、NIの作成・更新・削除など、AWS ネットワーク関連のリソースアクティビティに関する分析情報を得ます。\n- AWSユーザーアクティビティ ... 失敗したサインイン試行、IP アドレス、リージョン、ユーザー エージェント、ID の種類、また想定されたロールを持つ悪意のある可能性があるユーザー アクティビティなど、AWS ユーザー アクティビティに関する分析情報を得ます。\n- ハンティング ... 脅威判定となるログクエリを提供 Changes made to AWS IAM policy Tracking Privileged Account Rare Activity Exploit and Pentest Framework User Agent IAM Privilege Escalation by Instance Profile attachment Privileged role attached to Instance Suspicious credential token access of valid IAM Roles Unused or Unsupported Cloud Regions \n- Changes made to AWS IAM policy\n- Tracking Privileged Account Rare Activity\n- Exploit and Pentest Framework User Agent\n- IAM Privilege Escalation by Instance Profile attachment\n- Privileged role attached to Instance\n- Suspicious credential token access of valid IAM Roles\n- Unused or Unsupported Cloud Regions\n- ノートブック ... Jupyter Notebookによる分析を提供\n- ソリューション ... 外部のエンドポイントセキュリティツールと連携することが可能 Trend Micro Apex One McAfee Network Security Platform \n- Trend Micro Apex One\n- McAfee Network Security Platform  > Sumo LogicSumo Logic  > 料金料金 \n\n- Sumo Logic 料金表  > SIEMからCloudTrailへの接続方法SIEMからCloudTrailへの接続方法 \n\n1. [AWSアカウントSecurity - S3] にてバケット cloudtrail-accumulativelogs-{account-id} を下記設定にて作成 パブリックアクセスをすべてブロック オフ バケットポリシー json{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSCloudTrailAclCheck20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\" }, { \"Sid\": \"AWSCloudTrailWrite20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } \n2. パブリックアクセスをすべてブロック オフ\n3. バケットポリシー json{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSCloudTrailAclCheck20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}\" }, { \"Sid\": \"AWSCloudTrailWrite20150319\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::cloudtrail-accumulativelogs-{account-id}/AWSLogs/{organization-id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } \n4. [親AWSアカウント - KMS] にて下記設定でKSMを作成 キーのタイプ 対称 キーマテリアルオリジン KMS リージョンごと 単一リージョン エイリアス名 cloudtrail-kms キーポリシー json{ \"Version\": \"2012-10-17\", \"Id\": \"Key policy created by CloudTrail\", \"Statement\": [ { \"Sid\": \"Enable IAM User Permissions\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:*\", \"Resource\": \"*\" }, { \"Sid\": \"Allow CloudTrail to encrypt logs\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:GenerateDataKey*\", \"Resource\": \"*\", \"Condition\": { \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow CloudTrail to describe key\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:DescribeKey\", \"Resource\": \"*\" }, { \"Sid\": \"Allow principals in the account to decrypt log files\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow alias creation during setup\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:CreateAlias\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\", \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\" } } }, { \"Sid\": \"Enable cross account log decryption\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } } ] } \n5. キーのタイプ 対称\n6. キーマテリアルオリジン KMS\n7. リージョンごと 単一リージョン\n8. エイリアス名 cloudtrail-kms\n9. キーポリシー json{ \"Version\": \"2012-10-17\", \"Id\": \"Key policy created by CloudTrail\", \"Statement\": [ { \"Sid\": \"Enable IAM User Permissions\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:*\", \"Resource\": \"*\" }, { \"Sid\": \"Allow CloudTrail to encrypt logs\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:GenerateDataKey*\", \"Resource\": \"*\", \"Condition\": { \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow CloudTrail to describe key\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"kms:DescribeKey\", \"Resource\": \"*\" }, { \"Sid\": \"Allow principals in the account to decrypt log files\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } }, { \"Sid\": \"Allow alias creation during setup\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": \"kms:CreateAlias\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\", \"kms:ViaService\": \"ec2.ap-northeast-1.amazonaws.com\" } } }, { \"Sid\": \"Enable cross account log decryption\", \"Effect\": \"Allow\", \"Principal\": { \"AWS\": \"*\" }, \"Action\": [ \"kms:Decrypt\", \"kms:ReEncryptFrom\" ], \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"kms:CallerAccount\": \"{account-id}\" }, \"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:{account-id}:trail/*\" } } } ] } \n10. [親AWSアカウント - CloudTrail] にて下記設定で証跡を作成 全般的な詳細 証跡名 cloudtrail-logs 組織に証跡を適用 はい ストレージの場所 既存のS3バケットを使用する 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id} ログファイルのSSE-KMS暗号化 有効 カスタマー管理のAWS KMSキー 新規 AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id} ログファイルの検証 有効 管理イベント APIアクティビティ すべて \n11. 全般的な詳細 証跡名 cloudtrail-logs 組織に証跡を適用 はい ストレージの場所 既存のS3バケットを使用する 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id} ログファイルのSSE-KMS暗号化 有効 カスタマー管理のAWS KMSキー 新規 AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id} ログファイルの検証 有効 \n12. 証跡名 cloudtrail-logs\n13. 組織に証跡を適用 はい\n14. ストレージの場所 既存のS3バケットを使用する\n15. 証跡ログバケット名 cloudtrail-accumulativelogs-{account-id}\n16. ログファイルのSSE-KMS暗号化 有効\n17. カスタマー管理のAWS KMSキー 新規\n18. AWS KMSエイリアス arn:aws:kms:{region}:{account-id}:key/{kms-id}\n19. ログファイルの検証 有効\n20. 管理イベント APIアクティビティ すべて \n21. APIアクティビティ すべて\n22. [Sumo Logic - Setup Wizard - Start streaming data to Sumo Logic - CloudTrail] にて下記設定でCloudTrailデータタイプを作成 Source Category aws/cloudtrail S3 Bucket S3 Bucket Name cloudtrail-accumulativelogs-{account-id} Path Expression AWSLogs/{organization-id}/* S3 Region Asia Pacific (Tokyo) How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n23. Source Category aws/cloudtrail\n24. S3 Bucket S3 Bucket Name cloudtrail-accumulativelogs-{account-id} Path Expression AWSLogs/{organization-id}/* S3 Region Asia Pacific (Tokyo) How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n25. S3 Bucket Name cloudtrail-accumulativelogs-{account-id}\n26. Path Expression AWSLogs/{organization-id}/*\n27. S3 Region Asia Pacific (Tokyo)\n28. How do you want the user to access the S3 Bucket? Role-based access 指定されたCFnテンプレートでIAMロールを作成 \n29. 指定されたCFnテンプレートでIAMロールを作成  > SIEM機能 (AWS CloudTrail)SIEM機能 (AWS CloudTrail) \n\nデフォルト監視対象 \n\n- Console Logins Geo Location of All Users Login Events By User Logins Over Time Logins from Multiple IP Logins from Outside the USA Outlier - Success Login Outlier - Failed Login Login Results - One Day Time Comparison Logins without MFA \n- Geo Location of All Users\n- Login Events By User\n- Logins Over Time\n- Logins from Multiple IP\n- Logins from Outside the USA\n- Outlier - Success Login\n- Outlier - Failed Login\n- Login Results - One Day Time Comparison\n- Logins without MFA\n- Network and Security Authorization Failures from All Countries Network and Security Events Over Time Authorization Failures Over Time Network ACL with All Allowed Ingress/Egress Recent Authorization Failures Recent Security Group and Network ACL Changes Created and Deleted Network and Security Events Short Lived Critical Operations \n- Authorization Failures from All Countries\n- Network and Security Events Over Time\n- Authorization Failures Over Time\n- Network ACL with All Allowed Ingress/Egress\n- Recent Authorization Failures\n- Recent Security Group and Network ACL Changes\n- Created and Deleted Network and Security Events\n- Short Lived Critical Operations\n- Operations Action Events Requested AWS Services Over Time Events by AWS Region Recent Elastic IP Address Operations Created Resources Over Time Deleted Resources Over Time \n- Action Events\n- Requested AWS Services Over Time\n- Events by AWS Region\n- Recent Elastic IP Address Operations\n- Created Resources Over Time\n- Deleted Resources Over Time\n- Overview Geo Location of All Users Created Resources Deleted Resources Over Time Top 10 Users Failed Logins Created and Deleted Network and Security Events \n- Geo Location of All Users\n- Created Resources\n- Deleted Resources Over Time\n- Top 10 Users\n- Failed Logins\n- Created and Deleted Network and Security Events\n- S3 Public Objects and Buckets New Public Objects New Public Object by Object-Bucket New Public Objects Table Public Buckets Public Buckets Table Modified Public Objects Modified Public Objects by Object-Buket Modified Public Objects Table \n- New Public Objects\n- New Public Object by Object-Bucket\n- New Public Objects Table\n- Public Buckets\n- Public Buckets Table\n- Modified Public Objects\n- Modified Public Objects by Object-Buket\n- Modified Public Objects Table\n- User Monitoring Geo Location of All Users Top 10 Users Launched and Terminated Instances by User Administrative Activities Over Time Top 10 Activities by Administrative User Recent Activity by Administrative Users \n- Geo Location of All Users\n- Top 10 Users\n- Launched and Terminated Instances by User\n- Administrative Activities Over Time\n- Top 10 Activities by Administrative User\n- Recent Activity by Administrative Users  > 総評総評  > 使用コスト使用コスト \n\n初期導入の段階ではSumo LogicよりAzure Sentinelの方が倍のコストがかかります。    ログ取込量/日 Azure Sentinel月額 Sumo Logic月額     100MB 2,396 JPY 0 USD   500MB 11,978 JPY 0 USD   3GB 71,870 JPY 332 USD    \n\n※ Azure Sentinelの内訳は「 ((GB当たりのAzure Sentinel取込量347.20円) + (GB当たりのLog Analytics取込量451.36円) * 取込量GB 」  > 導入コスト導入コスト \n\n一度の設定で完了するSumo Logicの方が導入コストが低いです。Azure SentinelはIAMロールのみで済むという点で導入は楽ですがAWSアカウントごとに設定する必要があるので手離れが悪いです。  > SIEM機能SIEM機能 \n\nAzure Sentinelの方が分析機能が充実しています。Sumo Logicが大まかな脅威をログクエリからしか拾えないのに対し、Azure Sentinelは細かな脅威判定をログクエリで提供しているのに加え、Jupyter Notebookや外部のエンドポイントセキュリティツールを提供しています。また、デフォルトの監視対象も時間経過に伴うイベントアラート、悪意ある可能性があるイベント、最近のインシデント等必要十分な情報を提供しています。 \n\nまた、対象のデータソースはAzure SentinelがAWS CloudTrail、Google Workspace、Office 365、Azure AD等と幅広く用意しているのに対し、Sumo LogicはSIEMという観点では実質AWS CloudTrail専用のツールに落ち着いています。  > WRAPUPWRAPUP \n\nメインプロダクトがまだ2-3しかない状況でSIEMをAWSだけに限定する場合はSumo Logicで十分でしょう。使用コスト、導入コストともに低く抑えることができるので、しばらくはSumo Logicで運用し、プロダクトがスケールする段階でAzure Sentinelを移行するのが現実的だと思いました。"},"name":"[2021-08-15]AWS CloudTrail用のコスパの良いSIEMを探す","tags":["siem","aws-cloudtrail","azure-sentinel","sumo-logic"],"childPublishedDate":{"published_on":"2021-08-15T00:00:00.000Z","published_on_unix":1628985600}}},{"node":{"number":91,"relative_category":"blog/backend","fields":{"title":"Hardware-Accelerated GPU Scheduling機能を使ったWSL2はどのくらいパフォーマンスが向上するか","excerpt":"新しいPC端末を購入したところ「Hardware-Accerlarated GPU Scheduling」機能があることに気づきました。使用したところ気持ち速くなったように感じたのでどのくらいパフォーマンスが向上したか調べてみました。   > PROBLEMPROBLEM \n\n- システム設定で「Hardware-Accerlarated GPU Scheduling（HAGS）」機能を使ったところWSL2のパフォーマンスが体感的に速くなったように感じた 他の端末にもHAGSを展開していきたいので実際にどのらくらいパフォーマンスが向上するか検証したい \n- 他の端末にもHAGSを展開していきたいので実際にどのらくらいパフォーマンスが向上するか検証したい  > SOLUTIONSOLUTION \n\nと言うわけで、以前Phoronixによって書かれた「WSLとWSL2とのベンチマーク比較の記事」を参考にPhoronix Test SuiteでHAGSのオン・オフのベンチマーク比較を行います。  > 検証端末の環境検証端末の環境    Item Content     Processor AMD Ryzen 9 5900X 12-Core (12 Cores / 24 Threads)   Memory 52 GB   Disk 2 x 275GB Virtual Disk   OS Ubuntu 20.04   Kernel 5.4.72-microsoft-standard-WSL2 (x86_64)   Display Server X Server   Compiler GCC 9.3.0   File System ext4   System Layer wsl     > Phoronix Test SuiteをインストールするPhoronix Test Suiteをインストールする sh\n\nbrew install phoronix-test-suite sudo apt install php php-gd php-xml php-curl   > 実行するベンチマークテストを選定する実行するベンチマークテストを選定する \n\nまず実行可能なテストとテストスーツを確認します、テストスーツは関連テストのグループになります。 sh\n\nphoronix-test-suite list-available-tests phoronix-test-suite list-available-suite  \n\n今回は開発する際に関係がある下記のテストを選定しました。テストスーツは数時間では完了しないケースがあったので今回の対象から外しています。 \n\n- pts/build-gcc\n- pts/compress-gzip\n- pts/system-decompress-gzip\n- pts/gnupg\n- pts/mutex\n- pts/openssl\n- pts/git\n- pts/pybench\n- pts/nginx\n- pts/node-web-tooling  > ベンチマーク結果ベンチマーク結果    Item HAGSオン HAGSオフ     pts/build-gcc 717.39 sec 715.56 sec   pts/compress-gzip 29.10 sec 29.36 sec   pts/system-decompress-gzip 2.397 sec 2.427 sec   pts/mutex Lock Shared 15.2 sec 15.2 sec   pts/mutex Unlock spinlock 33.1 sec 33.4 sec   pts/mutex Unlock std::mutex 14.8 sec 14.7 sec   pts/mutex Semaphore Release And Acquire 8.44 sec 8.36 sec   pts/mutex Unlock pthread_mutex 8.45 sec 8.34 sec   pts/openssl 3704.3 sign/sec 3694 sign/sec   pts/git 39.01 sec 38.85 sec   pts/pybench 869 msec 877 msec   pts/nginx 70124.29 req/sec 71919.70 req/sec   pts/node-web-tooling 16.71 sec 17.01 sec     > WRAPUPWRAPUP \n\n残念ながらベンチマーク結果からHAGSのオンとオフの間に大きなパフォーマンスの変化は見られませんでした。通常の開発の場合はほぼ恩恵を受けられないと言って問題ないでしょう。 \n\n結論として、他の端末へのHAGSの展開はお薦めしません。不具合等の口コミも散見されるので使用端末との相性を見ながら導入するのが良さそうです。個人的にはChromeのハードウェアアクセラレーション機能との相性を見つつしばらく運用しようと思います。"},"name":"[2021-08-01]Hardware-Accelerated GPU Scheduling機能を使ったWSL2はどのくらいパフォーマンスが向上するか","tags":["wsl2","hags","windows-10"],"childPublishedDate":{"published_on":"2021-08-01T00:00:00.000Z","published_on_unix":1627776000}}}]}},"pageContext":{"number":59}},"staticQueryHashes":[]}