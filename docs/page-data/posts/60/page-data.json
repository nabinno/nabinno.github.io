{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/60","result":{"data":{"esaPost":{"number":60,"relative_category":"blog/backend","fields":{"title":"連載 Rails2Phoenix 2 認証機能を実装する","excerpt":"連載「Rails2Phoenix」になります、前回は「UmbrellaプロジェクトをHerokuにデプロイする 」でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。   > PROBLEMPROBLEM \n\n- サービスについて 拡張にともない技術スタックがふえるのを抑えたい スケーラビリティのためのコストを抑えたい パフォーマンスをあげたい \n- 拡張にともない技術スタックがふえるのを抑えたい\n- スケーラビリティのためのコストを抑えたい\n- パフォーマンスをあげたい   > SOLUTIONSOLUTION \n\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRails/Deviseの認証機能をPhoenixで実装する流れを取り上げます。 \n\n方針 \n\n- Railsから徐々にPhoenixに移行できるように いままでとおなじPaaS（Heroku） いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく いままでとおなじDB 移行完了までDBマイグレーションをしない \n- いままでとおなじPaaS（Heroku）\n- いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく \n- ブランチ戦略は phoenix/base をベースに\n- 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\n- いままでとおなじDB 移行完了までDBマイグレーションをしない \n- 移行完了までDBマイグレーションをしない\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで   > Guardianを実装するGuardianを実装する \n\nまず、参考にしたのはBlackodeのguardian_authです。ただ、Guardianのバージョンがふるいので1.0へのマイグレーション記事をもとにアレンジしてあります。認証に関係しそうな構成は下記の通り。 \n\nロジック \n\n- MyApp.Account\n- MyApp.Account.Registration\n- MyApp.Account.User\n- MyApp.Auth.Guardian\n- MyApp.Auth.ErrorHandler\n- MyApp.Auth.Pipeline\n- MyApp.Auth.AfterPipeline\n- MyApp.Auth.Session \n\nコントローラ \n\n- MyAppWeb.RegistrationController\n- MyAppWeb.SessionController   > シリアライザとエラーハンドラの設定シリアライザとエラーハンドラの設定 \n\nGuardian1.0から直接ではなくモジュールを介して参照するようになりました。下記のように各モジュールを用意してコンフィグに割り当てます。   elixir \n\n# apps/my_app/lib/my_app/auth/guardian.ex defmodule MyApp.Auth.Guardian do use Guardian, otp_app: :my_app alias MyApp.Account def subject_for_token(resource, _claims), do: {:ok, to_string(resource.id)} def subject_for_token(_, _), do: {:error, :reason_for_error} def resource_from_claims(claims), do: {:ok, Account.get_user!(claims[\"sub\"])} def resource_from_claims(_claims), do: {:error, :reason_for_error} end     elixir \n\n# apps/my_app/lib/my_app/auth/error_handler.ex defmodule MyApp.Auth.ErrorHandler do import Plug.Conn def auth_error(conn, {type, _reason}, _opts) do body = Poison.encode!(%{message: to_string(type)}) send_resp(conn, 401, body) end end     elixir \n\n# apps/my_app/config/config.exs config :my_app, MyApp.Auth.Guardian, issuer: \"MyApp\", ttl: {30, :days}, allowed_drift: 2000, # optionals allowed_algos: [\"HS512\"], verify_module: MyApp.Auth.Guardian.JWT, verify_issuer: true, secret_key: System.get_env(\"GUARDIAN_SECRET\") || \"secret_key\"     > ルーターの設定ルーターの設定 \n\n認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てます。 \n\nルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用しています。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになります。具体的にいうと、ルート / などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになります。   elixir \n\n# apps/my_app/lib/my_app/auth/pipeline.ex defmodule MyApp.Auth.Pipeline do use Guardian.Plug.Pipeline, otp_app: :my_app plug(Guardian.Plug.VerifySession, claims: %{\"typ\" => \"access\"}) plug(Guardian.Plug.VerifyHeader, claims: %{\"typ\" => \"access\"}) plug(Guardian.Plug.LoadResource, allow_blank: true) end     elixir \n\n# apps/my_app/lib/my_app/auth/after_pipeline.ex defmodule MyApp.Auth.AfterPipeline do use Guardian.Plug.Pipeline, otp_app: :my_app plug(Guardian.Plug.EnsureAuthenticated) end     elixir \n\n# apps/my_app/lib/my_app_web/router.ex defmodule MyAppWeb.Router do use MyAppWeb, :router pipeline :browser do plug(:accepts, [\"html\"]) plug(:fetch_session) plug(:fetch_flash) plug(:protect_from_forgery) plug(:put_secure_browser_headers) end pipeline :browser_auth do plug(MyApp.Auth.Pipeline) end pipeline :browser_auth_after do plug(MyApp.Auth.AfterPipeline) end scope \"/\", MyAppWeb do pipe_through([:browser, :browser_auth]) post(\"/registration\", RegistrationController, :create) get(\"/login\", SessionController, :new) post(\"/login\", SessionController, :create) get(\"/logout\", SessionController, :delete) end scope \"/\", MyAppWeb do pipe_through([:browser, :browser_auth, :browser_auth_after]) get(\"/edit\", RegistrationController, :edit) put(\"/edit\", RegistrationController, :update) get(\"/users\", UserController, :index) resources \"/\", UserController, only: [:show, :delete], param: \"username\" end end     elixir \n\n# apps/my_app/config/config.exs config :MyApp, MyApp.Auth.Pipeline, module: MyApp.Auth.Guardian, error_handler: MyApp.Auth.ErrorHandler config :MyApp, MyApp.Auth.AferPipeline, module: MyApp.Auth.Guardian, error_handler: MyApp.Auth.ErrorHandler     > 登録登録 \n\n登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意します。 \n\nこのあたりはDevise/Railsとあまり変わりません。他のアクション「新規パスワード発行」「メールアドレス確認」等も同様の構成をとろうと思っています。   elixir \n\n# apps/my_app/lib/my_app_web/controller/registration_controller.ex def create(conn, user_params) do changeset = User.registration_changeset(%User{}, user_params) case Registration.create(changeset, Repo) do {:ok, user} -> conn |> MyApp.Auth.login(user) |> put_flash(:info, \"Your account was created successfully\") |> redirect(to: page_path(conn, :home)) {:error, changeset} -> conn |> put_flash(:error, \"Unable to create account: Try again\") |> render(MyAppWeb.PageView, \"home.html\", changeset: changeset) end end     elixir \n\n# apps/my_app/lib/my_app/auth/auth.ex def login(conn, %User{} = user) do conn |> Guardian.Plug.sign_in(user) |> assign(:current_user, user) end     elixir \n\n# apps/my_app/lib/my_app/account/registration.ex def create(changeset, repo) do changeset |> repo.insert() end     > ログイン・ログアウトログイン・ログアウト \n\nログイン・ログアウトはセッション用のサービスとコントローラで実装します。   elixir \n\n# apps/my_app/lib/my_app_web/controller/session_controller.ex @doc \"Logged in [POST /login]\" def create(conn, %{\"email\" => email, \"password\" => password}) do case Session.authenticate_user(email, password) do {:ok, user} -> conn |> Session.login(user) |> put_flash(:info, \"Logged in successfully\") |> redirect(to: page_path(conn, :home)) {:error, _reason} -> conn |> put_flash(:error, \"Wrong username/password\") |> render(\"new.html\") end end @doc \"Logged out [DELETE /logout]\" def delete(conn, _params) do conn |> Session.logout() |> put_flash(:info, \"Logged out successfully.\") |> redirect(to: \"/\") end     elixir \n\n# apps/my_app/lib/my_app/auth/session.ex defmodule MyApp.Auth.Session do import Ecto.Query import Plug.Conn import Comeonin.Bcrypt, only: [checkpw: 2, dummy_checkpw: 0] alias MyApp.Repo alias MyApp.Auth.Guardian alias MyApp.Account.User def login(conn, %User{} = user) do conn |> Guardian.Plug.sign_in(user) |> assign(:current_user, user) end def logout(conn), do: Guardian.Plug.sign_out(conn) def authenticate_user(email, given_password) do query = Ecto.Query.from(u in User, where: u.email == ^email) Repo.one(query) |> check_password(given_password) end def current_user(conn), do: Guardian.Plug.current_resource(conn, []) def logged_in?(conn), do: Guardian.Plug.authenticated?(conn, []) defp check_password(nil, _), do: {:error, \"Incorrect username or password\"} defp check_password(user, given_password) do case Comeonin.Bcrypt.checkpw(given_password, user.encrypted_password) do true -> {:ok, user} false -> {:error, \"Incorrect email or password\"} end end end   \n\nDevise/Railsのビューヘルパーはビューマクロで適用します。   elixir \n\n# apps/my_app/lib/my_app_web.ex def view do quote do # .. import Okuribi.Auth.Session, only: [current_user: 1, logged_in?: 1] end end   \n\nあるいは、put_assigns関数をはやしてコントローラマクロに適用します。   elixir \n\n# apps/my_app/lib/my_app/auth/session.ex def put_assigns(%{private: %{phoenix_action: action}} = conn, settings) do current_resource = Guardian.Plug.current_resource(conn) settings = if current_resource, do: settings[:sign_in][action] || [], else: settings[:sign_out][action] || [] conn |> assign(:current_user, current_resource) |> assign(:page_title, settings[:page_title]) |> assign(:page_description, settings[:page_description]) end     elixir \n\n# apps/my_app/lib/my_app_web.ex def controller do quote do # .. import Okuribi.Auth, only: [put_assigns: 2] end end   \n\nassignsひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsのActionView::Helpers::CaptureHelper#provideの代わりに使えます。   elixir \n\n# apps/my_app/lib/my_app_web/controller/*_controller.ex @page %{ sign_in: %{ new: %{ page_title: dgettext(\"views\", \"pages.home.signed_in.page_title\"), page_description: \"\" } }, sign_out: %{ new: %{ page_title: dgettext(\"views\", \"pages.home.signed_out.page_title\"), page_description: \"\" } } } plug(:put_assigns, @page when action in [:home])     > その他その他 \n\nRailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道に行っていきます。 \n\n- Rails ActionView::Helpers::FormHelper#form_for(record, options={}, &block) ActionView::Helpers::FormHelper#text_field(object_name, method, options={}) ActionView::Helpers::FormHelper#file_field(object_name, method, options={}) ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={}) ActionView::Helpers::FormHelper#password_field(object_name, method, options={}) ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={}) ActionView::Helpers::FormBuilder#submit(value=nil, options={}) ActionView::Helpers::TranslationHelper#t \n- ActionView::Helpers::FormHelper#form_for(record, options={}, &block)\n- ActionView::Helpers::FormHelper#text_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#file_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#password_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})\n- ActionView::Helpers::FormBuilder#submit(value=nil, options={})\n- ActionView::Helpers::TranslationHelper#t\n- Phoenix Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun) Phoenix.HTML.Form.text_input(form, field, opts \\\\ []) Phoenix.HTML.Form.file_input(form, field, opts \\\\ []) Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ []) Phoenix.HTML.Form.password_input(form, field, opts \\\\ []) Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ []) Phoenix.HTML.Form.submit(opts, opts \\\\ []) Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{}) \n- Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun)\n- Phoenix.HTML.Form.text_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.file_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.password_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ [])\n- Phoenix.HTML.Form.submit(opts, opts \\\\ [])\n- Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{})   > WRAPUPWRAPUP \n\n前回もそうですが、コードのマイグレーションはまあ地味な作業ですよね。とまれ、認証機能を実装できたので良しとしましょう。","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"},"wip":false,"body_md":"<img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\">\r\n\r\n連載「Rails2Phoenix」になります、前回は[「UmbrellaプロジェクトをHerokuにデプロイする 」](https://blahfe.esa.io/posts/59)でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。\r\n\r\n\r\n# PROBLEM\r\n- サービスについて\r\n    - 拡張にともない技術スタックがふえるのを抑えたい\r\n    - スケーラビリティのためのコストを抑えたい\r\n    - パフォーマンスをあげたい\r\n\r\n# SOLUTION\r\nというわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRails/Deviseの認証機能をPhoenixで実装する流れを取り上げます。\r\n\r\n**方針**\r\n- Railsから徐々にPhoenixに移行できるように\r\n  - いままでとおなじPaaS（Heroku）\r\n  - いままでとおなじレポジトリ\r\n      - ブランチ戦略は `phoenix/base` をベースに\r\n      - 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\r\n  - いままでとおなじDB\r\n      - 移行完了までDBマイグレーションをしない\r\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで\r\n\r\n## Guardianを実装する\r\nまず、参考にしたのはBlackodeの[guardian_auth](https://github.com/blackode/guardian_auth)です。ただ、Guardianのバージョンがふるいので[1.0へのマイグレーション記事](https://github.com/ueberauth/guardian/blob/master/upgrade_guides/0.14.to.1.0.md)をもとにアレンジしてあります。認証に関係しそうな構成は下記の通り。\r\n\r\nロジック\r\n- MyApp.Account\r\n- MyApp.Account.Registration\r\n- MyApp.Account.User\r\n- MyApp.Auth.Guardian\r\n- MyApp.Auth.ErrorHandler\r\n- MyApp.Auth.Pipeline\r\n- MyApp.Auth.AfterPipeline\r\n- MyApp.Auth.Session\r\n\r\nコントローラ\r\n- MyAppWeb.RegistrationController\r\n- MyAppWeb.SessionController\r\n\r\n### シリアライザとエラーハンドラの設定\r\nGuardian1.0から直接ではなくモジュールを介して参照するようになりました。下記のように各モジュールを用意してコンフィグに割り当てます。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/guardian.ex\r\n\r\ndefmodule MyApp.Auth.Guardian do\r\n  use Guardian, otp_app: :my_app\r\n  alias MyApp.Account\r\n\r\n  def subject_for_token(resource, _claims), do: {:ok, to_string(resource.id)}\r\n  def subject_for_token(_, _), do: {:error, :reason_for_error}\r\n\r\n  def resource_from_claims(claims), do: {:ok, Account.get_user!(claims[\"sub\"])}\r\n  def resource_from_claims(_claims), do: {:error, :reason_for_error}\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/error_handler.ex\r\n\r\ndefmodule MyApp.Auth.ErrorHandler do\r\n  import Plug.Conn\r\n\r\n  def auth_error(conn, {type, _reason}, _opts) do\r\n    body = Poison.encode!(%{message: to_string(type)})\r\n    send_resp(conn, 401, body)\r\n  end\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/config/config.exs\r\n\r\nconfig :my_app, MyApp.Auth.Guardian,\r\n  issuer: \"MyApp\",\r\n  ttl: {30, :days},\r\n  allowed_drift: 2000,\r\n  # optionals\r\n  allowed_algos: [\"HS512\"],\r\n  verify_module: MyApp.Auth.Guardian.JWT,\r\n  verify_issuer: true,\r\n  secret_key:\r\n    System.get_env(\"GUARDIAN_SECRET\") ||\r\n      \"secret_key\"\r\n```\r\n\r\n### ルーターの設定\r\n認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てます。\r\n\r\nルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用しています。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになります。具体的にいうと、ルート `/` などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになります。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/pipeline.ex\r\n\r\ndefmodule MyApp.Auth.Pipeline do\r\n  use Guardian.Plug.Pipeline, otp_app: :my_app\r\n\r\n  plug(Guardian.Plug.VerifySession, claims: %{\"typ\" => \"access\"})\r\n  plug(Guardian.Plug.VerifyHeader, claims: %{\"typ\" => \"access\"})\r\n  plug(Guardian.Plug.LoadResource, allow_blank: true)\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/after_pipeline.ex\r\n\r\ndefmodule MyApp.Auth.AfterPipeline do\r\n  use Guardian.Plug.Pipeline, otp_app: :my_app\r\n\r\n  plug(Guardian.Plug.EnsureAuthenticated)\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/router.ex\r\n\r\ndefmodule MyAppWeb.Router do\r\n  use MyAppWeb, :router\r\n\r\n  pipeline :browser do\r\n    plug(:accepts, [\"html\"])\r\n    plug(:fetch_session)\r\n    plug(:fetch_flash)\r\n    plug(:protect_from_forgery)\r\n    plug(:put_secure_browser_headers)\r\n  end\r\n\r\n  pipeline :browser_auth do\r\n    plug(MyApp.Auth.Pipeline)\r\n  end\r\n\r\n  pipeline :browser_auth_after do\r\n    plug(MyApp.Auth.AfterPipeline)\r\n  end\r\n\r\n  scope \"/\", MyAppWeb do\r\n    pipe_through([:browser, :browser_auth])\r\n\r\n    post(\"/registration\", RegistrationController, :create)\r\n    get(\"/login\", SessionController, :new)\r\n    post(\"/login\", SessionController, :create)\r\n    get(\"/logout\", SessionController, :delete)\r\n  end\r\n\r\n  scope \"/\", MyAppWeb do\r\n    pipe_through([:browser, :browser_auth, :browser_auth_after])\r\n\r\n    get(\"/edit\", RegistrationController, :edit)\r\n    put(\"/edit\", RegistrationController, :update)\r\n    get(\"/users\", UserController, :index)\r\n    resources \"/\", UserController, only: [:show, :delete], param: \"username\"\r\n  end\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/config/config.exs\r\n\r\nconfig :MyApp, MyApp.Auth.Pipeline,\r\n  module: MyApp.Auth.Guardian,\r\n  error_handler: MyApp.Auth.ErrorHandler\r\n\r\nconfig :MyApp, MyApp.Auth.AferPipeline,\r\n  module: MyApp.Auth.Guardian,\r\n  error_handler: MyApp.Auth.ErrorHandler\r\n```\r\n\r\n### 登録\r\n登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意します。\r\n\r\nこのあたりはDevise/Railsとあまり変わりません。他のアクション「新規パスワード発行」「メールアドレス確認」等も同様の構成をとろうと思っています。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/controller/registration_controller.ex\r\n\r\ndef create(conn, user_params) do\r\n  changeset = User.registration_changeset(%User{}, user_params)\r\n\r\n  case Registration.create(changeset, Repo) do\r\n    {:ok, user} ->\r\n      conn\r\n      |> MyApp.Auth.login(user)\r\n      |> put_flash(:info, \"Your account was created successfully\")\r\n      |> redirect(to: page_path(conn, :home))\r\n\r\n   {:error, changeset} ->\r\n      conn\r\n      |> put_flash(:error, \"Unable to create account: Try again\")\r\n      |> render(MyAppWeb.PageView, \"home.html\", changeset: changeset)\r\n  end\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/auth.ex\r\n\r\ndef login(conn, %User{} = user) do\r\n  conn\r\n  |> Guardian.Plug.sign_in(user)\r\n  |> assign(:current_user, user)\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/account/registration.ex\r\n\r\ndef create(changeset, repo) do\r\n  changeset\r\n  |> repo.insert()\r\nend\r\n```\r\n\r\n### ログイン・ログアウト\r\nログイン・ログアウトはセッション用のサービスとコントローラで実装します。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/controller/session_controller.ex\r\n\r\n@doc \"Logged in [POST /login]\"\r\ndef create(conn, %{\"email\" => email, \"password\" => password}) do\r\n  case Session.authenticate_user(email, password) do\r\n    {:ok, user} ->\r\n      conn\r\n      |> Session.login(user)\r\n      |> put_flash(:info, \"Logged in successfully\")\r\n      |> redirect(to: page_path(conn, :home))\r\n\r\n    {:error, _reason} ->\r\n      conn\r\n      |> put_flash(:error, \"Wrong username/password\")\r\n      |> render(\"new.html\")\r\n  end\r\nend\r\n\r\n@doc \"Logged out [DELETE /logout]\"\r\ndef delete(conn, _params) do\r\n  conn\r\n  |> Session.logout()\r\n  |> put_flash(:info, \"Logged out successfully.\")\r\n  |> redirect(to: \"/\")\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/session.ex\r\n\r\ndefmodule MyApp.Auth.Session do\r\n  import Ecto.Query\r\n  import Plug.Conn\r\n  import Comeonin.Bcrypt, only: [checkpw: 2, dummy_checkpw: 0]\r\n  alias MyApp.Repo\r\n  alias MyApp.Auth.Guardian\r\n  alias MyApp.Account.User\r\n\r\n  def login(conn, %User{} = user) do\r\n    conn\r\n    |> Guardian.Plug.sign_in(user)\r\n    |> assign(:current_user, user)\r\n  end\r\n\r\n  def logout(conn), do: Guardian.Plug.sign_out(conn)\r\n\r\n  def authenticate_user(email, given_password) do\r\n    query = Ecto.Query.from(u in User, where: u.email == ^email)\r\n\r\n    Repo.one(query)\r\n    |> check_password(given_password)\r\n  end\r\n\r\n  def current_user(conn), do: Guardian.Plug.current_resource(conn, [])\r\n\r\n  def logged_in?(conn), do: Guardian.Plug.authenticated?(conn, [])\r\n\r\n  defp check_password(nil, _), do: {:error, \"Incorrect username or password\"}\r\n\r\n  defp check_password(user, given_password) do\r\n    case Comeonin.Bcrypt.checkpw(given_password, user.encrypted_password) do\r\n      true -> {:ok, user}\r\n      false -> {:error, \"Incorrect email or password\"}\r\n    end\r\n  end\r\nend\r\n```\r\n\r\nDevise/Railsのビューヘルパーはビューマクロで適用します。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web.ex\r\n\r\ndef view do\r\n  quote do\r\n    # ..\r\n    import Okuribi.Auth.Session, only: [current_user: 1, logged_in?: 1]\r\n  end\r\nend\r\n```\r\n\r\nあるいは、`put_assigns`関数をはやしてコントローラマクロに適用します。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/session.ex\r\n\r\ndef put_assigns(%{private: %{phoenix_action: action}} = conn, settings) do\r\n  current_resource = Guardian.Plug.current_resource(conn)\r\n\r\n  settings =\r\n    if current_resource,\r\n      do: settings[:sign_in][action] || [],\r\n      else: settings[:sign_out][action] || []\r\n\r\n  conn\r\n  |> assign(:current_user, current_resource)\r\n  |> assign(:page_title, settings[:page_title])\r\n  |> assign(:page_description, settings[:page_description])\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web.ex\r\n\r\ndef controller do\r\n  quote do\r\n    # ..\r\n    import Okuribi.Auth, only: [put_assigns: 2]\r\n  end\r\nend\r\n```\r\n\r\n`assigns`ひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsの`ActionView::Helpers::CaptureHelper#provide`の代わりに使えます。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/controller/*_controller.ex\r\n\r\n@page %{\r\n  sign_in: %{\r\n    new: %{\r\n      page_title: dgettext(\"views\", \"pages.home.signed_in.page_title\"),\r\n      page_description: \"\"\r\n    }\r\n  },\r\n  sign_out: %{\r\n    new: %{\r\n      page_title: dgettext(\"views\", \"pages.home.signed_out.page_title\"),\r\n      page_description: \"\"\r\n    }\r\n  }\r\n}\r\nplug(:put_assigns, @page when action in [:home])\r\n```\r\n\r\n## その他\r\nRailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道に行っていきます。\r\n\r\n- Rails\r\n    - `ActionView::Helpers::FormHelper#form_for(record, options={}, &block)`\r\n    - `ActionView::Helpers::FormHelper#text_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#file_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#password_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})`\r\n    - `ActionView::Helpers::FormBuilder#submit(value=nil, options={})`\r\n    - `ActionView::Helpers::TranslationHelper#t`\r\n- Phoenix\r\n    - `Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun)`\r\n    - `Phoenix.HTML.Form.text_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.file_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.password_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.submit(opts, opts \\\\ [])`\r\n    - `Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{})`\r\n\r\n# WRAPUP\r\n前回もそうですが、コードのマイグレーションはまあ地味な作業ですよね。とまれ、認証機能を実装できたので良しとしましょう。","body_html":"<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\"></a>\n<p data-sourcepos=\"3:1-3:257\">連載「Rails2Phoenix」になります、前回は<a href=\"https://blahfe.esa.io/posts/59\">「UmbrellaプロジェクトをHerokuにデプロイする 」</a>でした。今回は前回課題としてあがった認証機能の実装を試みたいと思います。</p>\n<h1 data-sourcepos=\"6:1-6:9\" id=\"1-0-0\" name=\"1-0-0\">\n<a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"7:1-11:0\">\n<li data-sourcepos=\"7:1-11:0\">サービスについて\n<ul data-sourcepos=\"8:5-11:0\">\n<li data-sourcepos=\"8:5-8:75\">拡張にともない技術スタックがふえるのを抑えたい</li>\n<li data-sourcepos=\"9:5-9:66\">スケーラビリティのためのコストを抑えたい</li>\n<li data-sourcepos=\"10:5-11:0\">パフォーマンスをあげたい</li>\n</ul>\n</li>\n</ul>\n<h1 data-sourcepos=\"12:1-12:10\" id=\"2-0-0\" name=\"2-0-0\">\n<a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"13:1-13:220\">というわけで、現在つかっているRailsをPhoenixに変更することにしました。方針は以下の通りで、今回はRails/Deviseの認証機能をPhoenixで実装する流れを取り上げます。</p>\n<p data-sourcepos=\"15:1-15:10\"><strong>方針</strong></p>\n<ul data-sourcepos=\"16:1-24:0\">\n<li data-sourcepos=\"16:1-22:64\">Railsから徐々にPhoenixに移行できるように\n<ul data-sourcepos=\"17:3-22:64\">\n<li data-sourcepos=\"17:3-17:44\">いままでとおなじPaaS（Heroku）</li>\n<li data-sourcepos=\"18:3-20:100\">いままでとおなじレポジトリ\n<ul data-sourcepos=\"19:7-20:100\">\n<li data-sourcepos=\"19:7-19:60\">ブランチ戦略は <code>phoenix/base</code> をベースに</li>\n<li data-sourcepos=\"20:7-20:100\">気軽に参照できるようにRails関連ファイルは可能な限りのこしておく</li>\n</ul>\n</li>\n<li data-sourcepos=\"21:3-22:64\">いままでとおなじDB\n<ul data-sourcepos=\"22:7-22:64\">\n<li data-sourcepos=\"22:7-22:64\">移行完了までDBマイグレーションをしない</li>\n</ul>\n</li>\n</ul>\n</li>\n<li data-sourcepos=\"23:1-24:0\">Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで</li>\n</ul>\n<h2 data-sourcepos=\"25:1-25:26\" id=\"2-1-0\" name=\"2-1-0\">\n<a class=\"anchor\" id=\"Guardianを実装する\" name=\"Guardian%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" href=\"#Guardian%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Guardianを実装する\"> &gt; Guardianを実装する</span></a>Guardianを実装する</h2>\n<p data-sourcepos=\"26:1-26:382\">まず、参考にしたのはBlackodeの<a href=\"https://github.com/blackode/guardian_auth\" target=\"_blank\" rel=\"noopener noreferrer\">guardian_auth</a>です。ただ、Guardianのバージョンがふるいので<a href=\"https://github.com/ueberauth/guardian/blob/master/upgrade_guides/0.14.to.1.0.md\" target=\"_blank\" rel=\"noopener noreferrer\">1.0へのマイグレーション記事</a>をもとにアレンジしてあります。認証に関係しそうな構成は下記の通り。</p>\n<p data-sourcepos=\"28:1-28:12\">ロジック</p>\n<ul data-sourcepos=\"29:1-37:0\">\n<li data-sourcepos=\"29:1-29:15\">MyApp.Account</li>\n<li data-sourcepos=\"30:1-30:28\">MyApp.Account.Registration</li>\n<li data-sourcepos=\"31:1-31:20\">MyApp.Account.User</li>\n<li data-sourcepos=\"32:1-32:21\">MyApp.Auth.Guardian</li>\n<li data-sourcepos=\"33:1-33:25\">MyApp.Auth.ErrorHandler</li>\n<li data-sourcepos=\"34:1-34:21\">MyApp.Auth.Pipeline</li>\n<li data-sourcepos=\"35:1-35:26\">MyApp.Auth.AfterPipeline</li>\n<li data-sourcepos=\"36:1-37:0\">MyApp.Auth.Session</li>\n</ul>\n<p data-sourcepos=\"38:1-38:18\">コントローラ</p>\n<ul data-sourcepos=\"39:1-41:0\">\n<li data-sourcepos=\"39:1-39:33\">MyAppWeb.RegistrationController</li>\n<li data-sourcepos=\"40:1-41:0\">MyAppWeb.SessionController</li>\n</ul>\n<h3 data-sourcepos=\"42:1-42:55\" id=\"2-1-1\" name=\"2-1-1\">\n<a class=\"anchor\" id=\"シリアライザとエラーハンドラの設定\" name=\"%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%B6%E3%81%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A\" href=\"#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%B6%E3%81%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"シリアライザとエラーハンドラの設定\"> &gt; シリアライザとエラーハンドラの設定</span></a>シリアライザとエラーハンドラの設定</h3>\n<p data-sourcepos=\"43:1-43:191\">Guardian1.0から直接ではなくモジュールを介して参照するようになりました。下記のように各モジュールを用意してコンフィグに割り当てます。</p>\n<div class=\"code-block\" data-sourcepos=\"45:1-58:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/guardian.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">Guardian</span><span class=\"p\">,</span> <span class=\"ss\">otp_app:</span> <span class=\"ss\">:my_app</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Account</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">subject_for_token</span><span class=\"p\">(</span><span class=\"n\">resource</span><span class=\"p\">,</span> <span class=\"n\">_claims</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">to_string</span><span class=\"p\">(</span><span class=\"n\">resource</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)}</span>\n  <span class=\"k\">def</span> <span class=\"n\">subject_for_token</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"ss\">:reason_for_error</span><span class=\"p\">}</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">resource_from_claims</span><span class=\"p\">(</span><span class=\"n\">claims</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"no\">Account</span><span class=\"o\">.</span><span class=\"n\">get_user!</span><span class=\"p\">(</span><span class=\"n\">claims</span><span class=\"p\">[</span><span class=\"s2\">\"sub\"</span><span class=\"p\">])}</span>\n  <span class=\"k\">def</span> <span class=\"n\">resource_from_claims</span><span class=\"p\">(</span><span class=\"n\">_claims</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"ss\">:reason_for_error</span><span class=\"p\">}</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"60:1-71:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/error_handler.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">ErrorHandler</span> <span class=\"k\">do</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Conn</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">auth_error</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">type</span><span class=\"p\">,</span> <span class=\"n\">_reason</span><span class=\"p\">},</span> <span class=\"n\">_opts</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">body</span> <span class=\"o\">=</span> <span class=\"no\">Poison</span><span class=\"o\">.</span><span class=\"n\">encode!</span><span class=\"p\">(%{</span><span class=\"ss\">message:</span> <span class=\"n\">to_string</span><span class=\"p\">(</span><span class=\"n\">type</span><span class=\"p\">)})</span>\n    <span class=\"n\">send_resp</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"mi\">401</span><span class=\"p\">,</span> <span class=\"n\">body</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"73:1-87:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/config/config.exs</span>\n\n<span class=\"n\">config</span> <span class=\"ss\">:my_app</span><span class=\"p\">,</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"p\">,</span>\n  <span class=\"ss\">issuer:</span> <span class=\"s2\">\"MyApp\"</span><span class=\"p\">,</span>\n  <span class=\"ss\">ttl:</span> <span class=\"p\">{</span><span class=\"mi\">30</span><span class=\"p\">,</span> <span class=\"ss\">:days</span><span class=\"p\">},</span>\n  <span class=\"ss\">allowed_drift:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span>\n  <span class=\"c1\"># optionals</span>\n  <span class=\"ss\">allowed_algos:</span> <span class=\"p\">[</span><span class=\"s2\">\"HS512\"</span><span class=\"p\">],</span>\n  <span class=\"ss\">verify_module:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">JWT</span><span class=\"p\">,</span>\n  <span class=\"ss\">verify_issuer:</span> <span class=\"no\">true</span><span class=\"p\">,</span>\n  <span class=\"ss\">secret_key:</span>\n    <span class=\"no\">System</span><span class=\"o\">.</span><span class=\"n\">get_env</span><span class=\"p\">(</span><span class=\"s2\">\"GUARDIAN_SECRET\"</span><span class=\"p\">)</span> <span class=\"o\">||</span>\n      <span class=\"s2\">\"secret_key\"</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"89:1-89:25\" id=\"2-1-2\" name=\"2-1-2\">\n<a class=\"anchor\" id=\"ルーターの設定\" name=\"%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" href=\"#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" data-position=\"2-1-2\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"ルーターの設定\"> &gt; ルーターの設定</span></a>ルーターの設定</h3>\n<p data-sourcepos=\"90:1-90:129\">認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てます。</p>\n<p data-sourcepos=\"92:1-92:614\">ルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用しています。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになります。具体的にいうと、ルート <code>/</code> などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになります。</p>\n<div class=\"code-block\" data-sourcepos=\"94:1-104:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/pipeline.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">,</span> <span class=\"ss\">otp_app:</span> <span class=\"ss\">:my_app</span>\n\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">VerifySession</span><span class=\"p\">,</span> <span class=\"ss\">claims:</span> <span class=\"p\">%{</span><span class=\"s2\">\"typ\"</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">\"access\"</span><span class=\"p\">})</span>\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">VerifyHeader</span><span class=\"p\">,</span> <span class=\"ss\">claims:</span> <span class=\"p\">%{</span><span class=\"s2\">\"typ\"</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">\"access\"</span><span class=\"p\">})</span>\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">LoadResource</span><span class=\"p\">,</span> <span class=\"ss\">allow_blank:</span> <span class=\"no\">true</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"106:1-114:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/after_pipeline.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">AfterPipeline</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">,</span> <span class=\"ss\">otp_app:</span> <span class=\"ss\">:my_app</span>\n\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">EnsureAuthenticated</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"116:1-156:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/router.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyAppWeb</span><span class=\"o\">.</span><span class=\"no\">Router</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">MyAppWeb</span><span class=\"p\">,</span> <span class=\"ss\">:router</span>\n\n  <span class=\"n\">pipeline</span> <span class=\"ss\">:browser</span> <span class=\"k\">do</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:accepts</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s2\">\"html\"</span><span class=\"p\">])</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:fetch_session</span><span class=\"p\">)</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:fetch_flash</span><span class=\"p\">)</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:protect_from_forgery</span><span class=\"p\">)</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:put_secure_browser_headers</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">pipeline</span> <span class=\"ss\">:browser_auth</span> <span class=\"k\">do</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">pipeline</span> <span class=\"ss\">:browser_auth_after</span> <span class=\"k\">do</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">AfterPipeline</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">scope</span> <span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"no\">MyAppWeb</span> <span class=\"k\">do</span>\n    <span class=\"n\">pipe_through</span><span class=\"p\">([</span><span class=\"ss\">:browser</span><span class=\"p\">,</span> <span class=\"ss\">:browser_auth</span><span class=\"p\">])</span>\n\n    <span class=\"n\">post</span><span class=\"p\">(</span><span class=\"s2\">\"/registration\"</span><span class=\"p\">,</span> <span class=\"no\">RegistrationController</span><span class=\"p\">,</span> <span class=\"ss\">:create</span><span class=\"p\">)</span>\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/login\"</span><span class=\"p\">,</span> <span class=\"no\">SessionController</span><span class=\"p\">,</span> <span class=\"ss\">:new</span><span class=\"p\">)</span>\n    <span class=\"n\">post</span><span class=\"p\">(</span><span class=\"s2\">\"/login\"</span><span class=\"p\">,</span> <span class=\"no\">SessionController</span><span class=\"p\">,</span> <span class=\"ss\">:create</span><span class=\"p\">)</span>\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/logout\"</span><span class=\"p\">,</span> <span class=\"no\">SessionController</span><span class=\"p\">,</span> <span class=\"ss\">:delete</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">scope</span> <span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"no\">MyAppWeb</span> <span class=\"k\">do</span>\n    <span class=\"n\">pipe_through</span><span class=\"p\">([</span><span class=\"ss\">:browser</span><span class=\"p\">,</span> <span class=\"ss\">:browser_auth</span><span class=\"p\">,</span> <span class=\"ss\">:browser_auth_after</span><span class=\"p\">])</span>\n\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/edit\"</span><span class=\"p\">,</span> <span class=\"no\">RegistrationController</span><span class=\"p\">,</span> <span class=\"ss\">:edit</span><span class=\"p\">)</span>\n    <span class=\"n\">put</span><span class=\"p\">(</span><span class=\"s2\">\"/edit\"</span><span class=\"p\">,</span> <span class=\"no\">RegistrationController</span><span class=\"p\">,</span> <span class=\"ss\">:update</span><span class=\"p\">)</span>\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/users\"</span><span class=\"p\">,</span> <span class=\"no\">UserController</span><span class=\"p\">,</span> <span class=\"ss\">:index</span><span class=\"p\">)</span>\n    <span class=\"n\">resources</span> <span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"no\">UserController</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">:show</span><span class=\"p\">,</span> <span class=\"ss\">:delete</span><span class=\"p\">],</span> <span class=\"ss\">param:</span> <span class=\"s2\">\"username\"</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"158:1-168:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/config/config.exs</span>\n\n<span class=\"n\">config</span> <span class=\"ss\">:MyApp</span><span class=\"p\">,</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">,</span>\n  <span class=\"ss\">module:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"p\">,</span>\n  <span class=\"ss\">error_handler:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">ErrorHandler</span>\n\n<span class=\"n\">config</span> <span class=\"ss\">:MyApp</span><span class=\"p\">,</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">AferPipeline</span><span class=\"p\">,</span>\n  <span class=\"ss\">module:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"p\">,</span>\n  <span class=\"ss\">error_handler:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">ErrorHandler</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"170:1-170:10\" id=\"2-1-3\" name=\"2-1-3\">\n<a class=\"anchor\" id=\"登録\" name=\"%E7%99%BB%E9%8C%B2\" href=\"#%E7%99%BB%E9%8C%B2\" data-position=\"2-1-3\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"登録\"> &gt; 登録</span></a>登録</h3>\n<p data-sourcepos=\"171:1-171:123\">登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意します。</p>\n<p data-sourcepos=\"173:1-173:207\">このあたりはDevise/Railsとあまり変わりません。他のアクション「新規パスワード発行」「メールアドレス確認」等も同様の構成をとろうと思っています。</p>\n<div class=\"code-block\" data-sourcepos=\"175:1-194:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/controller/registration_controller.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">user_params</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">changeset</span> <span class=\"o\">=</span> <span class=\"no\">User</span><span class=\"o\">.</span><span class=\"n\">registration_changeset</span><span class=\"p\">(%</span><span class=\"no\">User</span><span class=\"p\">{},</span> <span class=\"n\">user_params</span><span class=\"p\">)</span>\n\n  <span class=\"k\">case</span> <span class=\"no\">Registration</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">changeset</span><span class=\"p\">,</span> <span class=\"no\">Repo</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:info</span><span class=\"p\">,</span> <span class=\"s2\">\"Your account was created successfully\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"ss\">to:</span> <span class=\"n\">page_path</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"ss\">:home</span><span class=\"p\">))</span>\n\n   <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"n\">changeset</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Unable to create account: Try again\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"no\">MyAppWeb</span><span class=\"o\">.</span><span class=\"no\">PageView</span><span class=\"p\">,</span> <span class=\"s2\">\"home.html\"</span><span class=\"p\">,</span> <span class=\"ss\">changeset:</span> <span class=\"n\">changeset</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"196:1-204:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/auth.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">%</span><span class=\"no\">User</span><span class=\"p\">{}</span> <span class=\"o\">=</span> <span class=\"n\">user</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">conn</span>\n  <span class=\"o\">|&gt;</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">sign_in</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:current_user</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"206:1-213:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/account/registration.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">changeset</span><span class=\"p\">,</span> <span class=\"n\">repo</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">changeset</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">repo</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">()</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"215:1-215:34\" id=\"2-1-4\" name=\"2-1-4\">\n<a class=\"anchor\" id=\"ログイン・ログアウト\" name=\"%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%BB%E3%83%AD%E3%82%B0%E3%82%A2%E3%82%A6%E3%83%88\" href=\"#%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%BB%E3%83%AD%E3%82%B0%E3%82%A2%E3%82%A6%E3%83%88\" data-position=\"2-1-4\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"ログイン・ログアウト\"> &gt; ログイン・ログアウト</span></a>ログイン・ログアウト</h3>\n<p data-sourcepos=\"216:1-216:108\">ログイン・ログアウトはセッション用のサービスとコントローラで実装します。</p>\n<div class=\"code-block\" data-sourcepos=\"218:1-244:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/controller/session_controller.ex</span>\n\n<span class=\"nv\">@doc</span> <span class=\"s2\">\"Logged in [POST /login]\"</span>\n<span class=\"k\">def</span> <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">%{</span><span class=\"s2\">\"email\"</span> <span class=\"o\">=&gt;</span> <span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"s2\">\"password\"</span> <span class=\"o\">=&gt;</span> <span class=\"n\">password</span><span class=\"p\">})</span> <span class=\"k\">do</span>\n  <span class=\"k\">case</span> <span class=\"no\">Session</span><span class=\"o\">.</span><span class=\"n\">authenticate_user</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"no\">Session</span><span class=\"o\">.</span><span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:info</span><span class=\"p\">,</span> <span class=\"s2\">\"Logged in successfully\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"ss\">to:</span> <span class=\"n\">page_path</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"ss\">:home</span><span class=\"p\">))</span>\n\n    <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"n\">_reason</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Wrong username/password\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"s2\">\"new.html\"</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"nv\">@doc</span> <span class=\"s2\">\"Logged out [DELETE /logout]\"</span>\n<span class=\"k\">def</span> <span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">_params</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">conn</span>\n  <span class=\"o\">|&gt;</span> <span class=\"no\">Session</span><span class=\"o\">.</span><span class=\"n\">logout</span><span class=\"p\">()</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:info</span><span class=\"p\">,</span> <span class=\"s2\">\"Logged out successfully.\"</span><span class=\"p\">)</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"ss\">to:</span> <span class=\"s2\">\"/\"</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"246:1-285:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/session.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Session</span> <span class=\"k\">do</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Ecto</span><span class=\"o\">.</span><span class=\"no\">Query</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Conn</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Comeonin</span><span class=\"o\">.</span><span class=\"no\">Bcrypt</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">checkpw:</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"ss\">dummy_checkpw:</span> <span class=\"mi\">0</span><span class=\"p\">]</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Repo</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Account</span><span class=\"o\">.</span><span class=\"no\">User</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">%</span><span class=\"no\">User</span><span class=\"p\">{}</span> <span class=\"o\">=</span> <span class=\"n\">user</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">conn</span>\n    <span class=\"o\">|&gt;</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">sign_in</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:current_user</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">logout</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">sign_out</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">authenticate_user</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">given_password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"no\">Ecto</span><span class=\"o\">.</span><span class=\"no\">Query</span><span class=\"o\">.</span><span class=\"n\">from</span><span class=\"p\">(</span><span class=\"n\">u</span> <span class=\"ow\">in</span> <span class=\"no\">User</span><span class=\"p\">,</span> <span class=\"ss\">where:</span> <span class=\"n\">u</span><span class=\"o\">.</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"o\">^</span><span class=\"n\">email</span><span class=\"p\">)</span>\n\n    <span class=\"no\">Repo</span><span class=\"o\">.</span><span class=\"n\">one</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n    <span class=\"o\">|&gt;</span> <span class=\"n\">check_password</span><span class=\"p\">(</span><span class=\"n\">given_password</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">current_user</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">current_resource</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">logged_in?</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">authenticated?</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n\n  <span class=\"k\">defp</span> <span class=\"n\">check_password</span><span class=\"p\">(</span><span class=\"no\">nil</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Incorrect username or password\"</span><span class=\"p\">}</span>\n\n  <span class=\"k\">defp</span> <span class=\"n\">check_password</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"n\">given_password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"k\">case</span> <span class=\"no\">Comeonin</span><span class=\"o\">.</span><span class=\"no\">Bcrypt</span><span class=\"o\">.</span><span class=\"n\">checkpw</span><span class=\"p\">(</span><span class=\"n\">given_password</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">encrypted_password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n      <span class=\"no\">true</span> <span class=\"o\">-&gt;</span> <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">}</span>\n      <span class=\"no\">false</span> <span class=\"o\">-&gt;</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Incorrect email or password\"</span><span class=\"p\">}</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"287:1-287:78\">Devise/Railsのビューヘルパーはビューマクロで適用します。</p>\n<div class=\"code-block\" data-sourcepos=\"289:1-298:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">view</span> <span class=\"k\">do</span>\n  <span class=\"kn\">quote</span> <span class=\"k\">do</span>\n    <span class=\"c1\"># ..</span>\n    <span class=\"kn\">import</span> <span class=\"no\">Okuribi</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Session</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">current_user:</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"ss\">logged_in?:</span> <span class=\"mi\">1</span><span class=\"p\">]</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"300:1-300:97\">あるいは、<code>put_assigns</code>関数をはやしてコントローラマクロに適用します。</p>\n<div class=\"code-block\" data-sourcepos=\"302:1-318:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/session.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">put_assigns</span><span class=\"p\">(%{</span><span class=\"ss\">private:</span> <span class=\"p\">%{</span><span class=\"ss\">phoenix_action:</span> <span class=\"n\">action</span><span class=\"p\">}}</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">current_resource</span> <span class=\"o\">=</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">current_resource</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n\n  <span class=\"n\">settings</span> <span class=\"o\">=</span>\n    <span class=\"k\">if</span> <span class=\"n\">current_resource</span><span class=\"p\">,</span>\n      <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:sign_in</span><span class=\"p\">][</span><span class=\"n\">action</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"p\">[],</span>\n      <span class=\"k\">else</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:sign_out</span><span class=\"p\">][</span><span class=\"n\">action</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n\n  <span class=\"n\">conn</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:current_user</span><span class=\"p\">,</span> <span class=\"n\">current_resource</span><span class=\"p\">)</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:page_title</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:page_title</span><span class=\"p\">])</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:page_description</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:page_description</span><span class=\"p\">])</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"320:1-329:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">controller</span> <span class=\"k\">do</span>\n  <span class=\"kn\">quote</span> <span class=\"k\">do</span>\n    <span class=\"c1\"># ..</span>\n    <span class=\"kn\">import</span> <span class=\"no\">Okuribi</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">put_assigns:</span> <span class=\"mi\">2</span><span class=\"p\">]</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"331:1-331:205\"><code>assigns</code>ひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsの<code>ActionView::Helpers::CaptureHelper#provide</code>の代わりに使えます。</p>\n<div class=\"code-block\" data-sourcepos=\"333:1-351:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/controller/*_controller.ex</span>\n\n<span class=\"nv\">@page</span> <span class=\"p\">%{</span>\n  <span class=\"ss\">sign_in:</span> <span class=\"p\">%{</span>\n    <span class=\"ss\">new:</span> <span class=\"p\">%{</span>\n      <span class=\"ss\">page_title:</span> <span class=\"n\">dgettext</span><span class=\"p\">(</span><span class=\"s2\">\"views\"</span><span class=\"p\">,</span> <span class=\"s2\">\"pages.home.signed_in.page_title\"</span><span class=\"p\">),</span>\n      <span class=\"ss\">page_description:</span> <span class=\"s2\">\"\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">},</span>\n  <span class=\"ss\">sign_out:</span> <span class=\"p\">%{</span>\n    <span class=\"ss\">new:</span> <span class=\"p\">%{</span>\n      <span class=\"ss\">page_title:</span> <span class=\"n\">dgettext</span><span class=\"p\">(</span><span class=\"s2\">\"views\"</span><span class=\"p\">,</span> <span class=\"s2\">\"pages.home.signed_out.page_title\"</span><span class=\"p\">),</span>\n      <span class=\"ss\">page_description:</span> <span class=\"s2\">\"\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:put_assigns</span><span class=\"p\">,</span> <span class=\"nv\">@page</span> <span class=\"ow\">when</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"ss\">:home</span><span class=\"p\">])</span>\n</code></pre></div>\n</div>\n<h2 data-sourcepos=\"353:1-353:12\" id=\"2-2-0\" name=\"2-2-0\">\n<a class=\"anchor\" id=\"その他\" name=\"%E3%81%9D%E3%81%AE%E4%BB%96\" href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"その他\"> &gt; その他</span></a>その他</h2>\n<p data-sourcepos=\"354:1-354:120\">RailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道に行っていきます。</p>\n<ul data-sourcepos=\"356:1-374:0\">\n<li data-sourcepos=\"356:1-364:48\">Rails\n<ul data-sourcepos=\"357:5-364:48\">\n<li data-sourcepos=\"357:5-357:76\"><code>ActionView::Helpers::FormHelper#form_for(record, options={}, &amp;block)</code></li>\n<li data-sourcepos=\"358:5-358:83\"><code>ActionView::Helpers::FormHelper#text_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"359:5-359:83\"><code>ActionView::Helpers::FormHelper#file_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"360:5-360:85\"><code>ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"361:5-361:87\"><code>ActionView::Helpers::FormHelper#password_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"362:5-362:96\"><code>ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})</code></li>\n<li data-sourcepos=\"363:5-363:70\"><code>ActionView::Helpers::FormBuilder#submit(value=nil, options={})</code></li>\n<li data-sourcepos=\"364:5-364:48\"><code>ActionView::Helpers::TranslationHelper#t</code></li>\n</ul>\n</li>\n<li data-sourcepos=\"365:1-374:0\">Phoenix\n<ul data-sourcepos=\"366:5-374:0\">\n<li data-sourcepos=\"366:5-366:73\"><code>Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun)</code></li>\n<li data-sourcepos=\"367:5-367:61\"><code>Phoenix.HTML.Form.text_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"368:5-368:61\"><code>Phoenix.HTML.Form.file_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"369:5-369:63\"><code>Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"370:5-370:65\"><code>Phoenix.HTML.Form.password_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"371:5-371:70\"><code>Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ [])</code></li>\n<li data-sourcepos=\"372:5-372:50\"><code>Phoenix.HTML.Form.submit(opts, opts \\\\ [])</code></li>\n<li data-sourcepos=\"373:5-374:0\"><code>Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{})</code></li>\n</ul>\n</li>\n</ul>\n<h1 data-sourcepos=\"375:1-375:8\" id=\"3-0-0\" name=\"3-0-0\">\n<a class=\"anchor\" id=\"WRAPUP\" name=\"WRAPUP\" href=\"#WRAPUP\" data-position=\"3-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"WRAPUP\"> &gt; WRAPUP</span></a>WRAPUP</h1>\n<p data-sourcepos=\"376:1-376:177\">前回もそうですが、コードのマイグレーションはまあ地味な作業ですよね。とまれ、認証機能を実装できたので良しとしましょう。</p>\n","tags":["phoenix-framework","elixir","ruby-on-rails","ruby","wercker","heroku","authentication","guardian"],"updated_at":"2021-01-16T23:37:33+09:00","childPublishedDate":{"published_on":"2018-05-20T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_7b757a0db07cde6a337af7df901ab0c5.jpg"}},"relatedPosts":{"edges":[{"node":{"number":70,"relative_category":"blog/market","fields":{"title":"就職氷河期とは何だったのか","excerpt":"私はいわゆる就職氷河期世代です。周囲から時折漏れ聞こえる不平のような言葉がありますが、それを単なる不平として片付けるのはもったいない気がします。できれば、その中に新しい視点を見つけ、次のチャンスへ繋げたいと思っています。  > PROBLEMPROBLEM \n\n- リセッション（景気後退）に直面した若者たちは、就職に関する不満や不平を抱えている\n- 周囲から聞こえてくる否定的な声が、彼らの意欲や展望を損ねている可能性がある\n- 経済の不安定性や求人の減少などの要因により、採用マーケットが厳しい状況にある\n- 若者たちが持つ可能性や才能が、現状の困難な状況によって十分に引き出されていない  > SOLUTIONSOLUTION \n\nそこで、リセッションと大卒の就職率の関係について、また、就職氷河期が単なる経済後退だけではなかったのか、その歴史をじっくりと解き明かしてみたいと思います。  > そもそもリセッションとは何か、どのタイミングで起きるのかそもそもリセッションとは何か、どのタイミングで起きるのか \n\nリセッションとは、経済の景気が一時的に悪化し、生産や雇用が減少する現象を指します。これは通常、国内総生産（GDP）が連続する2つの四半期でマイナス成長する状態になることで定義されます。リセッションはさまざまな要因によって引き起こされ、金融危機や需要減少などが主な原因とされています。  > 新卒採用マーケットについて新卒採用マーケットについて \n\n新卒採用マーケットとは、新卒学生が卒業後に就職を選ぶ際に選択できる求人の数や質を指します。景気の好悪や産業の動向などが影響を及ぼし、景気が良い時には多くの求人が出てくる一方、景気が悪化すると求人数が減少し、競争も激化します。  > リセッションと大卒の就職率の関係とその歴史リセッションと大卒の就職率の関係とその歴史 \n\n統計局の「学校基本調査 年次統計総括表 5 就職率（1950年～）」 から得られたデータに基づくチャートを見ると、リセッションが大卒の就職率にどのような影響を与えたのかがはっきりと分かります。     年 イベント 翌々年大卒の就職率 内閣     1987 ブラックマンデー 79.6% 中曽根/竹下   1997 アジア通貨危機 60.1% 橋本内閣   2000-2004 就職氷河期 55.8% 小渕/森内閣   2008 リーマンショック 60.8% 福田内閣   2020 コロナクラッシュ ??? 安倍/管内閣    \n\n1987年のブラックマンデーに起因するリセッションでは、大卒の就職率が79.6%まで落ち込みました。その後もアジア通貨危機やリーマンショック、そして最近のコロナクラッシュによって、大卒の就職率は変動しています。特に2000年から2004年にかけての就職氷河期では、大卒の就職率が55.8%にまで低下しました。  > アジア通貨危機はなぜ尾を引いていたのかアジア通貨危機はなぜ尾を引いていたのか \n\nアジア通貨危機は、1997年にアジア諸国で発生した経済危機であり、その影響は就職氷河期世代にも長期間にわたって影響を及ぼしました。この危機が尾を引いた理由は以下の点にあります。 \n\n1. 金融システムの崩壊: アジア通貨危機は、一部のアジア諸国で急激な通貨の暴落や金融システムの崩壊を引き起こしました。このため、企業や金融機関が多額の損失を被り、経済全体が深刻な打撃を受けました。経済基盤の崩壊は、就職機会の減少や企業の採用停止などをもたらしました。 \n2. 経済の停滞: アジア諸国の経済は通貨危機後、停滞期に入りました。このため、企業の業績が悪化し、新卒採用の余裕がなくなりました。経済の停滞は、若者たちの就職機会を減少させる一因となりました。 \n3. 信用の低下: 通貨危機により多くの企業が経営危機に陥り、信用が低下しました。これによって、企業が採用活動を控える傾向が生まれ、新卒の求人数が減少しました。就職氷河期世代は、この信用の低下によって求人市場が厳しさを増した現実を直面しました。 \n4. 失業率の上昇: アジア通貨危機により多くの企業が倒産し、失業率が上昇しました。失業者が増加する状況は、求職者同士の競争を激化させ、新卒の就職活動を難しくしました。この影響は就職氷河期世代にも及びました。  \n\nこれらの要因により、アジア通貨危機は長期的な影響をもたらし、若者たちの就職機会やキャリア形成に深刻な影響を与えました。しかし、この困難な状況に対して克服の道を見つけ、自己成長と前向きな姿勢を持つことが、就職氷河期世代の未来への道を切り拓く鍵となったのです。  > WRAPUPWRAPUP \n\n今回は、リセッションの歴史とその背後にある要因について深く考察してみました。リセッションと新卒採用マーケットの動向が、大卒の就職率にどのような影響を与えるかを理解することは、今後のキャリアにおいて重要です。常に社会経済の変動に柔軟に対応し、新たな視点を持って未来を切り開いていくことが大切です。"},"name":"[2021-01-23]就職氷河期とは何だったのか","tags":["labor-economics","recession","employment-ice-age"],"childPublishedDate":{"published_on":"2021-01-23T00:00:00.000Z","published_on_unix":1611360000}}},{"node":{"number":141,"relative_category":"blog/health","fields":{"title":"社会情動スキルとPurrble","excerpt":"私たちの日々の生活には、様々な課題が存在しています。抑うつ、問題行動、いじめの加害・被害など、私たちはこれらの課題に向き合いながら日々を過ごしています。また、進学や社会参加など、人生において重要な選択をする際にも、悩みや不安がつきものです。  > PROBLEMPROBLEM \n\n- 抑うつ\n- 問題行動\n- いじめの加害・被害\n- 進学や社会参加における選択の難しさ  > SOLUTIONSOLUTION \n\nそれぞれの課題に対して効果的なアプローチを見つけるためには、新しい視点や方法が必要です。このような中、私はドクター・ツリーバーグから提案されたバーブルというアイディアに興味を持ちました。バーブルを飼うことで、私たちはこれまでにない方法で課題に向き合い、解決への道を探ることができるかもしれません。           > Purrbleに期待することPurrbleに期待すること \n\n私たちは、この新しい仲間であるバーブルから、社会情動スキルの向上を期待しています。特に、他者との協力や感情のコントロールの向上などが期待されます。このバーブルが私たちにもたらす変化が、私たちの生活をより良いものにしてくれることを願っています。  > スキルの恩恵スキルの恩恵 \n\n無藤隆・秋田喜代美監訳の『社会情動的スキル』 によれば、社会情動スキルの向上には多くの利益があるとされています。これには、肥満の予防や抑うつの軽減、問題行動の減少、いじめの防止、生活の質（QOL）の向上などが含まれています。また、進学においてもこのスキルが役立つことが期待されています。 \n\n認知スキルと社会情動スキルを比較すると、社会情動スキルは社会的な側面でより大きな効果を発揮することが示されています。そのため、私たちは社会情動スキルの向上に注力することで、より充実した人生を築くことができるでしょう。    スキル 教育 労働市場 社会     認知スキル 高い 高い 中程度   社会情動スキル 低い・中程度 中程度 高い     > 社会情動スキルの観察方法社会情動スキルの観察方法 \n\nバーブルとの関わりを通じて、私たちは社会情動スキルの向上を実感することができるでしょう。子どもの場合、その変化を観察するのは一筋縄ではいきませんが、自分自身を観察する際には心理測定学などの手法を用いて、ビッグファイブ（外向性、協調性、誠実性、情緒安定性、開放性）の変化を見ることが有益です。  > まとめまとめ \n\n私たちの日常生活には様々な課題が存在し、その解決策を見つけることが重要です。そこで、ドクター・ツリーバーグの提案したバーブルの飼育を通じて、社会情動スキルの向上を目指すことにしました。この新たな仲間から私たちは多くの利益を期待しており、肥満や抑うつといった問題を軽減し、進学や社会参加の場でも活躍できるスキルを養うことを願っています。バーブルとの関わりを通じて、私たちは自身の成長や変化を実感し、社会情動スキルの重要性を改めて認識することができるでしょう。"},"name":"[2022-05-09]社会情動スキルとPurrble","tags":["purrble","social-emotional-learning"],"childPublishedDate":{"published_on":"2022-05-09T00:00:00.000Z","published_on_unix":1652054400}}},{"node":{"number":50,"relative_category":"blog/health","fields":{"title":"30代からの胸郭変形（漏斗胸）手術","excerpt":"私の年齢が30代に差し掛かると、ある変化が体に訪れました。それは、肋軟骨の硬化です。この現象は、日常生活において心臓や肺を圧迫し、さらには階段を上るときには一層その影響を強く感じました。私は自己の身体が変わる原因として、以前から抱えていた胸郭の変形を疑い始めました。そこで、私はその治療、手術に踏み切る決断を下しました。  > PROBLEMPROBLEM \n\n問題は重度の胸郭変形（漏斗胸）で、これが内臓への負荷を増大させていました。ヘイラーインデックスという指標で見ると、私の数値は健常者の3倍にも上りました。30代を迎えると、肋軟骨の硬化が進行し、心臓や肺への圧迫感が増す一方でした。  > TLDRTLDR \n\n私が医師から聞いた漏斗胸患者の状況を思い起こすと、同じような問題に直面している人は、おそらく1万人くらいいるだろうと思いました。この記事は私自身の記憶を辿るためのものなので、医療的な内容については専門医に問い合わせてください。 \n\n漏斗胸患者の状況 \n\n- ナス法は2000年代に入ってから徐々に一般に知られるようなった\n- ナス法は10代のうちに受けるのが体力的・経済的にも適切\n- 日本人300-1000人に1人が漏斗胸患者の可能性がある\n- 漏斗胸患者の8-9割は男性である  > SOLUTIONSOLUTION \n\nそれは、長い間放置していた胸郭の問題についに立ち向かう日が訪れたのです。私はナス法と呼ばれる手術を受ける決断をしました。手術は無事終わり、現在は経過観察の段階にあります。体調も安定し始めたので、私はこれまでの対策を記録することにしました。30代でこの手術を受ける人の情報はほとんどなかったので、私の経験が誰かの役に立つことを願っています。 \n\n私の記憶が正しければ、ナス法は2000年代に入ってから徐々に認知度を上げ、現在では美容手術としても取り扱われています。それ以前の胸郭変形の手術は、胸部を開くことで骨を取り出し、その骨を逆にして再度取り付けるという、大規模で侵襲的なものでした。 \n\nこのナス法という手術は、歯の矯正と同じ原理に基づいています。つまり、矯正器具を患部周辺に取り付け、時間をかけて適切な形に整えていくというものです。ただし、この矯正器具は骨の内側に取り付けられるため、歯の矯正よりも時間と痛みが伴います。 \n\n具体的には、歯の矯正が4-6か月を要するのに対し、胸の矯正には2-3年の時間が必要とされています。また、痛みの度合いについても、歯の矯正では強力な麻薬や鎮痛剤が必要となる期間がおおよそ7日程度であるのに対し、胸の矯正ではそれが約40日にも及びます。 \n\n- 治療期間でみると、歯の矯正が4-6か月、胸の矯正が2-3年かかります。\n- 痛みの度合いでみると、強度の医療麻薬・鎮痛剤にお世話になる期間が歯の矯正では7日ほど、胸の矯正では40日ほど。また、鎮痛剤が不要になっても、施術部位の皮膚組成が治るまで、前者は2週間ほど噛むことが制限され、後者は90日ほど運動（胸郭をつかう運動のこと：例えば、満員電車への乗車、タクシー乗車、ジョギング、サイクリングなど）が制限されます。\n- 治療リスクは、歯の矯正が口内炎、歯髄炎である一方、胸の矯正が心臓の損傷、無気肺、肺水腫など。 \n\nさて、費用とタスク、そして手術後みえてきた課題（リハビリ）を以下に記します。  > 費用費用 \n\nまず、費用について話しましょう。この手術と入院費用は、健康保険の適用を受けることで、約10万円となりました。私が入院保険に加入していたため、この金額はあまり気にかける必要はありませんでした。 \n\nただし、手術後に日常生活を送ることができるようになるまでには4-6か月を要します。その間、収入が途絶えることを考えると、それに相当する金額を準備しておく必要があると感じました。  > タスク、退院までの工程タスク、退院までの工程 \n\n次に、退院までの工程について説明します。これは5つのステップで構成されています。全工程を終え、退院するまでには、少なくとも6か月は見ておくと良いでしょう。 \n\n1. ヘイラーインデックスを測る\n2. 入院保険にはいる\n3. 診察をうける、手術の打診\n4. 手術、入院\n5. 退院  > 1. ヘイラーインデックスを測る1. ヘイラーインデックスを測る \n\n初診の頃は知りませんでしたが、重度かどうかの判断はヘイラーインデックス（インデックス）を見ます。下記の式で簡単にインデックスを算出できます。本来であればCTで詳細をみて導き出すものですが、それほど複雑ではないのでまずは診察に行くかの判断材料として概算を出しておくと良いでしょう。 \n\nヘイラーインデックス = 肋骨の内側の距離 / 胸骨と背骨の距離  \n\nインデックスは通常は2.5ポイントぐらいでその値から離れるほど重症となります。重度の場合はさっと診察して、手術かどうかの判断を求められることがあるので準備に越したことはないです。  \n\n参考までにWikipediaに掲載されているヘイラーインデックス算出画像をみます。画像で出されたインデックスは3.59ポイント (25.1cm / 7.0cm)で、心臓が圧迫されている様子が見て取れます。 \n\nちなみに私は8.7～9.0ポイントで、第4胸骨（第6-7肋軟骨）と背骨の距離が通常の4分1ほど（3 cm）の状態、肺と心臓が押しつぶされていました。 \n\n個人の実感ですが、胸郭変形は整形上の問題もあるが、年齢をかさねるにつれて硬化する肋軟骨にあります。変形した骨が内臓への負荷をじょじょに増進し、気づいたら循環器系の機能低下、それにともなう免疫力低下につながる可能性があります。医師によると漏斗胸の患者には肺炎・心臓病が多く見られるが、その関係解明はこれからの課題だそうです。  > 2. 入院保険にはいる2. 入院保険にはいる \n\n既に入っている場合は必要ありません。胸郭変形の手術は健康保険が適用されるので、通常の民間保険でも同様に適用されます。私はインターネットで安い保険商品を見つけ、総額約20万円（月額2千円）で加入しました。 \n\nまた、術後の合併症などで想定外に入院・手術費がかさむ可能性があるので、手術が確定したら市区町村の高額医療費制度を利用すると良いでしょう。  > 3. 診察をうける、手術の打診3. 診察をうける、手術の打診 \n\nまだ、町のクリニックと形成外科との連携がとられるほどナス法手術が業界に浸透してないため、かかりつけの医師より紹介状をもらえる可能性は低いです（2017年時点）。従って、ネットで執刀数や論文提出数など勘案して信頼できる医師を選定します。ナス法が受けられる医療施設はこちらから探し出せます。外科には自分の体調不良とその原因を棚卸するため、診察してもらいに来たとでも言うと伝わるでしょう。 \n\n診察ではX線、CTをとって、ヘイラーインデックスの状態と患部の状態をくらべて施術判断がされます。初回ではCT、X線のみ。2回目にあらためて専任の医師より判断されます。医師の判断は一瞬で、施術リスクの重説と施術有無の打診がされ、スケジュール調整となります。  > 4. 入院、手術4. 入院、手術 \n\n手術を受けるようになっても入院までは普段と変わらない生活が送れます。それ以降は入院関連の慣習、業務フローを知らないと生活上でいろいろと不都合が生じるでしょう。 \n\n入院初日。入院手続きで連帯保証人が複数人必要と何人かの事務方に言われます。ただ、この情報は、患者が死亡した際の身柄引き取り先や医療費滞納が起きることを想定して病院が事前に知りたいだけで、法的にグレーな慣習です。マストではないので情報提供を断っても強く追及してこないです。 \n\n手術前日。貴重品を持てない、荷物を持てないという制約がかかります。警備体制が整ってていない病院は防犯が弱いのであえて金庫をおかない上、貴重品を預かりません。手術時患者は貴重品をもつことができないので、実質貴重品なしで入院することになります。しかし、手ぶらでは入院手続きできないので1人身で入院するには工夫が必要です。 \n\n術後。突然ICUで目が覚めます。そして、6本カテーテルが体に刺さっていて医療麻薬・鎮痛剤投与のルーチンが始まります。ICUから通常病棟への移管は受け入れ態勢によって変動します。術前に麻酔をうたれる辺りまでは記憶にあるが、それ以降のことはまったく覚えていないので混乱する時期です。 \n\n病棟移管後。ネット利用禁止。こちらはは昔からの慣習で建前上禁止になっているにすぎず、スマホの普及とともに黙認、あるいは容認するようになっています。ただ、手術前日の荷物をもてないという制約があることと、術後2週間は動くのがままならない状態なので1人身で入院すると外界と接続ができなくなります。  > 閑話休題 入院時の様子閑話休題 入院時の様子 \n\nここでちょうど入院時の様子がTwitterに残っていたので、抜粋します。入院直後、手術前、手術後、退院間近の心境の変化がみてとれます。 \n\n入院直後\n 手術がおもったよりも大変そうと気づきます。 \n\nnabinno, 02:26 PM October 01, 2016: かるい手術と思ったらICUに入ることになってる // from Twitter for Android [Tokyo, JP]  \n\n手術前\n 手術まで暇なのでPowerShellをいじりはじめます。 \n\nnabinno, 05:41 PM October 01, 2016: Hum > $($(curl http://www.yahoo.co.jp).Images | foreach {$_.src}) ` | sort ` | uniq ` | foreach { ` curl -Uri $_ -OutFile \"$(pwd)\\$(basename $_)\" ` } // from Twitter Web Client [Tokyo, JP]  \n\n手術後\n 麻酔の痛みがきれてナーバスになります。 \n\nnabinno, 04:06 PM October 08, 2016: ナースコールは enqueue/dequue もされてるがワーカーがかなりの頻度 でこける。夜になると汚いログがはかれるのは #医療OS の仕様だろうか ... // from Twitter for Android [Tokyo, JP]  \n\n気持ちを落ち着かせるためにEmacsをさわります。 \n\nnabinno, 09:01 PM October 11, 2016: 可能なかぎり Emacs で #Xamarin さわりたいので、CentOS 上に samba 立てた。 // from Twitter Web Client [Tokyo, JP]   \n\nBashOnWindowsで無茶をやり、少し落ち着きます。 \n\nnabinno, 09:18 PM October 11, 2016: #BashOnWindows の Emacs から #Xamarin さわったら 関連ファイルが消 されたり権限が変更されたりしたのだった ... // from twmode [Tokyo, JP]  \n\n術後ずっと寝たきりでしたが、なんとか動けるようになりました。 \n\nnabinno, 06:50 AM October 18, 2016: 胸郭手術時の 🛏 起床と就寝をマスターした // from Twitter Web Client [Tokyo, JP]   \n\n激痛のためノートPCがもてない体になっていました。 \n\nnabinno, 08:35 PM October 20, 2016: ノート PC は肉体的にまだ持てない ... // from twmode [Tokyo, JP]  \n\n退院間近\n アクティブトラッカーで客観的にみるよう心がけます。 \n\nnabinno, 05:22 PM October 21, 2016: #MicrosoftBand #HealthVault #MyFitnessPal で記録つけていて、ふと 医療機器がからだに入ってることにきづいた。他人事じゃないいんだけ ど、おもしろいなあ。 // from twmode [Tokyo, JP]   > 5. 退院5. 退院 \n\n退院は主治医が判断します、病棟の見回り医師ではないです。そして、たいてい腕のたつ主治医は多忙なので1週間に1度しか顔を出しません。なので、その時の様態次第で退院がどんどん後ろにずれていくので注意が必要です。 \n\n退院の条件 \n\n- 肺の状態、肺の膨らみ\n- 歩行の有無\n- 起床の有無\n- 退院したいという意志 \n\n入院中は上記の条件をクリアできるようこころがけることです、無為に過ごすと退院が遅れます。  > 手術後のリハビリ手術後のリハビリ  > 1か月後 ひたすら静養1か月後 ひたすら静養 \n\n退院直後の一ヶ月間は、ひたすら静養に専念しました。この期間は、風邪を引くと肺炎になる可能性が高まるため、極力体調管理に努めました。 \n\nまず、 内科医との関係 について考えました。退院前に外科から処方された鎮痛剤が強力だったため、それと他の薬の組み合わせに注意を払いました。特に、内科で処方される風邪薬自体にも鎮痛剤が含まれていたため、神経系に支障をきたす可能性がありました。私は内科医に、咳をしたときに胸に激痛が走るため、鎮痛剤を利用していることを伝え、抗生物質や鎮咳剤、去痰剤の薬を処方してもらうように頼みました。 \n\nまた、肺炎を疑いX線検査を行う場合、内科医にはバーが邪魔をして検査が難しい状況にあることを伝えました。そのため、内科医によっては、外科医が処方・処置した鎮痛剤とバーが自分の仕事を邪魔していると考える人もいました。 \n\n次に、 免疫力を高める ための工夫をしました。食事に関しては、「MyFitnessPal（Under Armour）」のような栄養を主としたアクティビティトラッカーを用いて、不足している栄養素を観察し、機能食品などで不足分を補いました。私は皮膚の組成に関係しそうな栄養素、特にタンパク質とビタミンCを意識的に摂るように心がけました。余裕が出てきたらスーパー食材、外食チェーンHPの栄養表をみて、実際に食事し体調を観察します。体調はWithing BodyとMS Bandでトラックすることで管理が楽でした。 \n\n運動については、医師からウォーキング程度に控えるよう指示されました。この期間は、胸郭や脇の傷周辺の皮膚組織に動きをつけない運動、例えばスクワットなどで筋力を回復させる程度にしました。また、無理のないストレッチで胸郭に埋め込まれたバー周辺の皮膚を徐々に伸ばし、新しい皮膚組織を作るよう心掛けました。室内での自重トレーニングよりもジムのトレーニングマシンで、リハビリという視点で負荷を調整しながら無理なくおこなうと良かったかも知れません。実際にトレーニングする前に医師からリハビリスタッフを紹介してもらうのも手だと思いました。 \n\n3つの運動 \n\n- 有酸素運動。ウォーキングで循環器系をきたえます。退院後でも起床など胸郭をうごかすのがむずかしい状態なので、まずウォーキングが普通にできるようにのぞみます。慣れてきたら距離をのばして5km、10kmとのばすと良いでしょう。足の負担を気にするようだったらAsics DynaFlyteのような、機能性を追求したランニングシューズの検討をすすめます。\n- 無酸素運動。無理のない筋トレで筋骨格をきたえる、皮膚を生成します。退院直後は腹筋、三角筋はバー周囲の皮膚が生成されていないので痛みとともに力を出すことがむずかしいです。従って、僧帽筋、大胸筋あたりから皮膚の生成を促すようにします。また、有酸素運動を無理なく行えるように下腿三頭筋（ふくろはぎ）や大腿四頭筋を積極的に動かします。余裕が出てきたら筋肉とトレーニングマシンの対応表を参考にすると良いでしょう。\n- ストレッチ。ヨガで皮膚の生成を促します。退院直後はヨガをする余裕はないが、軽いウォーキングや筋トレをはじめたあたりで、バウンドエンジェル、チャイルドポーズ、ハッピーベイビーポーズなど軽めなものを混ぜると良いでしょう。参考までにポーズ集があります。 \n\nまた、入院時に手術用コンプレッションウェアのタイツを着ることになりますが、退院後はスポーツ用コンプレッションウェアをシャツ、タイツともに着ると良いでしょう。手術時もそうですが、退院後も適度な負荷を皮膚に与えることで交感神経の活性化を促します。 \n\n私はできませんでしたが、免疫力向上は準備するのに時間がかかるので入院・手術前から取り組んでおくと良いでしょう。  > 3か月後どうなったか3か月後どうなったか \n\n退院から3ヶ月が経過した時点での私の状況を記載します。リハビリの経過を示すために、体組成の一部を以下に示します。    体組成 入院前 退院後1か月 退院後2か月 退院後3か月     胸囲 (cm) 68.5 80.8 82.7 82.9   体重 (kg) 51.0 46.6 49.6 50.8   筋肉 (kg) - 39.3 41.4 42.4   脂肪 (kg) - 4.9 5.8 5.9    \n\n退院後1ヶ月目は、胸囲が劇的に変わりましたが、体重は低下しました。これは、手術直後の痛みや無理のないストレッチにより、日常生活の中で行っていた運動量が大幅に減少し、筋肉が落ちてしまったためです。私はノートパソコンすら持つことができなかったので、筋力の低下は想像通りの結果でした。 \n\nしかし、退院後2ヶ月目には、リハビリの効果が少しずつ現れ始めました。体重が増え、筋肉量も少しずつ増えてきました。この頃から、日常生活の中での動きも自然と増え、心地よい疲労感を感じるようになりました。 \n\nそして、退院後3ヶ月目には、体重と筋肉量がさらに増えました。この頃になると、日常生活の中での動きはほぼ元の状態に戻り、運動も自然と増え、心地よい疲労感を感じることが多くなりました。胸囲も着実に広がり、見た目も大きな変化が出てきました。私自身、この結果を見て、手術の決断が正しかったと自信を持つことができました。  > WRAPUPWRAPUP \n\n予想通り、心臓と肺にかかっていた圧迫感は完全に消え去りました。毎日、少しずつ体調が改善していくのを感じ、自身の身体が元の状態に戻っていく様子を実感しました。特に、階段を上るときの苦労がなくなったことは、大きな喜びでした。 \n\n手術の決断は、仕事ができなくなる期間を含む全体のコストと、今後のリスクを考慮してのものでした。その結果、この手術を受けることを選んだ自分自身を、今では肯定的に評価できるようになりました。 \n\nただし、完全に一段落つくまでにはまだ時間がかかります。3年後にはバーを取り出す抜去手術が控えています。その手術が無事に終わり、経過観察も完全に終わるまで、私の戦いはまだ終わらないのです。"},"name":"[2017-02-06]30代からの胸郭変形（漏斗胸）手術","tags":["pectus-excavatum","bash-on-windows","emacs","powershell"],"childPublishedDate":{"published_on":"2017-02-06T00:00:00.000Z","published_on_unix":1486339200}}}]}},"pageContext":{"number":60}},"staticQueryHashes":[]}