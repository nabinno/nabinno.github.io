{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/60","result":{"data":{"esaPost":{"number":60,"relative_category":"blog/backend","fields":{"title":"連載 Rails2Phoenix 2 認証機能を実装する","excerpt":"> PROBLEMPROBLEM \n\n- サービスについて 拡張にともない技術スタックがふえるのを抑えたい スケーラビリティのためのコストを抑えたい パフォーマンスをあげたい \n- 拡張にともない技術スタックがふえるのを抑えたい\n- スケーラビリティのためのコストを抑えたい\n- パフォーマンスをあげたい   > SOLUTIONSOLUTION \n\nというわけで、現在つかっているRailsをPhoenixに変更することにした。 \n\n- 方針 Railsから徐々にPhoenixに移行できるように いままでとおなじPaaS（Heroku） いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく いままでとおなじDB 移行完了までDBマイグレーションをしない Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで \n- Railsから徐々にPhoenixに移行できるように いままでとおなじPaaS（Heroku） いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく いままでとおなじDB 移行完了までDBマイグレーションをしない \n- いままでとおなじPaaS（Heroku）\n- いままでとおなじレポジトリ ブランチ戦略は phoenix/base をベースに 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく \n- ブランチ戦略は phoenix/base をベースに\n- 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\n- いままでとおなじDB 移行完了までDBマイグレーションをしない \n- 移行完了までDBマイグレーションをしない\n- Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで \n\n今回はRails/Deviseの認証機能をPhoenixで実装するながれをとりあげる。   > Guardianを実装するGuardianを実装する \n\n参考にしたのはBlackodeのguardian_auth  ただ、Guardianのバージョンがふるいので1.0へのマイグレーション記事をもとにアレンジしてある。 \n\n認証に関係しそうな構成は下記のとおり。 \n\nロジック \n\n- MyApp.Account\n- MyApp.Account.Registration\n- MyApp.Account.User\n- MyApp.Auth.Guardian\n- MyApp.Auth.ErrorHandler\n- MyApp.Auth.Pipeline\n- MyApp.Auth.AfterPipeline\n- MyApp.Auth.Session \n\nコントローラ \n\n- MyAppWeb.RegistrationController\n- MyAppWeb.SessionController   > シリアライザとエラーハンドラの設定シリアライザとエラーハンドラの設定 \n\nGuardian1.0から直接ではなくモジュールを介して参照するようになった。下記のように各モジュールを用意してコンフィグに割り当てる。   elixir \n\n# apps/my_app/lib/my_app/auth/guardian.ex defmodule MyApp.Auth.Guardian do use Guardian, otp_app: :my_app alias MyApp.Account def subject_for_token(resource, _claims), do: {:ok, to_string(resource.id)} def subject_for_token(_, _), do: {:error, :reason_for_error} def resource_from_claims(claims), do: {:ok, Account.get_user!(claims[\"sub\"])} def resource_from_claims(_claims), do: {:error, :reason_for_error} end     elixir \n\n# apps/my_app/lib/my_app/auth/error_handler.ex defmodule MyApp.Auth.ErrorHandler do import Plug.Conn def auth_error(conn, {type, _reason}, _opts) do body = Poison.encode!(%{message: to_string(type)}) send_resp(conn, 401, body) end end     elixir \n\n# apps/my_app/config/config.exs config :my_app, MyApp.Auth.Guardian, issuer: \"MyApp\", ttl: {30, :days}, allowed_drift: 2000, # optionals allowed_algos: [\"HS512\"], verify_module: MyApp.Auth.Guardian.JWT, verify_issuer: true, secret_key: System.get_env(\"GUARDIAN_SECRET\") || \"secret_key\"     > ルーターの設定ルーターの設定 \n\n認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てる。 \n\nルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用している。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになる。具体的にいうと、ルート / などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになる。   elixir \n\n# apps/my_app/lib/my_app/auth/pipeline.ex defmodule MyApp.Auth.Pipeline do use Guardian.Plug.Pipeline, otp_app: :my_app plug(Guardian.Plug.VerifySession, claims: %{\"typ\" => \"access\"}) plug(Guardian.Plug.VerifyHeader, claims: %{\"typ\" => \"access\"}) plug(Guardian.Plug.LoadResource, allow_blank: true) end     elixir \n\n# apps/my_app/lib/my_app/auth/after_pipeline.ex defmodule MyApp.Auth.AfterPipeline do use Guardian.Plug.Pipeline, otp_app: :my_app plug(Guardian.Plug.EnsureAuthenticated) end     elixir \n\n# apps/my_app/lib/my_app_web/router.ex defmodule MyAppWeb.Router do use MyAppWeb, :router pipeline :browser do plug(:accepts, [\"html\"]) plug(:fetch_session) plug(:fetch_flash) plug(:protect_from_forgery) plug(:put_secure_browser_headers) end pipeline :browser_auth do plug(MyApp.Auth.Pipeline) end pipeline :browser_auth_after do plug(MyApp.Auth.AfterPipeline) end scope \"/\", MyAppWeb do pipe_through([:browser, :browser_auth]) post(\"/registration\", RegistrationController, :create) get(\"/login\", SessionController, :new) post(\"/login\", SessionController, :create) get(\"/logout\", SessionController, :delete) end scope \"/\", MyAppWeb do pipe_through([:browser, :browser_auth, :browser_auth_after]) get(\"/edit\", RegistrationController, :edit) put(\"/edit\", RegistrationController, :update) get(\"/users\", UserController, :index) resources \"/\", UserController, only: [:show, :delete], param: \"username\" end end     elixir \n\n# apps/my_app/config/config.exs config :MyApp, MyApp.Auth.Pipeline, module: MyApp.Auth.Guardian, error_handler: MyApp.Auth.ErrorHandler config :MyApp, MyApp.Auth.AferPipeline, module: MyApp.Auth.Guardian, error_handler: MyApp.Auth.ErrorHandler     > 登録登録 \n\n登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意する。 \n\nこのあたりはDevise/Railsとあまり変わらない。ほかのアクション「新規パスワード発行」「メールアドレス確認」なども同様の構成をとろうと思っている。   elixir \n\n# apps/my_app/lib/my_app_web/controller/registration_controller.ex def create(conn, user_params) do changeset = User.registration_changeset(%User{}, user_params) case Registration.create(changeset, Repo) do {:ok, user} -> conn |> MyApp.Auth.login(user) |> put_flash(:info, \"Your account was created successfully\") |> redirect(to: page_path(conn, :home)) {:error, changeset} -> conn |> put_flash(:error, \"Unable to create account: Try again\") |> render(MyAppWeb.PageView, \"home.html\", changeset: changeset) end end     elixir \n\n# apps/my_app/lib/my_app/auth/auth.ex def login(conn, %User{} = user) do conn |> Guardian.Plug.sign_in(user) |> assign(:current_user, user) end     elixir \n\n# apps/my_app/lib/my_app/account/registration.ex def create(changeset, repo) do changeset |> repo.insert() end     > ログイン・ログアウトログイン・ログアウト \n\nログイン・ログアウトはセッション用のサービスとコントローラで実装する。   elixir \n\n# apps/my_app/lib/my_app_web/controller/session_controller.ex @doc \"Logged in [POST /login]\" def create(conn, %{\"email\" => email, \"password\" => password}) do case Session.authenticate_user(email, password) do {:ok, user} -> conn |> Session.login(user) |> put_flash(:info, \"Logged in successfully\") |> redirect(to: page_path(conn, :home)) {:error, _reason} -> conn |> put_flash(:error, \"Wrong username/password\") |> render(\"new.html\") end end @doc \"Logged out [DELETE /logout]\" def delete(conn, _params) do conn |> Session.logout() |> put_flash(:info, \"Logged out successfully.\") |> redirect(to: \"/\") end     elixir \n\n# apps/my_app/lib/my_app/auth/session.ex defmodule MyApp.Auth.Session do import Ecto.Query import Plug.Conn import Comeonin.Bcrypt, only: [checkpw: 2, dummy_checkpw: 0] alias MyApp.Repo alias MyApp.Auth.Guardian alias MyApp.Account.User def login(conn, %User{} = user) do conn |> Guardian.Plug.sign_in(user) |> assign(:current_user, user) end def logout(conn), do: Guardian.Plug.sign_out(conn) def authenticate_user(email, given_password) do query = Ecto.Query.from(u in User, where: u.email == ^email) Repo.one(query) |> check_password(given_password) end def current_user(conn), do: Guardian.Plug.current_resource(conn, []) def logged_in?(conn), do: Guardian.Plug.authenticated?(conn, []) defp check_password(nil, _), do: {:error, \"Incorrect username or password\"} defp check_password(user, given_password) do case Comeonin.Bcrypt.checkpw(given_password, user.encrypted_password) do true -> {:ok, user} false -> {:error, \"Incorrect email or password\"} end end end   \n\nDevise/Railsのビューヘルパーはビューマクロで適用する。   elixir \n\n# apps/my_app/lib/my_app_web.ex def view do quote do # .. import Okuribi.Auth.Session, only: [current_user: 1, logged_in?: 1] end end   \n\nあるいは、put_assigns関数をはやしてコントローラマクロに適用する。   elixir \n\n# apps/my_app/lib/my_app/auth/session.ex def put_assigns(%{private: %{phoenix_action: action}} = conn, settings) do current_resource = Guardian.Plug.current_resource(conn) settings = if current_resource, do: settings[:sign_in][action] || [], else: settings[:sign_out][action] || [] conn |> assign(:current_user, current_resource) |> assign(:page_title, settings[:page_title]) |> assign(:page_description, settings[:page_description]) end     elixir \n\n# apps/my_app/lib/my_app_web.ex def controller do quote do # .. import Okuribi.Auth, only: [put_assigns: 2] end end   \n\nassignsひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsのActionView::Helpers::CaptureHelper#provideの代わりに使える。   elixir \n\n# apps/my_app/lib/my_app_web/controller/*_controller.ex @page %{ sign_in: %{ new: %{ page_title: dgettext(\"views\", \"pages.home.signed_in.page_title\"), page_description: \"\" } }, sign_out: %{ new: %{ page_title: dgettext(\"views\", \"pages.home.signed_out.page_title\"), page_description: \"\" } } } plug(:put_assigns, @page when action in [:home])     > その他その他 \n\nRailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道におこなっていく。 \n\n- Rails ActionView::Helpers::FormHelper#form_for(record, options={}, &block) ActionView::Helpers::FormHelper#text_field(object_name, method, options={}) ActionView::Helpers::FormHelper#file_field(object_name, method, options={}) ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={}) ActionView::Helpers::FormHelper#password_field(object_name, method, options={}) ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={}) ActionView::Helpers::FormBuilder#submit(value=nil, options={}) ActionView::Helpers::TranslationHelper#t \n- ActionView::Helpers::FormHelper#form_for(record, options={}, &block)\n- ActionView::Helpers::FormHelper#text_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#file_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#password_field(object_name, method, options={})\n- ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})\n- ActionView::Helpers::FormBuilder#submit(value=nil, options={})\n- ActionView::Helpers::TranslationHelper#t\n- Phoenix Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun) Phoenix.HTML.Form.text_input(form, field, opts \\\\ []) Phoenix.HTML.Form.file_input(form, field, opts \\\\ []) Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ []) Phoenix.HTML.Form.password_input(form, field, opts \\\\ []) Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ []) Phoenix.HTML.Form.submit(opts, opts \\\\ []) Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{}) \n- Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun)\n- Phoenix.HTML.Form.text_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.file_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.password_input(form, field, opts \\\\ [])\n- Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ [])\n- Phoenix.HTML.Form.submit(opts, opts \\\\ [])\n- Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{})","thumbnail":"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png"},"wip":false,"body_md":"<img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\">\r\n\r\n# PROBLEM\r\n- サービスについて\r\n    - 拡張にともない技術スタックがふえるのを抑えたい\r\n    - スケーラビリティのためのコストを抑えたい\r\n    - パフォーマンスをあげたい\r\n\r\n# SOLUTION\r\nというわけで、現在つかっているRailsをPhoenixに変更することにした。\r\n\r\n- 方針\r\n    - Railsから徐々にPhoenixに移行できるように\r\n      - いままでとおなじPaaS（Heroku）\r\n      - いままでとおなじレポジトリ\r\n          - ブランチ戦略は `phoenix/base` をベースに\r\n          - 気軽に参照できるようにRails関連ファイルは可能な限りのこしておく\r\n      - いままでとおなじDB\r\n          - 移行完了までDBマイグレーションをしない\r\n    - Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで\r\n\r\n今回はRails/Deviseの認証機能をPhoenixで実装するながれをとりあげる。\r\n\r\n## Guardianを実装する\r\n参考にしたのはBlackodeの[guardian_auth](https://github.com/blackode/guardian_auth) :pray: ただ、Guardianのバージョンがふるいので[1.0へのマイグレーション記事](https://github.com/ueberauth/guardian/blob/master/upgrade_guides/0.14.to.1.0.md)をもとにアレンジしてある。\r\n\r\n認証に関係しそうな構成は下記のとおり。\r\n\r\nロジック\r\n- MyApp.Account\r\n- MyApp.Account.Registration\r\n- MyApp.Account.User\r\n- MyApp.Auth.Guardian\r\n- MyApp.Auth.ErrorHandler\r\n- MyApp.Auth.Pipeline\r\n- MyApp.Auth.AfterPipeline\r\n- MyApp.Auth.Session\r\n\r\nコントローラ\r\n- MyAppWeb.RegistrationController\r\n- MyAppWeb.SessionController\r\n\r\n### シリアライザとエラーハンドラの設定\r\nGuardian1.0から直接ではなくモジュールを介して参照するようになった。下記のように各モジュールを用意してコンフィグに割り当てる。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/guardian.ex\r\n\r\ndefmodule MyApp.Auth.Guardian do\r\n  use Guardian, otp_app: :my_app\r\n  alias MyApp.Account\r\n\r\n  def subject_for_token(resource, _claims), do: {:ok, to_string(resource.id)}\r\n  def subject_for_token(_, _), do: {:error, :reason_for_error}\r\n\r\n  def resource_from_claims(claims), do: {:ok, Account.get_user!(claims[\"sub\"])}\r\n  def resource_from_claims(_claims), do: {:error, :reason_for_error}\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/error_handler.ex\r\n\r\ndefmodule MyApp.Auth.ErrorHandler do\r\n  import Plug.Conn\r\n\r\n  def auth_error(conn, {type, _reason}, _opts) do\r\n    body = Poison.encode!(%{message: to_string(type)})\r\n    send_resp(conn, 401, body)\r\n  end\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/config/config.exs\r\n\r\nconfig :my_app, MyApp.Auth.Guardian,\r\n  issuer: \"MyApp\",\r\n  ttl: {30, :days},\r\n  allowed_drift: 2000,\r\n  # optionals\r\n  allowed_algos: [\"HS512\"],\r\n  verify_module: MyApp.Auth.Guardian.JWT,\r\n  verify_issuer: true,\r\n  secret_key:\r\n    System.get_env(\"GUARDIAN_SECRET\") ||\r\n      \"secret_key\"\r\n```\r\n\r\n### ルーターの設定\r\n認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てる。\r\n\r\nルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用している。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになる。具体的にいうと、ルート `/` などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになる。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/pipeline.ex\r\n\r\ndefmodule MyApp.Auth.Pipeline do\r\n  use Guardian.Plug.Pipeline, otp_app: :my_app\r\n\r\n  plug(Guardian.Plug.VerifySession, claims: %{\"typ\" => \"access\"})\r\n  plug(Guardian.Plug.VerifyHeader, claims: %{\"typ\" => \"access\"})\r\n  plug(Guardian.Plug.LoadResource, allow_blank: true)\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/after_pipeline.ex\r\n\r\ndefmodule MyApp.Auth.AfterPipeline do\r\n  use Guardian.Plug.Pipeline, otp_app: :my_app\r\n\r\n  plug(Guardian.Plug.EnsureAuthenticated)\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/router.ex\r\n\r\ndefmodule MyAppWeb.Router do\r\n  use MyAppWeb, :router\r\n\r\n  pipeline :browser do\r\n    plug(:accepts, [\"html\"])\r\n    plug(:fetch_session)\r\n    plug(:fetch_flash)\r\n    plug(:protect_from_forgery)\r\n    plug(:put_secure_browser_headers)\r\n  end\r\n\r\n  pipeline :browser_auth do\r\n    plug(MyApp.Auth.Pipeline)\r\n  end\r\n\r\n  pipeline :browser_auth_after do\r\n    plug(MyApp.Auth.AfterPipeline)\r\n  end\r\n\r\n  scope \"/\", MyAppWeb do\r\n    pipe_through([:browser, :browser_auth])\r\n\r\n    post(\"/registration\", RegistrationController, :create)\r\n    get(\"/login\", SessionController, :new)\r\n    post(\"/login\", SessionController, :create)\r\n    get(\"/logout\", SessionController, :delete)\r\n  end\r\n\r\n  scope \"/\", MyAppWeb do\r\n    pipe_through([:browser, :browser_auth, :browser_auth_after])\r\n\r\n    get(\"/edit\", RegistrationController, :edit)\r\n    put(\"/edit\", RegistrationController, :update)\r\n    get(\"/users\", UserController, :index)\r\n    resources \"/\", UserController, only: [:show, :delete], param: \"username\"\r\n  end\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/config/config.exs\r\n\r\nconfig :MyApp, MyApp.Auth.Pipeline,\r\n  module: MyApp.Auth.Guardian,\r\n  error_handler: MyApp.Auth.ErrorHandler\r\n\r\nconfig :MyApp, MyApp.Auth.AferPipeline,\r\n  module: MyApp.Auth.Guardian,\r\n  error_handler: MyApp.Auth.ErrorHandler\r\n```\r\n\r\n### 登録\r\n登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意する。\r\n\r\nこのあたりはDevise/Railsとあまり変わらない。ほかのアクション「新規パスワード発行」「メールアドレス確認」なども同様の構成をとろうと思っている。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/controller/registration_controller.ex\r\n\r\ndef create(conn, user_params) do\r\n  changeset = User.registration_changeset(%User{}, user_params)\r\n\r\n  case Registration.create(changeset, Repo) do\r\n    {:ok, user} ->\r\n      conn\r\n      |> MyApp.Auth.login(user)\r\n      |> put_flash(:info, \"Your account was created successfully\")\r\n      |> redirect(to: page_path(conn, :home))\r\n\r\n   {:error, changeset} ->\r\n      conn\r\n      |> put_flash(:error, \"Unable to create account: Try again\")\r\n      |> render(MyAppWeb.PageView, \"home.html\", changeset: changeset)\r\n  end\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/auth.ex\r\n\r\ndef login(conn, %User{} = user) do\r\n  conn\r\n  |> Guardian.Plug.sign_in(user)\r\n  |> assign(:current_user, user)\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/account/registration.ex\r\n\r\ndef create(changeset, repo) do\r\n  changeset\r\n  |> repo.insert()\r\nend\r\n```\r\n\r\n### ログイン・ログアウト\r\nログイン・ログアウトはセッション用のサービスとコントローラで実装する。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/controller/session_controller.ex\r\n\r\n@doc \"Logged in [POST /login]\"\r\ndef create(conn, %{\"email\" => email, \"password\" => password}) do\r\n  case Session.authenticate_user(email, password) do\r\n    {:ok, user} ->\r\n      conn\r\n      |> Session.login(user)\r\n      |> put_flash(:info, \"Logged in successfully\")\r\n      |> redirect(to: page_path(conn, :home))\r\n\r\n    {:error, _reason} ->\r\n      conn\r\n      |> put_flash(:error, \"Wrong username/password\")\r\n      |> render(\"new.html\")\r\n  end\r\nend\r\n\r\n@doc \"Logged out [DELETE /logout]\"\r\ndef delete(conn, _params) do\r\n  conn\r\n  |> Session.logout()\r\n  |> put_flash(:info, \"Logged out successfully.\")\r\n  |> redirect(to: \"/\")\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/session.ex\r\n\r\ndefmodule MyApp.Auth.Session do\r\n  import Ecto.Query\r\n  import Plug.Conn\r\n  import Comeonin.Bcrypt, only: [checkpw: 2, dummy_checkpw: 0]\r\n  alias MyApp.Repo\r\n  alias MyApp.Auth.Guardian\r\n  alias MyApp.Account.User\r\n\r\n  def login(conn, %User{} = user) do\r\n    conn\r\n    |> Guardian.Plug.sign_in(user)\r\n    |> assign(:current_user, user)\r\n  end\r\n\r\n  def logout(conn), do: Guardian.Plug.sign_out(conn)\r\n\r\n  def authenticate_user(email, given_password) do\r\n    query = Ecto.Query.from(u in User, where: u.email == ^email)\r\n\r\n    Repo.one(query)\r\n    |> check_password(given_password)\r\n  end\r\n\r\n  def current_user(conn), do: Guardian.Plug.current_resource(conn, [])\r\n\r\n  def logged_in?(conn), do: Guardian.Plug.authenticated?(conn, [])\r\n\r\n  defp check_password(nil, _), do: {:error, \"Incorrect username or password\"}\r\n\r\n  defp check_password(user, given_password) do\r\n    case Comeonin.Bcrypt.checkpw(given_password, user.encrypted_password) do\r\n      true -> {:ok, user}\r\n      false -> {:error, \"Incorrect email or password\"}\r\n    end\r\n  end\r\nend\r\n```\r\n\r\nDevise/Railsのビューヘルパーはビューマクロで適用する。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web.ex\r\n\r\ndef view do\r\n  quote do\r\n    # ..\r\n    import Okuribi.Auth.Session, only: [current_user: 1, logged_in?: 1]\r\n  end\r\nend\r\n```\r\n\r\nあるいは、`put_assigns`関数をはやしてコントローラマクロに適用する。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app/auth/session.ex\r\n\r\ndef put_assigns(%{private: %{phoenix_action: action}} = conn, settings) do\r\n  current_resource = Guardian.Plug.current_resource(conn)\r\n\r\n  settings =\r\n    if current_resource,\r\n      do: settings[:sign_in][action] || [],\r\n      else: settings[:sign_out][action] || []\r\n\r\n  conn\r\n  |> assign(:current_user, current_resource)\r\n  |> assign(:page_title, settings[:page_title])\r\n  |> assign(:page_description, settings[:page_description])\r\nend\r\n```\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web.ex\r\n\r\ndef controller do\r\n  quote do\r\n    # ..\r\n    import Okuribi.Auth, only: [put_assigns: 2]\r\n  end\r\nend\r\n```\r\n\r\n`assigns`ひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsの`ActionView::Helpers::CaptureHelper#provide`の代わりに使える。\r\n\r\n```elixir\r\n# apps/my_app/lib/my_app_web/controller/*_controller.ex\r\n\r\n@page %{\r\n  sign_in: %{\r\n    new: %{\r\n      page_title: dgettext(\"views\", \"pages.home.signed_in.page_title\"),\r\n      page_description: \"\"\r\n    }\r\n  },\r\n  sign_out: %{\r\n    new: %{\r\n      page_title: dgettext(\"views\", \"pages.home.signed_out.page_title\"),\r\n      page_description: \"\"\r\n    }\r\n  }\r\n}\r\nplug(:put_assigns, @page when action in [:home])\r\n```\r\n\r\n## その他\r\nRailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道におこなっていく。\r\n\r\n- Rails\r\n    - `ActionView::Helpers::FormHelper#form_for(record, options={}, &block)`\r\n    - `ActionView::Helpers::FormHelper#text_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#file_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#password_field(object_name, method, options={})`\r\n    - `ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})`\r\n    - `ActionView::Helpers::FormBuilder#submit(value=nil, options={})`\r\n    - `ActionView::Helpers::TranslationHelper#t`\r\n- Phoenix\r\n    - `Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun)`\r\n    - `Phoenix.HTML.Form.text_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.file_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.password_input(form, field, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ [])`\r\n    - `Phoenix.HTML.Form.submit(opts, opts \\\\ [])`\r\n    - `Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{})`\r\n","body_html":"<a href=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"728\" alt=\"thumbnail\" src=\"https://img.esa.io/uploads/production/attachments/16651/2021/01/11/97367/d19fe4dc-962c-4e58-b8e5-c1787fd566ed.png\"></a>\n<h1 data-sourcepos=\"3:1-3:9\" id=\"1-0-0\" name=\"1-0-0\">\n<a class=\"anchor\" id=\"PROBLEM\" name=\"PROBLEM\" href=\"#PROBLEM\" data-position=\"1-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"PROBLEM\"> &gt; PROBLEM</span></a>PROBLEM</h1>\n<ul data-sourcepos=\"4:1-8:0\">\n<li data-sourcepos=\"4:1-8:0\">サービスについて\n<ul data-sourcepos=\"5:5-8:0\">\n<li data-sourcepos=\"5:5-5:75\">拡張にともない技術スタックがふえるのを抑えたい</li>\n<li data-sourcepos=\"6:5-6:66\">スケーラビリティのためのコストを抑えたい</li>\n<li data-sourcepos=\"7:5-8:0\">パフォーマンスをあげたい</li>\n</ul>\n</li>\n</ul>\n<h1 data-sourcepos=\"9:1-9:10\" id=\"2-0-0\" name=\"2-0-0\">\n<a class=\"anchor\" id=\"SOLUTION\" name=\"SOLUTION\" href=\"#SOLUTION\" data-position=\"2-0-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"SOLUTION\"> &gt; SOLUTION</span></a>SOLUTION</h1>\n<p data-sourcepos=\"10:1-10:93\">というわけで、現在つかっているRailsをPhoenixに変更することにした。</p>\n<ul data-sourcepos=\"12:1-21:0\">\n<li data-sourcepos=\"12:1-21:0\">方針\n<ul data-sourcepos=\"13:5-21:0\">\n<li data-sourcepos=\"13:5-19:68\">Railsから徐々にPhoenixに移行できるように\n<ul data-sourcepos=\"14:7-19:68\">\n<li data-sourcepos=\"14:7-14:48\">いままでとおなじPaaS（Heroku）</li>\n<li data-sourcepos=\"15:7-17:104\">いままでとおなじレポジトリ\n<ul data-sourcepos=\"16:11-17:104\">\n<li data-sourcepos=\"16:11-16:64\">ブランチ戦略は <code>phoenix/base</code> をベースに</li>\n<li data-sourcepos=\"17:11-17:104\">気軽に参照できるようにRails関連ファイルは可能な限りのこしておく</li>\n</ul>\n</li>\n<li data-sourcepos=\"18:7-19:68\">いままでとおなじDB\n<ul data-sourcepos=\"19:11-19:68\">\n<li data-sourcepos=\"19:11-19:68\">移行完了までDBマイグレーションをしない</li>\n</ul>\n</li>\n</ul>\n</li>\n<li data-sourcepos=\"20:5-21:0\">Phoenixは今後の拡張性をかんがえてUmbrellaプロジェクトで</li>\n</ul>\n</li>\n</ul>\n<p data-sourcepos=\"22:1-22:91\">今回はRails/Deviseの認証機能をPhoenixで実装するながれをとりあげる。</p>\n<h2 data-sourcepos=\"24:1-24:26\" id=\"2-1-0\" name=\"2-1-0\">\n<a class=\"anchor\" id=\"Guardianを実装する\" name=\"Guardian%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" href=\"#Guardian%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" data-position=\"2-1-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"Guardianを実装する\"> &gt; Guardianを実装する</span></a>Guardianを実装する</h2>\n<p data-sourcepos=\"25:1-25:312\">参考にしたのはBlackodeの<a href=\"https://github.com/blackode/guardian_auth\" target=\"_blank\" rel=\"noopener noreferrer\">guardian_auth</a> <img class=\"emoji\" title=\":pray:\" alt=\":pray:\" src=\"https://assets.esa.io/images/emoji/unicode/1f64f.png\"> ただ、Guardianのバージョンがふるいので<a href=\"https://github.com/ueberauth/guardian/blob/master/upgrade_guides/0.14.to.1.0.md\" target=\"_blank\" rel=\"noopener noreferrer\">1.0へのマイグレーション記事</a>をもとにアレンジしてある。</p>\n<p data-sourcepos=\"27:1-27:57\">認証に関係しそうな構成は下記のとおり。</p>\n<p data-sourcepos=\"29:1-29:12\">ロジック</p>\n<ul data-sourcepos=\"30:1-38:0\">\n<li data-sourcepos=\"30:1-30:15\">MyApp.Account</li>\n<li data-sourcepos=\"31:1-31:28\">MyApp.Account.Registration</li>\n<li data-sourcepos=\"32:1-32:20\">MyApp.Account.User</li>\n<li data-sourcepos=\"33:1-33:21\">MyApp.Auth.Guardian</li>\n<li data-sourcepos=\"34:1-34:25\">MyApp.Auth.ErrorHandler</li>\n<li data-sourcepos=\"35:1-35:21\">MyApp.Auth.Pipeline</li>\n<li data-sourcepos=\"36:1-36:26\">MyApp.Auth.AfterPipeline</li>\n<li data-sourcepos=\"37:1-38:0\">MyApp.Auth.Session</li>\n</ul>\n<p data-sourcepos=\"39:1-39:18\">コントローラ</p>\n<ul data-sourcepos=\"40:1-42:0\">\n<li data-sourcepos=\"40:1-40:33\">MyAppWeb.RegistrationController</li>\n<li data-sourcepos=\"41:1-42:0\">MyAppWeb.SessionController</li>\n</ul>\n<h3 data-sourcepos=\"43:1-43:55\" id=\"2-1-1\" name=\"2-1-1\">\n<a class=\"anchor\" id=\"シリアライザとエラーハンドラの設定\" name=\"%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%B6%E3%81%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A\" href=\"#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%B6%E3%81%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A\" data-position=\"2-1-1\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"シリアライザとエラーハンドラの設定\"> &gt; シリアライザとエラーハンドラの設定</span></a>シリアライザとエラーハンドラの設定</h3>\n<p data-sourcepos=\"44:1-44:182\">Guardian1.0から直接ではなくモジュールを介して参照するようになった。下記のように各モジュールを用意してコンフィグに割り当てる。</p>\n<div class=\"code-block\" data-sourcepos=\"46:1-59:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/guardian.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">Guardian</span><span class=\"p\">,</span> <span class=\"ss\">otp_app:</span> <span class=\"ss\">:my_app</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Account</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">subject_for_token</span><span class=\"p\">(</span><span class=\"n\">resource</span><span class=\"p\">,</span> <span class=\"n\">_claims</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">to_string</span><span class=\"p\">(</span><span class=\"n\">resource</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)}</span>\n  <span class=\"k\">def</span> <span class=\"n\">subject_for_token</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"ss\">:reason_for_error</span><span class=\"p\">}</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">resource_from_claims</span><span class=\"p\">(</span><span class=\"n\">claims</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"no\">Account</span><span class=\"o\">.</span><span class=\"n\">get_user!</span><span class=\"p\">(</span><span class=\"n\">claims</span><span class=\"p\">[</span><span class=\"s2\">\"sub\"</span><span class=\"p\">])}</span>\n  <span class=\"k\">def</span> <span class=\"n\">resource_from_claims</span><span class=\"p\">(</span><span class=\"n\">_claims</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"ss\">:reason_for_error</span><span class=\"p\">}</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"61:1-72:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/error_handler.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">ErrorHandler</span> <span class=\"k\">do</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Conn</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">auth_error</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">type</span><span class=\"p\">,</span> <span class=\"n\">_reason</span><span class=\"p\">},</span> <span class=\"n\">_opts</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">body</span> <span class=\"o\">=</span> <span class=\"no\">Poison</span><span class=\"o\">.</span><span class=\"n\">encode!</span><span class=\"p\">(%{</span><span class=\"ss\">message:</span> <span class=\"n\">to_string</span><span class=\"p\">(</span><span class=\"n\">type</span><span class=\"p\">)})</span>\n    <span class=\"n\">send_resp</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"mi\">401</span><span class=\"p\">,</span> <span class=\"n\">body</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"74:1-88:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/config/config.exs</span>\n\n<span class=\"n\">config</span> <span class=\"ss\">:my_app</span><span class=\"p\">,</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"p\">,</span>\n  <span class=\"ss\">issuer:</span> <span class=\"s2\">\"MyApp\"</span><span class=\"p\">,</span>\n  <span class=\"ss\">ttl:</span> <span class=\"p\">{</span><span class=\"mi\">30</span><span class=\"p\">,</span> <span class=\"ss\">:days</span><span class=\"p\">},</span>\n  <span class=\"ss\">allowed_drift:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span>\n  <span class=\"c1\"># optionals</span>\n  <span class=\"ss\">allowed_algos:</span> <span class=\"p\">[</span><span class=\"s2\">\"HS512\"</span><span class=\"p\">],</span>\n  <span class=\"ss\">verify_module:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">JWT</span><span class=\"p\">,</span>\n  <span class=\"ss\">verify_issuer:</span> <span class=\"no\">true</span><span class=\"p\">,</span>\n  <span class=\"ss\">secret_key:</span>\n    <span class=\"no\">System</span><span class=\"o\">.</span><span class=\"n\">get_env</span><span class=\"p\">(</span><span class=\"s2\">\"GUARDIAN_SECRET\"</span><span class=\"p\">)</span> <span class=\"o\">||</span>\n      <span class=\"s2\">\"secret_key\"</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"90:1-90:25\" id=\"2-1-2\" name=\"2-1-2\">\n<a class=\"anchor\" id=\"ルーターの設定\" name=\"%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" href=\"#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" data-position=\"2-1-2\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"ルーターの設定\"> &gt; ルーターの設定</span></a>ルーターの設定</h3>\n<p data-sourcepos=\"91:1-91:126\">認証のパイプラインは、認証中と認証後のものを用意しコンフィグとルーターに割り当てる。</p>\n<p data-sourcepos=\"93:1-93:599\">ルータースコープ内のパイプラインくみあわせについて、ここでは未ログインスコープには認証前・認証中パイプライン、ログイン済スコープには認証前・認証中・認証後パイプラインを適用している。こうすることでどのスコープにも認証リソースをロードすることができ、かつ、認証も担保することができるようになる。具体的にいうと、ルート <code>/</code> などの同一URLで未ログインスコープとログイン済スコープの切り替えができるようになる。</p>\n<div class=\"code-block\" data-sourcepos=\"95:1-105:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/pipeline.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">,</span> <span class=\"ss\">otp_app:</span> <span class=\"ss\">:my_app</span>\n\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">VerifySession</span><span class=\"p\">,</span> <span class=\"ss\">claims:</span> <span class=\"p\">%{</span><span class=\"s2\">\"typ\"</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">\"access\"</span><span class=\"p\">})</span>\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">VerifyHeader</span><span class=\"p\">,</span> <span class=\"ss\">claims:</span> <span class=\"p\">%{</span><span class=\"s2\">\"typ\"</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">\"access\"</span><span class=\"p\">})</span>\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">LoadResource</span><span class=\"p\">,</span> <span class=\"ss\">allow_blank:</span> <span class=\"no\">true</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"107:1-115:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/after_pipeline.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">AfterPipeline</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">,</span> <span class=\"ss\">otp_app:</span> <span class=\"ss\">:my_app</span>\n\n  <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">EnsureAuthenticated</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"117:1-157:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/router.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyAppWeb</span><span class=\"o\">.</span><span class=\"no\">Router</span> <span class=\"k\">do</span>\n  <span class=\"kn\">use</span> <span class=\"no\">MyAppWeb</span><span class=\"p\">,</span> <span class=\"ss\">:router</span>\n\n  <span class=\"n\">pipeline</span> <span class=\"ss\">:browser</span> <span class=\"k\">do</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:accepts</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s2\">\"html\"</span><span class=\"p\">])</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:fetch_session</span><span class=\"p\">)</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:fetch_flash</span><span class=\"p\">)</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:protect_from_forgery</span><span class=\"p\">)</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:put_secure_browser_headers</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">pipeline</span> <span class=\"ss\">:browser_auth</span> <span class=\"k\">do</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">pipeline</span> <span class=\"ss\">:browser_auth_after</span> <span class=\"k\">do</span>\n    <span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">AfterPipeline</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">scope</span> <span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"no\">MyAppWeb</span> <span class=\"k\">do</span>\n    <span class=\"n\">pipe_through</span><span class=\"p\">([</span><span class=\"ss\">:browser</span><span class=\"p\">,</span> <span class=\"ss\">:browser_auth</span><span class=\"p\">])</span>\n\n    <span class=\"n\">post</span><span class=\"p\">(</span><span class=\"s2\">\"/registration\"</span><span class=\"p\">,</span> <span class=\"no\">RegistrationController</span><span class=\"p\">,</span> <span class=\"ss\">:create</span><span class=\"p\">)</span>\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/login\"</span><span class=\"p\">,</span> <span class=\"no\">SessionController</span><span class=\"p\">,</span> <span class=\"ss\">:new</span><span class=\"p\">)</span>\n    <span class=\"n\">post</span><span class=\"p\">(</span><span class=\"s2\">\"/login\"</span><span class=\"p\">,</span> <span class=\"no\">SessionController</span><span class=\"p\">,</span> <span class=\"ss\">:create</span><span class=\"p\">)</span>\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/logout\"</span><span class=\"p\">,</span> <span class=\"no\">SessionController</span><span class=\"p\">,</span> <span class=\"ss\">:delete</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"n\">scope</span> <span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"no\">MyAppWeb</span> <span class=\"k\">do</span>\n    <span class=\"n\">pipe_through</span><span class=\"p\">([</span><span class=\"ss\">:browser</span><span class=\"p\">,</span> <span class=\"ss\">:browser_auth</span><span class=\"p\">,</span> <span class=\"ss\">:browser_auth_after</span><span class=\"p\">])</span>\n\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/edit\"</span><span class=\"p\">,</span> <span class=\"no\">RegistrationController</span><span class=\"p\">,</span> <span class=\"ss\">:edit</span><span class=\"p\">)</span>\n    <span class=\"n\">put</span><span class=\"p\">(</span><span class=\"s2\">\"/edit\"</span><span class=\"p\">,</span> <span class=\"no\">RegistrationController</span><span class=\"p\">,</span> <span class=\"ss\">:update</span><span class=\"p\">)</span>\n    <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"/users\"</span><span class=\"p\">,</span> <span class=\"no\">UserController</span><span class=\"p\">,</span> <span class=\"ss\">:index</span><span class=\"p\">)</span>\n    <span class=\"n\">resources</span> <span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"no\">UserController</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">:show</span><span class=\"p\">,</span> <span class=\"ss\">:delete</span><span class=\"p\">],</span> <span class=\"ss\">param:</span> <span class=\"s2\">\"username\"</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"159:1-169:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/config/config.exs</span>\n\n<span class=\"n\">config</span> <span class=\"ss\">:MyApp</span><span class=\"p\">,</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Pipeline</span><span class=\"p\">,</span>\n  <span class=\"ss\">module:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"p\">,</span>\n  <span class=\"ss\">error_handler:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">ErrorHandler</span>\n\n<span class=\"n\">config</span> <span class=\"ss\">:MyApp</span><span class=\"p\">,</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">AferPipeline</span><span class=\"p\">,</span>\n  <span class=\"ss\">module:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span><span class=\"p\">,</span>\n  <span class=\"ss\">error_handler:</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">ErrorHandler</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"171:1-171:10\" id=\"2-1-3\" name=\"2-1-3\">\n<a class=\"anchor\" id=\"登録\" name=\"%E7%99%BB%E9%8C%B2\" href=\"#%E7%99%BB%E9%8C%B2\" data-position=\"2-1-3\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"登録\"> &gt; 登録</span></a>登録</h3>\n<p data-sourcepos=\"172:1-172:120\">登録は登録用のロジック（ユーザーモデルと登録サービス）とコントローラを用意する。</p>\n<p data-sourcepos=\"174:1-174:207\">このあたりはDevise/Railsとあまり変わらない。ほかのアクション「新規パスワード発行」「メールアドレス確認」なども同様の構成をとろうと思っている。</p>\n<div class=\"code-block\" data-sourcepos=\"176:1-195:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/controller/registration_controller.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">user_params</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">changeset</span> <span class=\"o\">=</span> <span class=\"no\">User</span><span class=\"o\">.</span><span class=\"n\">registration_changeset</span><span class=\"p\">(%</span><span class=\"no\">User</span><span class=\"p\">{},</span> <span class=\"n\">user_params</span><span class=\"p\">)</span>\n\n  <span class=\"k\">case</span> <span class=\"no\">Registration</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">changeset</span><span class=\"p\">,</span> <span class=\"no\">Repo</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:info</span><span class=\"p\">,</span> <span class=\"s2\">\"Your account was created successfully\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"ss\">to:</span> <span class=\"n\">page_path</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"ss\">:home</span><span class=\"p\">))</span>\n\n   <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"n\">changeset</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Unable to create account: Try again\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"no\">MyAppWeb</span><span class=\"o\">.</span><span class=\"no\">PageView</span><span class=\"p\">,</span> <span class=\"s2\">\"home.html\"</span><span class=\"p\">,</span> <span class=\"ss\">changeset:</span> <span class=\"n\">changeset</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"197:1-205:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/auth.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">%</span><span class=\"no\">User</span><span class=\"p\">{}</span> <span class=\"o\">=</span> <span class=\"n\">user</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">conn</span>\n  <span class=\"o\">|&gt;</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">sign_in</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:current_user</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"207:1-214:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/account/registration.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">changeset</span><span class=\"p\">,</span> <span class=\"n\">repo</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">changeset</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">repo</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">()</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<h3 data-sourcepos=\"216:1-216:34\" id=\"2-1-4\" name=\"2-1-4\">\n<a class=\"anchor\" id=\"ログイン・ログアウト\" name=\"%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%BB%E3%83%AD%E3%82%B0%E3%82%A2%E3%82%A6%E3%83%88\" href=\"#%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%BB%E3%83%AD%E3%82%B0%E3%82%A2%E3%82%A6%E3%83%88\" data-position=\"2-1-4\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"ログイン・ログアウト\"> &gt; ログイン・ログアウト</span></a>ログイン・ログアウト</h3>\n<p data-sourcepos=\"217:1-217:105\">ログイン・ログアウトはセッション用のサービスとコントローラで実装する。</p>\n<div class=\"code-block\" data-sourcepos=\"219:1-245:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/controller/session_controller.ex</span>\n\n<span class=\"nv\">@doc</span> <span class=\"s2\">\"Logged in [POST /login]\"</span>\n<span class=\"k\">def</span> <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">%{</span><span class=\"s2\">\"email\"</span> <span class=\"o\">=&gt;</span> <span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"s2\">\"password\"</span> <span class=\"o\">=&gt;</span> <span class=\"n\">password</span><span class=\"p\">})</span> <span class=\"k\">do</span>\n  <span class=\"k\">case</span> <span class=\"no\">Session</span><span class=\"o\">.</span><span class=\"n\">authenticate_user</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"no\">Session</span><span class=\"o\">.</span><span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:info</span><span class=\"p\">,</span> <span class=\"s2\">\"Logged in successfully\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"ss\">to:</span> <span class=\"n\">page_path</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"ss\">:home</span><span class=\"p\">))</span>\n\n    <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"n\">_reason</span><span class=\"p\">}</span> <span class=\"o\">-&gt;</span>\n      <span class=\"n\">conn</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Wrong username/password\"</span><span class=\"p\">)</span>\n      <span class=\"o\">|&gt;</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"s2\">\"new.html\"</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"nv\">@doc</span> <span class=\"s2\">\"Logged out [DELETE /logout]\"</span>\n<span class=\"k\">def</span> <span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">_params</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">conn</span>\n  <span class=\"o\">|&gt;</span> <span class=\"no\">Session</span><span class=\"o\">.</span><span class=\"n\">logout</span><span class=\"p\">()</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">put_flash</span><span class=\"p\">(</span><span class=\"ss\">:info</span><span class=\"p\">,</span> <span class=\"s2\">\"Logged out successfully.\"</span><span class=\"p\">)</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"ss\">to:</span> <span class=\"s2\">\"/\"</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"247:1-286:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/session.ex</span>\n\n<span class=\"k\">defmodule</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Session</span> <span class=\"k\">do</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Ecto</span><span class=\"o\">.</span><span class=\"no\">Query</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"no\">Conn</span>\n  <span class=\"kn\">import</span> <span class=\"no\">Comeonin</span><span class=\"o\">.</span><span class=\"no\">Bcrypt</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">checkpw:</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"ss\">dummy_checkpw:</span> <span class=\"mi\">0</span><span class=\"p\">]</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Repo</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Guardian</span>\n  <span class=\"n\">alias</span> <span class=\"no\">MyApp</span><span class=\"o\">.</span><span class=\"no\">Account</span><span class=\"o\">.</span><span class=\"no\">User</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">%</span><span class=\"no\">User</span><span class=\"p\">{}</span> <span class=\"o\">=</span> <span class=\"n\">user</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">conn</span>\n    <span class=\"o\">|&gt;</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">sign_in</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:current_user</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">logout</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">sign_out</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">authenticate_user</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">given_password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"no\">Ecto</span><span class=\"o\">.</span><span class=\"no\">Query</span><span class=\"o\">.</span><span class=\"n\">from</span><span class=\"p\">(</span><span class=\"n\">u</span> <span class=\"ow\">in</span> <span class=\"no\">User</span><span class=\"p\">,</span> <span class=\"ss\">where:</span> <span class=\"n\">u</span><span class=\"o\">.</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"o\">^</span><span class=\"n\">email</span><span class=\"p\">)</span>\n\n    <span class=\"no\">Repo</span><span class=\"o\">.</span><span class=\"n\">one</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n    <span class=\"o\">|&gt;</span> <span class=\"n\">check_password</span><span class=\"p\">(</span><span class=\"n\">given_password</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">current_user</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">current_resource</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n\n  <span class=\"k\">def</span> <span class=\"n\">logged_in?</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">authenticated?</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n\n  <span class=\"k\">defp</span> <span class=\"n\">check_password</span><span class=\"p\">(</span><span class=\"no\">nil</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">),</span> <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Incorrect username or password\"</span><span class=\"p\">}</span>\n\n  <span class=\"k\">defp</span> <span class=\"n\">check_password</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"n\">given_password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n    <span class=\"k\">case</span> <span class=\"no\">Comeonin</span><span class=\"o\">.</span><span class=\"no\">Bcrypt</span><span class=\"o\">.</span><span class=\"n\">checkpw</span><span class=\"p\">(</span><span class=\"n\">given_password</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">encrypted_password</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n      <span class=\"no\">true</span> <span class=\"o\">-&gt;</span> <span class=\"p\">{</span><span class=\"ss\">:ok</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">}</span>\n      <span class=\"no\">false</span> <span class=\"o\">-&gt;</span> <span class=\"p\">{</span><span class=\"ss\">:error</span><span class=\"p\">,</span> <span class=\"s2\">\"Incorrect email or password\"</span><span class=\"p\">}</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"288:1-288:75\">Devise/Railsのビューヘルパーはビューマクロで適用する。</p>\n<div class=\"code-block\" data-sourcepos=\"290:1-299:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">view</span> <span class=\"k\">do</span>\n  <span class=\"kn\">quote</span> <span class=\"k\">do</span>\n    <span class=\"c1\"># ..</span>\n    <span class=\"kn\">import</span> <span class=\"no\">Okuribi</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"o\">.</span><span class=\"no\">Session</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">current_user:</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"ss\">logged_in?:</span> <span class=\"mi\">1</span><span class=\"p\">]</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"301:1-301:94\">あるいは、<code>put_assigns</code>関数をはやしてコントローラマクロに適用する。</p>\n<div class=\"code-block\" data-sourcepos=\"303:1-319:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app/auth/session.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">put_assigns</span><span class=\"p\">(%{</span><span class=\"ss\">private:</span> <span class=\"p\">%{</span><span class=\"ss\">phoenix_action:</span> <span class=\"n\">action</span><span class=\"p\">}}</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n  <span class=\"n\">current_resource</span> <span class=\"o\">=</span> <span class=\"no\">Guardian</span><span class=\"o\">.</span><span class=\"no\">Plug</span><span class=\"o\">.</span><span class=\"n\">current_resource</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n\n  <span class=\"n\">settings</span> <span class=\"o\">=</span>\n    <span class=\"k\">if</span> <span class=\"n\">current_resource</span><span class=\"p\">,</span>\n      <span class=\"k\">do</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:sign_in</span><span class=\"p\">][</span><span class=\"n\">action</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"p\">[],</span>\n      <span class=\"k\">else</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:sign_out</span><span class=\"p\">][</span><span class=\"n\">action</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"p\">[]</span>\n\n  <span class=\"n\">conn</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:current_user</span><span class=\"p\">,</span> <span class=\"n\">current_resource</span><span class=\"p\">)</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:page_title</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:page_title</span><span class=\"p\">])</span>\n  <span class=\"o\">|&gt;</span> <span class=\"n\">assign</span><span class=\"p\">(</span><span class=\"ss\">:page_description</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"p\">[</span><span class=\"ss\">:page_description</span><span class=\"p\">])</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<div class=\"code-block\" data-sourcepos=\"321:1-330:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web.ex</span>\n\n<span class=\"k\">def</span> <span class=\"n\">controller</span> <span class=\"k\">do</span>\n  <span class=\"kn\">quote</span> <span class=\"k\">do</span>\n    <span class=\"c1\"># ..</span>\n    <span class=\"kn\">import</span> <span class=\"no\">Okuribi</span><span class=\"o\">.</span><span class=\"no\">Auth</span><span class=\"p\">,</span> <span class=\"ss\">only:</span> <span class=\"p\">[</span><span class=\"ss\">put_assigns:</span> <span class=\"mi\">2</span><span class=\"p\">]</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n</div>\n<p data-sourcepos=\"332:1-332:202\"><code>assigns</code>ひとつでアクセスできるので、下記のようにコントローラでまとめて指定することでRailsの<code>ActionView::Helpers::CaptureHelper#provide</code>の代わりに使える。</p>\n<div class=\"code-block\" data-sourcepos=\"334:1-352:3\">\n<div class=\"code-filename\">\n<i class=\"fa fa-file-code-o\"></i>elixir</div>\n<div class=\"highlight\"><pre class=\"highlight elixir\"><code><span class=\"c1\"># apps/my_app/lib/my_app_web/controller/*_controller.ex</span>\n\n<span class=\"nv\">@page</span> <span class=\"p\">%{</span>\n  <span class=\"ss\">sign_in:</span> <span class=\"p\">%{</span>\n    <span class=\"ss\">new:</span> <span class=\"p\">%{</span>\n      <span class=\"ss\">page_title:</span> <span class=\"n\">dgettext</span><span class=\"p\">(</span><span class=\"s2\">\"views\"</span><span class=\"p\">,</span> <span class=\"s2\">\"pages.home.signed_in.page_title\"</span><span class=\"p\">),</span>\n      <span class=\"ss\">page_description:</span> <span class=\"s2\">\"\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">},</span>\n  <span class=\"ss\">sign_out:</span> <span class=\"p\">%{</span>\n    <span class=\"ss\">new:</span> <span class=\"p\">%{</span>\n      <span class=\"ss\">page_title:</span> <span class=\"n\">dgettext</span><span class=\"p\">(</span><span class=\"s2\">\"views\"</span><span class=\"p\">,</span> <span class=\"s2\">\"pages.home.signed_out.page_title\"</span><span class=\"p\">),</span>\n      <span class=\"ss\">page_description:</span> <span class=\"s2\">\"\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"n\">plug</span><span class=\"p\">(</span><span class=\"ss\">:put_assigns</span><span class=\"p\">,</span> <span class=\"nv\">@page</span> <span class=\"ow\">when</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"ss\">:home</span><span class=\"p\">])</span>\n</code></pre></div>\n</div>\n<h2 data-sourcepos=\"354:1-354:12\" id=\"2-2-0\" name=\"2-2-0\">\n<a class=\"anchor\" id=\"その他\" name=\"%E3%81%9D%E3%81%AE%E4%BB%96\" href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\" data-position=\"2-2-0\"><i class=\"fa fa-link\"></i><span class=\"hidden\" data-text=\"その他\"> &gt; その他</span></a>その他</h2>\n<p data-sourcepos=\"355:1-355:120\">RailsのビューをPhoenixのテンプレートに移植するには下記の変換を地道におこなっていく。</p>\n<ul data-sourcepos=\"357:1-374:65\">\n<li data-sourcepos=\"357:1-365:48\">Rails\n<ul data-sourcepos=\"358:5-365:48\">\n<li data-sourcepos=\"358:5-358:76\"><code>ActionView::Helpers::FormHelper#form_for(record, options={}, &amp;block)</code></li>\n<li data-sourcepos=\"359:5-359:83\"><code>ActionView::Helpers::FormHelper#text_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"360:5-360:83\"><code>ActionView::Helpers::FormHelper#file_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"361:5-361:85\"><code>ActionView::Helpers::FormHelper#hidden_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"362:5-362:87\"><code>ActionView::Helpers::FormHelper#password_field(object_name, method, options={})</code></li>\n<li data-sourcepos=\"363:5-363:96\"><code>ActionView::Helpers::FormHelper#radio_button(object_name, method, tag_value, options={})</code></li>\n<li data-sourcepos=\"364:5-364:70\"><code>ActionView::Helpers::FormBuilder#submit(value=nil, options={})</code></li>\n<li data-sourcepos=\"365:5-365:48\"><code>ActionView::Helpers::TranslationHelper#t</code></li>\n</ul>\n</li>\n<li data-sourcepos=\"366:1-374:65\">Phoenix\n<ul data-sourcepos=\"367:5-374:65\">\n<li data-sourcepos=\"367:5-367:73\"><code>Phoenix.HTML.Form.form_for(form_data, action, options \\\\ [], fun)</code></li>\n<li data-sourcepos=\"368:5-368:61\"><code>Phoenix.HTML.Form.text_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"369:5-369:61\"><code>Phoenix.HTML.Form.file_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"370:5-370:63\"><code>Phoenix.HTML.Form.hidden_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"371:5-371:65\"><code>Phoenix.HTML.Form.password_input(form, field, opts \\\\ [])</code></li>\n<li data-sourcepos=\"372:5-372:70\"><code>Phoenix.HTML.Form.radio_button(form, field, value, opts \\\\ [])</code></li>\n<li data-sourcepos=\"373:5-373:50\"><code>Phoenix.HTML.Form.submit(opts, opts \\\\ [])</code></li>\n<li data-sourcepos=\"374:5-374:65\"><code>Gettext.dgettext(backend, domain, msgid, bindings \\\\ %{})</code></li>\n</ul>\n</li>\n</ul>\n","tags":["phoenix-framework","elixir","ruby-on-rails","ruby","wercker","heroku","authentication","guardian"],"updated_at":"2021-01-11T12:39:59+09:00","childPublishedDate":{"published_on":"2018-05-20T00:00:00.000Z"},"updated_by":{"name":"なびの👷","screen_name":"nabinno","icon":"https://img.esa.io/uploads/production/members/94286/icon/thumb_m_ef5f024307008aa399b91f87fa5f64e8.jpg"}},"relatedPosts":{"edges":[{"node":{"number":56,"relative_category":"blog/backend","fields":{"title":"RubyのCSVパースをPyCallで実行する（ベンチマーク）","excerpt":"先日RubyからPythonにアクセスできるPyCallというライブラリの存在を知り、ぜひともベンチマークを取りたいと思った次第です。現状RubyのCSVの読み込みに不満を持っており、そこをどうにか解消したいと考えています。   > PROBLEMPROBLEM \n\n- 大量のCSVを読み込む際、毎回時間がかかる   > SOLUTIONSOLUTION \n\nというわけで、「Dalibor Nasevicのベンチマーク記事」にPyCallのベンチマークをくわえて比較してみることにしました。記事では下記の通り CSV.foreach が速いとの結論でした。    kind_of_parse time (real) memory (MB)     1. CSV.read  39.13 866.6   2. CSV.parse  36.16 936.87   3. line by line from String Object 23.39 73.42   4. line by line from IO Object 24.55 0.0   5. CSV.foreach  24.04 0.0      > PyCallのベンチマークPyCallのベンチマーク \n\nそれでは、PyCallのベンチマークを計りましょう。コードは下記のようになります。   ruby \n\nrequire_relative './helpers' require 'pycall/import' include PyCall::Import pyimport :pandas, as: :pd print_memory_usage do print_time_spent do csv = pd.read_csv.('data.csv') sum = csv['id'].sum.() puts \"Sum: #{sum}\" end end   \n\nPyCallは pyenv との相性が悪いのでSystemインストールしたPythonでたたきます。   sh \n\n$ PYTHON=/usr/bin/python3.4 ruby parse_6_pycall.rb Sum: 499999500000 Time: 1.49 Memory: 54.99 MB   \n\n結果    kind_of_parse time (real) memory (MB)     1. CSV.read  39.13 866.6   2. CSV.parse  36.16 936.87   3. line by line from String Object 23.39 73.42   4. line by line from IO Object 24.55 0.0   5. CSV.foreach  24.04 0.0   6. PyCall 1.49 54.99    \n\nはい、結果が出ました。Daliborのベンチマーク記事で一番速かった CSV.foreach より16倍の実行速度となりました。   > WRAPUPWRAPUP \n\nPyCallのオブジェクトが PyObjectとActiveRecordと相性が悪そうなのと、PythonとRuby双方のメモリー管理が運用を難しくすることから、安易に本番環境のRailsに導入するのは厳しいと思います。 \n\nただし、実行回数が限定されたスクリプトなら積極的に使って良いでしょう。"},"name":"[2017-06-05]RubyのCSVパースをPyCallで実行する（ベンチマーク）","tags":["ruby","benchmark","pycall"],"childPublishedDate":{"published_on":"2017-06-05T00:00:00.000Z","published_on_unix":1496620800}}},{"node":{"number":62,"relative_category":"blog/backend","fields":{"title":"Elixirではてなブックマーク","excerpt":"紆余曲折合ってはてなブックマークの運用を見直す必要が出てきました。人の興味というのは尽きないもので知りたいことが次々出てきます。にも拘わらず人の時間は有限でそれにあがなうための手段を考えたわけです。   > PROBLEMPROBLEM \n\n- フィードリーダーで記事を読んだ後にはてなブックマーク（ブクマ）するとフィード消化するのに時間がかかる フィードをそのままブクマしていると下記の問題がでてくる あとで確認することができない 読みたくない記事をブクマしてしまう 適切でないURLでブクマしてしまう \n- フィードをそのままブクマしていると下記の問題がでてくる あとで確認することができない 読みたくない記事をブクマしてしまう 適切でないURLでブクマしてしまう \n- あとで確認することができない\n- 読みたくない記事をブクマしてしまう\n- 適切でないURLでブクマしてしまう   > SOLUTIONSOLUTION \n\nというわけで、下記の方針でブクマすることにしました。設置方法の詳細はGitHubレポジトリを参照ください。そして、方針は下記の通りになります。 \n\n方針 \n\n- フィードごとにタグづけする\n- ブクマ対象になる記事をリンクとタイトルで除外判定する\n- ブクマ対象になる記事をリンクから校正すべきものかリダイレクトすべきものか判定する\n- 上記設定はYAMLファイルで簡単に管理できるようにする\n- フィード読込とブクマを非同期処理できるようElixirで実装する   > ブクマの管理方法ブクマの管理方法 \n\nまずブクマの管理ですが、下記5つのYAMLファイルで構成しています、構造はマップとリストのみ。ブクマしたいと思う記事を読みすすめる中で気になるキーワードが出てきたら都度 feed.yaml を更新します。また、記事にノイズが多いようだったら傾向を分析して除外ファイル feed_excluded_link.yaml feed_excluded_title.yaml を更新します。    item description     feed.yaml フィードグループ名に対するリンク、タグのマップ   feed_excluded_link.yaml 除外すべきフィードリンクのリスト   feed_excluded_title.yaml 除外すべきフィードタイトルのリスト   feed_corrected_link.yaml フィードリンクに対するトリミングすべきパラメータのマップ   feed_redirected_link.yaml フィードリンクに対するリダイレクト先リンクのマップ      yaml \n\n# feed.yaml nabinno/sports/feed_group_name: tags: - ski links: - http://rss.example.com/ski_feed.rss - http://rss.example.com/snowboard_feed.rss - http://ski-status.example.com/rss # feed_excluded_link.yaml - anti-ski.example.com - awesome-snowboard.example.com # feed_excluded_title.yaml - queer - two-planker - beaver-tail # feed_corrected_link.yaml amazon.com: - ref - ie # feed_redirected_link.yaml ski-status.example.com: - Floki.find(fst, \".post__body a\")     > Elixirによる非同期処理Elixirによる非同期処理 \n\nElixirで非同期処理を行っているのですが、大きく分けて監視機構のSupervisorと非同期処理のTask.async_streamを使っています。   > 監視機構 Supervisor監視機構 Supervisor \n\nまず、Supervisor。Elixirには監視機構Supervisorがあり、それが各ワーカーを子プロセスとして管理しています。ここではフィード読込とブクマは別々のワーカーで処理しますが、キャッシュが暖気処理を別ワーカーで行っているため再起動戦略は「失敗したイベントの中にあるすべての子プロセスを再起動」（ one_for_all ）にしてあります。再起動戦略の詳細は「OTPスーパバイザ · Elixir School」を参照下さい。 \n\n下記のように Supervisor.start_link を Keshikimi2.Application.start に適用すると、アプリケーション開始（ mix run ）した時点で監視機構が起動されます。   ex \n\nSupervisor.start_link( [ :hackney_pool.child_spec(:hatena_bookmark_pool, timeout: 15_000, max_connections: 100), # @todo 当該ワーカーで暖気処理を行っていないので `one_for_one` にした場合、再起動時にほかに影響する supervisor(Cachex, [:feed, []]), supervisor(Keshikimi2Feed.Registry, [prefix]), # フィード読込処理 (PubSub) supervisor(Keshikimi2Feed.Subscriber, [prefix]), worker(Keshikimi2Feed.Worker, [prefix]), worker(Keshikimi2Feed.Publisher, [[prefix: prefix, poll_interval: 3_000]]), # ブクマ処理 worker(Keshikimi2.HatenaBookmark.AddEntry, [ [prefix: prefix, poll_interval: 3_000] ]) ], strategy: :one_for_all, name: name(prefix) )     > 非同期処理 Task.async_stream非同期処理 Task.async_stream \n\n次に、Task.async_stream。配列を引き回すリクエスト処理は Task.async_stream がうってつけです。下記ではキャッシュからブクマ対象になるフィードリンクを取り出し、除外処理、校正処理を加えて、ブクマのリクエストを出すという流れを組んでいます。Elixirでは、流れをひとまとめにして視覚的にわかりやすく非同期処理してくことができます。   ex \n\nCachex.keys!(:feed) |> Enum.reject(fn key -> key in [ \"excluded_links\", \"excluded_titles\", \"corrected_links\", \"redirected_links\", \"feed_group\", \"archived_links\" ] end) |> Task.async_stream( fn item_link -> with {:ok, [item_title, feed_tags]} <- Cachex.get(:feed, item_link), :ok <- validate_all(item_link, item_title), corrected_link <- correct_all(item_link), {:ok, payload} <- FormData.create( %{ url: corrected_link, comment: feed_tags |> Enum.map_join(fn tag -> \"[#{tag}]\" end), rks: System.get_env(\"HATENA_BOOKMARK_RKS\"), private: 0, keep_original_url: 1, with_status_op: 1, from: \"inplace\", post_twitter: 0, post_evernote: 0 }, :url_encoded, get: false ) do do_add_entries_to_hb(payload) Logger.info(\"add entry: #{item_link}\") end archive_link(item_link) end, timeout: 15_000 ) |> Stream.run()     > WRAPUPWRAPUP \n\nElixirの非同期処理を使うことではてなブックマークの運用がとても快適になりました。はてなブックマークとの今後の付き合い方は下記のように考えています。 \n\n- 手動でブクマ: 気になった記事があるごとに\n- ブクマの確認: 気になるタグごとにまとめて確認 \n\nブクマの確認については、例えば、CIでデプロイしている間に最近のGitHubの動向を確認したい場合は「nabinno/github」をみる、という感じの運用です。 \n\n融通が利かない点で途中運用が難しくなる気もしますが、しばらく回してみます。"},"name":"[2019-01-01]Elixirではてなブックマーク","tags":["elixir","hatena-bookmark"],"childPublishedDate":{"published_on":"2019-01-01T00:00:00.000Z","published_on_unix":1546300800}}},{"node":{"number":63,"relative_category":"blog/frontend","fields":{"title":"イケてるしヤバい言語REBOLの後継Redでクライアントソフトをつくった話","excerpt":"Redという言語はご存じでしょうか。癖になる手触りですぐに虜になりました。新年早々の恋になります。   > PROBLEMPROBLEM \n\n- クロスプラットフォーム用のクライアントソフトをつくるにあたり 重たいフレームワークが多い 汎用的な言語をつかってるものが多く、そのためライブラリー等の依存関係が多くなりやすい \n- 重たいフレームワークが多い\n- 汎用的な言語をつかってるものが多く、そのためライブラリー等の依存関係が多くなりやすい   > SOLUTIONSOLUTION \n\nというわけで、年明け見つけたRedがシンプルだったので使ってみました。題材は以前つくったEmacsライブラリ「esa.el」の移植です。 \n\n- https://github.com/nabinno/esa.red   > やったことやったこと   > エディターエディター \n\n構文がすなおなので特にエディタは関係なさそうでしたが、慣れ親しんでるEmacsに「Skrylar/red.el」を適用しました。その際、 red-font-lock-keywords と red-indent-line に足りない箇所があったのでオーバーライドしました。   > 糖衣構文の適用糖衣構文の適用 \n\nRedはコマンドラインREPLがつかえるので、doc.red-lang.orgとred-by-example.orgをみながらひとつひとつ挙動を確認しました。その中でどうしても慣れない表現が2つあったので糖衣構文を実装（nabinno/red-elixir）。 \n\n1. compose \n\nブロック内の変数を評価しブロックとして返す関数 compose は、VIDのフェイス更新によく使われます。HTML/JavaScripでいうところDOM更新にあたるものといえば分かるでしょうか。頻繁に「 compose [foo (bar)] 」のような表現がつづくとほかの変数や関数とまざり可読性がおちるので、Elixirのシジルを参考に compose 関数を省略しました。こんな感じです。 \n\n;-- before compose [foo (bar)] ;-- after ~c[foo (bar)]  \n\n2. 関数の入れ子 \n\n素のRedはイテレーター構文なので、関数の入れ子による可読性低下をおさえるため変数定義をよく使います。個人的には変数は意味のあるものだけ使いたい派なので、パイプを導入しました。といっても、フロントエンドの場合、データ加工はあまりやらないのでつかうケースはほぼありませんでした。あってもこのくらいです。   red \n\n;-- before rejoin collect [ foreach d data [ keep rejoin [d \" \"] ] ] ;-- after data .[ |> Series/map 'd [rejoin [d \" \"]] |> rejoin ]     > タスクランナーの用意タスクランナーの用意 \n\n今回は上で実装したライブラリ「red-elixir」のほかにHTTPリクエスト・JSONパーサーライブラリを使っています。ライブラリパッケージはインストールはgit submodulesで良いですが、呼び出しも考えると実装が冗長的になるのでパッケージ管理とタスクランナーをあわせて用意しました（nabinno/hot、nabinno/mods）。 \n\nタスクランナーインストール後、パッケージのインストールから呼び出しまでの流れ \n\nRedはGoとおなじくワンバイナリーなので、wgetやcurlだけでインストールが完了します。   sh \n\n> mkdir -p ~/.local/bin > wget https://github.com/nabinno/hot/releases/download/0.0.3/hot-linux -O ~/.local/bin/hot > chmod 744 ~/.local/bin/hot   \n\nパッケージ管理はElixirのmixを参考にタスクランナー管理ファイル内に定義します。   sh \n\n> hot cmd/install https://raw.githubusercontent.com/nabinno/mods/master/mods.red > cat hots.red Red [] hots: context [ mods: [ red-elixir #(init: %init.red git: https://github.com/nabinno/red-elixir) json #(init: %json.red git: https://github.com/rebolek/red-tools) http-tools #(init: %http-tools.red git: https://github.com/rebolek/red-tools) ] ] > hot mods/get   \n\nビルド時は #include をつかうのでパッケージ呼び出し機能は使えないですが、コマンドラインREPLで挙動確認している際は do/args %require を使います。   sh \n\n> red >> do/args %require [red-elixir] >> 1 .. 10 .[ |> Series/map 'i [i * 2] |> Series/map 'i [i + 1] ] == [3 5 7 9 11 13 15 17 19 21]     > WRAPUPWRAPUP \n\nクライアントソフトを作る中で感じたことは、この1点です。Redは既存のフレームワークと比べるとまだまだ機能不足感が拭えませんが、それを補えるだけの表現力を持っていました。手触りが本当に良い言語でした。"},"name":"[2019-03-31]イケてるしヤバい言語REBOLの後継Redでクライアントソフトをつくった話","tags":["red","esa"],"childPublishedDate":{"published_on":"2019-03-31T00:00:00.000Z","published_on_unix":1553990400}}}]}},"pageContext":{"number":60}},"staticQueryHashes":[]}